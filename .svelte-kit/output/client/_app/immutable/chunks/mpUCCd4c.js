import{C as fI,E as dI,b3 as J_,q as Ff,x as Y_,O as X_,y as wr,aQ as pI,b4 as gI,b5 as yI,ax as mI,b6 as wI,i as bI,aO as _I,J as vy,b7 as SI,b8 as EI,Q as vI,b9 as kI,ba as xI,bb as II,bc as TI,bd as AI}from"./Dx6vkeWC.js";import{B as RI}from"./CL2VAI88.js";import{a as CI,b as OI,d as MI,n as LI,f as DI}from"./C7qgDVRg.js";function z3(t,e,...n){var r=new RI(t);fI(()=>{const s=e()??null;r.ensure(s,s&&(i=>s(i,...n)))},dI)}function FI(t,e){var n=void 0,r;J_(()=>{n!==(n=e())&&(r&&(Ff(r),r=null),n&&(r=Y_(()=>{X_(()=>n(t))})))})}function Z_(t){var e,n,r="";if(typeof t=="string"||typeof t=="number")r+=t;else if(typeof t=="object")if(Array.isArray(t)){var s=t.length;for(e=0;e<s;e++)t[e]&&(n=Z_(t[e]))&&(r&&(r+=" "),r+=n)}else for(n in t)t[n]&&(r&&(r+=" "),r+=n);return r}function NI(){for(var t,e,n=0,r="",s=arguments.length;n<s;n++)(t=arguments[n])&&(e=Z_(t))&&(r&&(r+=" "),r+=e);return r}function PI(t){return typeof t=="object"?NI(t):t??""}const ky=[...` 	
\r\fÂ \v\uFEFF`];function $I(t,e,n){var r=t==null?"":""+t;if(n){for(var s in n)if(n[s])r=r?r+" "+s:s;else if(r.length)for(var i=s.length,o=0;(o=r.indexOf(s,o))>=0;){var c=o+i;(o===0||ky.includes(r[o-1]))&&(c===r.length||ky.includes(r[c]))?r=(o===0?"":r.substring(0,o))+r.substring(c+1):o=c}}return r===""?null:r}function xy(t,e=!1){var n=e?" !important;":";",r="";for(var s in t){var i=t[s];i!=null&&i!==""&&(r+=" "+s+": "+i+n)}return r}function Ol(t){return t[0]!=="-"||t[1]!=="-"?t.toLowerCase():t}function BI(t,e){if(e){var n="",r,s;if(Array.isArray(e)?(r=e[0],s=e[1]):r=e,t){t=String(t).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var i=!1,o=0,c=!1,a=[];r&&a.push(...Object.keys(r).map(Ol)),s&&a.push(...Object.keys(s).map(Ol));var u=0,h=-1;const w=t.length;for(var l=0;l<w;l++){var d=t[l];if(c?d==="/"&&t[l-1]==="*"&&(c=!1):i?i===d&&(i=!1):d==="/"&&t[l+1]==="*"?c=!0:d==='"'||d==="'"?i=d:d==="("?o++:d===")"&&o--,!c&&i===!1&&o===0){if(d===":"&&h===-1)h=l;else if(d===";"||l===w-1){if(h!==-1){var f=Ol(t.substring(u,h).trim());if(!a.includes(f)){d!==";"&&l++;var p=t.substring(u,l).trim();n+=" "+p+";"}}u=l+1,h=-1}}}}return r&&(n+=xy(r)),s&&(n+=xy(s,!0)),n=n.trim(),n===""?null:n}return t==null?null:String(t)}function qI(t,e,n,r,s,i){var o=t.__className;if(wr||o!==n||o===void 0){var c=$I(n,r,i);(!wr||c!==t.getAttribute("class"))&&(c==null?t.removeAttribute("class"):e?t.className=c:t.setAttribute("class",c)),t.__className=n}else if(i&&s!==i)for(var a in i){var u=!!i[a];(s==null||u!==!!s[a])&&t.classList.toggle(a,u)}return i}function Ml(t,e={},n,r){for(var s in n){var i=n[s];e[s]!==i&&(n[s]==null?t.style.removeProperty(s):t.style.setProperty(s,i,r))}}function UI(t,e,n,r){var s=t.__style;if(wr||s!==e){var i=BI(e,r);(!wr||i!==t.getAttribute("style"))&&(i==null?t.removeAttribute("style"):t.style.cssText=i),t.__style=e}else r&&(Array.isArray(r)?(Ml(t,n?.[0],r[0]),Ml(t,n?.[1],r[1],"important")):Ml(t,n,r));return r}function Nf(t,e,n=!1){if(t.multiple){if(e==null)return;if(!pI(e))return gI();for(var r of t.options)r.selected=e.includes(Iy(r));return}for(r of t.options){var s=Iy(r);if(yI(s,e)){r.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function VI(t){var e=new MutationObserver(()=>{Nf(t,t.__value)});e.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),mI(()=>{e.disconnect()})}function Iy(t){return"__value"in t?t.__value:t.value}const Ki=Symbol("class"),Wi=Symbol("style"),eS=Symbol("is custom element"),tS=Symbol("is html");function jI(t){if(wr){var e=!1,n=()=>{if(!e){if(e=!0,t.hasAttribute("value")){var r=t.value;Ta(t,"value",null),t.value=r}if(t.hasAttribute("checked")){var s=t.checked;Ta(t,"checked",null),t.checked=s}}};t.__on_r=n,vI(n),kI()}}function H3(t,e){var n=op(t);n.value===(n.value=e??void 0)||t.value===e&&(e!==0||t.nodeName!=="PROGRESS")||(t.value=e??"")}function KI(t,e){e?t.hasAttribute("selected")||t.setAttribute("selected",""):t.removeAttribute("selected")}function Ta(t,e,n,r){var s=op(t);wr&&(s[e]=t.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&t.nodeName==="LINK")||s[e]!==(s[e]=n)&&(e==="loading"&&(t[TI]=n),n==null?t.removeAttribute(e):typeof n!="string"&&nS(t).includes(e)?t[e]=n:t.setAttribute(e,n))}function WI(t,e,n,r,s=!1,i=!1){if(wr&&s&&t.tagName==="INPUT"){var o=t,c=o.type==="checkbox"?"defaultChecked":"defaultValue";c in n||jI(o)}var a=op(t),u=a[eS],h=!a[tS];let l=wr&&u;l&&vy(!1);var d=e||{},f=t.tagName==="OPTION";for(var p in e)p in n||(n[p]=null);n.class?n.class=PI(n.class):n[Ki]&&(n.class=null),n[Wi]&&(n.style??=null);var w=nS(t);for(const A in n){let L=n[A];if(f&&A==="value"&&L==null){t.value=t.__value="",d[A]=L;continue}if(A==="class"){var g=t.namespaceURI==="http://www.w3.org/1999/xhtml";qI(t,g,L,r,e?.[Ki],n[Ki]),d[A]=L,d[Ki]=n[Ki];continue}if(A==="style"){UI(t,L,e?.[Wi],n[Wi]),d[A]=L,d[Wi]=n[Wi];continue}var m=d[A];if(!(L===m&&!(L===void 0&&t.hasAttribute(A)))){d[A]=L;var _=A[0]+A[1];if(_!=="$$")if(_==="on"){const D={},K="$$"+A;let O=A.slice(2);var v=DI(O);if(CI(O)&&(O=O.slice(0,-7),D.capture=!0),!v&&m){if(L!=null)continue;t.removeEventListener(O,d[K],D),d[K]=null}if(L!=null)if(v)t[`__${O}`]=L,MI([O]);else{let N=function(W){d[A].call(this,W)};d[K]=OI(O,t,N,D)}else v&&(t[`__${O}`]=void 0)}else if(A==="style")Ta(t,A,L);else if(A==="autofocus")SI(t,!!L);else if(!u&&(A==="__value"||A==="value"&&L!=null))t.value=t.__value=L;else if(A==="selected"&&f)KI(t,L);else{var k=A;h||(k=LI(k));var I=k==="defaultValue"||k==="defaultChecked";if(L==null&&!u&&!I)if(a[A]=null,k==="value"||k==="checked"){let D=t;const K=e===void 0;if(k==="value"){let O=D.defaultValue;D.removeAttribute(k),D.defaultValue=O,D.value=D.__value=K?O:null}else{let O=D.defaultChecked;D.removeAttribute(k),D.defaultChecked=O,D.checked=K?O:!1}}else t.removeAttribute(A);else I||w.includes(k)&&(u||typeof L!="string")?(t[k]=L,k in a&&(a[k]=EI)):typeof L!="function"&&Ta(t,k,L)}}}return l&&vy(!0),d}function Q3(t,e,n=[],r=[],s=[],i,o=!1,c=!1){wI(s,n,r,a=>{var u=void 0,h={},l=t.nodeName==="SELECT",d=!1;if(J_(()=>{var p=e(...a.map(bI)),w=WI(t,u,p,i,o,c);d&&l&&"value"in p&&Nf(t,p.value);for(let m of Object.getOwnPropertySymbols(h))p[m]||Ff(h[m]);for(let m of Object.getOwnPropertySymbols(p)){var g=p[m];m.description===_I&&(!u||g!==u[m])&&(h[m]&&Ff(h[m]),h[m]=Y_(()=>FI(t,()=>g))),w[m]=g}u=w}),l){var f=t;X_(()=>{Nf(f,u.value,!0),VI(f)})}d=!0})}function op(t){return t.__attributes??={[eS]:t.nodeName.includes("-"),[tS]:t.namespaceURI===xI}}var Ty=new Map;function nS(t){var e=t.getAttribute("is")||t.nodeName,n=Ty.get(e);if(n)return n;Ty.set(e,n=[]);for(var r,s=t,i=Element.prototype;i!==s;){r=AI(s);for(var o in r)r[o].set&&n.push(o);s=II(s)}return n}const Ay="1.31.2";var bn=[],nn=[],zI=Uint8Array,Ll="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var bs=0,HI=Ll.length;bs<HI;++bs)bn[bs]=Ll[bs],nn[Ll.charCodeAt(bs)]=bs;nn[45]=62;nn[95]=63;function QI(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function GI(t,e,n){return(e+n)*3/4-n}function Ro(t){var e,n=QI(t),r=n[0],s=n[1],i=new zI(GI(t,r,s)),o=0,c=s>0?r-4:r,a;for(a=0;a<c;a+=4)e=nn[t.charCodeAt(a)]<<18|nn[t.charCodeAt(a+1)]<<12|nn[t.charCodeAt(a+2)]<<6|nn[t.charCodeAt(a+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return s===2&&(e=nn[t.charCodeAt(a)]<<2|nn[t.charCodeAt(a+1)]>>4,i[o++]=e&255),s===1&&(e=nn[t.charCodeAt(a)]<<10|nn[t.charCodeAt(a+1)]<<4|nn[t.charCodeAt(a+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function JI(t){return bn[t>>18&63]+bn[t>>12&63]+bn[t>>6&63]+bn[t&63]}function YI(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(JI(r));return s.join("")}function Co(t){for(var e,n=t.length,r=n%3,s=[],i=16383,o=0,c=n-r;o<c;o+=i)s.push(YI(t,o,o+i>c?c:o+i));return r===1?(e=t[n-1],s.push(bn[e>>2]+bn[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(bn[e>>10]+bn[e>>4&63]+bn[e<<2&63]+"=")),s.join("")}function hr(t){if(t===void 0)return{};if(!sS(t))throw new Error(`The arguments to a Convex function must be an object. Received: ${t}`);return t}function rS(t){if(typeof t>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof t!="string")throw new Error(`Invalid deployment address: found ${t}".`);if(!(t.startsWith("http:")||t.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${t}".`);try{new URL(t)}catch{throw new Error(`Invalid deployment address: "${t}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(t.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${t}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function sS(t){const e=typeof t=="object",n=Object.getPrototypeOf(t),r=n===null||n===Object.prototype||n?.constructor?.name==="Object";return e&&r}const iS=!0,Ks=BigInt("-9223372036854775808"),cp=BigInt("9223372036854775807"),Pf=BigInt("0"),XI=BigInt("8"),ZI=BigInt("256");function oS(t){return Number.isNaN(t)||!Number.isFinite(t)||Object.is(t,-0)}function eT(t){t<Pf&&(t-=Ks+Ks);let e=t.toString(16);e.length%2===1&&(e="0"+e);const n=new Uint8Array(new ArrayBuffer(8));let r=0;for(const s of e.match(/.{2}/g).reverse())n.set([parseInt(s,16)],r++),t>>=XI;return Co(n)}function tT(t){const e=Ro(t);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let n=Pf,r=Pf;for(const s of e)n+=BigInt(s)*ZI**r,r++;return n>cp&&(n+=Ks+Ks),n}function nT(t){if(t<Ks||cp<t)throw new Error(`BigInt ${t} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,t,!0),Co(new Uint8Array(e))}function rT(t){const e=Ro(t);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const sT=DataView.prototype.setBigInt64?nT:eT,iT=DataView.prototype.getBigInt64?rT:tT,Ry=1024;function cS(t){if(t.length>Ry)throw new Error(`Field name ${t} exceeds maximum field name length ${Ry}.`);if(t.startsWith("$"))throw new Error(`Field name ${t} starts with a '$', which is reserved.`);for(let e=0;e<t.length;e+=1){const n=t.charCodeAt(e);if(n<32||n>=127)throw new Error(`Field name ${t} has invalid character '${t[e]}': Field names can only contain non-control ASCII characters`)}}function Ws(t){if(t===null||typeof t=="boolean"||typeof t=="number"||typeof t=="string")return t;if(Array.isArray(t))return t.map(r=>Ws(r));if(typeof t!="object")throw new Error(`Unexpected type of ${t}`);const e=Object.entries(t);if(e.length===1){const r=e[0][0];if(r==="$bytes"){if(typeof t.$bytes!="string")throw new Error(`Malformed $bytes field on ${t}`);return Ro(t.$bytes).buffer}if(r==="$integer"){if(typeof t.$integer!="string")throw new Error(`Malformed $integer field on ${t}`);return iT(t.$integer)}if(r==="$float"){if(typeof t.$float!="string")throw new Error(`Malformed $float field on ${t}`);const s=Ro(t.$float);if(s.byteLength!==8)throw new Error(`Received ${s.byteLength} bytes, expected 8 for $float`);const o=new DataView(s.buffer).getFloat64(0,iS);if(!oS(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(r==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(r==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const n={};for(const[r,s]of Object.entries(t))cS(r),n[r]=Ws(s);return n}const Cy=16384;function yo(t){const e=JSON.stringify(t,(n,r)=>r===void 0?"undefined":typeof r=="bigint"?`${r.toString()}n`:r);if(e.length>Cy){const n="[...truncated]";let r=Cy-n.length;const s=e.codePointAt(r-1);return s!==void 0&&s>65535&&(r-=1),e.substring(0,r)+n}return e}function $f(t,e,n,r){if(t===void 0){const o=n&&` (present at path ${n} in original object ${yo(e)})`;throw new Error(`undefined is not a valid Convex value${o}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(t===null)return t;if(typeof t=="bigint"){if(t<Ks||cp<t)throw new Error(`BigInt ${t} does not fit into a 64-bit signed integer.`);return{$integer:sT(t)}}if(typeof t=="number")if(oS(t)){const o=new ArrayBuffer(8);return new DataView(o).setFloat64(0,t,iS),{$float:Co(new Uint8Array(o))}}else return t;if(typeof t=="boolean"||typeof t=="string")return t;if(t instanceof ArrayBuffer)return{$bytes:Co(new Uint8Array(t))};if(Array.isArray(t))return t.map((o,c)=>$f(o,e,n+`[${c}]`));if(t instanceof Set)throw new Error(Dl(n,"Set",[...t],e));if(t instanceof Map)throw new Error(Dl(n,"Map",[...t],e));if(!sS(t)){const o=t?.constructor?.name,c=o?`${o} `:"";throw new Error(Dl(n,c,t,e))}const s={},i=Object.entries(t);i.sort(([o,c],[a,u])=>o===a?0:o<a?-1:1);for(const[o,c]of i)c!==void 0&&(cS(o),s[o]=$f(c,e,n+`.${o}`));return s}function Dl(t,e,n,r){return t?`${e}${yo(n)} is not a supported Convex type (present at path ${t} in original object ${yo(r)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${yo(n)} is not a supported Convex type.`}function Kr(t){return $f(t,t,"")}var oT=Object.defineProperty,cT=(t,e,n)=>e in t?oT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Fl=(t,e,n)=>cT(t,typeof e!="symbol"?e+"":e,n),Oy,My;const aT=Symbol.for("ConvexError");class Bf extends(My=Error,Oy=aT,My){constructor(e){super(typeof e=="string"?e:yo(e)),Fl(this,"name","ConvexError"),Fl(this,"data"),Fl(this,Oy,!0),this.data=e}}var uT=Object.defineProperty,lT=(t,e,n)=>e in t?uT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Ly=(t,e,n)=>lT(t,typeof e!="symbol"?e+"":e,n);const hT="color:rgb(0, 145, 255)";function aS(t){switch(t){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class uS{constructor(e){Ly(this,"_onLogLineFuncs"),Ly(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let n=Math.random().toString(36).substring(2,15);for(let r=0;r<10&&this._onLogLineFuncs[n]!==void 0;r++)n=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[n]=e,()=>{delete this._onLogLineFuncs[n]}}logVerbose(...e){if(this._verbose)for(const n of Object.values(this._onLogLineFuncs))n("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const n of Object.values(this._onLogLineFuncs))n("info",...e)}warn(...e){for(const n of Object.values(this._onLogLineFuncs))n("warn",...e)}error(...e){for(const n of Object.values(this._onLogLineFuncs))n("error",...e)}}function fT(t){const e=new uS(t);return e.addLogLineListener((n,...r)=>{switch(n){case"debug":console.debug(...r);break;case"info":console.log(...r);break;case"warn":console.warn(...r);break;case"error":console.error(...r);break;default:console.log(...r)}}),e}function dT(t){return new uS(t)}function Aa(t,e,n,r,s){const i=aS(n);if(typeof s=="object"&&(s=`ConvexError ${JSON.stringify(s.errorData,null,2)}`),e==="info"){const o=s.match(/^\[.*?\] /);if(o===null){t.error(`[CONVEX ${i}(${r})] Could not parse console.log`);return}const c=s.slice(1,o[0].length-2),a=s.slice(o[0].length);t.log(`%c[CONVEX ${i}(${r})] [${c}]`,hT,a)}else t.error(`[CONVEX ${i}(${r})] ${s}`)}function pT(t,e){const n=`[CONVEX FATAL ERROR] ${e}`;return t.error(n),new Error(n)}function Is(t,e,n){return`[CONVEX ${aS(t)}(${e})] ${n.errorMessage}
  Called by client`}function qf(t,e){return e.data=t.errorData,e}function Wr(t){const e=t.split(":");let n,r;return e.length===1?(n=e[0],r="default"):(n=e.slice(0,e.length-1).join(":"),r=e[e.length-1]),n.endsWith(".js")&&(n=n.slice(0,-3)),`${n}:${r}`}function Lr(t,e){return JSON.stringify({udfPath:Wr(t),args:Kr(e)})}function Dy(t,e,n){const{initialNumItems:r,id:s}=n;return JSON.stringify({type:"paginated",udfPath:Wr(t),args:Kr(e),options:Kr({initialNumItems:r,id:s})})}function gT(t){return JSON.parse(t).type==="paginated"}var yT=Object.defineProperty,mT=(t,e,n)=>e in t?yT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,gn=(t,e,n)=>mT(t,typeof e!="symbol"?e+"":e,n);class wT{constructor(){gn(this,"nextQueryId"),gn(this,"querySetVersion"),gn(this,"querySet"),gn(this,"queryIdToToken"),gn(this,"identityVersion"),gn(this,"auth"),gn(this,"outstandingQueriesOlderThanRestart"),gn(this,"outstandingAuthOlderThanRestart"),gn(this,"paused"),gn(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,n,r,s){const i=Wr(e),o=Lr(i,n),c=this.querySet.get(o);if(c!==void 0)return c.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const a=this.nextQueryId++,u={id:a,canonicalizedUdfPath:i,args:n,numSubscribers:1,journal:r,componentPath:s};this.querySet.set(o,u),this.queryIdToToken.set(a,o);const h=this.querySetVersion,l=this.querySetVersion+1,d={type:"Add",queryId:a,udfPath:i,args:[Kr(n)],journal:r,componentPath:s};return this.paused?this.pendingQuerySetModifications.set(a,d):this.querySetVersion=l,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:h,newVersion:l,modifications:[d]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const n of e.modifications)switch(n.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(n.queryId);const r=n.journal;if(r!==void 0){const s=this.queryIdToToken.get(n.queryId);s!==void 0&&(this.querySet.get(s).journal=r)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(n.queryId);break}default:throw new Error(`Invalid modification ${n.type}`)}}queryId(e,n){const r=Wr(e),s=Lr(r,n),i=this.querySet.get(s);return i!==void 0?i.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}getAuth(){return this.auth}setAuth(e){this.auth={tokenType:"User",value:e};const n=this.identityVersion;return this.paused||(this.identityVersion=n+1),{type:"Authenticate",baseVersion:n,...this.auth}}setAdminAuth(e,n){const r={tokenType:"Admin",value:e,impersonating:n};this.auth=r;const s=this.identityVersion;return this.paused||(this.identityVersion=s+1),{type:"Authenticate",baseVersion:s,...r}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){return this.auth?.value!==e}queryPath(e){const n=this.queryIdToToken.get(e);return n?this.querySet.get(n).canonicalizedUdfPath:null}queryArgs(e){const n=this.queryIdToToken.get(e);return n?this.querySet.get(n).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){return this.querySet.get(e)?.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const n=[];for(const i of this.querySet.values()){const o={type:"Add",queryId:i.id,udfPath:i.canonicalizedUdfPath,args:[Kr(i.args)],journal:i.journal,componentPath:i.componentPath};n.push(o),e.has(i.id)||this.outstandingQueriesOlderThanRestart.add(i.id)}this.querySetVersion=1;const r={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:n};if(!this.auth)return this.identityVersion=0,[r,void 0];this.outstandingAuthOlderThanRestart=!0;const s={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[r,s]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,n=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,n]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const n=this.querySet.get(e);if(n.numSubscribers>1)return n.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(n.id),this.outstandingQueriesOlderThanRestart.delete(n.id);const r=this.querySetVersion,s=this.querySetVersion+1,i={type:"Remove",queryId:n.id};return this.paused?this.pendingQuerySetModifications.has(n.id)?this.pendingQuerySetModifications.delete(n.id):this.pendingQuerySetModifications.set(n.id,i):this.querySetVersion=s,{type:"ModifyQuerySet",baseVersion:r,newVersion:s,modifications:[i]}}}}var bT=Object.defineProperty,_T=(t,e,n)=>e in t?bT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Mc=(t,e,n)=>_T(t,typeof e!="symbol"?e+"":e,n);class ST{constructor(e,n){this.logger=e,this.markConnectionStateDirty=n,Mc(this,"inflightRequests"),Mc(this,"requestsOlderThanRestart"),Mc(this,"inflightMutationsCount",0),Mc(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,n){const r=new Promise(s=>{const i=n?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:i,requestedAt:new Date,onResult:s}}),e.type==="Mutation"?this.inflightMutationsCount++:e.type==="Action"&&this.inflightActionsCount++});return this.markConnectionStateDirty(),r}onResponse(e){const n=this.inflightRequests.get(e.requestId);if(n===void 0||n.status.status==="Completed")return null;const r=n.message.type==="Mutation"?"mutation":"action",s=n.message.udfPath;for(const a of e.logLines)Aa(this.logger,"info",r,s,a);const i=n.status;let o,c;if(e.success)o={success:!0,logLines:e.logLines,value:Ws(e.result)},c=()=>i.onResult(o);else{const a=e.result,{errorData:u}=e;Aa(this.logger,"error",r,s,a),o={success:!1,errorMessage:a,errorData:u!==void 0?Ws(u):void 0,logLines:e.logLines},c=()=>i.onResult(o)}return e.type==="ActionResponse"||!e.success?(c(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),n.message.type==="Action"?this.inflightActionsCount--:n.message.type==="Mutation"&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:e.requestId,result:o}):(n.status={status:"Completed",result:o,ts:e.ts,onResolve:c},null)}removeCompleted(e){const n=new Map;for(const[r,s]of this.inflightRequests.entries()){const i=s.status;i.status==="Completed"&&i.ts.lessThanOrEqual(e)&&(i.onResolve(),n.set(r,i.result),s.message.type==="Mutation"?this.inflightMutationsCount--:s.message.type==="Action"&&this.inflightActionsCount--,this.inflightRequests.delete(r),this.requestsOlderThanRestart.delete(r))}return n.size>0&&this.markConnectionStateDirty(),n}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[n,r]of this.inflightRequests){if(r.status.status==="NotSent"){r.status.status="Requested",e.push(r.message);continue}if(r.message.type==="Mutation")e.push(r.message);else if(r.message.type==="Action"){if(this.inflightRequests.delete(n),this.requestsOlderThanRestart.delete(n),this.inflightActionsCount--,r.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");r.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),e}resume(){const e=[];for(const[,n]of this.inflightRequests)if(n.status.status==="NotSent"){n.status.status="Requested",e.push(n.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const n of this.inflightRequests.values())n.status.status!=="Completed"&&n.status.requestedAt.getTime()<e&&(e=n.status.requestedAt.getTime());return new Date(e)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}const Ra=Symbol.for("functionName"),lS=Symbol.for("toReferencePath");function ET(t){return t[lS]??null}function vT(t){return t.startsWith("function://")}function kT(t){let e;if(typeof t=="string")vT(t)?e={functionHandle:t}:e={name:t};else if(t[Ra])e={name:t[Ra]};else{const n=ET(t);if(!n)throw new Error(`${t} is not a functionReference`);e={reference:n}}return e}function Fn(t){const e=kT(t);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof t=="string")return t;const n=t[Ra];if(!n)throw new Error(`${t} is not a functionReference`);return n}function hS(t=[]){const e={get(n,r){if(typeof r=="string"){const s=[...t,r];return hS(s)}else if(r===Ra){if(t.length<2){const o=["api",...t].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const s=t.slice(0,-1).join("/"),i=t[t.length-1];return i==="default"?s:s+":"+i}else return r===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}const xT=hS();var IT=Object.defineProperty,TT=(t,e,n)=>e in t?IT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Ca=(t,e,n)=>TT(t,typeof e!="symbol"?e+"":e,n);class Oo{constructor(e){Ca(this,"queryResults"),Ca(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...n){const r=hr(n[0]),s=Fn(e),i=this.queryResults.get(Lr(s,r));if(i!==void 0)return Oo.queryValue(i.result)}getAllQueries(e){const n=[],r=Fn(e);for(const s of this.queryResults.values())s.udfPath===Wr(r)&&n.push({args:s.args,value:Oo.queryValue(s.result)});return n}setQuery(e,n,r){const s=hr(n),i=Fn(e),o=Lr(i,s);let c;r===void 0?c=void 0:c={success:!0,value:r,logLines:[]};const a={udfPath:i,args:s,result:c};this.queryResults.set(o,a),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class AT{constructor(){Ca(this,"queryResults"),Ca(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,n){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!n.has(o.mutationId));const r=this.queryResults;this.queryResults=new Map(e);const s=new Oo(this.queryResults);for(const o of this.optimisticUpdates)o.update(s);const i=[];for(const[o,c]of this.queryResults){const a=r.get(o);(a===void 0||a.result!==c.result)&&i.push(o)}return i}applyOptimisticUpdate(e,n){this.optimisticUpdates.push({update:e,mutationId:n});const r=new Oo(this.queryResults);return e(r),r.modifiedQueries}rawQueryResult(e){const n=this.queryResults.get(e);if(n!==void 0)return n.result}queryResult(e){const n=this.queryResults.get(e);if(n===void 0)return;const r=n.result;if(r!==void 0){if(r.success)return r.value;throw r.errorData!==void 0?qf(r,new Bf(Is("query",n.udfPath,r))):new Error(Is("query",n.udfPath,r))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){return this.queryResults.get(e)?.result?.logLines}}var RT=Object.defineProperty,CT=(t,e,n)=>e in t?RT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Nl=(t,e,n)=>CT(t,typeof e!="symbol"?e+"":e,n);class Nt{constructor(e,n){Nl(this,"low"),Nl(this,"high"),Nl(this,"__isUnsignedLong__"),this.low=e|0,this.high=n|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new Nt(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,n=this.low;return[n&255,n>>>8&255,n>>>16&255,n>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?Fy:e>=OT?MT:new Nt(e%mo|0,e/mo|0)}toString(){return(BigInt(this.high)*BigInt(mo)+BigInt(this.low)).toString()}equals(e){return Nt.isLong(e)||(e=Nt.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return Nt.isLong(e)||(e=Nt.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?Nt.fromNumber(e):new Nt(e.low,e.high)}}const Fy=new Nt(0,0),Ny=65536,mo=Ny*Ny,OT=mo*mo,MT=new Nt(-1,-1);var LT=Object.defineProperty,DT=(t,e,n)=>e in t?LT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Lc=(t,e,n)=>DT(t,typeof e!="symbol"?e+"":e,n);class Py{constructor(e,n){Lc(this,"version"),Lc(this,"remoteQuerySet"),Lc(this,"queryPath"),Lc(this,"logger"),this.version={querySet:0,ts:Nt.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=n}transition(e){const n=e.startVersion;if(this.version.querySet!==n.querySet||this.version.ts.notEquals(n.ts)||this.version.identity!==n.identity)throw new Error(`Invalid start version: ${n.ts.toString()}:${n.querySet}:${n.identity}, transitioning from ${this.version.ts.toString()}:${this.version.querySet}:${this.version.identity}`);for(const r of e.modifications)switch(r.type){case"QueryUpdated":{const s=this.queryPath(r.queryId);if(s)for(const o of r.logLines)Aa(this.logger,"info","query",s,o);const i=Ws(r.value??null);this.remoteQuerySet.set(r.queryId,{success:!0,value:i,logLines:r.logLines});break}case"QueryFailed":{const s=this.queryPath(r.queryId);if(s)for(const o of r.logLines)Aa(this.logger,"info","query",s,o);const{errorData:i}=r;this.remoteQuerySet.set(r.queryId,{success:!1,errorMessage:r.errorMessage,errorData:i!==void 0?Ws(i):void 0,logLines:r.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(r.queryId);break}default:throw new Error(`Invalid modification ${r.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function Pl(t){const e=Ro(t);return Nt.fromBytesLE(Array.from(e))}function FT(t){const e=new Uint8Array(t.toBytesLE());return Co(e)}function $y(t){switch(t.type){case"FatalError":case"AuthError":case"ActionResponse":case"TransitionChunk":case"Ping":return{...t};case"MutationResponse":return t.success?{...t,ts:Pl(t.ts)}:{...t};case"Transition":return{...t,startVersion:{...t.startVersion,ts:Pl(t.startVersion.ts)},endVersion:{...t.endVersion,ts:Pl(t.endVersion.ts)}}}}function NT(t){switch(t.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...t};case"Connect":return t.maxObservedTimestamp!==void 0?{...t,maxObservedTimestamp:FT(t.maxObservedTimestamp)}:{...t,maxObservedTimestamp:void 0}}}var PT=Object.defineProperty,$T=(t,e,n)=>e in t?PT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,bt=(t,e,n)=>$T(t,typeof e!="symbol"?e+"":e,n);const BT=1e3,qT=1001,UT=1005,VT=4040;let ua;function la(){return ua===void 0&&(ua=Date.now()),typeof performance>"u"||!performance.now?Date.now():Math.round(ua+performance.now())}function By(){return`t=${Math.round((la()-ua)/100)/10}s`}const fS={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},TableSummariesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};function jT(t){if(t===void 0)return"Unknown";for(const e of Object.keys(fS))if(t.startsWith(e))return e;return"Unknown"}class KT{constructor(e,n,r,s,i,o){this.markConnectionStateDirty=i,this.debug=o,bt(this,"socket"),bt(this,"connectionCount"),bt(this,"_hasEverConnected",!1),bt(this,"lastCloseReason"),bt(this,"transitionChunkBuffer",null),bt(this,"defaultInitialBackoff"),bt(this,"maxBackoff"),bt(this,"retries"),bt(this,"serverInactivityThreshold"),bt(this,"reconnectDueToServerInactivityTimeout"),bt(this,"uri"),bt(this,"onOpen"),bt(this,"onResume"),bt(this,"onMessage"),bt(this,"webSocketConstructor"),bt(this,"logger"),bt(this,"onServerDisconnectError"),this.webSocketConstructor=r,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=6e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=n.onOpen,this.onResume=n.onResume,this.onMessage=n.onMessage,this.onServerDisconnectError=n.onServerDisconnectError,this.logger=s,this.connect()}setSocketState(e){this.socket=e,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}assembleTransition(e){if(e.partNumber<0||e.partNumber>=e.totalParts||e.totalParts===0||this.transitionChunkBuffer&&(this.transitionChunkBuffer.totalParts!==e.totalParts||this.transitionChunkBuffer.transitionId!==e.transitionId))throw this.transitionChunkBuffer=null,new Error("Invalid TransitionChunk");if(this.transitionChunkBuffer===null&&(this.transitionChunkBuffer={chunks:[],totalParts:e.totalParts,transitionId:e.transitionId}),e.partNumber!==this.transitionChunkBuffer.chunks.length){const n=this.transitionChunkBuffer.chunks.length;throw this.transitionChunkBuffer=null,new Error(`TransitionChunk received out of order: expected part ${n}, got ${e.partNumber}`)}if(this.transitionChunkBuffer.chunks.push(e.chunk),this.transitionChunkBuffer.chunks.length===e.totalParts){const n=this.transitionChunkBuffer.chunks.join("");this.transitionChunkBuffer=null;const r=$y(JSON.parse(n));if(r.type!=="Transition")throw new Error(`Expected Transition, got ${r.type} after assembling chunks`);return r}return null}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:e,paused:"no"}),this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");this.setSocketState({state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"}),this.resetServerInactivityTimeout(),this.socket.paused==="no"&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:la()})),this.lastCloseReason!=="InitialConnect"&&(this.lastCloseReason?this.logger.log("WebSocket reconnected at",By(),"after disconnect due to",this.lastCloseReason):this.logger.log("WebSocket reconnected at",By())),this.connectionCount+=1,this.lastCloseReason=null},e.onerror=n=>{this.transitionChunkBuffer=null;const r=n.message;r&&this.logger.log(`WebSocket error message: ${r}`)},e.onmessage=n=>{this.resetServerInactivityTimeout();const r=n.data.length;let s=$y(JSON.parse(n.data));if(this._logVerbose(`received ws message with type ${s.type}`),s.type==="Ping")return;if(s.type==="TransitionChunk"){const o=this.assembleTransition(s);if(!o)return;s=o,this._logVerbose(`assembled full ws message of type ${s.type}`)}this.transitionChunkBuffer!==null&&(this.transitionChunkBuffer=null,this.logger.log(`Received unexpected ${s.type} while buffering TransitionChunks`)),s.type==="Transition"&&this.reportLargeTransition({messageLength:r,transition:s}),this.onMessage(s).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())},e.onclose=n=>{if(this._logVerbose("begin ws.onclose"),this.transitionChunkBuffer=null,this.lastCloseReason===null&&(this.lastCloseReason=n.reason||`closed with code ${n.code}`),n.code!==BT&&n.code!==qT&&n.code!==UT&&n.code!==VT){let s=`WebSocket closed with code ${n.code}`;n.reason&&(s+=`: ${n.reason}`),this.logger.log(s),this.onServerDisconnectError&&n.reason&&this.onServerDisconnectError(s)}const r=jT(n.reason);this.scheduleReconnect(r)}}socketState(){return this.socket.state}sendMessage(e){const n={type:e.type,...e.type==="Authenticate"&&e.tokenType==="User"?{value:`...${e.value.slice(-7)}`}:{}};if(this.socket.state==="ready"&&this.socket.paused==="no"){const r=NT(e),s=JSON.stringify(r);let i=!1;try{this.socket.ws.send(s),i=!0}catch(o){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${o}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`${i?"sent":"failed to send"} message with type ${e.type}: ${JSON.stringify(n)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(n)}`),!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(e){this.socket={state:"disconnected"};const n=this.nextBackoff(e);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${Math.round(n)}ms`),setTimeout(()=>this.connect(),n)}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect("client");return}default:this.socket}}close(){switch(this.transitionChunkBuffer=null,this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return e.onmessage=n=>{this._logVerbose("Ignoring message received after close")},new Promise(n=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),n()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws;e.onmessage=r=>{this._logVerbose("Ignoring message received after close")};const n=new Promise(r=>{e.onclose=()=>{r()}});return e.close(),n}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.setSocketState({state:"terminated"}),e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:la()})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:this.socket.state==="ready",hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(e){const r=(e==="client"?100:e==="Unknown"?this.defaultInitialBackoff:fS[e].timeout)*Math.pow(2,this.retries);this.retries+=1;const s=Math.min(r,this.maxBackoff),i=s*(Math.random()-.5);return s+i}reportLargeTransition({transition:e,messageLength:n}){if(e.clientClockSkew===void 0||e.serverTs===void 0)return;const r=la()-e.clientClockSkew-e.serverTs/1e6,s=`${Math.round(r)}ms`,i=`${Math.round(n/1e4)/100}MB`,o=n/(r/1e3),c=`${Math.round(o/1e4)/100}MB per second`;this._logVerbose(`received ${i} transition in ${s} at ${c}`),n>2e7?this.logger.log(`received query results totaling more that 20MB (${i}) which will take a long time to download on slower connections`):r>2e4&&this.logger.log(`received query results totaling ${i} which took more than 20s to arrive (${s})`),this.debug&&this.sendMessage({type:"Event",eventType:"ClientReceivedTransition",event:{transitionTransitTime:r,messageLength:n}})}}function WT(){return zT()}function zT(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}class ao extends Error{}ao.prototype.name="InvalidTokenError";function HT(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,n)=>{let r=n.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function QT(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return HT(e)}catch{return atob(e)}}function dS(t,e){if(typeof t!="string")throw new ao("Invalid token specified: must be a string");e||(e={});const n=e.header===!0?0:1,r=t.split(".")[n];if(typeof r!="string")throw new ao(`Invalid token specified: missing part #${n+1}`);let s;try{s=QT(r)}catch(i){throw new ao(`Invalid token specified: invalid base64 for part #${n+1} (${i.message})`)}try{return JSON.parse(s)}catch(i){throw new ao(`Invalid token specified: invalid json for part #${n+1} (${i.message})`)}}var GT=Object.defineProperty,JT=(t,e,n)=>e in t?GT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Zt=(t,e,n)=>JT(t,typeof e!="symbol"?e+"":e,n);const YT=480*60*60*1e3,qy=2;class XT{constructor(e,n,r){Zt(this,"authState",{state:"noAuth"}),Zt(this,"configVersion",0),Zt(this,"syncState"),Zt(this,"authenticate"),Zt(this,"stopSocket"),Zt(this,"tryRestartSocket"),Zt(this,"pauseSocket"),Zt(this,"resumeSocket"),Zt(this,"clearAuth"),Zt(this,"logger"),Zt(this,"refreshTokenLeewaySeconds"),Zt(this,"tokenConfirmationAttempts",0),this.syncState=e,this.authenticate=n.authenticate,this.stopSocket=n.stopSocket,this.tryRestartSocket=n.tryRestartSocket,this.pauseSocket=n.pauseSocket,this.resumeSocket=n.resumeSocket,this.clearAuth=n.clearAuth,this.logger=r.logger,this.refreshTokenLeewaySeconds=r.refreshTokenLeewaySeconds}async setConfig(e,n){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const r=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});r.isFromOutdatedConfig||(r.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:n},hasRetried:!1}),this.authenticate(r.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:n}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){if(e.authUpdateAttempted===!1&&(this.authState.state==="waitingForServerConfirmationOfFreshToken"||this.authState.state==="waitingForServerConfirmationOfCachedToken")){this._logVerbose("ignoring non-auth token expired error");return}const{baseVersion:n}=e;if(!this.syncState.isCurrentOrNewerAuthVersion(n+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this._logVerbose(`attempting to reauthenticate: ${e.error}`),this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"&&this.tokenConfirmationAttempts>=qy){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${qy-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();const n=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});n.isFromOutdatedConfig||(n.value&&this.syncState.isNewAuth(n.value)?(this.authenticate(n.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:n.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const n=this.decodeToken(e);if(!n){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:r,exp:s}=n;if(!r||!s){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const i=s-r;if(i<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(YT,(i-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${i}s`),o=0);const c=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:c,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,n){const r=++this.configVersion;this._logVerbose(`fetching token with config version ${r}`);const s=await e(n);return this.configVersion!==r?(this._logVerbose(`stale config version, expected ${r}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:s}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){const n=e.state==="waitingForServerConfirmationOfFreshToken"?{hadAuth:e.hadAuth,state:e.state,token:`...${e.token.slice(-7)}`}:{state:e.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(n)}`),e.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0;break}this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return dS(e)}catch(n){return this._logVerbose(`Error decoding token: ${n instanceof Error?n.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const ZT=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function eA(t,e){const n={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(t,{detail:n})}function tA(t){let e=t.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:t.startTime}}function nA(t){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const n of ZT){const r=performance.getEntriesByName(n).filter(s=>s.entryType==="mark").filter(s=>s.detail.sessionId===t);e.push(...r)}return e.map(tA)}var rA=Object.defineProperty,sA=(t,e,n)=>e in t?rA(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,rt=(t,e,n)=>sA(t,typeof e!="symbol"?e+"":e,n);class iA{constructor(e,n,r){if(rt(this,"address"),rt(this,"state"),rt(this,"requestManager"),rt(this,"webSocketManager"),rt(this,"authenticationManager"),rt(this,"remoteQuerySet"),rt(this,"optimisticQueryResults"),rt(this,"_transitionHandlerCounter",0),rt(this,"_nextRequestId"),rt(this,"_onTransitionFns",new Map),rt(this,"_sessionId"),rt(this,"firstMessageReceived",!1),rt(this,"debug"),rt(this,"logger"),rt(this,"maxObservedTimestamp"),rt(this,"connectionStateSubscribers",new Map),rt(this,"nextConnectionStateSubscriberId",0),rt(this,"_lastPublishedConnectionState"),rt(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{const f=this.connectionState();if(JSON.stringify(f)!==JSON.stringify(this._lastPublishedConnectionState)){this._lastPublishedConnectionState=f;for(const p of this.connectionStateSubscribers.values())p(f)}})}),rt(this,"mark",f=>{this.debug&&eA(f,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");r?.skipConvexDeploymentUrlCheck!==!0&&rS(e),r={...r};const s=r.authRefreshTokenLeewaySeconds??2;let i=r.webSocketConstructor;if(!i&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");i=i||WebSocket,this.debug=r.reportDebugInfoToConvex??!1,this.address=e,this.logger=r.logger===!1?dT({verbose:r.verbose??!1}):r.logger!==!0&&r.logger?r.logger:fT({verbose:r.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const c=e.substring(o+3),a=e.substring(0,o);let u;if(a==="http")u="ws";else if(a==="https")u="wss";else throw new Error(`Unknown parent protocol ${a}`);const h=`${u}://${c}/api/${Ay}/sync`;this.state=new wT,this.remoteQuerySet=new Py(f=>this.state.queryPath(f),this.logger),this.requestManager=new ST(this.logger,this.markConnectionStateDirty);const l=()=>{this.webSocketManager.pause(),this.state.pause()};this.authenticationManager=new XT(this.state,{authenticate:f=>{const p=this.state.setAuth(f);return this.webSocketManager.sendMessage(p),p.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:l,resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:s}),this.optimisticQueryResults=new AT,this.addOnTransitionHandler(f=>{n(f.queries.map(p=>p.token))}),this._nextRequestId=0,this._sessionId=WT();const{unsavedChangesWarning:d}=r;if(typeof window>"u"||typeof window.addEventListener>"u"){if(d===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else d!==!1&&window.addEventListener("beforeunload",f=>{if(this.requestManager.hasIncompleteRequests()){f.preventDefault();const p="Are you sure you want to leave? Your changes may not be saved.";return(f||window.event).returnValue=p,p}});this.webSocketManager=new KT(h,{onOpen:f=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...f,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const p=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new Py(m=>this.state.queryPath(m),this.logger);const[w,g]=this.state.restart(p);g&&this.webSocketManager.sendMessage(g),this.webSocketManager.sendMessage(w);for(const m of this.requestManager.restart())this.webSocketManager.sendMessage(m)},onResume:()=>{const[f,p]=this.state.resume();p&&this.webSocketManager.sendMessage(p),f&&this.webSocketManager.sendMessage(f);for(const w of this.requestManager.resume())this.webSocketManager.sendMessage(w)},onMessage:f=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),f.type){case"Transition":{this.observedTimestamp(f.endVersion.ts),this.authenticationManager.onTransition(f),this.remoteQuerySet.transition(f),this.state.transition(f);const p=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(p);break}case"MutationResponse":{f.success&&this.observedTimestamp(f.ts);const p=this.requestManager.onResponse(f);p!==null&&this.notifyOnQueryResultChanges(new Map([[p.requestId,p.result]]));break}case"ActionResponse":{this.requestManager.onResponse(f);break}case"AuthError":{this.authenticationManager.onAuthError(f);break}case"FatalError":{const p=pT(this.logger,f.error);throw this.webSocketManager.terminate(),p}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:r.onServerDisconnectError},i,this.logger,this.markConnectionStateDirty,this.debug),this.mark("convexClientConstructed"),r.expectAuth&&l()}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const n=this.remoteQuerySet.remoteQueryResults(),r=new Map;for(const[i,o]of n){const c=this.state.queryToken(i);if(c!==null){const a={result:o,udfPath:this.state.queryPath(i),args:this.state.queryArgs(i)};r.set(c,a)}}const s=this.optimisticQueryResults.ingestQueryResultsFromServer(r,new Set(e.keys()));this.handleTransition({queries:s.map(i=>{const o=this.optimisticQueryResults.rawQueryResult(i);return{token:i,modification:{kind:"Updated",result:o}}}),reflectedMutations:Array.from(e).map(([i,o])=>({requestId:i,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const n of this._onTransitionFns.values())n(e)}addOnTransitionHandler(e){const n=this._transitionHandlerCounter++;return this._onTransitionFns.set(n,e),()=>this._onTransitionFns.delete(n)}getCurrentAuthClaims(){const e=this.state.getAuth();let n={};if(e&&e.tokenType==="User")try{n=e?dS(e.value):{}}catch{n={}}else return;return{token:e.value,decoded:n}}setAuth(e,n){this.authenticationManager.setConfig(e,n)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,n){const r=this.state.setAdminAuth(e,n);this.webSocketManager.sendMessage(r)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,n,r){const s=hr(n),{modification:i,queryToken:o,unsubscribe:c}=this.state.subscribe(e,s,r?.journal,r?.componentPath);return i!==null&&this.webSocketManager.sendMessage(i),{queryToken:o,unsubscribe:()=>{const a=c();a&&this.webSocketManager.sendMessage(a)}}}localQueryResult(e,n){const r=hr(n),s=Lr(e,r);return this.optimisticQueryResults.queryResult(s)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,n){const r=hr(n),s=Lr(e,r);return this.optimisticQueryResults.queryLogs(s)}queryJournal(e,n){const r=hr(n),s=Lr(e,r);return this.state.queryJournal(s)}connectionState(){const e=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:e.isConnected,hasEverConnected:e.hasEverConnected,connectionCount:e.connectionCount,connectionRetries:e.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(e){const n=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(n,e),()=>{this.connectionStateSubscribers.delete(n)}}async mutation(e,n,r){const s=await this.mutationInternal(e,n,r);if(!s.success)throw s.errorData!==void 0?qf(s,new Bf(Is("mutation",e,s))):new Error(Is("mutation",e,s));return s.value}async mutationInternal(e,n,r,s){const{mutationPromise:i}=this.enqueueMutation(e,n,r,s);return i}enqueueMutation(e,n,r,s){const i=hr(n);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,r!==void 0){const h=r.optimisticUpdate;if(h!==void 0){const l=p=>{h(p,i)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},f=this.optimisticQueryResults.applyOptimisticUpdate(l,o).map(p=>{const w=this.localQueryResultByToken(p);return{token:p,modification:{kind:"Updated",result:w===void 0?void 0:{success:!0,value:w,logLines:[]}}}});this.handleTransition({queries:f,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const c={type:"Mutation",requestId:o,udfPath:e,componentPath:s,args:[Kr(i)]},a=this.webSocketManager.sendMessage(c),u=this.requestManager.request(c,a);return{requestId:o,mutationPromise:u}}async action(e,n){const r=await this.actionInternal(e,n);if(!r.success)throw r.errorData!==void 0?qf(r,new Bf(Is("action",e,r))):new Error(Is("action",e,r));return r.value}async actionInternal(e,n,r){const s=hr(n),i=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:i,udfPath:e,componentPath:r,args:[Kr(s)]},c=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,c)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=nA(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const n=`${this.address}/api/debug_event`;fetch(n,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${Ay}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(r=>{r.ok||this.logger.warn("Analytics request failed with response:",r.body)}).catch(r=>{this.logger.warn("Analytics response failed with error:",r)})}}function $l(t){if(typeof t!="object"||t===null||!Array.isArray(t.page)||typeof t.isDone!="boolean"||typeof t.continueCursor!="string")throw new Error(`Not a valid paginated query result: ${t?.toString()}`);return t}var oA=Object.defineProperty,cA=(t,e,n)=>e in t?oA(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Uy=(t,e,n)=>cA(t,typeof e!="symbol"?e+"":e,n);class aA{constructor(e,n){this.client=e,this.onTransition=n,Uy(this,"paginatedQuerySet",new Map),Uy(this,"lastTransitionTs"),this.lastTransitionTs=Nt.fromNumber(0),this.client.addOnTransitionHandler(r=>this.onBaseTransition(r))}subscribe(e,n,r){const s=Wr(e),i=Dy(s,n,r),o=()=>this.removePaginatedQuerySubscriber(i),c=this.paginatedQuerySet.get(i);return c?(c.numSubscribers+=1,{paginatedQueryToken:i,unsubscribe:o}):(this.paginatedQuerySet.set(i,{token:i,canonicalizedUdfPath:s,args:n,numSubscribers:1,options:{initialNumItems:r.initialNumItems},nextPageKey:0,pageKeys:[],pageKeyToQuery:new Map,ongoingSplits:new Map,skip:!1,id:r.id}),this.addPageToPaginatedQuery(i,null,r.initialNumItems),{paginatedQueryToken:i,unsubscribe:o})}localQueryResult(e,n,r){const s=Wr(e),i=Dy(s,n,r);return this.localQueryResultByToken(i)}localQueryResultByToken(e){const n=this.paginatedQuerySet.get(e);if(!n)return;const r=this.activePageQueryTokens(n);if(r.length===0)return{results:[],status:"LoadingFirstPage",loadMore:a=>this.loadMoreOfPaginatedQuery(e,a)};let s=[],i=!1,o=!1;for(const a of r){const u=this.client.localQueryResultByToken(a);if(u===void 0){i=!0,o=!1;continue}const h=$l(u);s=s.concat(h.page),o=!!h.isDone}let c;return i?c=s.length===0?"LoadingFirstPage":"LoadingMore":o?c="Exhausted":c="CanLoadMore",{results:s,status:c,loadMore:a=>this.loadMoreOfPaginatedQuery(e,a)}}onBaseTransition(e){const n=e.queries.map(o=>o.token),r=this.queriesContainingTokens(n);let s=[];r.length>0&&(this.processPaginatedQuerySplits(r,o=>this.client.localQueryResultByToken(o)),s=r.map(o=>({token:o,modification:{kind:"Updated",result:this.localQueryResultByToken(o)}})));const i={...e,paginatedQueries:s};this.onTransition(i)}loadMoreOfPaginatedQuery(e,n){this.mustGetPaginatedQuery(e);const r=this.queryTokenForLastPageOfPaginatedQuery(e),s=this.client.localQueryResultByToken(r);if(!s)return!1;const i=$l(s);if(i.isDone)return!1;this.addPageToPaginatedQuery(e,i.continueCursor,n);const o={timestamp:this.lastTransitionTs,reflectedMutations:[],queries:[],paginatedQueries:[{token:e,modification:{kind:"Updated",result:this.localQueryResultByToken(e)}}]};return this.onTransition(o),!0}queriesContainingTokens(e){if(e.length===0)return[];const n=[],r=new Set(e);for(const[s,i]of this.paginatedQuerySet)for(const o of this.allQueryTokens(i))if(r.has(o)){n.push(s);break}return n}processPaginatedQuerySplits(e,n){for(const r of e){const s=this.mustGetPaginatedQuery(r),{ongoingSplits:i,pageKeyToQuery:o,pageKeys:c}=s;for(const[a,[u,h]]of i)n(o.get(u).queryToken)!==void 0&&n(o.get(h).queryToken)!==void 0&&this.completePaginatedQuerySplit(s,a,u,h);for(const a of c){if(i.has(a))continue;const u=o.get(a).queryToken,h=n(u);if(!h)continue;const l=$l(h);l.splitCursor&&(l.pageStatus==="SplitRecommended"||l.pageStatus==="SplitRequired"||l.page.length>s.options.initialNumItems*2)&&this.splitPaginatedQueryPage(s,a,l.splitCursor,l.continueCursor)}}}splitPaginatedQueryPage(e,n,r,s){const i=e.nextPageKey++,o=e.nextPageKey++,c={cursor:s,numItems:e.options.initialNumItems,id:e.id},a=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...c,cursor:null,endCursor:r}});e.pageKeyToQuery.set(i,a);const u=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...c,cursor:r,endCursor:s}});e.pageKeyToQuery.set(o,u),e.ongoingSplits.set(n,[i,o])}addPageToPaginatedQuery(e,n,r){const s=this.mustGetPaginatedQuery(e),i=s.nextPageKey++,o={cursor:n,numItems:r,id:s.id},c={...s.args,paginationOpts:o},a=this.client.subscribe(s.canonicalizedUdfPath,c);return s.pageKeys.push(i),s.pageKeyToQuery.set(i,a),a}removePaginatedQuerySubscriber(e){const n=this.paginatedQuerySet.get(e);if(n&&(n.numSubscribers-=1,!(n.numSubscribers>0))){for(const r of n.pageKeyToQuery.values())r.unsubscribe();this.paginatedQuerySet.delete(e)}}completePaginatedQuerySplit(e,n,r,s){const i=e.pageKeyToQuery.get(n);e.pageKeyToQuery.delete(n);const o=e.pageKeys.indexOf(n);e.pageKeys.splice(o,1,r,s),e.ongoingSplits.delete(n),i.unsubscribe()}activePageQueryTokens(e){return e.pageKeys.map(n=>e.pageKeyToQuery.get(n).queryToken)}allQueryTokens(e){return Array.from(e.pageKeyToQuery.values()).map(n=>n.queryToken)}queryTokenForLastPageOfPaginatedQuery(e){const n=this.mustGetPaginatedQuery(e),r=n.pageKeys[n.pageKeys.length-1];if(r===void 0)throw new Error(`No pages for paginated query ${e}`);return n.pageKeyToQuery.get(r).queryToken}mustGetPaginatedQuery(e){const n=this.paginatedQuerySet.get(e);if(!n)throw new Error("paginated query no longer exists for token "+e);return n}}var uA=Object.defineProperty,lA=(t,e,n)=>e in t?uA(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,_s=(t,e,n)=>lA(t,typeof e!="symbol"?e+"":e,n);class hA{constructor(e,n={}){_s(this,"listeners"),_s(this,"_client"),_s(this,"_paginatedClient"),_s(this,"callNewListenersWithCurrentValuesTimer"),_s(this,"_closed"),_s(this,"_disabled"),n.skipConvexDeploymentUrlCheck!==!0&&rS(e);const{disabled:r,...s}=n;this._closed=!1,this._disabled=!!r,typeof window>"u"&&!("unsavedChangesWarning"in s)&&(s.unsavedChangesWarning=!1),this.disabled||(this._client=new iA(e,()=>{},s),this._paginatedClient=new aA(this._client,i=>this._transition(i))),this.listeners=new Set}get closed(){return this._closed}get client(){if(this._client)return this._client;throw new Error("ConvexClient is disabled")}get paginatedClient(){if(this._paginatedClient)return this._paginatedClient;throw new Error("ConvexClient is disabled")}get disabled(){return this._disabled}onUpdate(e,n,r,s){if(this.disabled)return this.createDisabledUnsubscribe();const{queryToken:i,unsubscribe:o}=this.client.subscribe(Fn(e),n),c={queryToken:i,callback:r,onError:s,unsubscribe:o,hasEverRun:!1,query:e,args:n,paginationOptions:void 0};this.listeners.add(c),this.queryResultReady(i)&&this.callNewListenersWithCurrentValuesTimer===void 0&&(this.callNewListenersWithCurrentValuesTimer=setTimeout(()=>this.callNewListenersWithCurrentValues(),0));const a={unsubscribe:()=>{this.closed||(this.listeners.delete(c),o())},getCurrentValue:()=>this.client.localQueryResultByToken(i),getQueryLogs:()=>this.client.localQueryLogs(i)},u=a.unsubscribe;return Object.assign(u,a),u}onPaginatedUpdate_experimental(e,n,r,s,i){if(this.disabled)return this.createDisabledUnsubscribe();const o={initialNumItems:r.initialNumItems,id:-1},{paginatedQueryToken:c,unsubscribe:a}=this.paginatedClient.subscribe(Fn(e),n,o),u={queryToken:c,callback:s,onError:i,unsubscribe:a,hasEverRun:!1,query:e,args:n,paginationOptions:o};this.listeners.add(u),this.paginatedClient.localQueryResultByToken(c)&&this.callNewListenersWithCurrentValuesTimer===void 0&&(this.callNewListenersWithCurrentValuesTimer=setTimeout(()=>this.callNewListenersWithCurrentValues(),0));const h={unsubscribe:()=>{this.closed||(this.listeners.delete(u),a())},getCurrentValue:()=>this.paginatedClient.localQueryResult(Fn(e),n,o),getQueryLogs:()=>[]},l=h.unsubscribe;return Object.assign(l,h),l}callNewListenersWithCurrentValues(){this.callNewListenersWithCurrentValuesTimer=void 0,this._transition({queries:[],paginatedQueries:[]},!0)}queryResultReady(e){return this.client.hasLocalQueryResultByToken(e)}createDisabledUnsubscribe(){const e=()=>{};return Object.assign(e,{unsubscribe:e,getCurrentValue:()=>{},getQueryLogs:()=>{}}),e}async close(){if(!this.disabled)return this.listeners.clear(),this._closed=!0,this._paginatedClient&&(this._paginatedClient=void 0),this.client.close()}getAuth(){if(!this.disabled)return this.client.getCurrentAuthClaims()}setAuth(e,n){this.disabled||this.client.setAuth(e,n??(()=>{}))}setAdminAuth(e,n){if(this.closed)throw new Error("ConvexClient has already been closed.");this.disabled||this.client.setAdminAuth(e,n)}_transition({queries:e,paginatedQueries:n},r=!1){const s=[...e.map(i=>i.token),...n.map(i=>i.token)];for(const i of this.listeners){const{callback:o,queryToken:c,onError:a,hasEverRun:u}=i,h=gT(c),l=h?!!this.paginatedClient.localQueryResultByToken(c):this.client.hasLocalQueryResultByToken(c);if(s.includes(c)||r&&!u&&l){i.hasEverRun=!0;let d;try{h?d=this.paginatedClient.localQueryResultByToken(c):d=this.client.localQueryResultByToken(c)}catch(f){if(!(f instanceof Error))throw f;a?a(f,"Second argument to onUpdate onError is reserved for later use"):Promise.reject(f);continue}o(d,"Second argument to onUpdate callback is reserved for later use")}}}async mutation(e,n,r){if(this.disabled)throw new Error("ConvexClient is disabled");return await this.client.mutation(Fn(e),n,r)}async action(e,n){if(this.disabled)throw new Error("ConvexClient is disabled");return await this.client.action(Fn(e),n)}async query(e,n){if(this.disabled)throw new Error("ConvexClient is disabled");const r=this.client.localQueryResult(Fn(e),n);return r!==void 0?Promise.resolve(r):new Promise((s,i)=>{const{unsubscribe:o}=this.onUpdate(e,n,c=>{o(),s(c)},c=>{o(),i(c)})})}connectionState(){if(this.disabled)throw new Error("ConvexClient is disabled");return this.client.connectionState()}subscribeToConnectionState(e){return this.disabled?()=>{}:this.client.subscribeToConnectionState(e)}}function pS(t,e){const n={get(r,s){if(typeof s=="string"){const i=[...e,s];return pS(t,i)}else if(s===lS){if(e.length<1){const i=[t,...e].join(".");throw new Error(`API path is expected to be of the form \`${t}.childComponent.functionName\`. Found: \`${i}\``)}return"_reference/childComponent/"+e.join("/")}else return}};return new Proxy({},n)}const fA=()=>pS("components",[]),dA="https://aware-barracuda-102.convex.cloud";let Bl=null;function pA(){return Bl||(Bl=new hA(dA)),Bl}class Si{}class G3 extends Si{constructor(e,n){super(),this.collection=e,this.alias=n,this.type="collectionRef"}}class J3 extends Si{constructor(e,n){super(),this.query=e,this.alias=n,this.type="queryRef"}}class zs extends Si{constructor(e){super(),this.path=e,this.type="ref"}}class $n extends Si{constructor(e){super(),this.value=e,this.type="val"}}class nr extends Si{constructor(e,n){super(),this.name=e,this.args=n,this.type="func"}}class gA extends Si{constructor(e,n){super(),this.name=e,this.args=n,this.type="agg"}}function Y3(t){return t instanceof gA||t instanceof nr||t instanceof zs||t instanceof $n}function X3(t){return typeof t=="object"&&"expression"in t?t.expression:t}function Vy(t){return typeof t=="object"&&"expression"in t?t.expression:t}function Z3(t){return typeof t=="object"&&"expression"in t&&t.residual===!0}function eW(t){return{expression:t,residual:!0}}function yA(t,e){if(t.from.alias===e)return t.from;for(const n of t.join||[])if(n.from.alias===e)return n.from}function Oa(t,e,n){if(e.path.length!==0){if(e.path.length===1){const r=e.path[0];if(t.select){const s=t.select[r];if(s&&s.type==="ref")return Oa(t,s,n)}return{collection:n,path:[r]}}if(e.path.length>1){const[r,...s]=e.path,i=yA(t,r);return i?i.type==="queryRef"?Oa(i.query,new zs(s),n):{collection:i.collection,path:s}:void 0}}}class cn extends Error{constructor(e){super(e),this.name="TanStackDBError"}}class jy extends cn{constructor(e,n,r){const s=`${e==="insert"?"Insert":"Update"} validation failed: ${n.map(i=>`
- ${i.message} - path: ${i.path}`).join("")}`;super(r||s),this.name="SchemaValidationError",this.type=e,this.issues=n}}class sc extends cn{constructor(e){super(e),this.name="CollectionConfigurationError"}}class mA extends sc{constructor(){super("Collection requires a config")}}class wA extends sc{constructor(){super("Collection requires a sync config")}}class bA extends sc{constructor(){super("Schema must implement the standard-schema interface")}}class Ky extends sc{constructor(){super("Schema validation must be synchronous")}}class ic extends cn{constructor(e){super(e),this.name="CollectionStateError"}}class _A extends ic{constructor(e,n){super(`Cannot perform ${e} on collection "${n}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}}class SA extends ic{constructor(e,n,r){super(`Invalid collection status transition from "${e}" to "${n}" for collection "${r}"`)}}class EA extends ic{constructor(){super("Collection is in error state")}}class vA extends ic{constructor(){super("Active subscribers count is negative - this should never happen")}}class xn extends cn{constructor(e){super(e),this.name="CollectionOperationError"}}class kA extends xn{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}}class xA extends xn{constructor(e,n){const r=e===null?"null":typeof e;super(`getKey returned an invalid key type. Expected string or number, but got ${r}: ${JSON.stringify(e)}. Item: ${JSON.stringify(n)}`)}}class IA extends xn{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}}class TA extends xn{constructor(e,n,r){const s=`Cannot insert document with key "${e}" from sync because it already exists in the collection "${n}"`;r?.hasCustomGetKey&&r.hasJoins?super(`${s}. This collection uses a custom getKey with joined queries. Joined queries can produce multiple rows with the same key when relationships are not 1:1. Consider: (1) using a composite key in your getKey function (e.g., \`\${item.key1}-\${item.key2}\`), (2) ensuring your join produces unique rows per key, or (3) removing the custom getKey to use the default composite key behavior.`):super(s)}}class AA extends xn{constructor(){super("The first argument to update is missing")}}class RA extends xn{constructor(){super("No keys were passed to update")}}class CA extends xn{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}}class OA extends xn{constructor(e,n){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${n}". Please delete the old item and create a new one if a key change is necessary.`)}}class MA extends xn{constructor(){super("No keys were passed to delete")}}class LA extends xn{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}}class ap extends cn{constructor(e){super(e),this.name="MissingHandlerError"}}class DA extends ap{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}}class FA extends ap{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}}class NA extends ap{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}}class Er extends cn{constructor(e){super(e),this.name="TransactionError"}}class PA extends Er{constructor(){super("mutationFn is required when creating a transaction")}}class $A extends Er{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}}class BA extends Er{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}}class qA extends Er{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}}class Wy extends Er{constructor(){super("No pending sync transaction to write to")}}class zy extends Er{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}}class UA extends Er{constructor(){super("No pending sync transaction to commit")}}class VA extends Er{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}}class Ei extends cn{constructor(e){super(e),this.name="QueryBuilderError"}}class tW extends Ei{constructor(e){super(`Only one source is allowed in the ${e}`)}}class nW extends Ei{constructor(e){super(`A sub query passed to a ${e} must have a from clause itself`)}}class rW extends Ei{constructor(e){super(`Invalid source for live query: The value provided for alias "${e}" is not a Collection or subquery. Live queries only accept Collection instances or subqueries. Please ensure you're passing a valid Collection or QueryBuilder, not a plain array or other data type.`)}}class sW extends Ei{constructor(e,n){super(`Invalid source for ${e}: Expected an object with a single key-value pair like { alias: collection }. For example: .from({ todos: todosCollection }). Got: ${n}`)}}class iW extends Ei{constructor(){super("Join condition must be an equality expression")}}class oW extends Ei{constructor(){super("Query must have a from clause")}}class Jt extends cn{constructor(e){super(e),this.name="QueryCompilationError"}}class cW extends Jt{constructor(){super("DISTINCT requires a SELECT clause.")}}class aW extends Jt{constructor(){super("HAVING clause requires GROUP BY clause")}}class uW extends Jt{constructor(){super("LIMIT and OFFSET require an ORDER BY clause to ensure deterministic results")}}class lW extends Jt{constructor(e,n,r){const s=n?`alias "${e}" (collection "${n}")`:`collection "${e}"`,i=r?.length?`. Available keys: ${r.join(", ")}`:"";super(`Input for ${s} not found in inputs map${i}`)}}class hW extends Jt{constructor(e,n){super(`Subquery uses alias "${e}" which is already used in the parent query. Each alias must be unique across parent and subquery contexts. Parent query aliases: ${n.join(", ")}. Please rename "${e}" in either the parent query or subquery to avoid conflicts.`)}}class fW extends Jt{constructor(e){super(`Unsupported FROM type: ${e}`)}}class jA extends Jt{constructor(e){super(`Unknown expression type: ${e}`)}}class KA extends Jt{constructor(){super("Reference path cannot be empty")}}class WA extends Jt{constructor(e){super(`Unknown function: ${e}`)}}class dW extends Jt{constructor(e){super(`Collection "${e}" not found during compilation of join`)}}class as extends cn{constructor(e){super(e),this.name="JoinError"}}class pW extends as{constructor(e){super(`Unsupported join type: ${e}`)}}class gW extends as{constructor(e){super(`Invalid join condition: both expressions refer to the same source "${e}"`)}}class yW extends as{constructor(){super("Invalid join condition: expressions must reference source aliases")}}class mW extends as{constructor(e){super(`Invalid join condition: left expression refers to an unavailable source "${e}"`)}}class wW extends as{constructor(e){super(`Invalid join condition: right expression does not refer to the joined source "${e}"`)}}class bW extends as{constructor(){super("Invalid join condition")}}class _W extends as{constructor(e){super(`Unsupported join source type: ${e}`)}}class xu extends cn{constructor(e){super(e),this.name="GroupByError"}}class zA extends xu{constructor(e){super(`Non-aggregate expression '${e}' in SELECT must also appear in GROUP BY clause`)}}class HA extends xu{constructor(e){super(`Unsupported aggregate function: ${e}`)}}class QA extends xu{constructor(e){super(`Aggregate function in HAVING clause must also be in SELECT clause: ${e}`)}}class GA extends xu{constructor(e){super(`Unknown expression type in HAVING clause: ${e}`)}}class Hy extends cn{constructor(e,n){const r=n instanceof Error?n.message:String(n);super(`Collection "${e}" sync cleanup function threw an error: ${r}`),this.name="SyncCleanupError"}}class JA extends cn{constructor(e){super(e),this.name="QueryOptimizerError"}}class SW extends JA{constructor(){super("Cannot combine empty expression list")}}class EW extends Jt{constructor(e,n,r,s){super(`Internal error: subscription for alias '${e}' (remapped from '${n}', collection '${r}') is missing in join pipeline. Available aliases: ${s.join(", ")}. This indicates a bug in alias tracking.`)}}class vW extends Jt{constructor(e){super(`Internal error: compiler returned aliases without inputs: ${e.join(", ")}. This indicates a bug in query compilation. Please report this issue.`)}}class kW extends Jt{constructor(){super("setWindow() can only be called on collections with an ORDER BY clause. Add .orderBy() to your query to enable window movement.")}}const ql=new WeakMap;let YA=1;function Qy(t){if(ql.has(t))return ql.get(t);const e=YA++;return ql.set(t,e),e}const up=(t,e,n)=>{const{nulls:r}=n;if(t==null&&e==null)return 0;if(t==null)return r==="first"?-1:1;if(e==null)return r==="first"?1:-1;if(typeof t=="string"&&typeof e=="string"&&n.stringSort==="locale")return t.localeCompare(e,n.locale,n.localeOptions);if(Array.isArray(t)&&Array.isArray(e)){for(let o=0;o<Math.min(t.length,e.length);o++){const c=up(t[o],e[o],n);if(c!==0)return c}return t.length-e.length}if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();const s=typeof t=="object",i=typeof e=="object";if(s||i){if(s&&i){const o=Qy(t),c=Qy(e);return o-c}if(s)return 1;if(i)return-1}return t<e?-1:t>e?1:0},XA=(t,e,n)=>up(e,t,{...n,nulls:n.nulls==="first"?"last":"first"});function Ma(t){return(e,n)=>t.direction==="asc"?up(e,n,t):XA(e,n,t)}const Uf=Ma({direction:"asc",nulls:"first",stringSort:"locale"});function ZA(t,e){if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.byteLength;n++)if(t[n]!==e[n])return!1;return!0}const eR=128;function Dn(t){return t instanceof Date?t.getTime():(typeof Buffer<"u"&&t instanceof Buffer||t instanceof Uint8Array)&&t.byteLength<=eR?`__u8__${Array.from(t).join(",")}`:t}function tR(t,e){if(t===e)return!0;const n=typeof Buffer<"u"&&t instanceof Buffer||t instanceof Uint8Array,r=typeof Buffer<"u"&&e instanceof Buffer||e instanceof Uint8Array;return n&&r?ZA(t,e):!1}function ft(t){return t==null}function ha(t){return t===!0}function gr(t,e=!1){return hp(t,e)}function lp(t){return hp(t,!0)}function hp(t,e){switch(t.type){case"val":{const n=t.value;return()=>n}case"ref":return e?rR(t):nR(t);case"func":return sR(t,e);default:throw new jA(t.type)}}function nR(t){const[e,...n]=t.path;if(!e)throw new KA;if(n.length===0)return r=>r[e];if(n.length===1){const r=n[0];return s=>s[e]?.[r]}else return r=>{const s=r[e];if(s===void 0)return;let i=s;for(const o of n){if(i==null)return i;i=i[o]}return i}}function rR(t){const e=t.path;return n=>{let r=n;for(const s of e){if(r==null)return r;r=r[s]}return r}}function sR(t,e){const n=t.args.map(r=>hp(r,e));switch(t.name){case"eq":{const r=n[0],s=n[1];return i=>{const o=Dn(r(i)),c=Dn(s(i));return ft(o)||ft(c)?null:tR(o,c)}}case"gt":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)||ft(c)?null:o>c}}case"gte":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)||ft(c)?null:o>=c}}case"lt":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)||ft(c)?null:o<c}}case"lte":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)||ft(c)?null:o<=c}}case"and":return r=>{let s=!1;for(const i of n){const o=i(r);if(o===!1)return!1;ft(o)&&(s=!0)}return s?null:!0};case"or":return r=>{let s=!1;for(const i of n){const o=i(r);if(o===!0)return!0;ft(o)&&(s=!0)}return s?null:!1};case"not":{const r=n[0];return s=>{const i=r(s);return ft(i)?null:!i}}case"in":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)?null:Array.isArray(c)?c.includes(o):!1}}case"like":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)||ft(c)?null:Gy(o,c,!1)}}case"ilike":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return ft(o)||ft(c)?null:Gy(o,c,!0)}}case"upper":{const r=n[0];return s=>{const i=r(s);return typeof i=="string"?i.toUpperCase():i}}case"lower":{const r=n[0];return s=>{const i=r(s);return typeof i=="string"?i.toLowerCase():i}}case"length":{const r=n[0];return s=>{const i=r(s);return typeof i=="string"||Array.isArray(i)?i.length:0}}case"concat":return r=>n.map(s=>{const i=s(r);try{return String(i??"")}catch{try{return JSON.stringify(i)||""}catch{return"[object]"}}}).join("");case"coalesce":return r=>{for(const s of n){const i=s(r);if(i!=null)return i}return null};case"add":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return(o??0)+(c??0)}}case"subtract":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return(o??0)-(c??0)}}case"multiply":{const r=n[0],s=n[1];return i=>{const o=r(i),c=s(i);return(o??0)*(c??0)}}case"divide":{const r=n[0],s=n[1];return i=>{const o=r(i),a=s(i)??0;return a!==0?(o??0)/a:null}}case"isUndefined":{const r=n[0];return s=>r(s)===void 0}case"isNull":{const r=n[0];return s=>r(s)===null}default:throw new WA(t.name)}}function Gy(t,e,n){if(typeof t!="string"||typeof e!="string")return!1;const r=n?t.toLowerCase():t;let i=(n?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return i=i.replace(/%/g,".*"),i=i.replace(/_/g,"."),new RegExp(`^${i}$`).test(r)}function Bn(t,e){return fa(t,e,new Map)}function fa(t,e,n){if(t===e)return!0;if(t==null||e==null||typeof t!=typeof e)return!1;if(t instanceof Date)return e instanceof Date?t.getTime()===e.getTime():!1;if(t instanceof RegExp)return e instanceof RegExp?t.source===e.source&&t.flags===e.flags:!1;if(t instanceof Map){if(!(e instanceof Map)||t.size!==e.size)return!1;if(n.has(t))return n.get(t)===e;n.set(t,e);const s=Array.from(t.entries()).every(([i,o])=>e.has(i)&&fa(o,e.get(i),n));return n.delete(t),s}if(t instanceof Set){if(!(e instanceof Set)||t.size!==e.size)return!1;if(n.has(t))return n.get(t)===e;n.set(t,e);const r=Array.from(t),s=Array.from(e);if(r.every(o=>typeof o!="object"))return n.delete(t),r.every(o=>e.has(o));const i=r.length===s.length;return n.delete(t),i}if(ArrayBuffer.isView(t)&&ArrayBuffer.isView(e)&&!(t instanceof DataView)&&!(e instanceof DataView)){const r=t,s=e;if(r.length!==s.length)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}if(La(t)&&La(e)){const r=Vf(t),s=Vf(e);return r!==s?!1:typeof t.equals=="function"?t.equals(e):t.toString()===e.toString()}if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;if(n.has(t))return n.get(t)===e;n.set(t,e);const r=t.every((s,i)=>fa(s,e[i],n));return n.delete(t),r}if(typeof t=="object"){if(n.has(t))return n.get(t)===e;n.set(t,e);const r=Object.keys(t),s=Object.keys(e);if(r.length!==s.length)return n.delete(t),!1;const i=r.every(o=>o in e&&fa(t[o],e[o],n));return n.delete(t),i}return!1}const iR=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function Vf(t){return t[Symbol.toStringTag]}function La(t){const e=Vf(t);return typeof e=="string"&&iR.includes(e)}const fp={direction:"asc",nulls:"first",stringSort:"locale"};class oR{constructor(e){this.originalIndex=e}lookup(e,n){const r=e==="gt"?"lt":e==="gte"?"lte":e==="lt"?"gt":e==="lte"?"gte":e;return this.originalIndex.lookup(r,n)}rangeQuery(e={}){return this.originalIndex.rangeQueryReversed(e)}rangeQueryReversed(e={}){return this.originalIndex.rangeQuery(e)}take(e,n,r){return this.originalIndex.takeReversed(e,n,r)}takeReversed(e,n,r){return this.originalIndex.take(e,n,r)}get orderedEntriesArray(){return this.originalIndex.orderedEntriesArrayReversed}get orderedEntriesArrayReversed(){return this.originalIndex.orderedEntriesArray}supports(e){return this.originalIndex.supports(e)}matchesField(e){return this.originalIndex.matchesField(e)}matchesCompareOptions(e){return this.originalIndex.matchesCompareOptions(e)}matchesDirection(e){return this.originalIndex.matchesDirection(e)}getStats(){return this.originalIndex.getStats()}add(e,n){this.originalIndex.add(e,n)}remove(e,n){this.originalIndex.remove(e,n)}update(e,n,r){this.originalIndex.update(e,n,r)}build(e){this.originalIndex.build(e)}clear(){this.originalIndex.clear()}get keyCount(){return this.originalIndex.keyCount}equalityLookup(e){return this.originalIndex.equalityLookup(e)}inArrayLookup(e){return this.originalIndex.inArrayLookup(e)}get indexedKeysSet(){return this.originalIndex.indexedKeysSet}get valueMapData(){return this.originalIndex.valueMapData}}function oc(t,e,n){const r=n??{...fp,...t.compareOptions};for(const s of t.indexes.values())if(s.matchesField(e)&&s.matchesCompareOptions(r))return s.matchesDirection(r.direction)?s:new oR(s)}function cR(t){if(t.length===0)return new Set;if(t.length===1)return new Set(t[0]);let e=new Set(t[0]);for(let n=1;n<t.length;n++){const r=new Set;for(const s of e)t[n].has(s)&&r.add(s);e=r}return e}function aR(t){const e=new Set;for(const n of t)for(const r of n)e.add(r);return e}function uR(t,e){return dp(t,e)}function dp(t,e){if(t.type==="func")switch(t.name){case"eq":case"gt":case"gte":case"lt":case"lte":return hR(t,e);case"and":return fR(t,e);case"or":return dR(t,e);case"in":return pR(t,e)}return{canOptimize:!1,matchingKeys:new Set}}function lR(t,e){if(t.type!=="func"||t.args.length<2)return{canOptimize:!1,matchingKeys:new Set};const n=new Map;for(const r of t.args)if(r.type==="func"&&["gt","gte","lt","lte"].includes(r.name)){const s=r;if(s.args.length===2){const i=s.args[0],o=s.args[1];let c=null,a=null,u=s.name;if(i.type==="ref"&&o.type==="val")c=i,a=o;else if(i.type==="val"&&o.type==="ref")switch(c=o,a=i,u){case"gt":u="lt";break;case"gte":u="lte";break;case"lt":u="gt";break;case"lte":u="gte";break}if(c&&a){const l=c.path.join("."),d=a.value;n.has(l)||n.set(l,[]),n.get(l).push({operation:u,value:d})}}}for(const[r,s]of n)if(s.length>=2){const i=r.split("."),o=oc(e,i);if(o&&o.supports("gt")&&o.supports("lt")){let c,a,u=!0,h=!0;for(const{operation:d,value:f}of s)switch(d){case"gt":(c===void 0||f>c)&&(c=f,u=!1);break;case"gte":(c===void 0||f>c)&&(c=f,u=!0);break;case"lt":(a===void 0||f<a)&&(a=f,h=!1);break;case"lte":(a===void 0||f<a)&&(a=f,h=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:c,to:a,fromInclusive:u,toInclusive:h})}}}return{canOptimize:!1,matchingKeys:new Set}}function hR(t,e){if(t.type!=="func"||t.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};const n=t.args[0],r=t.args[1];let s=null,i=null,o=t.name;if(n.type==="ref"&&r.type==="val")s=n,i=r;else if(n.type==="val"&&r.type==="ref")switch(s=r,i=n,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(s&&i){const c=s.path,a=oc(e,c);if(a){const u=i.value,h=o;return a.supports(h)?{canOptimize:!0,matchingKeys:a.lookup(h,u)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function fR(t,e){if(t.type!=="func"||t.args.length<2)return{canOptimize:!1,matchingKeys:new Set};const n=lR(t,e);if(n.canOptimize)return n;const r=[];for(const s of t.args){const i=dp(s,e);i.canOptimize&&r.push(i)}if(r.length>0){const s=r.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:cR(s)}}return{canOptimize:!1,matchingKeys:new Set}}function dR(t,e){if(t.type!=="func"||t.args.length<2)return{canOptimize:!1,matchingKeys:new Set};const n=[];for(const r of t.args){const s=dp(r,e);s.canOptimize&&n.push(s)}if(n.length>0){const r=n.map(i=>i.matchingKeys);return{canOptimize:!0,matchingKeys:aR(r)}}return{canOptimize:!1,matchingKeys:new Set}}function pR(t,e){if(t.type!=="func"||t.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};const n=t.args[0],r=t.args[1];if(n.type==="ref"&&r.type==="val"&&Array.isArray(r.value)){const s=n.path,i=r.value,o=oc(e,s);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",i)};if(o.supports("eq")){const c=new Set;for(const a of i){const u=o.lookup("eq",a);for(const h of u)c.add(h)}return{canOptimize:!0,matchingKeys:c}}}}return{canOptimize:!1,matchingKeys:new Set}}class gR extends Map{constructor(e,n){super(n),this.defaultValue=e}get(e){return this.has(e)?super.get(e):this.defaultValue()}update(e,n){const r=this.get(e),s=n(r);return this.set(e,s),s}}const Ul=3e4;function Vl(t,e){if(e.length<=Ul)t.push(...e);else for(let n=0;n<e.length;n+=Ul){const r=e.slice(n,n+Ul);t.push(...r)}}function yR(t,e,n){let r=0,s=t.length;for(;r<s;){const i=Math.floor((r+s)/2),o=n(t[i],e);if(o<0)r=i+1;else if(o>0)s=i;else return i}return r}class mR{constructor(){this.objectIds=new WeakMap,this.nextId=0}getId(e){if(typeof e!="object"||e===null){const n=String(e);let r=0;for(let s=0;s<n.length;s++){const i=n.charCodeAt(s);r=(r<<5)-r+i,r=r&r}return r}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}}const jl=new mR;function wR(t,e){const[n,r]=t,[s,i]=e,o=[...Dc(n,Math.min(r,s)),...Dc(Math.max(n,i),r)],c=[...Dc(s,Math.min(i,n)),...Dc(Math.max(s,r),i)];return{onlyInA:o,onlyInB:c}}function Dc(t,e){const n=[];for(let r=t;r<e;r++)n.push(r);return n}function Da(t,e){return typeof t==typeof e?t<e?-1:t>e?1:0:typeof t=="string"?-1:1}const bR=_t(),_R=_t(),SR=_t(),ER=_t(),vR=_t();function _t(){return Math.random()*(2**31-1)>>>0}const gS=new ArrayBuffer(8),kR=new DataView(gS),cr=new Uint8Array(gS);class Iu{constructor(){this.hash=bR,this.length=0,this.carry=0,this.carryBytes=0}_mix(e){e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e,this.hash=this.hash<<13|this.hash>>>19,this.hash=Math.imul(this.hash,5)+3864292196}writeByte(e){this.carry|=(e&255)<<8*this.carryBytes,this.carryBytes++,this.length++,this.carryBytes===4&&(this._mix(this.carry>>>0),this.carry=0,this.carryBytes=0)}update(e){switch(typeof e){case"symbol":{this.update(vR);const n=e.description;if(!n)return;for(let r=0;r<n.length;r++){const s=n.charCodeAt(r);this.writeByte(s&255),this.writeByte(s>>>8&255)}return}case"string":this.update(_R);for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);this.writeByte(r&255),this.writeByte(r>>>8&255)}return;case"number":kR.setFloat64(0,e,!0),this.writeByte(cr[0]),this.writeByte(cr[1]),this.writeByte(cr[2]),this.writeByte(cr[3]),this.writeByte(cr[4]),this.writeByte(cr[5]),this.writeByte(cr[6]),this.writeByte(cr[7]);return;case"bigint":{let n=e;for(n<0n?(n=-n,this.update(ER)):this.update(SR);n>0n;)this.writeByte(Number(n&0xffn)),n>>=8n;e===0n&&this.writeByte(0);return}default:throw new TypeError(`Unsupported input type: ${typeof e}`)}}digest(){if(this.carryBytes>0){let e=this.carry>>>0;e=Math.imul(e,3432918353),e=e<<15|e>>>17,e=Math.imul(e,461845907),this.hash^=e}return this.hash^=this.length,this.hash^=this.hash>>>16,this.hash=Math.imul(this.hash,2246822507),this.hash^=this.hash>>>13,this.hash=Math.imul(this.hash,3266489909),this.hash^=this.hash>>>16,this.hash>>>0}}const xR=_t(),IR=_t(),TR=_t(),AR=_t(),RR=_t(),CR=_t(),OR=_t(),MR=_t(),LR=_t(),DR=_t(),FR=_t(),NR=_t(),PR=128,Mo=new WeakMap;function rn(t){const e=new Iu;return yS(e,t),e.digest()}function $R(t){const e=Mo.get(t);if(e!==void 0)return e;let n;if(t instanceof Date)n=BR(t);else if(typeof Buffer<"u"&&t instanceof Buffer||t instanceof Uint8Array)if(t.byteLength<=PR)n=qR(t);else return jf(t);else{if(t instanceof File)return jf(t);{let r=t,s=MR;t instanceof Array&&(s=LR),t instanceof Map&&(s=DR,r=[...t.entries()]),t instanceof Set&&(s=FR,r=[...t.entries()]),n=UR(r,s)}}return Mo.set(t,n),n}function BR(t){const e=new Iu;return e.update(OR),e.update(t.getTime()),e.digest()}function qR(t){const e=new Iu;e.update(NR),e.update(t.byteLength);for(let n=0;n<t.byteLength;n++)e.writeByte(t[n]);return e.digest()}function UR(t,e){const n=new Iu;n.update(e);const r=Object.keys(t);r.sort(jR);for(const s of r)n.update(RR),n.update(s),yS(n,t[s]);return n.digest()}function yS(t,e){if(e===null){t.update(TR);return}switch(typeof e){case"undefined":t.update(AR);return;case"boolean":t.update(e?xR:IR);return;case"number":t.update(isNaN(e)?NaN:e===0?0:e);return;case"bigint":case"string":case"symbol":t.update(e);return;case"object":t.update(VR(e));return;case"function":t.update(jf(e));return;default:console.warn(`Ignored input during hashing because it is of type ${typeof e} which is not supported`)}}function VR(t){let e=Mo.get(t);return e===void 0&&(e=$R(t)),e}let Jy=1;function jf(t){let e=Mo.get(t);return e===void 0&&(e=Jy^CR,Jy++,Mo.set(t,e)),e}function jR(t,e){return t.localeCompare(e)}class kt{#e;constructor(e=[]){this.#e=e}toString(e=!1){return`MultiSet(${JSON.stringify(this.#e,null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new kt(JSON.parse(e))}map(e){return new kt(this.#e.map(([n,r])=>[e(n),r]))}filter(e){return new kt(this.#e.filter(([n,r])=>e(n)))}negate(){return new kt(this.#e.map(([e,n])=>[e,-n]))}concat(e){const n=[];return Vl(n,this.#e),Vl(n,e.getInner()),new kt(n)}consolidate(){if(this.#e.length>0){const e=this.#e[0]?.[0];if(Array.isArray(e)&&e.length===2)return this.#t()}return this.#n()}#t(){const e=new Map,n=new Map,r=i=>{if(i.length!==2)throw new Error("Expected tuple of length 2");const[o,c]=i;return`${jl.getStringId(o)}|${jl.getStringId(c)}`};for(const[i,o]of this.#e){if(!Array.isArray(i)||i.length!==2)return this.#n();const[c,a]=i;if(typeof c!="string"&&typeof c!="number")return this.#n();let u;Array.isArray(a)&&a.length===2?u=r(a):u=jl.getStringId(a);const h=c+"|"+u;e.set(h,(e.get(h)||0)+o),n.has(h)||n.set(h,i)}const s=[];for(const[i,o]of e)o!==0&&s.push([n.get(i),o]);return new kt(s)}#n(){const e=new gR(()=>0),n=new Map;let r=!1,s=!1,i=!1;for(const[a,u]of this.#e)if(typeof a=="string")r=!0;else if(typeof a=="number")s=!0;else{i=!0;break}const o=i||r&&s;for(const[a,u]of this.#e){const h=o?rn(a):a;o&&!n.has(h)&&n.set(h,a),e.update(h,l=>l+u)}const c=[];for(const[a,u]of e.entries())if(u!==0){const h=o?n.get(a):a;c.push([h,u])}return new kt(c)}extend(e){const n=e instanceof kt?e.getInner():e;Vl(this.#e,n)}add(e,n){n!==0&&this.#e.push([e,n])}getInner(){return this.#e}}class KR{#e;constructor(e){this.#e=e}drain(){const e=[...this.#e].reverse();return this.#e.length=0,e}isEmpty(){return this.#e.length===0}}class vi{#e=[];sendData(e){e instanceof kt||(e=new kt(e));for(const n of this.#e)n.unshift(e)}newReader(){const e=[];return this.#e.push(e),new KR(e)}}class mS{constructor(e,n,r){this.id=e,this.inputs=n,this.output=r}hasPendingWork(){return this.inputs.some(e=>!e.isEmpty())}}class Tu extends mS{constructor(e,n,r){super(e,[n],r),this.id=e}inputMessages(){return this.inputs[0].drain()}}class xW extends mS{constructor(e,n,r,s){super(e,[n,r],s),this.id=e}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}}class wS extends Tu{run(){for(const e of this.inputMessages())this.output.sendData(this.inner(e))}}class IW{#e=[];#t=0;#n=!1;constructor(){}#r(){if(this.#n)throw new Error("Graph already finalized")}getNextOperatorId(){return this.#r(),this.#t++}newInput(){this.#r();const e=new vi;return new WR(this,e)}addOperator(e){this.#r(),this.#e.push(e)}finalize(){this.#r(),this.#n=!0}step(){if(!this.#n)throw new Error("Graph not finalized");for(const e of this.#e)e.run()}pendingWork(){return this.#e.some(e=>e.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}}class ki{#e;#t;constructor(e,n){this.#e=e,this.#t=n}connectReader(){return this.#t.newReader()}get writer(){return this.#t}get graph(){return this.#e}pipe(...e){return e.reduce((n,r)=>r(n),this)}}class WR extends ki{sendData(e){this.writer.sendData(e)}}class zR extends wS{#e;constructor(e,n,r,s){super(e,n,r),this.#e=s}inner(e){return e.map(this.#e)}}function Fa(t){return e=>{const n=new ki(e.graph,new vi),r=new zR(e.graph.getNextOperatorId(),e.connectReader(),n.writer,t);return e.graph.addOperator(r),n}}const uo=Symbol("NO_PREFIX");class Yy extends Map{addValue(e,n){if(n===0)return this.size===0;const r=wo(e),s=this.get(r);if(da(s)){const[i,o]=s;if(wo(i)!==r)throw new Error("Mismatching prefixes, this should never happen");if(i===e||rn(i)===rn(e)){const a=o+n;a===0?this.delete(r):this.set(r,[e,a])}else{const a=new lo;a.set(rn(i),s),a.set(rn(e),[e,n]),this.set(r,a)}}else s===void 0?this.set(r,[e,n]):s.addValue(e,n)&&this.delete(r);return this.size===0}}class lo extends Map{addValue(e,n){if(n===0)return this.size===0;const r=rn(e),s=this.get(r);if(s){const[,i]=s,o=i+n;o===0?this.delete(r):this.set(r,[e,o])}else this.set(r,[e,n]);return this.size===0}}class Na{#e;#t=new Map;constructor(){this.#e=new Map}static fromMultiSets(e){const n=new Na;for(const r of e)for(const[s,i]of r.getInner()){const[o,c]=s;n.addValue(o,[c,i])}return n}toString(e=!1){return`Index(${JSON.stringify([...this.entries()],void 0,e?2:void 0)})`}get size(){return this.#e.size}has(e){return this.#e.has(e)}hasPresence(e){return(this.#t.get(e)||0)!==0}getConsolidatedMultiplicity(e){return this.#t.get(e)||0}getPresenceKeys(){return this.#t.keys()}get(e){return[...this.getIterator(e)]}*getIterator(e){const n=this.#e.get(e);if(da(n))yield n;else{if(n===void 0)return;if(n instanceof lo)for(const r of n.values())yield r;else for(const r of n.values())if(da(r))yield r;else for(const s of r.values())yield s}}*entries(){for(const e of this.#e.keys())for(const n of this.getIterator(e))yield[e,n]}*entriesIterators(){for(const e of this.#e.keys())yield[e,this.getIterator(e)]}addValue(e,n){const[r,s]=n;if(s===0)return;const i=(this.#t.get(e)||0)+s;i===0?this.#t.delete(e):this.#t.set(e,i);const o=this.#e.get(e);if(o===void 0){this.#e.set(e,n);return}if(da(o)){this.#n(e,o,r,s);return}if(o instanceof lo){const c=wo(r);if(c!==uo){const a=new Yy;a.set(uo,o),a.set(c,n),this.#e.set(e,a)}else o.addValue(r,s)&&this.#e.delete(e)}else o.addValue(r,s)&&this.#e.delete(e)}#n(e,n,r,s){const[i,o]=n;if(i===r){const u=o+s;u===0?this.#e.delete(e):this.#e.set(e,[r,u]);return}const c=wo(r),a=wo(i);if(a===c&&(i===r||rn(i)===rn(r))){const u=o+s;u===0?this.#e.delete(e):this.#e.set(e,[r,u]);return}if(a===uo&&c===uo){const u=new lo;u.set(rn(i),n),u.set(rn(r),[r,s]),this.#e.set(e,u)}else{const u=new Yy;if(a===c){const h=new lo;h.set(rn(i),n),h.set(rn(r),[r,s]),u.set(a,h)}else u.set(a,n),u.set(c,[r,s]);this.#e.set(e,u)}}append(e){for(const[n,r]of e.entries())this.addValue(n,r)}join(e){const n=[];if(this.size<=e.size)for(const[r,s]of this.entriesIterators()){if(!e.has(r))continue;const i=e.get(r);for(const[o,c]of s)for(const[a,u]of i)c!==0&&u!==0&&n.push([[r,[o,a]],c*u])}else for(const[r,s]of e.entriesIterators()){if(!this.has(r))continue;const i=this.get(r);for(const[o,c]of s)for(const[a,u]of i)u!==0&&c!==0&&n.push([[r,[a,o]],u*c])}return new kt(n)}}function wo(t){return Array.isArray(t)&&(typeof t[0]=="string"||typeof t[0]=="number"||typeof t[0]=="bigint")?t[0]:uo}function da(t){return Array.isArray(t)}class HR extends Tu{#e=new Na;#t=new Na;#n;constructor(e,n,r,s){super(e,n,r),this.#n=s}run(){const e=new Set;for(const r of this.inputMessages())for(const[s,i]of r.getInner()){const[o,c]=s;this.#e.addValue(o,[c,i]),e.add(o)}const n=[];for(const r of e){const s=this.#e.get(r),i=this.#t.get(r),o=this.#n(s),c=new Map,a=new Map;for(const[u,h]of o){const l=c.get(u)??0;c.set(u,l+h)}for(const[u,h]of i){const l=a.get(u)??0;a.set(u,l+h)}for(const[u,h]of a)c.has(u)||(n.push([[r,u],-h]),this.#t.addValue(r,[u,-h]));for(const[u,h]of c)a.has(u)||h!==0&&(n.push([[r,u],h]),this.#t.addValue(r,[u,h]));for(const[u,h]of c){const l=a.get(u);if(l!==void 0){const d=h-l;d!==0&&(n.push([[r,u],d]),this.#t.addValue(r,[u,d]))}}}n.length>0&&this.output.sendData(new kt(n))}}function QR(t){return e=>{const n=new ki(e.graph,new vi),r=new HR(e.graph.getNextOperatorId(),e.connectReader(),n.writer,t);return e.graph.addOperator(r),n}}function Xy(t){return"pipe"in t}function Zy(t,e={}){const n=Object.fromEntries(Object.entries(e).filter(([r,s])=>!Xy(s)));return Object.fromEntries(Object.entries(e).filter(([r,s])=>Xy(s))),r=>{const s="__original_key__";return r.pipe(Fa(c=>{const a=t(c),u=JSON.stringify(a),h={};h[s]=a;for(const[l,d]of Object.entries(n))h[l]=d.preMap(c);return[u,h]})).pipe(QR(c=>{let a=0;for(const[l,d]of c)a+=d;if(a<=0)return[];const u={},h=c[0]?.[0]?.[s];u[s]=h;for(const[l,d]of Object.entries(n)){const f=c.map(([p,w])=>[p[l],w]);u[l]=d.reduce(f)}return[[u,1]]})).pipe(Fa(([c,a])=>{const u=a[s],h={};Object.assign(h,u);for(const[l,d]of Object.entries(n))d.postMap?h[l]=d.postMap(a[l]):h[l]=a[l];return[c,h]}))}}function GR(t=e=>e){return{preMap:e=>t(e),reduce:e=>{let n=0;for(const[r,s]of e)n+=r*s;return n}}}function JR(t=e=>e){return{preMap:e=>t(e)==null?0:1,reduce:e=>{let n=0;for(const[r,s]of e)n+=r*s;return n}}}function YR(t=e=>e){return{preMap:e=>({sum:t(e),count:0}),reduce:e=>{let n=0,r=0;for(const[s,i]of e)n+=s.sum*i,r+=i;return{sum:n,count:r}},postMap:e=>e.sum/e.count}}function XR(t){const e=t??(n=>n);return{preMap:n=>e(n),reduce:n=>{let r;for(const[s,i]of n)(!r||s&&s<r)&&(r=s);return r}}}function ZR(t){const e=t??(n=>n);return{preMap:n=>e(n),reduce:n=>{let r;for(const[s,i]of n)(!r||s&&s>r)&&(r=s);return r}}}const eC={sum:GR,count:JR,avg:YR,min:XR,max:ZR};class tC extends wS{#e;constructor(e,n,r,s){super(e,n,r),this.#e=s}inner(e){return e.filter(this.#e)}}function Fc(t){return e=>{const n=new ki(e.graph,new vi),r=new tC(e.graph.getNextOperatorId(),e.connectReader(),n.writer,t);return e.graph.addOperator(r),n}}class nC extends Tu{run(){const e=this.inputMessages();if(e.length===0)return;const n=new kt;for(const s of e)n.extend(s);const r=n.consolidate();r.getInner().length>0&&this.output.sendData(r)}}function rC(){return t=>{const e=new ki(t.graph,new vi),n=new nC(t.graph.getNextOperatorId(),t.connectReader(),e.writer);return t.graph.addOperator(n),e}}const sC="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function Ts(t,e,n){const r=n[0];if(e!=null&&t>=e)throw new Error(t+" >= "+e);if(t.slice(-1)===r||e&&e.slice(-1)===r)throw new Error("trailing zero");if(e){let o=0;for(;(t[o]||r)===e[o];)o++;if(o>0)return e.slice(0,o)+Ts(t.slice(o),e.slice(o),n)}const s=t?n.indexOf(t[0]):0,i=e!=null?n.indexOf(e[0]):n.length;if(i-s>1){const o=Math.round(.5*(s+i));return n[o]}else return e&&e.length>1?e.slice(0,1):n[s]+Ts(t.slice(1),null,n)}function bS(t){if(t.length!==_S(t[0]))throw new Error("invalid integer part of order key: "+t)}function _S(t){if(t>="a"&&t<="z")return t.charCodeAt(0)-97+2;if(t>="A"&&t<="Z")return 90-t.charCodeAt(0)+2;throw new Error("invalid order key head: "+t)}function ho(t){const e=_S(t[0]);if(e>t.length)throw new Error("invalid order key: "+t);return t.slice(0,e)}function em(t,e){if(t==="A"+e[0].repeat(26))throw new Error("invalid order key: "+t);const n=ho(t);if(t.slice(n.length).slice(-1)===e[0])throw new Error("invalid order key: "+t)}function tm(t,e){bS(t);const[n,...r]=t.split("");let s=!0;for(let i=r.length-1;s&&i>=0;i--){const o=e.indexOf(r[i])+1;o===e.length?r[i]=e[0]:(r[i]=e[o],s=!1)}if(s){if(n==="Z")return"a"+e[0];if(n==="z")return null;const i=String.fromCharCode(n.charCodeAt(0)+1);return i>"a"?r.push(e[0]):r.pop(),i+r.join("")}else return n+r.join("")}function iC(t,e){bS(t);const[n,...r]=t.split("");let s=!0;for(let i=r.length-1;s&&i>=0;i--){const o=e.indexOf(r[i])-1;o===-1?r[i]=e.slice(-1):(r[i]=e[o],s=!1)}if(s){if(n==="a")return"Z"+e.slice(-1);if(n==="A")return null;const i=String.fromCharCode(n.charCodeAt(0)-1);return i<"Z"?r.push(e.slice(-1)):r.pop(),i+r.join("")}else return n+r.join("")}function oC(t,e,n=sC){if(t!=null&&em(t,n),e!=null&&em(e,n),t!=null&&e!=null&&t>=e)throw new Error(t+" >= "+e);if(t==null){if(e==null)return"a"+n[0];const a=ho(e),u=e.slice(a.length);if(a==="A"+n[0].repeat(26))return a+Ts("",u,n);if(a<e)return a;const h=iC(a,n);if(h==null)throw new Error("cannot decrement any more");return h}if(e==null){const a=ho(t),u=t.slice(a.length),h=tm(a,n);return h??a+Ts(u,null,n)}const r=ho(t),s=t.slice(r.length),i=ho(e),o=e.slice(i.length);if(r===i)return r+Ts(s,o,n);const c=tm(r,n);if(c==null)throw new Error("cannot increment any more");return c<e?c:r+Ts(s,null,n)}class nm{#e=[];#t;#n;#r;constructor(e,n,r){this.#n=e,this.#r=e+n,this.#t=r}get size(){const e=this.#n,n=this.#r-this.#n,r=this.#e.length-e;return Math.max(0,Math.min(n,r))}move({offset:e,limit:n}){const r=this.#n,s=this.#r-this.#n,i=[this.#n,this.#r===1/0?this.#n+this.size:this.#r];this.#n=e??r,this.#r=this.#n+(n??s);const o=[this.#n,this.#r===1/0?Math.max(this.#n+this.size,i[1]):this.#r],{onlyInA:c,onlyInB:a}=wR(i,o),u=[];a.forEach(l=>{const d=this.#e[l];d&&u.push(d)});const h=[];return c.forEach(l=>{const d=this.#e[l];d&&h.push(d)}),{moveIns:u,moveOuts:h,changes:c.length+a.length>0}}insert(e){const n={moveIn:null,moveOut:null},r=this.#c(e),s=r===0?null:im(this.#e[r-1]),i=r===this.#e.length?null:im(this.#e[r]),o=oC(s,i),c=rm(e,o);if(this.#e.splice(r,0,c),r<this.#r){const a=Math.max(r,this.#n);a<this.#e.length&&(n.moveIn=this.#e[a],this.#r<this.#e.length&&(n.moveOut=this.#e[this.#r]))}return n}delete(e){const n={moveIn:null,moveOut:null},r=this.#c(e),[s]=this.#e.splice(r,1);if(r<this.#r){if(n.moveOut=s,r<this.#n){const o=this.#n-1;o<this.#e.length?n.moveOut=this.#e[o]:n.moveOut=null}const i=this.#r-1;i<this.#e.length&&(n.moveIn=this.#e[i])}return n}#c(e){return yR(this.#e,rm(e,""),(n,r)=>this.#t(sm(n),sm(r)))}}class cC extends Tu{#e=new Map;#t;constructor(e,n,r,s,i){super(e,n,r);const o=i.limit??1/0,c=i.offset??0;this.#t=this.createTopK(c,o,uC(s)),i.setSizeCallback?.(()=>this.#t.size),i.setWindowFn?.(this.moveTopK.bind(this))}createTopK(e,n,r){return new nm(e,n,r)}moveTopK({offset:e,limit:n}){if(!(this.#t instanceof nm))throw new Error("Cannot move B+-tree implementation of TopK with fractional index");const r=[],s=this.#t.move({offset:e,limit:n});s.moveIns.forEach(i=>this.handleMoveIn(i,r)),s.moveOuts.forEach(i=>this.handleMoveOut(i,r)),s.changes&&this.output.sendData(new kt(r))}run(){const e=[];for(const n of this.inputMessages())for(const[r,s]of n.getInner()){const[i,o]=r;this.processElement(i,o,s,e)}e.length>0&&this.output.sendData(new kt(e))}processElement(e,n,r,s){const{oldMultiplicity:i,newMultiplicity:o}=this.addKey(e,r);let c={moveIn:null,moveOut:null};i<=0&&o>0?c=this.#t.insert([e,n]):i>0&&o<=0&&(c=this.#t.delete([e,n])),this.handleMoveIn(c.moveIn,s),this.handleMoveOut(c.moveOut,s)}handleMoveIn(e,n){if(e){const[[r,s],i]=e;n.push([[r,[s,i]],1])}}handleMoveOut(e,n){if(e){const[[r,s],i]=e;n.push([[r,[s,i]],-1])}}getMultiplicity(e){return this.#e.get(e)??0}addKey(e,n){const r=this.getMultiplicity(e),s=r+n;return s===0?this.#e.delete(e):this.#e.set(e,s),{oldMultiplicity:r,newMultiplicity:s}}}function aC(t,e){const n=e||{};return r=>{const s=new ki(r.graph,new vi),i=new cC(r.graph.getNextOperatorId(),r.connectReader(),s.writer,t,n);return r.graph.addOperator(i),s}}function rm(t,e){return[t,e]}function sm(t){return t[0]}function im(t){return t[1]}function uC(t){return([e,n],[r,s])=>{const i=t(n,s);return i!==0?i:Da(e,r)}}function lC(t,e,n){const r=n?.limit??1/0,s=n?.offset??0,i=n?.setSizeCallback,o=n?.setWindowFn,c=n?.comparator??((a,u)=>a===u?0:a<u?-1:1);return a=>a.pipe(t((u,h)=>c(e(u),e(h)),{limit:r,offset:s,setSizeCallback:i,setWindowFn:o}),rC())}function hC(t,e){return lC(aC,t,e)}class fC{constructor(e,n,r){this._root=Kl,this._size=0,this._maxNodeSize=r>=4?Math.min(r,256):32,this._compare=e,n&&this.setPairs(n)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=Kl,this._size=0}get(e,n){return this._root.get(e,n,this)}set(e,n,r){this._root.isShared&&(this._root=this._root.clone());const s=this._root.set(e,n,r,this);return s===!0||s===!1?s:(this._root=new pp([this._root,s]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,pC)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){const e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(n,r)=>{e.push(n)}),e}nextHigherPair(e,n){return n=n||[],e===void 0?this._root.minPair(n):this._root.getPairOrNextHigher(e,this._compare,!1,n)}nextHigherKey(e){const n=this.nextHigherPair(e,om);return n&&n[0]}nextLowerPair(e,n){return n=n||[],e===void 0?this._root.maxPair(n):this._root.getPairOrNextLower(e,this._compare,!1,n)}nextLowerKey(e){const n=this.nextLowerPair(e,om);return n&&n[0]}setPairs(e,n){let r=0;for(const s of e)this.set(s[0],s[1],n)&&r++;return r}forRange(e,n,r,s,i){const o=this._root.forRange(e,n,r,!1,this,i||0,s);return typeof o=="number"?o:o.break}editRange(e,n,r,s,i){let o=this._root;o.isShared&&(this._root=o=o.clone());try{const c=o.forRange(e,n,r,!0,this,i||0,s);return typeof c=="number"?c:c.break}finally{let c;for(;o.keys.length<=1&&!o.isLeaf;)c||=o.isShared,this._root=o=o.keys.length===0?Kl:o.children[0];c&&(o.isShared=!0)}}}class Lo{get isLeaf(){return this.children===void 0}constructor(e=[],n){this.keys=e,this.values=n||vt,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,n,r){const s=this.keys;let i=0,o=s.length,c=o>>1;for(;i<o;){const a=r(s[c],e);if(a<0)i=c+1;else if(a>0)o=c;else{if(a===0)return c;if(e===e)return s.length;throw new Error("BTree: NaN was used as a key")}c=i+o>>1}return c^n}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;const n=this.keys.length-1;return e[0]=this.keys[n],e[1]=this.values[n],e}clone(){const e=this.values;return new Lo(this.keys.slice(0),e===vt?e:e.slice(0))}get(e,n,r){const s=this.indexOf(e,-1,r._compare);return s<0?n:this.values[s]}getPairOrNextLower(e,n,r,s){const i=this.indexOf(e,-1,n),o=i<0?~i-1:r?i:i-1;if(o>=0)return s[0]=this.keys[o],s[1]=this.values[o],s}getPairOrNextHigher(e,n,r,s){const i=this.indexOf(e,-1,n),o=i<0?~i:r?i:i+1,c=this.keys;if(o<c.length)return s[0]=c[o],s[1]=this.values[o],s}set(e,n,r,s){let i=this.indexOf(e,-1,s._compare);if(i<0){if(i=~i,s._size++,this.keys.length<s._maxNodeSize)return this.insertInLeaf(i,e,n,s);{const o=this.splitOffRightSide();let c=this;return i>this.keys.length&&(i-=this.keys.length,c=o),c.insertInLeaf(i,e,n,s),o}}else return r!==!1&&(n!==void 0&&this.reifyValues(),this.keys[i]=e,this.values[i]=n),!1}reifyValues(){return this.values===vt?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,n,r,s){if(this.keys.splice(e,0,n),this.values===vt){for(;vt.length<s._maxNodeSize;)vt.push(void 0);if(r===void 0)return!0;this.values=vt.slice(0,this.keys.length-1)}return this.values.splice(e,0,r),!0}takeFromRight(e){let n=this.values;e.values===vt?n!==vt&&n.push(void 0):(n=this.reifyValues(),n.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let n=this.values;e.values===vt?n!==vt&&n.unshift(void 0):(n=this.reifyValues(),n.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){const e=this.keys.length>>1,n=this.keys.splice(e),r=this.values===vt?vt:this.values.splice(e);return new Lo(n,r)}forRange(e,n,r,s,i,o,c){const a=i._compare;let u,h;if(n===e){if(!r||(h=(u=this.indexOf(e,-1,a))+1,u<0))return o}else u=this.indexOf(e,0,a),h=this.indexOf(n,-1,a),h<0?h=~h:r===!0&&h++;const l=this.keys,d=this.values;if(c!==void 0)for(let f=u;f<h;f++){const p=l[f],w=c(p,d[f],o++);if(w!==void 0){if(s===!0){if(p!==l[f]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");w.delete?(this.keys.splice(f,1),this.values!==vt&&this.values.splice(f,1),i._size--,f--,h--):w.hasOwnProperty("value")&&(d[f]=w.value)}if(w.break!==void 0)return w}}else o+=h-u;return o}mergeSibling(e,n){if(this.keys.push.apply(this.keys,e.keys),this.values===vt){if(e.values===vt)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}}class pp extends Lo{constructor(e,n){if(!n){n=[];for(let r=0;r<e.length;r++)n[r]=e[r].maxKey()}super(n),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,n,r){const s=this.indexOf(e,0,r._compare),i=this.children;return s<i.length?i[s].get(e,n,r):void 0}getPairOrNextLower(e,n,r,s){const i=this.indexOf(e,0,n),o=this.children;if(i>=o.length)return this.maxPair(s);const c=o[i].getPairOrNextLower(e,n,r,s);return c===void 0&&i>0?o[i-1].maxPair(s):c}getPairOrNextHigher(e,n,r,s){const i=this.indexOf(e,0,n),o=this.children,c=o.length;if(i>=c)return;const a=o[i].getPairOrNextHigher(e,n,r,s);return a===void 0&&i<c-1?o[i+1].minPair(s):a}set(e,n,r,s){const i=this.children,o=s._maxNodeSize,c=s._compare;let a=Math.min(this.indexOf(e,0,c),i.length-1),u=i[a];if(u.isShared&&(i[a]=u=u.clone()),u.keys.length>=o){let l;a>0&&(l=i[a-1]).keys.length<o&&c(u.keys[0],e)<0?(l.isShared&&(i[a-1]=l=l.clone()),l.takeFromRight(u),this.keys[a-1]=l.maxKey()):(l=i[a+1])!==void 0&&l.keys.length<o&&c(u.maxKey(),e)<0&&(l.isShared&&(i[a+1]=l=l.clone()),l.takeFromLeft(u),this.keys[a]=i[a].maxKey())}const h=u.set(e,n,r,s);if(h===!1)return!1;if(this.keys[a]=u.maxKey(),h===!0)return!0;if(this.keys.length<o)return this.insert(a+1,h),!0;{const l=this.splitOffRightSide();let d=this;return c(h.maxKey(),this.maxKey())>0&&(d=l,a-=this.keys.length),d.insert(a+1,h),l}}insert(e,n){this.children.splice(e,0,n),this.keys.splice(e,0,n.maxKey())}splitOffRightSide(){const e=this.children.length>>1;return new pp(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,n,r,s,i,o,c){const a=i._compare,u=this.keys,h=this.children;let l=this.indexOf(e,0,a),d=l;const f=Math.min(n===e?l:this.indexOf(n,0,a),u.length-1);if(s){if(d<=f)try{for(;d<=f;d++){h[d].isShared&&(h[d]=h[d].clone());const p=h[d].forRange(e,n,r,s,i,o,c);if(u[d]=h[d].maxKey(),typeof p!="number")return p;o=p}}finally{const p=i._maxNodeSize>>1;for(l>0&&l--,d=f;d>=l;d--)h[d].keys.length<=p&&(h[d].keys.length!==0?this.tryMerge(d,i._maxNodeSize):(u.splice(d,1),h.splice(d,1)));h.length!==0&&h[0].keys.length===0&&gC(!1,"emptiness bug")}}else for(;d<=f;d++){const p=h[d].forRange(e,n,r,s,i,o,c);if(typeof p!="number")return p;o=p}return o}tryMerge(e,n){const r=this.children;return e>=0&&e+1<r.length&&r[e].keys.length+r[e+1].keys.length<=n?(r[e].isShared&&(r[e]=r[e].clone()),r[e].mergeSibling(r[e+1],n),r.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=r[e].maxKey(),!0):!1}mergeSibling(e,n){const r=this.keys.length;this.keys.push.apply(this.keys,e.keys);const s=e.children;if(this.children.push.apply(this.children,s),e.isShared&&!this.isShared)for(const i of s)i.isShared=!0;this.tryMerge(r-1,n)}}const vt=[],dC={delete:!0},pC=()=>dC,Kl=(function(){const t=new Lo;return t.isShared=!0,t})(),om=[];function gC(t,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}function yC(){const t=new Map;function e(n){const r=n.join(".");if(t.has(r))return t.get(r);const s=new Proxy({},{get(i,o,c){if(o==="__refProxy")return!0;if(o==="__path")return n;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(i,o,c);const a=[...n,String(o)];return e(a)},has(i,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(i,o)},ownKeys(i){return Reflect.ownKeys(i)},getOwnPropertyDescriptor(i,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(i,o)}});return t.set(r,s),s}return e([])}function TW(t){const e=new Map;let n=0;function r(i){const o=i.join(".");if(e.has(o))return e.get(o);const c=new Proxy({},{get(a,u,h){if(u==="__refProxy")return!0;if(u==="__path")return i;if(u==="__type")return;if(typeof u=="symbol")return Reflect.get(a,u,h);const l=[...i,String(u)];return r(l)},has(a,u){return u==="__refProxy"||u==="__path"||u==="__type"?!0:Reflect.has(a,u)},ownKeys(a){const u=++n,h=`__SPREAD_SENTINEL__${i.join(".")}__${u}`;return Object.prototype.hasOwnProperty.call(a,h)||Object.defineProperty(a,h,{enumerable:!0,configurable:!0,value:!0}),Reflect.ownKeys(a)},getOwnPropertyDescriptor(a,u){return u==="__refProxy"||u==="__path"||u==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(a,u)}});return e.set(o,c),c}return new Proxy({},{get(i,o,c){if(o==="__refProxy")return!0;if(o==="__path")return[];if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(i,o,c);const a=String(o);if(t.includes(a))return r([a])},has(i,o){return o==="__refProxy"||o==="__path"||o==="__type"||typeof o=="string"&&t.includes(o)?!0:Reflect.has(i,o)},ownKeys(i){return[...t,"__refProxy","__path","__type"]},getOwnPropertyDescriptor(i,o){if(o==="__refProxy"||o==="__path"||o==="__type")return{enumerable:!1,configurable:!0};if(typeof o=="string"&&t.includes(o))return{enumerable:!0,configurable:!0}}})}function zt(t){return mC(t)?new zs(t.__path):t&&typeof t=="object"&&"type"in t&&(t.type==="func"||t.type==="ref"||t.type==="val"||t.type==="agg")?t:new $n(t)}function mC(t){return t&&typeof t=="object"&&t.__refProxy===!0}function Kf(t,e){return new nr("eq",[zt(t),zt(e)])}function cm(t,e){return new nr("gt",[zt(t),zt(e)])}function wC(t,e){return new nr("gte",[zt(t),zt(e)])}function Wf(t,e){return new nr("lt",[zt(t),zt(e)])}function zf(t,e,...n){const r=[t,e,...n];return new nr("and",r.map(s=>zt(s)))}function bC(t,e,...n){const r=[t,e,...n];return new nr("or",r.map(s=>zt(s)))}function AW(t,e){return new nr("in",[zt(t),zt(e)])}class _C{constructor(e,n,r,s){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=n,this.compareOptions=fp,this.name=r,this.initialize(s)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((n,r)=>n===e[r])}matchesCompareOptions(e){const n={...this.compareOptions,direction:void 0},r={...e,direction:void 0};return Bn(n,r)}matchesDirection(e){return this.compareOptions.direction===e}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return lp(this.expression)(e)}trackLookup(e){const n=performance.now()-e;this.lookupCount++,this.totalLookupTime+=n}updateTimestamp(){this.lastUpdated=new Date}}class Hf extends _C{constructor(e,n,r,s){super(e,n,r,s),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=Uf,this.compareFn=s?.compareFn??Uf,s?.compareOptions&&(this.compareOptions=s.compareOptions),this.orderedEntries=new fC(this.compareFn)}initialize(e){}add(e,n){let r;try{r=this.evaluateIndexExpression(n)}catch(i){throw new Error(`Failed to evaluate index expression for key ${e}: ${i}`)}const s=Dn(r);if(this.valueMap.has(s))this.valueMap.get(s).add(e);else{const i=new Set([e]);this.valueMap.set(s,i),this.orderedEntries.set(s,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,n){let r;try{r=this.evaluateIndexExpression(n)}catch(i){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,i);return}const s=Dn(r);if(this.valueMap.has(s)){const i=this.valueMap.get(s);i.delete(e),i.size===0&&(this.valueMap.delete(s),this.orderedEntries.delete(s))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,n,r){this.remove(e,n),this.add(e,r)}build(e){this.clear();for(const[n,r]of e)this.add(n,r)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,n){const r=performance.now();let s;switch(e){case"eq":s=this.equalityLookup(n);break;case"gt":s=this.rangeQuery({from:n,fromInclusive:!1});break;case"gte":s=this.rangeQuery({from:n,fromInclusive:!0});break;case"lt":s=this.rangeQuery({to:n,toInclusive:!1});break;case"lte":s=this.rangeQuery({to:n,toInclusive:!0});break;case"in":s=this.inArrayLookup(n);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(r),s}get keyCount(){return this.indexedKeys.size}equalityLookup(e){const n=Dn(e);return new Set(this.valueMap.get(n)??[])}rangeQuery(e={}){const{from:n,to:r,fromInclusive:s=!0,toInclusive:i=!0}=e,o=new Set,c=Dn(n),a=Dn(r),u=c??this.orderedEntries.minKey(),h=a??this.orderedEntries.maxKey();return this.orderedEntries.forRange(u,h,i,(l,d)=>{if(!s&&this.compareFn(l,n)===0)return;const f=this.valueMap.get(l);f&&f.forEach(p=>o.add(p))}),o}rangeQueryReversed(e={}){const{from:n,to:r,fromInclusive:s=!0,toInclusive:i=!0}=e;return this.rangeQuery({from:r??this.orderedEntries.maxKey(),to:n??this.orderedEntries.minKey(),fromInclusive:i,toInclusive:s})}takeInternal(e,n,r,s,i=!1){const o=new Set,c=[];let a,u=Dn(r);for(;(a=n(u))!==void 0&&c.length<e;){u=a[0];const h=this.valueMap.get(u);if(h&&h.size>0){const l=Array.from(h).sort(Da);i&&l.reverse();for(const d of l){if(c.length>=e)break;!o.has(d)&&(s?.(d)??!0)&&(c.push(d),o.add(d))}}}return c}take(e,n,r){const s=i=>this.orderedEntries.nextHigherPair(i);return this.takeInternal(e,s,n,r)}takeReversed(e,n,r){const s=i=>this.orderedEntries.nextLowerPair(i);return this.takeInternal(e,s,n,r,!0)}inArrayLookup(e){const n=new Set;for(const r of e){const s=Dn(r),i=this.valueMap.get(s);i&&i.forEach(o=>n.add(o))}return n}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get orderedEntriesArrayReversed(){return this.takeReversed(this.orderedEntries.size).map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}}function SS(t){return t.config.autoIndex==="eager"}function gp(t,e,n,r,s){if(!SS(n))return;const i=r??{...fp,...n.compareOptions};if(!Array.from(n.indexes.values()).find(c=>c.matchesField(e)&&c.matchesCompareOptions(i)))try{n.createIndex(c=>{let a=c;for(const u of e)a=a[u];return a},{name:`auto:${e.join(".")}`,indexType:Hf,options:s?{compareFn:s,compareOptions:i}:{}})}catch(c){console.warn(`${n.id?`[${n.id}] `:""}Failed to create auto-index for field path "${e.join(".")}":`,c)}}function SC(t,e){if(!SS(e))return;const n=EC(t);for(const{fieldName:r,fieldPath:s}of n)gp(r,s,e)}function EC(t){const e=[];function n(r){if(r.type!=="func")return;const s=r;if(s.name==="and"){for(const u of s.args)n(u);return}if(!["eq","gt","gte","lt","lte","in"].includes(s.name)||s.args.length<1||s.args[0].type!=="ref")return;const c=s.args[0].path;if(c.length===0)return;const a=c.join("_");e.push({fieldName:a,fieldPath:c})}return n(t),e}const{sum:vC,count:kC,avg:xC,min:IC,max:TC}=eC;function AC(t,e){const n=new Map,r=[...t];if(!e)return{selectToGroupByIndex:n,groupByExpressions:r};for(const[s,i]of Object.entries(e)){if(i.type==="agg")continue;const o=r.findIndex(c=>Pa(i,c));if(o===-1)throw new zA(s);n.set(s,o)}return{selectToGroupByIndex:n,groupByExpressions:r}}function RW(t,e,n,r,s){if(e.length===0){const u={};if(r){for(const[l,d]of Object.entries(r))if(d.type==="agg"){const f=d;u[l]=am(f)}}const h=()=>({__singleGroup:!0});if(t=t.pipe(Zy(h,u)),t=t.pipe(Fa(([,l])=>{const f={...l.__select_results||{}};if(r)for(const[p,w]of Object.entries(r))w.type==="agg"&&(f[p]=l[p]);return["single_group",{...l,__select_results:f}]})),n&&n.length>0)for(const l of n){const d=Vy(l),f=$a(d,r||{}),p=gr(f);t=t.pipe(Fc(([,w])=>{const g={result:w.__select_results};return ha(p(g))}))}if(s&&s.length>0)for(const l of s)t=t.pipe(Fc(([,d])=>{const f={result:d.__select_results};return ha(l(f))}));return t}const i=AC(e,r),o=e.map(u=>gr(u)),c=([,u])=>{const h={...u};delete h.__select_results;const l={};for(let d=0;d<e.length;d++){const f=o[d],p=f(h);l[`__key_${d}`]=p}return l},a={};if(r){for(const[u,h]of Object.entries(r))if(h.type==="agg"){const l=h;a[u]=am(l)}}if(t=t.pipe(Zy(c,a)),t=t.pipe(Fa(([,u])=>{const h=u.__select_results||{},l={};if(r)for(const[f,p]of Object.entries(r))if(p.type!=="agg"){const w=i.selectToGroupByIndex.get(f);w!==void 0?l[f]=u[`__key_${w}`]:l[f]=h[f]}else l[f]=u[f];else for(let f=0;f<e.length;f++)l[`__key_${f}`]=u[`__key_${f}`];let d;if(e.length===1)d=u.__key_0;else{const f=[];for(let p=0;p<e.length;p++)f.push(u[`__key_${p}`]);d=JSON.stringify(f)}return[d,{...u,__select_results:l}]})),n&&n.length>0)for(const u of n){const h=Vy(u),l=$a(h,r||{}),d=gr(l);t=t.pipe(Fc(([,f])=>{const p={result:f.__select_results};return d(p)}))}if(s&&s.length>0)for(const u of s)t=t.pipe(Fc(([,h])=>{const l={result:h.__select_results};return ha(u(l))}));return t}function Pa(t,e){if(!t||!e||t.type!==e.type)return!1;switch(t.type){case"ref":return!t.path||!e.path||t.path.length!==e.path.length?!1:t.path.every((n,r)=>n===e.path[r]);case"val":return t.value===e.value;case"func":return t.name===e.name&&t.args?.length===e.args?.length&&(t.args||[]).every((n,r)=>Pa(n,e.args[r]));case"agg":return t.name===e.name&&t.args?.length===e.args?.length&&(t.args||[]).every((n,r)=>Pa(n,e.args[r]));default:return!1}}function am(t){const e=gr(t.args[0]),n=([,i])=>{const o=e(i);return typeof o=="number"?o:o!=null?Number(o):0},r=([,i])=>{const o=e(i);return typeof o=="number"||o instanceof Date?o:o!=null?Number(o):0},s=([,i])=>e(i);switch(t.name.toLowerCase()){case"sum":return vC(n);case"count":return kC(s);case"avg":return xC(n);case"min":return IC(r);case"max":return TC(r);default:throw new HA(t.name)}}function $a(t,e,n="result"){switch(t.type){case"agg":{const r=t;for(const[s,i]of Object.entries(e))if(i.type==="agg"&&RC(r,i))return new zs([n,s]);throw new QA(r.name)}case"func":{const r=t,s=r.args.map(i=>$a(i,e));return new nr(r.name,s)}case"ref":return t;case"val":return t;default:throw new GA(t.type)}}function RC(t,e){return t.name===e.name&&t.args.length===e.args.length&&t.args.every((n,r)=>Pa(n,e.args[r]))}function CW(t,e,n,r,s,i,o,c,a){const u=n.map(p=>{const w=$a(p.expression,r,"__select_results");return{compiledExpression:gr(w),compareOptions:Qf(p,s)}}),h=p=>{const w=p;return n.length>1?u.map(g=>g.compiledExpression(w)):n.length===1?u[0].compiledExpression(w):null},l=(p,w)=>{if(n.length>1){const g=p,m=w;for(let _=0;_<n.length;_++){const v=u[_],I=Ma(v.compareOptions)(g[_],m[_]);if(I!==0)return I}return g.length-m.length}if(n.length===1){const g=u[0];return Ma(g.compareOptions)(p,w)}return Uf(p,w)};let d,f;if(c){let p,w,g,m=t.from.alias;const _=n[0],v=_.expression;if(v.type==="ref"){const k=Oa(t,v,s);if(k){w=k.collection;const I=k.path[0],A=Qf(_,w);I&&gp(I,k.path,w,A,l),g=gr(new zs(k.path),!0),p=oc(w,k.path,A),p?.supports("gt")||(p=void 0),m=v.path.length>1?String(v.path[0]):t.from.alias}}if(g){const I=n.every(K=>K.expression.type==="ref")?n.map(K=>{const O=K.expression,N=Oa(t,O,s);return gr(N?new zs(N.path):K.expression,!0)}):void 0;f={alias:m,offset:a??0,limit:c,comparator:(K,O)=>{if(n.length===1){const N=K&&g(K),W=O&&g(O);return l(N,W)}if(I){const N=W=>W&&I.map(q=>q(W));return l(N(K),N(O))}return 0},valueExtractorForRawRow:K=>{if(n.length===1)return g(K);if(I)return I.map(O=>O(K))},firstColumnValueExtractor:g,index:p,orderBy:n};const D=w?.id??s.id;i[D]=f,p&&(d=K=>{i[D].dataNeeded=()=>{const O=K();return Math.max(0,f.limit-O)}})}}return e.pipe(hC(h,{limit:c,offset:a,comparator:l,setSizeCallback:d,setWindowFn:p=>{o(w=>{p(w),f&&(f.offset=w.offset??f.offset,f.limit=w.limit??f.limit)})}}))}function Qf(t,e){return t.compareOptions.stringSort!==void 0?t.compareOptions:{...e.compareOptions,direction:t.compareOptions.direction,nulls:t.compareOptions.nulls}}function CC(t,e={}){const n=r=>{const s=[];for(const[i,o]of t.entries())(r?.(o)??!0)&&s.push({type:"insert",key:i,value:o});return s};if(e.limit!==void 0&&!e.orderBy)throw new Error("limit cannot be used without orderBy");if(e.orderBy){const r=e.where?bo(e.where):void 0,s=MC(t,e.orderBy,e.limit,r,e.optimizedOnly);if(s===void 0)return;const i=[];for(const o of s){const c=t.get(o);c!==void 0&&i.push({type:"insert",key:o,value:c})}return i}if(!e.where)return n();try{const r=e.where,s=uR(r,t);if(s.canOptimize){const i=[];for(const o of s.matchingKeys){const c=t.get(o);c!==void 0&&i.push({type:"insert",key:o,value:c})}return i}else{if(e.optimizedOnly)return;const i=bo(r);return n(i)}}catch(r){console.warn(`${t.id?`[${t.id}] `:""}Error processing where clause, falling back to full scan:`,r);const s=bo(e.where);return e.optimizedOnly?void 0:n(s)}}function bo(t){const e=lp(t);return n=>{try{const r=e(n);return ha(r)}catch{return!1}}}function OC(t,e){const n=bo(e.whereExpression);return r=>{const s=[];for(const i of r)if(i.type==="insert")n(i.value)&&s.push(i);else if(i.type==="update"){const o=n(i.value),c=i.previousValue?n(i.previousValue):!1;o&&c?s.push(i):o&&!c?s.push({...i,type:"insert"}):!o&&c&&s.push({...i,type:"delete",value:i.previousValue})}else n(i.value)&&s.push(i);(s.length>0||r.length===0)&&t(s)}}function MC(t,e,n,r,s){if(e.length===1){const a=e[0],u=a.expression;if(u.type==="ref"){const l=u.path,d=Qf(a,t);gp(l[0],l,t,d);const f=oc(t,l,d);if(f&&f.supports("gt")){const p=w=>{const g=t.get(w);return g===void 0?!1:r?.(g)??!0};return f.take(n??f.keyCount,void 0,p)}}}if(s)return;const i=[];for(const[a,u]of t.entries())(r?.(u)??!0)&&i.push({key:a,value:u});const o=(a,u)=>{for(const h of e){const l=Ma(h.compareOptions),d=um(a.value,h.expression),f=um(u.value,h.expression),p=l(d,f);if(p!==0)return p}return 0};i.sort(o);const c=i.map(a=>a.key);return n!==void 0?c.slice(0,n):c}function um(t,e){if(e.type==="ref"){const n=e;let r=t;for(const s of n.path)r=r?.[s];return r}else return e.type==="val"?e.value:lp(e)(t)}class lm{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e}indexOf(e,n){let r=0,s=this.sortedKeys.length;if(!this.comparator){for(;r<s;){const i=Math.floor((r+s)/2),o=this.sortedKeys[i],c=Da(e,o);if(c<0)s=i;else if(c>0)r=i+1;else return i}return r}for(;r<s;){const i=Math.floor((r+s)/2),o=this.sortedKeys[i],c=this.map.get(o),a=this.comparator(n,c);if(a<0)s=i;else if(a>0)r=i+1;else{const u=Da(e,o);if(u<0)s=i;else if(u>0)r=i+1;else return i}}return r}set(e,n){if(this.map.has(e)){const s=this.map.get(e),i=this.indexOf(e,s);this.sortedKeys.splice(i,1)}const r=this.indexOf(e,n);return this.sortedKeys.splice(r,0,e),this.map.set(e,n),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){const n=this.map.get(e),r=this.indexOf(e,n);return this.sortedKeys.splice(r,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(const e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(const e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(const n of this.sortedKeys)e(this.map.get(n),n,this.map)}}class LC{constructor(e){this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this.size=0,this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.commitPendingTransactions=()=>{let n=!1;for(const o of this.transactions.values())if(o.state==="persisting"){n=!0;break}const{committedSyncedTransactions:r,uncommittedSyncedTransactions:s,hasTruncateSync:i}=this.pendingSyncedTransactions.reduce((o,c)=>(c.committed?(o.committedSyncedTransactions.push(c),c.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(c),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!n||i){this.isCommittingSyncTransactions=!0;const o=i?r.find(d=>d.truncate)?.optimisticSnapshot:null,c=new Set;for(const d of r)for(const f of d.operations)c.add(f.key);let a=this.preSyncVisibleState;if(a.size===0){a=new Map;for(const d of c){const f=this.get(d);f!==void 0&&a.set(d,f)}}const u=[],h=this.config.sync.rowUpdateMode||"partial";for(const d of r){if(d.truncate){const f=new Set([...this.syncedData.keys(),...o?.upserts.keys()||[]]);for(const p of f){if(o?.deletes.has(p))continue;const w=o?.upserts.get(p)||this.syncedData.get(p);w!==void 0&&u.push({type:"delete",key:p,value:w})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear();for(const p of c)a.delete(p);this._events.emit("truncate",{type:"truncate",collection:this.collection})}for(const f of d.operations){const p=f.key;switch(this.syncedKeys.add(p),f.type){case"insert":this.syncedMetadata.set(p,f.metadata);break;case"update":this.syncedMetadata.set(p,Object.assign({},this.syncedMetadata.get(p),f.metadata));break;case"delete":this.syncedMetadata.delete(p);break}switch(f.type){case"insert":this.syncedData.set(p,f.value);break;case"update":{if(h==="partial"){const w=Object.assign({},this.syncedData.get(p),f.value);this.syncedData.set(p,w)}else this.syncedData.set(p,f.value);break}case"delete":this.syncedData.delete(p);break}}}if(i){const d=new Set;for(const w of r)for(const g of w.operations)(g.type==="insert"||g.type==="update")&&d.add(g.key);const f=new Map(o.upserts),p=new Set(o.deletes);for(const[w,g]of f)if(!p.has(w))if(d.has(w)){let m=!1;for(let _=u.length-1;_>=0;_--){const v=u[_];if(v.key===w&&v.type==="insert"){v.value=g,m=!0;break}}m||u.push({type:"insert",key:w,value:g})}else u.push({type:"insert",key:w,value:g});if(u.length>0&&p.size>0){const w=[];for(const g of u)g.type==="insert"&&p.has(g.key)||w.push(g);u.length=0,u.push(...w)}this.lifecycle.status!=="ready"&&this.lifecycle.markReady()}if(this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1,i&&o){for(const[d,f]of o.upserts)this.optimisticUpserts.set(d,f);for(const d of o.deletes)this.optimisticDeletes.add(d)}for(const d of this.transactions.values())if(!["completed","failed"].includes(d.state)){for(const f of d.mutations)if(this.isThisCollection(f.collection)&&f.optimistic)switch(f.type){case"insert":case"update":this.optimisticUpserts.set(f.key,f.modified),this.optimisticDeletes.delete(f.key);break;case"delete":this.optimisticUpserts.delete(f.key),this.optimisticDeletes.add(f.key);break}}const l=new Map;for(const d of this.transactions.values())if(d.state==="completed")for(const f of d.mutations)f.optimistic&&this.isThisCollection(f.collection)&&c.has(f.key)&&l.set(f.key,{type:f.type,value:f.modified});for(const d of c){const f=a.get(d),p=this.get(d),w=l.get(d);let g=!1;w&&(w.type==="delete"&&f!==void 0&&p===void 0&&Bn(w.value,f)||p!==void 0&&Bn(w.value,p))&&(g=!0),g||(f===void 0&&p!==void 0?u.push({type:"insert",key:d,value:p}):f!==void 0&&p===void 0?u.push({type:"delete",key:d,value:f}):f!==void 0&&p!==void 0&&!Bn(f,p)&&u.push({type:"update",key:d,value:p,previousValue:f}))}this.size=this.calculateSize(),u.length>0&&this.indexes.updateIndexes(u),this.changes.emitEvents(u,!0),this.pendingSyncedTransactions=s,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0)}},this.config=e,this.transactions=new lm((n,r)=>n.compareCreatedAt(r)),this.syncedData=new lm(e.compare)}setDeps(e){this.collection=e.collection,this.lifecycle=e.lifecycle,this.changes=e.changes,this.indexes=e.indexes,this._events=e.events}get(e){const{optimisticDeletes:n,optimisticUpserts:r,syncedData:s}=this;if(!n.has(e))return r.has(e)?r.get(e):s.get(e)}has(e){const{optimisticDeletes:n,optimisticUpserts:r,syncedData:s}=this;return n.has(e)?!1:r.has(e)?!0:s.has(e)}*keys(){const{syncedData:e,optimisticDeletes:n,optimisticUpserts:r}=this;for(const s of e.keys())n.has(s)||(yield s);for(const s of r.keys())!e.has(s)&&!n.has(s)&&(yield s)}*values(){for(const e of this.keys()){const n=this.get(e);n!==void 0&&(yield n)}}*entries(){for(const e of this.keys()){const n=this.get(e);n!==void 0&&(yield[e,n])}}*[Symbol.iterator](){for(const[e,n]of this.entries())yield[e,n]}forEach(e){let n=0;for(const[r,s]of this.entries())e(s,r,n++)}map(e){const n=[];let r=0;for(const[s,i]of this.entries())n.push(e(i,s,r++));return n}isThisCollection(e){return e===this.collection}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions&&!e)return;const n=new Map(this.optimisticUpserts),r=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();const s=[];for(const c of this.transactions.values())["completed","failed"].includes(c.state)||s.push(c);for(const c of s)for(const a of c.mutations)if(this.isThisCollection(a.collection)&&a.optimistic)switch(a.type){case"insert":case"update":this.optimisticUpserts.set(a.key,a.modified),this.optimisticDeletes.delete(a.key);break;case"delete":this.optimisticUpserts.delete(a.key),this.optimisticDeletes.add(a.key);break}this.size=this.calculateSize();const i=[];this.collectOptimisticChanges(n,r,i);const o=i.filter(c=>!!(!this.recentlySyncedKeys.has(c.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){const c=new Set;for(const u of this.pendingSyncedTransactions)for(const h of u.operations)c.add(h.key);const a=o.filter(u=>!(u.type==="delete"&&c.has(u.key)&&!s.some(l=>l.mutations.some(d=>this.isThisCollection(d.collection)&&d.key===u.key))));a.length>0&&this.indexes.updateIndexes(a),this.changes.emitEvents(a,e)}else o.length>0&&this.indexes.updateIndexes(o),this.changes.emitEvents(o,e)}calculateSize(){const e=this.syncedData.size,n=Array.from(this.optimisticDeletes).filter(s=>this.syncedData.has(s)&&!this.optimisticUpserts.has(s)).length,r=Array.from(this.optimisticUpserts.keys()).filter(s=>!this.syncedData.has(s)).length;return e-n+r}collectOptimisticChanges(e,n,r){const s=new Set([...e.keys(),...this.optimisticUpserts.keys(),...n,...this.optimisticDeletes]);for(const i of s){const o=this.get(i),c=this.getPreviousValue(i,e,n);c!==void 0&&o===void 0?r.push({type:"delete",key:i,value:c}):c===void 0&&o!==void 0?r.push({type:"insert",key:i,value:o}):c!==void 0&&o!==void 0&&c!==o&&r.push({type:"update",key:i,value:o,previousValue:c})}}getPreviousValue(e,n,r){if(!r.has(e))return n.has(e)?n.get(e):this.syncedData.get(e)}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;const e=new Set;for(const n of this.pendingSyncedTransactions)for(const r of n.operations)e.add(r.key);for(const n of e)this.recentlySyncedKeys.add(n);for(const n of e)if(!this.preSyncVisibleState.has(n)){const r=this.get(n);r!==void 0&&this.preSyncVisibleState.set(n,r)}}onTransactionStateChange(){this.changes.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}cleanup(){this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1}}class ES{constructor(){this.listeners=new Map}on(e,n){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(n),()=>{this.listeners.get(e)?.delete(n)}}once(e,n){const r=this.on(e,s=>{n(s),r()});return r}off(e,n){this.listeners.get(e)?.delete(n)}waitFor(e,n){return new Promise((r,s)=>{let i;const o=this.on(e,c=>{i&&(clearTimeout(i),i=void 0),r(c),o()});n&&(i=setTimeout(()=>{i=void 0,o(),s(new Error(`Timeout waiting for event ${String(e)}`))},n))})}emitInner(e,n){this.listeners.get(e)?.forEach(r=>{try{r(n)}catch(s){queueMicrotask(()=>{throw s})}})}clearListeners(){this.listeners.clear()}}function DC(t,e){if(e.length===0||t.length===0)return;if(t.length===1){const{expression:r,compareOptions:s}=t[0];return(s.direction==="asc"?cm:Wf)(r,new $n(e[0]))}const n=[];for(let r=0;r<t.length&&r<e.length;r++){const s=t[r],i=e[r],o=[];for(let u=0;u<r;u++){const h=t[u],l=e[u];o.push(Kf(h.expression,new $n(l)))}const a=(s.compareOptions.direction==="asc"?cm:Wf)(s.expression,new $n(i));if(o.length===0)n.push(a);else{const u=[...o,a];n.push(u.reduce((h,l)=>zf(h,l)))}}return n.length===1?n[0]:n.reduce((r,s)=>bC(r,s))}class FC extends ES{constructor(e,n,r){super(),this.collection=e,this.callback=n,this.options=r,this.loadedInitialState=!1,this.skipFiltering=!1,this.snapshotSent=!1,this.loadedSubsets=[],this.sentKeys=new Set,this.limitedSnapshotRowCount=0,this._status="ready",this.pendingLoadSubsetPromises=new Set,this.isBufferingForTruncate=!1,this.truncateBuffer=[],this.pendingTruncateRefetches=new Set,r.onUnsubscribe&&this.on("unsubscribed",i=>r.onUnsubscribe(i)),r.whereExpression&&SC(r.whereExpression,this.collection);const s=i=>{n(i),this.trackSentKeys(i)};this.callback=s,this.filteredCallback=r.whereExpression?OC(this.callback,r):this.callback,this.truncateCleanup=this.collection.on("truncate",()=>{this.handleTruncate()})}get status(){return this._status}handleTruncate(){const e=[...this.loadedSubsets],n=this.collection._sync.syncLoadSubsetFn!==null;if(e.length===0||!n){this.snapshotSent=!1,this.loadedInitialState=!1,this.limitedSnapshotRowCount=0,this.lastSentKey=void 0,this.loadedSubsets=[];return}this.isBufferingForTruncate=!0,this.truncateBuffer=[],this.pendingTruncateRefetches.clear(),this.snapshotSent=!1,this.loadedInitialState=!1,this.limitedSnapshotRowCount=0,this.lastSentKey=void 0,this.loadedSubsets=[],queueMicrotask(()=>{if(this.isBufferingForTruncate){for(const r of e){const s=this.collection._sync.loadSubset(r);this.loadedSubsets.push(r),this.trackLoadSubsetPromise(s),s instanceof Promise&&(this.pendingTruncateRefetches.add(s),s.catch(()=>{}).finally(()=>{this.pendingTruncateRefetches.delete(s),this.checkTruncateRefetchComplete()}))}this.pendingTruncateRefetches.size===0&&this.flushTruncateBuffer()}})}checkTruncateRefetchComplete(){this.pendingTruncateRefetches.size===0&&this.isBufferingForTruncate&&this.flushTruncateBuffer()}flushTruncateBuffer(){this.isBufferingForTruncate=!1;const e=this.truncateBuffer.flat();e.length>0&&this.filteredCallback(e),this.truncateBuffer=[]}setOrderByIndex(e){this.orderByIndex=e}setStatus(e){if(this._status===e)return;const n=this._status;this._status=e,this.emitInner("status:change",{type:"status:change",subscription:this,previousStatus:n,status:e});const r=`status:${e}`;this.emitInner(r,{type:r,subscription:this,previousStatus:n,status:e})}trackLoadSubsetPromise(e){e instanceof Promise&&(this.pendingLoadSubsetPromises.add(e),this.setStatus("loadingSubset"),e.finally(()=>{this.pendingLoadSubsetPromises.delete(e),this.pendingLoadSubsetPromises.size===0&&this.setStatus("ready")}))}hasLoadedInitialState(){return this.loadedInitialState}hasSentAtLeastOneSnapshot(){return this.snapshotSent}emitEvents(e){const n=this.filterAndFlipChanges(e);this.isBufferingForTruncate?n.length>0&&this.truncateBuffer.push(n):this.filteredCallback(n)}requestSnapshot(e){if(this.loadedInitialState)return!1;const n={where:this.options.whereExpression,optimizedOnly:e?.optimizedOnly??!1};if(e){if("where"in e){const a=e.where;if(n.where){const u=n.where,h=zf(u,a);n.where=h}else n.where=a}}else this.loadedInitialState=!0;const r={where:n.where,subscription:this,orderBy:e?.orderBy,limit:e?.limit},s=this.collection._sync.loadSubset(r);this.loadedSubsets.push(r),(e?.trackLoadSubsetPromise??!0)&&this.trackLoadSubsetPromise(s);const o=this.collection.currentStateAsChanges(n);if(o===void 0)return!1;const c=o.filter(a=>!this.sentKeys.has(a.key));for(const a of c)this.sentKeys.add(a.key);return this.snapshotSent=!0,this.callback(c),!0}requestLimitedSnapshot({orderBy:e,limit:n,minValues:r,offset:s}){if(!n)throw new Error("limit is required");if(!this.orderByIndex)throw new Error("Ordered snapshot was requested but no index was found. You have to call setOrderByIndex before requesting an ordered snapshot.");const o=r?.[0],c=this.orderByIndex,a=this.options.whereExpression,u=a?bo(a):void 0,h=k=>{if(this.sentKeys.has(k))return!1;const I=this.collection.get(k);return I===void 0?!1:u?.(I)??!0};let l=o;const d=[];let f=[];if(o!==void 0){const{expression:k}=e[0],I=this.collection.currentStateAsChanges({where:Kf(k,new $n(o))});if(I){const A=I.map(D=>D.key).filter(D=>!this.sentKeys.has(D)&&h(D));f.push(...A);const L=c.take(n-f.length,o,h);f.push(...L)}else f=c.take(n,o,h)}else f=c.take(n,o,h);const p=()=>Math.max(n-d.length,0),w=()=>f.length===0;for(;p()>0&&!w();){const k=new Set;for(const I of f){const A=this.collection.get(I);d.push({type:"insert",key:I,value:A}),l=A,k.add(I)}f=c.take(p(),l,h)}const g=this.limitedSnapshotRowCount;for(const k of d)this.sentKeys.add(k.key);this.callback(d),this.limitedSnapshotRowCount+=d.length,d.length>0&&(this.lastSentKey=d[d.length-1].key);let m;if(r!==void 0&&r.length>0){const k=DC(e,r);if(k){const{expression:I}=e[0],A=r[0];let L;if(A instanceof Date){const D=new Date(A.getTime()+1);L=zf(wC(I,new $n(A)),Wf(I,new $n(D)))}else L=Kf(I,new $n(A));m={whereFrom:k,whereCurrent:L,lastKey:this.lastSentKey}}}const _={where:a,limit:n,orderBy:e,cursor:m,offset:s??g,subscription:this},v=this.collection._sync.loadSubset(_);this.loadedSubsets.push(_),this.trackLoadSubsetPromise(v)}filterAndFlipChanges(e){if(this.loadedInitialState||this.skipFiltering)return e;const n=this.isBufferingForTruncate,r=[];for(const s of e){let i=s;if(this.sentKeys.has(s.key)){if(s.type==="insert")continue;s.type==="delete"&&this.sentKeys.delete(s.key)}else{if(s.type==="update")i={...s,type:"insert",previousValue:void 0};else if(s.type==="delete"&&!n)continue;this.sentKeys.add(s.key)}r.push(i)}return r}trackSentKeys(e){if(!(this.loadedInitialState||this.skipFiltering))for(const n of e)n.type==="delete"?this.sentKeys.delete(n.key):this.sentKeys.add(n.key)}markAllStateAsSeen(){this.skipFiltering=!0}unsubscribe(){this.truncateCleanup?.(),this.truncateCleanup=void 0,this.isBufferingForTruncate=!1,this.truncateBuffer=[],this.pendingTruncateRefetches.clear();for(const e of this.loadedSubsets)this.collection._sync.unloadSubset(e);this.loadedSubsets=[],this.emitInner("unsubscribed",{type:"unsubscribed",subscription:this}),this.clearListeners()}}class NC{constructor(){this.activeSubscribersCount=0,this.changeSubscriptions=new Set,this.batchedEvents=[],this.shouldBatchEvents=!1}setDeps(e){this.lifecycle=e.lifecycle,this.sync=e.sync,this.events=e.events,this.collection=e.collection}emitEmptyReadyEvent(){for(const e of this.changeSubscriptions)e.emitEvents([])}emitEvents(e,n=!1){if(this.shouldBatchEvents&&!n){this.batchedEvents.push(...e);return}let r=e;if(n&&(this.batchedEvents.length>0&&(r=[...this.batchedEvents,...e]),this.batchedEvents=[],this.shouldBatchEvents=!1),r.length!==0)for(const s of this.changeSubscriptions)s.emitEvents(r)}subscribeChanges(e,n={}){this.addSubscriber();const r=new FC(this.collection,e,{...n,onUnsubscribe:()=>{this.removeSubscriber(),this.changeSubscriptions.delete(r)}});return n.includeInitialState?r.requestSnapshot({trackLoadSubsetPromise:!1}):n.includeInitialState===!1&&r.markAllStateAsSeen(),this.changeSubscriptions.add(r),r}addSubscriber(){const e=this.activeSubscribersCount;this.activeSubscribersCount++,this.lifecycle.cancelGCTimer(),(this.lifecycle.status==="cleaned-up"||this.lifecycle.status==="idle")&&this.sync.startSync(),this.events.emitSubscribersChange(this.activeSubscribersCount,e)}removeSubscriber(){const e=this.activeSubscribersCount;if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.lifecycle.startGCTimer();else if(this.activeSubscribersCount<0)throw new vA;this.events.emitSubscribersChange(this.activeSubscribersCount,e)}cleanup(){this.batchedEvents=[],this.shouldBatchEvents=!1}}const PC=t=>setTimeout(()=>{t({didTimeout:!0,timeRemaining:()=>50})},0),$C=t=>{clearTimeout(t)},BC=typeof window<"u"&&"requestIdleCallback"in window?(t,e)=>window.requestIdleCallback(t,e):(t,e)=>PC(t),Wl=typeof window<"u"&&"cancelIdleCallback"in window?t=>window.cancelIdleCallback(t):$C;class qC{constructor(e,n){this.status="idle",this.hasBeenReady=!1,this.hasReceivedFirstCommit=!1,this.onFirstReadyCallbacks=[],this.gcTimeoutId=null,this.idleCallbackId=null,this.config=e,this.id=n}setDeps(e){this.indexes=e.indexes,this.events=e.events,this.changes=e.changes,this.sync=e.sync,this.state=e.state}validateStatusTransition(e,n){if(e===n)return;if(!{idle:["loading","error","cleaned-up"],loading:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(n))throw new SA(e,n,this.id)}setStatus(e,n=!1){if(e==="ready"&&!n)throw new ic(`You can't directly call "setStatus('ready'). You must use markReady instead.`);this.validateStatusTransition(this.status,e);const r=this.status;this.status=e,e==="ready"&&!this.indexes.isIndexesResolved&&this.indexes.resolveAllIndexes().catch(s=>{console.warn(`${this.config.id?`[${this.config.id}] `:""}Failed to resolve indexes:`,s)}),this.events.emitStatusChange(e,r)}validateCollectionUsable(e){switch(this.status){case"error":throw new _A(e,this.id);case"cleaned-up":this.sync.startSync();break}}markReady(){if(this.validateStatusTransition(this.status,"ready"),this.status==="loading"){if(this.setStatus("ready",!0),!this.hasBeenReady){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);const e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(n=>n())}this.changes.changeSubscriptions.size>0&&this.changes.emitEmptyReadyEvent()}}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);const e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.changes.activeSubscribersCount===0&&this.scheduleIdleCleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.idleCallbackId!==null&&(Wl(this.idleCallbackId),this.idleCallbackId=null)}scheduleIdleCleanup(){this.idleCallbackId!==null&&Wl(this.idleCallbackId),this.idleCallbackId=BC(e=>{this.changes.activeSubscribersCount===0?this.performCleanup(e)&&(this.idleCallbackId=null):this.idleCallbackId=null},{timeout:1e3})}performCleanup(e){return!e||e.timeRemaining()>0||e.didTimeout?(this.sync.cleanup(),this.state.cleanup(),this.changes.cleanup(),this.indexes.cleanup(),this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null),this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.setStatus("cleaned-up"),this.events.cleanup(),!0):(this.scheduleIdleCleanup(),!1)}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}cleanup(){this.idleCallbackId!==null&&(Wl(this.idleCallbackId),this.idleCallbackId=null),this.performCleanup()}}const UC=Symbol("liveQueryInternal");class VC{constructor(e,n){this.preloadPromise=null,this.syncCleanupFn=null,this.syncLoadSubsetFn=null,this.syncUnloadSubsetFn=null,this.pendingLoadSubsetPromises=new Set,this.config=e,this.id=n,this.syncMode=e.syncMode??"eager"}setDeps(e){this.collection=e.collection,this.state=e.state,this.lifecycle=e.lifecycle,this._events=e.events}startSync(){if(!(this.lifecycle.status!=="idle"&&this.lifecycle.status!=="cleaned-up")){this.lifecycle.setStatus("loading");try{const e=jC(this.config.sync.sync({collection:this.collection,begin:()=>{this.state.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:n=>{const r=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!r)throw new Wy;if(r.committed)throw new zy;let s;"key"in n?s=n.key:s=this.config.getKey(n.value);let i=n.type;if(n.type==="insert"){const c=this.state.syncedData.has(s),a=r.deletedKeys.has(s),u=r.truncate===!0;if(c&&!a&&!u){const h=this.state.syncedData.get(s);if(h!==void 0&&Bn(h,n.value))i="update";else{const d=this.config.utils[UC];throw new TA(s,this.id,{hasCustomGetKey:d?.hasCustomGetKey??!1,hasJoins:d?.hasJoins??!1})}}}const o={...n,type:i,key:s};r.operations.push(o),i==="delete"&&r.deletedKeys.add(s)},commit:()=>{const n=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!n)throw new UA;if(n.committed)throw new VA;n.committed=!0,this.state.commitPendingTransactions()},markReady:()=>{this.lifecycle.markReady()},truncate:()=>{const n=this.state.pendingSyncedTransactions[this.state.pendingSyncedTransactions.length-1];if(!n)throw new Wy;if(n.committed)throw new zy;n.operations=[],n.deletedKeys.clear(),n.truncate=!0,n.optimisticSnapshot={upserts:new Map(this.state.optimisticUpserts),deletes:new Set(this.state.optimisticDeletes)}}}));if(this.syncCleanupFn=e?.cleanup??null,this.syncLoadSubsetFn=e?.loadSubset??null,this.syncUnloadSubsetFn=e?.unloadSubset??null,this.syncMode==="on-demand"&&!this.syncLoadSubsetFn)throw new sc(`Collection "${this.id}" is configured with syncMode "on-demand" but the sync function did not return a loadSubset handler. Either provide a loadSubset handler or use syncMode "eager".`)}catch(e){throw this.lifecycle.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.syncMode==="on-demand"&&console.warn(`${this.id?`[${this.id}] `:""}Calling .preload() on a collection with syncMode "on-demand" is a no-op. In on-demand mode, data is only loaded when queries request it. Instead, create a live query and call .preload() on that to load the specific data you need. See https://tanstack.com/blog/tanstack-db-0.5-query-driven-sync for more details.`),this.preloadPromise=new Promise((e,n)=>{if(this.lifecycle.status==="ready"){e();return}if(this.lifecycle.status==="error"){n(new EA);return}if(this.lifecycle.onFirstReady(()=>{e()}),this.lifecycle.status==="idle"||this.lifecycle.status==="cleaned-up")try{this.startSync()}catch(r){n(r);return}}),this.preloadPromise)}get isLoadingSubset(){return this.pendingLoadSubsetPromises.size>0}trackLoadPromise(e){const n=!this.isLoadingSubset;this.pendingLoadSubsetPromises.add(e),n&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!0,previousIsLoadingSubset:!1,loadingSubsetTransition:"start"}),e.finally(()=>{const r=this.pendingLoadSubsetPromises.size===1&&this.pendingLoadSubsetPromises.has(e);this.pendingLoadSubsetPromises.delete(e),r&&this._events.emit("loadingSubset:change",{type:"loadingSubset:change",collection:this.collection,isLoadingSubset:!1,previousIsLoadingSubset:!0,loadingSubsetTransition:"end"})})}loadSubset(e){if(this.syncMode==="eager")return!0;if(this.syncLoadSubsetFn){const n=this.syncLoadSubsetFn(e);if(n instanceof Promise)return this.trackLoadPromise(n),n}return!0}unloadSubset(e){this.syncUnloadSubsetFn&&this.syncUnloadSubsetFn(e)}cleanup(){try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){const n=new Hy(this.id,e);throw n.cause=e,n.stack=e.stack,n}else throw new Hy(this.id,e)})}this.preloadPromise=null}}function jC(t){if(typeof t=="function")return{cleanup:t};if(typeof t=="object")return t}function vS(t){return typeof t=="function"&&t.prototype!==void 0&&t.prototype.constructor===t}async function KC(t){return vS(t)?t:await t()}class WC{constructor(e,n,r,s,i,o){this.id=e,this.expression=n,this.name=r,this.resolver=s,this.options=i,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,vS(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){const e=await KC(this.resolver);return new e(this.id,this.expression,this.name,this.options)}}class zC{constructor(e,n){this.indexId=e,this.lazyIndex=n}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){const n=this.expression;return n.type==="ref"&&n.path.length===e.length&&n.path.every((r,s)=>r===e[s])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){return this.index.equalityLookup?.(e)??new Set}rangeQuery(e){return this.index.rangeQuery?.(e)??new Set}inArrayLookup(e){return this.index.inArrayLookup?.(e)??new Set}_getLazyWrapper(){return this.lazyIndex}}class HC{constructor(){this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0}setDeps(e){this.state=e.state,this.lifecycle=e.lifecycle}createIndex(e,n={}){this.lifecycle.validateCollectionUsable("createIndex");const r=++this.indexCounter,s=yC(),i=e(s),o=zt(i),c=n.indexType??Hf,a=new WC(r,o,n.name,c,n.options,this.state.entries());if(this.lazyIndexes.set(r,a),c===Hf)try{const u=a.getResolved();this.resolvedIndexes.set(r,u)}catch(u){console.warn("Failed to resolve BTreeIndex:",u)}else if(typeof c=="function"&&c.prototype)try{const u=a.getResolved();this.resolvedIndexes.set(r,u)}catch{this.resolveSingleIndex(r,a).catch(u=>{console.warn("Failed to resolve single index:",u)})}else this.isIndexesResolved&&this.resolveSingleIndex(r,a).catch(u=>{console.warn("Failed to resolve single index:",u)});return new zC(r,a)}async resolveAllIndexes(){if(this.isIndexesResolved)return;const e=Array.from(this.lazyIndexes.entries()).map(async([n,r])=>{const s=await r.resolve();return s.build(this.state.entries()),this.resolvedIndexes.set(n,s),{indexId:n,resolvedIndex:s}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,n){const r=await n.resolve();return r.build(this.state.entries()),this.resolvedIndexes.set(e,r),r}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(const n of this.resolvedIndexes.values())for(const r of e)switch(r.type){case"insert":n.add(r.key,r.value);break;case"update":r.previousValue?n.update(r.key,r.previousValue,r.value):n.add(r.key,r.value);break;case"delete":n.remove(r.key,r.value);break}}cleanup(){this.lazyIndexes.clear(),this.resolvedIndexes.clear()}}var QC={};const GC=new Set(["find","findLast","findIndex","findLastIndex","filter","map","flatMap","forEach","some","every","reduce","reduceRight"]),JC=new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]),YC=new Set(["set","delete","clear","add"]),XC=new Set(["entries","keys","values","forEach"]);function yp(t){return t!==null&&typeof t=="object"&&!(t instanceof Date)&&!(t instanceof RegExp)&&!La(t)}function ZC(t,e,n,r){if(GC.has(t))return function(...s){const i=s[0];if(typeof i!="function")return e.apply(n.copy_,s);const o=(u,h)=>{if(yp(u)){const l={tracker:n,prop:String(h)},{proxy:d}=r(u,l);return d}return u},c=function(u,h,l){const d=o(u,h);return i.call(this,d,h,l)};if(t==="reduce"||t==="reduceRight"){const u=function(h,l,d,f){const p=o(l,d);return i.call(this,h,p,d,f)};return e.apply(n.copy_,[u,...s.slice(1)])}const a=e.apply(n.copy_,[c,...s.slice(1)]);if((t==="find"||t==="findLast")&&a&&typeof a=="object"){const u=n.copy_.indexOf(a);if(u!==-1)return o(a,u)}return t==="filter"&&Array.isArray(a)?a.map(u=>{const h=n.copy_.indexOf(u);return h!==-1?o(u,h):u}):a}}function eO(t,e){return function(){const n=t.copy_;let r=0;return{next(){if(r>=n.length)return{done:!0,value:void 0};const s=n[r];let i=s;if(yp(s)){const o={tracker:t,prop:String(r)},{proxy:c}=e(s,o);i=c}return r++,{done:!1,value:i}},[Symbol.iterator](){return this}}}}function hm(t,e,n){return function(...r){const s=t.apply(e.copy_,r);return n(e),s}}function tO(t,e,n,r,s,i,o){if(XC.has(t)||e===Symbol.iterator)return function(...a){const u=n.apply(s.copy_,a);if(t==="forEach"){const l=a[0];if(typeof l=="function"){const d=function(f,p,w){const g=l.call(this,f,p,w);return o(s),g};return n.apply(r,[d,...a.slice(1)])}}if(t==="entries"||t==="values"||t===Symbol.iterator.toString()||e===Symbol.iterator){const l=u,d=new Map;if(t==="values"&&r instanceof Map)for(const[p,w]of s.copy_.entries())d.set(w,p);const f=new Map;if(r instanceof Set)for(const p of s.copy_.values())f.set(p,p);return{next(){const p=l.next();if(!p.done&&p.value&&typeof p.value=="object"){if(t==="entries"&&Array.isArray(p.value)&&p.value.length===2){if(p.value[1]&&typeof p.value[1]=="object"){const w=p.value[0],g={tracker:s,prop:w,updateMap:_=>{s.copy_ instanceof Map&&s.copy_.set(w,_)}},{proxy:m}=i(p.value[1],g);p.value[1]=m}}else if(t==="values"||t===Symbol.iterator.toString()||e===Symbol.iterator)if(t==="values"&&r instanceof Map){const w=d.get(p.value);if(w!==void 0){const g={tracker:s,prop:w,updateMap:_=>{s.copy_ instanceof Map&&s.copy_.set(w,_)}},{proxy:m}=i(p.value,g);p.value=m}}else if(r instanceof Set){const w=p.value,g={tracker:s,prop:w,updateSet:_=>{s.copy_ instanceof Set&&(s.copy_.delete(w),s.copy_.add(_),f.set(w,_))}},{proxy:m}=i(p.value,g);p.value=m}else{const w=Symbol("iterator-value"),{proxy:g}=i(p.value,{tracker:s,prop:w});p.value=g}}return p},[Symbol.iterator](){return this}}}return u}}function Pe(...t){const e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...t):!e&&typeof process<"u"&&QC.DEBUG==="true"&&console.log("[proxy]",...t)}function Nn(t,e=new WeakMap){if(t==null||typeof t!="object")return t;if(e.has(t))return e.get(t);if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t.source,t.flags);if(Array.isArray(t)){const s=[];return e.set(t,s),t.forEach((i,o)=>{s[o]=Nn(i,e)}),s}if(ArrayBuffer.isView(t)&&!(t instanceof DataView)){const s=Object.getPrototypeOf(t).constructor,i=new s(t.length);e.set(t,i);for(let o=0;o<t.length;o++)i[o]=t[o];return i}if(t instanceof Map){const s=new Map;return e.set(t,s),t.forEach((i,o)=>{s.set(o,Nn(i,e))}),s}if(t instanceof Set){const s=new Set;return e.set(t,s),t.forEach(i=>{s.add(Nn(i,e))}),s}if(La(t))return t;const n={};e.set(t,n);for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=Nn(t[s],e));const r=Object.getOwnPropertySymbols(t);for(const s of r)n[s]=Nn(t[s],e);return n}let fm=0;function nO(){return fm+=1,fm}function mp(t,e){const n=new Map;function r(l,d){if(Pe("Object ID:",l.constructor.name),n.has(l))return n.get(l);{const f=mp(l,d);return n.set(l,f),f}}const s=new Map,i={copy_:Nn(t),originalObject:Nn(t),proxyCount:nO(),modified:!1,assigned_:{},parent:e,target:t};Pe("createChangeProxy called for target",t,i.proxyCount);function o(l){l.modified||(l.modified=!0),l.parent&&(Pe("propagating change to parent"),"updateMap"in l.parent?l.parent.updateMap(l.copy_):"updateSet"in l.parent?l.parent.updateSet(l.copy_):(l.parent.tracker.copy_[l.parent.prop]=l.copy_,l.parent.tracker.assigned_[l.parent.prop]=!0),o(l.parent.tracker))}function c(l){if(Pe("checkIfReverted called with assigned keys:",Object.keys(l.assigned_)),Object.keys(l.assigned_).length===0&&Object.getOwnPropertySymbols(l.assigned_).length===0)return Pe("No assigned properties, returning true"),!0;for(const f in l.assigned_)if(l.assigned_[f]===!0){const p=l.copy_[f],w=l.originalObject[f];if(Pe(`Checking property ${String(f)}, current:`,p,"original:",w),!Bn(p,w))return Pe(`Property ${String(f)} is different, returning false`),!1}else if(l.assigned_[f]===!1)return Pe(`Property ${String(f)} was deleted, returning false`),!1;const d=Object.getOwnPropertySymbols(l.assigned_);for(const f of d)if(l.assigned_[f]===!0){const p=l.copy_[f],w=l.originalObject[f];if(!Bn(p,w))return Pe("Symbol property is different, returning false"),!1}else if(l.assigned_[f]===!1)return Pe("Symbol property was deleted, returning false"),!1;return Pe("All properties match original values, returning true"),!0}function a(l,d){Pe("checkParentStatus called for child prop:",d);const f=c(l);Pe("Parent checkIfReverted returned:",f),f&&(Pe("Parent is fully reverted, clearing tracking"),l.modified=!1,l.assigned_={},l.parent&&(Pe("Continuing up the parent chain"),a(l.parent.tracker,l.parent.prop)))}function u(l){if(Pe("createObjectProxy",l),s.has(l))return Pe("proxyCache found match"),s.get(l);const d=new Proxy(l,{get(f,p){Pe("get",f,p);const w=i.copy_[p]??i.originalObject[p],g=i.originalObject[p];if(Pe("value (at top of proxy get)",w),Object.getOwnPropertyDescriptor(f,p)?.get)return w;if(typeof w=="function"){if(Array.isArray(f)){const _=p.toString();if(JC.has(_))return hm(w,i,o);const v=ZC(_,w,i,r);if(v)return v;if(p===Symbol.iterator)return eO(i,r)}if(f instanceof Map||f instanceof Set){const _=p.toString();if(YC.has(_))return hm(w,i,o);const v=tO(_,p,w,f,i,r,o);if(v)return v}return w.bind(f)}if(yp(w)){const _={tracker:i,prop:String(p)},{proxy:v}=r(g,_);return s.set(w,v),v}return w},set(f,p,w){const g=i.copy_[p];if(Pe(`set called for property ${String(p)}, current:`,g,"new:",w),Bn(g,w))Pe("Value unchanged, not tracking");else{const m=i.originalObject[p],_=Bn(w,m);if(Pe("value:",w,"original:",m,"isRevertToOriginal:",_),_){Pe(`Reverting property ${String(p)} to original value`),delete i.assigned_[p.toString()],Pe(`Updating copy with original value for ${String(p)}`),i.copy_[p]=Nn(m),Pe("Checking if all properties reverted");const v=c(i);Pe("All reverted:",v),v?(Pe("All properties reverted, clearing tracking"),i.modified=!1,i.assigned_={},e&&(Pe("Updating parent for property:",e.prop),a(e.tracker,e.prop))):(Pe("Some properties still changed, keeping modified flag"),i.modified=!0)}else Pe(`Setting new value for property ${String(p)}`),i.copy_[p]=w,i.assigned_[p.toString()]=!0,Pe("Marking object and ancestors as modified",i),o(i)}return!0},defineProperty(f,p,w){const g=Reflect.defineProperty(f,p,w);return g&&"value"in w&&(i.copy_[p]=Nn(w.value),i.assigned_[p.toString()]=!0,o(i)),g},getOwnPropertyDescriptor(f,p){return Reflect.getOwnPropertyDescriptor(f,p)},preventExtensions(f){return Reflect.preventExtensions(f)},isExtensible(f){return Reflect.isExtensible(f)},deleteProperty(f,p){Pe("deleteProperty",f,p);const w=typeof p=="symbol"?p.toString():p;if(w in f){const g=w in i.originalObject,m=Reflect.deleteProperty(f,p);return m&&(g?(i.assigned_[w]=!1,o(i)):(delete i.assigned_[w],Object.keys(i.assigned_).length===0&&Object.getOwnPropertySymbols(i.assigned_).length===0?i.modified=!1:i.modified=!0)),m}return!0}});return s.set(l,d),d}return{proxy:u(i.copy_),getChanges:()=>{if(Pe("getChanges called, modified:",i.modified),Pe(i),!i.modified)return Pe("Object not modified, returning empty object"),{};if(typeof i.copy_!="object"||Array.isArray(i.copy_)||Object.keys(i.assigned_).length===0)return i.copy_;const l={};for(const d in i.copy_)i.assigned_[d]===!0&&d in i.copy_&&(l[d]=i.copy_[d]);return Pe("Returning copy:",l),l}}}function rO(t){const e=t.map(n=>mp(n));return{proxies:e.map(n=>n.proxy),getChanges:()=>e.map(n=>n.getChanges())}}function sO(t,e){const{proxy:n,getChanges:r}=mp(t);return e(n),r()}function iO(t,e){const{proxies:n,getChanges:r}=rO(t);return e(n),r()}function oO(){let t,e,n=!0;return{promise:new Promise((s,i)=>{t=o=>{n=!1,s(o)},e=o=>{n=!1,i(o)}}),resolve:t,reject:e,isPending:()=>n}}function cO(t){return typeof t=="object"&&t!==null&&typeof t.hasPendingGraphRun=="function"}class aO{constructor(){this.contexts=new Map,this.clearListeners=new Set}getOrCreateContext(e){let n=this.contexts.get(e);return n||(n={queue:[],jobs:new Map,dependencies:new Map,completed:new Set},this.contexts.set(e,n)),n}schedule({contextId:e,jobId:n,dependencies:r,run:s}){if(typeof e>"u"){s();return}const i=this.getOrCreateContext(e);if(i.jobs.has(n)||i.queue.push(n),i.jobs.set(n,s),r){const o=new Set(r);o.delete(n),i.dependencies.set(n,o)}else i.dependencies.has(n)||i.dependencies.set(n,new Set);i.completed.delete(n)}flush(e){const n=this.contexts.get(e);if(!n)return;const{queue:r,jobs:s,dependencies:i,completed:o}=n;for(;r.length>0;){let c=!1;const a=r.length;for(let u=0;u<a;u++){const h=r.shift(),l=s.get(h);if(!l){i.delete(h),o.delete(h);continue}const d=i.get(h);let f=!d;if(d){f=!0;for(const p of d){if(p===h)continue;const w=cO(p)&&p.hasPendingGraphRun(e);if(s.has(p)&&!o.has(p)||!s.has(p)&&w){f=!1;break}}}f?(s.delete(h),i.delete(h),l(),o.add(h),c=!0):r.push(h)}if(!c)throw new Error(`Scheduler detected unresolved dependencies for context ${String(e)}.`)}this.contexts.delete(e)}flushAll(){for(const e of Array.from(this.contexts.keys()))this.flush(e)}clear(e){this.contexts.delete(e),this.clearListeners.forEach(n=>n(e))}onClear(e){return this.clearListeners.add(e),()=>this.clearListeners.delete(e)}hasPendingJobs(e){const n=this.contexts.get(e);return!!n&&n.jobs.size>0}clearJob(e,n){const r=this.contexts.get(e);r&&(r.jobs.delete(n),r.dependencies.delete(n),r.completed.delete(n),r.queue=r.queue.filter(s=>s!==n),r.jobs.size===0&&this.contexts.delete(e))}}const kS=new aO,Ba=[];let Do=[],uO=0;function lO(t,e){switch(`${t.type}-${e.type}`){case"insert-update":return{...t,type:"insert",original:{},modified:e.modified,changes:{...t.changes,...e.changes},key:t.key,globalKey:t.globalKey,metadata:e.metadata??t.metadata,syncMetadata:{...t.syncMetadata,...e.syncMetadata},mutationId:e.mutationId,updatedAt:e.updatedAt};case"insert-delete":return null;case"update-delete":return e;case"update-update":return{...e,original:t.original,changes:{...t.changes,...e.changes},metadata:e.metadata??t.metadata,syncMetadata:{...t.syncMetadata,...e.syncMetadata}};case"delete-delete":case"insert-insert":return e;default:{const n=`${t.type}-${e.type}`;throw new Error(`Unhandled mutation combination: ${n}`)}}}function Nc(t){const e=new pO(t);return Ba.push(e),e}function zl(){if(Do.length>0)return Do.slice(-1)[0]}function hO(t){kS.clear(t.id),Do.push(t)}function fO(t){try{kS.flush(t.id)}finally{Do=Do.filter(e=>e.id!==t.id)}}function dO(t){const e=Ba.findIndex(n=>n.id===t.id);e!==-1&&Ba.splice(e,1)}let pO=class{constructor(e){if(typeof e.mutationFn>"u")throw new PA;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=oO(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=uO++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&dO(this)}mutate(e){if(this.state!=="pending")throw new $A;hO(this);try{e()}finally{fO(this)}return this.autoCommit&&this.commit().catch(()=>{}),this}applyMutations(e){for(const n of e){const r=this.mutations.findIndex(s=>s.globalKey===n.globalKey);if(r>=0){const s=this.mutations[r],i=lO(s,n);i===null?this.mutations.splice(r,1):this.mutations[r]=i}else this.mutations.push(n)}}rollback(e){const n=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new BA;if(this.setState("failed"),!n){const r=new Set;this.mutations.forEach(s=>r.add(s.globalKey));for(const s of Ba)s.state==="pending"&&s.mutations.some(i=>r.has(i.globalKey))&&s.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject(this.error?.error),this.touchCollection(),this}touchCollection(){const e=new Set;for(const n of this.mutations)e.has(n.collection.id)||(n.collection._state.onTransactionStateChange(),n.collection._state.pendingSyncedTransactions.length>0&&n.collection._state.commitPendingTransactions(),e.add(n.collection.id))}async commit(){if(this.state!=="pending")throw new qA;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){const n=e instanceof Error?e:new Error(String(e));throw this.error={message:n.message,error:n},this.rollback(),n}return this}compareCreatedAt(e){const n=this.createdAt.getTime()-e.createdAt.getTime();return n!==0?n:this.sequenceNumber-e.sequenceNumber}};class gO{constructor(e,n){this.insert=(r,s)=>{this.lifecycle.validateCollectionUsable("insert");const i=this.state,o=zl();if(!o&&!this.config.onInsert)throw new DA;const c=Array.isArray(r)?r:[r],a=[],u=new Set;if(c.forEach(h=>{const l=this.validateData(h,"insert"),d=this.config.getKey(l);if(this.state.has(d)||u.has(d))throw new IA(d);u.add(d);const f=this.generateGlobalKey(d,h),p={mutationId:crypto.randomUUID(),original:{},modified:l,changes:Object.fromEntries(Object.keys(h).map(w=>[w,l[w]])),globalKey:f,key:d,metadata:s?.metadata,syncMetadata:this.config.sync.getSyncMetadata?.()||{},optimistic:s?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this.collection};a.push(p)}),o)return o.applyMutations(a),i.transactions.set(o.id,o),i.scheduleTransactionCleanup(o),i.recomputeOptimisticState(!0),o;{const h=Nc({mutationFn:async l=>await this.config.onInsert({transaction:l.transaction,collection:this.collection})});return h.applyMutations(a),h.commit().catch(()=>{}),i.transactions.set(h.id,h),i.scheduleTransactionCleanup(h),i.recomputeOptimisticState(!0),h}},this.delete=(r,s)=>{const i=this.state;this.lifecycle.validateCollectionUsable("delete");const o=zl();if(!o&&!this.config.onDelete)throw new NA;if(Array.isArray(r)&&r.length===0)throw new MA;const c=Array.isArray(r)?r:[r],a=[];for(const h of c){if(!this.state.has(h))throw new LA(h);const l=this.generateGlobalKey(h,this.state.get(h)),d={mutationId:crypto.randomUUID(),original:this.state.get(h),modified:this.state.get(h),changes:this.state.get(h),globalKey:l,key:h,metadata:s?.metadata,syncMetadata:i.syncedMetadata.get(h)||{},optimistic:s?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this.collection};a.push(d)}if(o)return o.applyMutations(a),i.transactions.set(o.id,o),i.scheduleTransactionCleanup(o),i.recomputeOptimisticState(!0),o;const u=Nc({autoCommit:!0,mutationFn:async h=>this.config.onDelete({transaction:h.transaction,collection:this.collection})});return u.applyMutations(a),u.commit().catch(()=>{}),i.transactions.set(u.id,u),i.scheduleTransactionCleanup(u),i.recomputeOptimisticState(!0),u},this.id=n,this.config=e}setDeps(e){this.lifecycle=e.lifecycle,this.state=e.state,this.collection=e.collection}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new bA}validateData(e,n,r){if(!this.config.schema)return e;const s=this.ensureStandardSchema(this.config.schema);if(n==="update"&&r){const o=this.state.get(r);if(o&&e&&typeof e=="object"&&typeof o=="object"){const c=Object.assign({},o,e),a=s["~standard"].validate(c);if(a instanceof Promise)throw new Ky;if("issues"in a&&a.issues){const d=a.issues.map(f=>({message:f.message,path:f.path?.map(p=>String(p))}));throw new jy(n,d)}const u=a.value,h=Object.keys(e);return Object.fromEntries(h.map(d=>[d,u[d]]))}}const i=s["~standard"].validate(e);if(i instanceof Promise)throw new Ky;if("issues"in i&&i.issues){const o=i.issues.map(c=>({message:c.message,path:c.path?.map(a=>String(a))}));throw new jy(n,o)}return i.value}generateGlobalKey(e,n){if(typeof e!="string"&&typeof e!="number")throw typeof e>"u"?new kA(n):new xA(e,n);return`KEY::${this.id}/${e}`}update(e,n,r){if(typeof e>"u")throw new AA;const s=this.state;this.lifecycle.validateCollectionUsable("update");const i=zl();if(!i&&!this.config.onUpdate)throw new FA;const o=Array.isArray(e),c=o?e:[e];if(o&&c.length===0)throw new RA;const a=typeof n=="function"?n:r,u=typeof n=="function"?{}:n,h=c.map(p=>{const w=this.state.get(p);if(!w)throw new CA(p);return w});let l;o?l=iO(h,a):l=[sO(h[0],a)];const d=c.map((p,w)=>{const g=l[w];if(!g||Object.keys(g).length===0)return null;const m=h[w],_=this.validateData(g,"update",p),v=Object.assign({},m,_),k=this.config.getKey(m),I=this.config.getKey(v);if(k!==I)throw new OA(k,I);const A=this.generateGlobalKey(I,v);return{mutationId:crypto.randomUUID(),original:m,modified:v,changes:Object.fromEntries(Object.keys(g).map(L=>[L,v[L]])),globalKey:A,key:p,metadata:u.metadata,syncMetadata:s.syncedMetadata.get(p)||{},optimistic:u.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this.collection}}).filter(Boolean);if(d.length===0){const p=Nc({mutationFn:async()=>{}});return p.commit().catch(()=>{}),s.scheduleTransactionCleanup(p),p}if(i)return i.applyMutations(d),s.transactions.set(i.id,i),s.scheduleTransactionCleanup(i),s.recomputeOptimisticState(!0),i;const f=Nc({mutationFn:async p=>this.config.onUpdate({transaction:p.transaction,collection:this.collection})});return f.applyMutations(d),f.commit().catch(()=>{}),s.transactions.set(f.id,f),s.scheduleTransactionCleanup(f),s.recomputeOptimisticState(!0),f}}class yO extends ES{constructor(){super()}setDeps(e){this.collection=e.collection}emit(e,n){this.emitInner(e,n)}emitStatusChange(e,n){this.emit("status:change",{type:"status:change",collection:this.collection,previousStatus:n,status:e});const r=`status:${e}`;this.emit(r,{type:r,collection:this.collection,previousStatus:n,status:e})}emitSubscribersChange(e,n){this.emit("subscribers:change",{type:"subscribers:change",collection:this.collection,previousSubscriberCount:n,subscriberCount:e})}cleanup(){this.clearListeners()}}function mO(t){const e=new wO(t);return t.utils?e.utils=t.utils:e.utils={},e}class wO{constructor(e){if(this.utils={},this.insert=(n,r)=>this._mutations.insert(n,r),this.delete=(n,r)=>this._mutations.delete(n,r),!e)throw new mA;if(!e.sync)throw new wA;e.id?this.id=e.id:this.id=crypto.randomUUID(),this.config={...e,autoIndex:e.autoIndex??"eager"},this._changes=new NC,this._events=new yO,this._indexes=new HC,this._lifecycle=new qC(e,this.id),this._mutations=new gO(e,this.id),this._state=new LC(e),this._sync=new VC(e,this.id),this.comparisonOpts=bO(e),this._changes.setDeps({collection:this,lifecycle:this._lifecycle,sync:this._sync,events:this._events}),this._events.setDeps({collection:this}),this._indexes.setDeps({state:this._state,lifecycle:this._lifecycle}),this._lifecycle.setDeps({changes:this._changes,events:this._events,indexes:this._indexes,state:this._state,sync:this._sync}),this._mutations.setDeps({collection:this,lifecycle:this._lifecycle,state:this._state}),this._state.setDeps({collection:this,lifecycle:this._lifecycle,changes:this._changes,indexes:this._indexes,events:this._events}),this._sync.setDeps({collection:this,state:this._state,lifecycle:this._lifecycle,events:this._events}),e.startSync===!0&&this._sync.startSync()}get status(){return this._lifecycle.status}get subscriberCount(){return this._changes.activeSubscribersCount}onFirstReady(e){return this._lifecycle.onFirstReady(e)}isReady(){return this._lifecycle.status==="ready"}get isLoadingSubset(){return this._sync.isLoadingSubset}startSyncImmediate(){this._sync.startSync()}preload(){return this._sync.preload()}get(e){return this._state.get(e)}has(e){return this._state.has(e)}get size(){return this._state.size}*keys(){yield*this._state.keys()}*values(){yield*this._state.values()}*entries(){yield*this._state.entries()}*[Symbol.iterator](){yield*this._state[Symbol.iterator]()}forEach(e){return this._state.forEach(e)}map(e){return this._state.map(e)}getKeyFromItem(e){return this.config.getKey(e)}createIndex(e,n={}){return this._indexes.createIndex(e,n)}get indexes(){return this._indexes.indexes}validateData(e,n,r){return this._mutations.validateData(e,n,r)}get compareOptions(){return{...this.comparisonOpts}}update(e,n,r){return this._mutations.update(e,n,r)}get state(){const e=new Map;for(const[n,r]of this.entries())e.set(n,r);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):this.preload().then(()=>this.state)}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):this.preload().then(()=>this.toArray)}currentStateAsChanges(e={}){return CC(this,e)}subscribeChanges(e,n={}){return this._changes.subscribeChanges(e,n)}on(e,n){return this._events.on(e,n)}once(e,n){return this._events.once(e,n)}off(e,n){this._events.off(e,n)}waitFor(e,n){return this._events.waitFor(e,n)}async cleanup(){return this._lifecycle.cleanup(),Promise.resolve()}}function bO(t){if(t.defaultStringCollation){const e=t.defaultStringCollation;return{stringSort:e.stringSort??"locale",locale:e.stringSort==="locale"?e.locale:void 0,localeOptions:e.stringSort==="locale"?e.localeOptions:void 0}}else return{stringSort:"locale"}}const Bt=()=>new Map,Gf=t=>{const e=Bt();return t.forEach((n,r)=>{e.set(r,n)}),e},rr=(t,e,n)=>{let r=t.get(e);return r===void 0&&t.set(e,r=n()),r},_O=(t,e)=>{const n=[];for(const[r,s]of t)n.push(e(s,r));return n},SO=(t,e)=>{for(const[n,r]of t)if(e(r,n))return!0;return!1},zr=()=>new Set,Hl=t=>t[t.length-1],EO=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},zn=Array.from,wp=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},bp=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},vO=(t,e)=>{const n=new Array(t);for(let r=0;r<t;r++)n[r]=e(r,n);return n},Hs=Array.isArray;class xS{constructor(){this._observers=Bt()}on(e,n){return rr(this._observers,e,zr).add(n),n}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return zn((this._observers.get(e)||Bt()).values()).forEach(r=>r(...n))}destroy(){this._observers=Bt()}}class kO{constructor(){this._observers=Bt()}on(e,n){rr(this._observers,e,zr).add(n)}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return zn((this._observers.get(e)||Bt()).values()).forEach(r=>r(...n))}destroy(){this._observers=Bt()}}const fn=Math.floor,pa=Math.abs,IS=(t,e)=>t<e?t:e,us=(t,e)=>t>e?t:e,TS=t=>t!==0?t<0:1/t<0,dm=1,pm=2,Ql=4,Gl=8,Fo=32,Vn=64,Wt=128,MW=1<<29,Au=31,Jf=63,Dr=127,xO=255,IO=2147483647,AS=4294967295,qa=Number.MAX_SAFE_INTEGER,gm=Number.MIN_SAFE_INTEGER,TO=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&fn(t)===t),RS=String.fromCharCode,AO=t=>t.toLowerCase(),RO=/^\s*/g,CO=t=>t.replace(RO,""),OO=/([A-Z])/g,ym=(t,e)=>CO(t.replace(OO,n=>`${e}${AO(n)}`)),MO=t=>{const e=unescape(encodeURIComponent(t)),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.codePointAt(s);return r},No=typeof TextEncoder<"u"?new TextEncoder:null,LO=t=>No.encode(t),DO=No?LO:MO;let _o=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});_o&&_o.decode(new Uint8Array).length===1&&(_o=null);const FO=(t,e)=>vO(e,()=>t).join("");class cc{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const ls=()=>new cc,NO=t=>{const e=ls();return t(e),Kt(e)},PO=t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e},Kt=t=>{const e=new Uint8Array(PO(t));let n=0;for(let r=0;r<t.bufs.length;r++){const s=t.bufs[r];e.set(s,n),n+=s.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},$O=(t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(us(n,e)*2),t.cpos=0)},ct=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(n*2),t.cpos=0),t.cbuf[t.cpos++]=e},Po=ct,Le=(t,e)=>{for(;e>Dr;)ct(t,Wt|Dr&e),e=fn(e/128);ct(t,Dr&e)},_p=(t,e)=>{const n=TS(e);for(n&&(e=-e),ct(t,(e>Jf?Wt:0)|(n?Vn:0)|Jf&e),e=fn(e/64);e>0;)ct(t,(e>Dr?Wt:0)|Dr&e),e=fn(e/128)},Yf=new Uint8Array(3e4),BO=Yf.length/3,qO=(t,e)=>{if(e.length<BO){const n=No.encodeInto(e,Yf).written||0;Le(t,n);for(let r=0;r<n;r++)ct(t,Yf[r])}else Dt(t,DO(e))},UO=(t,e)=>{const n=unescape(encodeURIComponent(e)),r=n.length;Le(t,r);for(let s=0;s<r;s++)ct(t,n.codePointAt(s))},Fr=No&&No.encodeInto?qO:UO,Ru=(t,e)=>{const n=t.cbuf.length,r=t.cpos,s=IS(n-r,e.length),i=e.length-s;t.cbuf.set(e.subarray(0,s),r),t.cpos+=s,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(us(n*2,i)),t.cbuf.set(e.subarray(s)),t.cpos=i)},Dt=(t,e)=>{Le(t,e.byteLength),Ru(t,e)},Sp=(t,e)=>{$O(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},VO=(t,e)=>Sp(t,4).setFloat32(0,e,!1),jO=(t,e)=>Sp(t,8).setFloat64(0,e,!1),KO=(t,e)=>Sp(t,8).setBigInt64(0,e,!1),mm=new DataView(new ArrayBuffer(4)),WO=t=>(mm.setFloat32(0,t),mm.getFloat32(0)===t),Qs=(t,e)=>{switch(typeof e){case"string":ct(t,119),Fr(t,e);break;case"number":TO(e)&&pa(e)<=IO?(ct(t,125),_p(t,e)):WO(e)?(ct(t,124),VO(t,e)):(ct(t,123),jO(t,e));break;case"bigint":ct(t,122),KO(t,e);break;case"object":if(e===null)ct(t,126);else if(Hs(e)){ct(t,117),Le(t,e.length);for(let n=0;n<e.length;n++)Qs(t,e[n])}else if(e instanceof Uint8Array)ct(t,116),Dt(t,e);else{ct(t,118);const n=Object.keys(e);Le(t,n.length);for(let r=0;r<n.length;r++){const s=n[r];Fr(t,s),Qs(t,e[s])}}break;case"boolean":ct(t,e?120:121);break;default:ct(t,127)}};class wm extends cc{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&Le(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const bm=t=>{t.count>0&&(_p(t.encoder,t.count===1?t.s:-t.s),t.count>1&&Le(t.encoder,t.count-2))};class ga{constructor(){this.encoder=new cc,this.s=0,this.count=0}write(e){this.s===e?this.count++:(bm(this),this.count=1,this.s=e)}toUint8Array(){return bm(this),Kt(this.encoder)}}const _m=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);_p(t.encoder,e),t.count>1&&Le(t.encoder,t.count-2)}};class Jl{constructor(){this.encoder=new cc,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(_m(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return _m(this),Kt(this.encoder)}}class zO{constructor(){this.sarr=[],this.s="",this.lensE=new ga}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new cc;return this.sarr.push(this.s),this.s="",Fr(e,this.sarr.join("")),Ru(e,this.lensE.toUint8Array()),Kt(e)}}const dn=t=>new Error(t),hn=()=>{throw dn("Method unimplemented")},Ht=()=>{throw dn("Unexpected case")},CS=dn("Unexpected end of array"),OS=dn("Integer out of Range");class Cu{constructor(e){this.arr=e,this.pos=0}}const sr=t=>new Cu(t),MS=t=>t.pos!==t.arr.length,HO=(t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n},Ft=t=>HO(t,Re(t)),Hr=t=>t.arr[t.pos++],Re=t=>{let e=0,n=1;const r=t.arr.length;for(;t.pos<r;){const s=t.arr[t.pos++];if(e=e+(s&Dr)*n,n*=128,s<Wt)return e;if(e>qa)throw OS}throw CS},Ep=t=>{let e=t.arr[t.pos++],n=e&Jf,r=64;const s=(e&Vn)>0?-1:1;if((e&Wt)===0)return s*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n=n+(e&Dr)*r,r*=128,e<Wt)return s*n;if(n>qa)throw OS}throw CS},QO=t=>{let e=Re(t);if(e===0)return"";{let n=String.fromCodePoint(Hr(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(Hr(t));else for(;e>0;){const r=e<1e4?e:1e4,s=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,n+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(n))}},GO=t=>_o.decode(Ft(t)),Nr=_o?GO:QO,vp=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},JO=t=>vp(t,4).getFloat32(0,!1),YO=t=>vp(t,8).getFloat64(0,!1),XO=t=>vp(t,8).getBigInt64(0,!1),ZO=[t=>{},t=>null,Ep,JO,YO,XO,t=>!1,t=>!0,Nr,t=>{const e=Re(t),n={};for(let r=0;r<e;r++){const s=Nr(t);n[s]=Gs(t)}return n},t=>{const e=Re(t),n=[];for(let r=0;r<e;r++)n.push(Gs(t));return n},Ft],Gs=t=>ZO[127-Hr(t)](t);class Sm extends Cu{constructor(e,n){super(e),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),MS(this)?this.count=Re(this)+1:this.count=-1),this.count--,this.s}}class ya extends Cu{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=Ep(this);const e=TS(this.s);this.count=1,e&&(this.s=-this.s,this.count=Re(this)+2)}return this.count--,this.s}}class Yl extends Cu{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=Ep(this),n=e&1;this.diff=fn(e/2),this.count=1,n&&(this.count=Re(this)+2)}return this.s+=this.diff,this.count--,this.s}}class e1{constructor(e){this.decoder=new ya(e),this.str=Nr(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),n=this.str.slice(this.spos,e);return this.spos=e,n}}const t1=crypto.getRandomValues.bind(crypto),n1=Math.random,LS=()=>t1(new Uint32Array(1))[0],LW=t=>t[fn(n1()*t.length)],r1="10000000-1000-4000-8000"+-1e11,s1=()=>r1.replace(/[018]/g,t=>(t^LS()&15>>t/4).toString(16)),i1=Date.now,Hn=t=>new Promise(t);Promise.all.bind(Promise);const o1=t=>Promise.resolve(t),Em=t=>t===void 0?null:t;class c1{constructor(){this.map=new Map}setItem(e,n){this.map.set(e,n)}getItem(e){return this.map.get(e)}}let DS=new c1,a1=!0;try{typeof localStorage<"u"&&localStorage&&(DS=localStorage,a1=!1)}catch{}const u1=DS,$o=Symbol("Equality"),FS=(t,e)=>t===e||t[$o]?.(e)||!1,l1=t=>typeof t=="object",h1=Object.assign,f1=Object.keys,d1=(t,e)=>{for(const n in t)e(t[n],n)},Ua=t=>f1(t).length,p1=t=>{for(const e in t)return!1;return!0},ac=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},kp=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),g1=(t,e)=>t===e||Ua(t)===Ua(e)&&ac(t,(n,r)=>(n!==void 0||kp(e,r))&&FS(e[r],n)),y1=Object.freeze,NS=t=>{for(const e in t){const n=t[e];(typeof n=="object"||typeof n=="function")&&NS(t[e])}return y1(t)},xp=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&xp(t,e,n+1)}},m1=t=>t,ma=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[$o]!=null)return t[$o](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!ma(t.get(n),e.get(n)))return!1;break}case void 0:case Object:if(Ua(t)!==Ua(e))return!1;for(const n in t)if(!kp(t,n)||!ma(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!ma(t[n],e[n]))return!1;break;default:return!1}return!0},w1=(t,e)=>e.includes(t);var PS={};const Js=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",b1=typeof window<"u"&&typeof document<"u"&&!Js;let yn;const _1=()=>{if(yn===void 0)if(Js){yn=Bt();const t=process.argv;let e=null;for(let n=0;n<t.length;n++){const r=t[n];r[0]==="-"?(e!==null&&yn.set(e,""),e=r):e!==null&&(yn.set(e,r),e=null)}e!==null&&yn.set(e,"")}else typeof location=="object"?(yn=Bt(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){const[e,n]=t.split("=");yn.set(`--${ym(e,"-")}`,n),yn.set(`-${ym(e,"-")}`,n)}})):yn=Bt();return yn},Xf=t=>_1().has(t),Va=t=>Em(Js?PS[t.toUpperCase().replaceAll("-","_")]:u1.getItem(t)),$S=t=>Xf("--"+t)||Va(t)!==null,S1=$S("production"),E1=Js&&w1(PS.FORCE_COLOR,["true","1","2"]),v1=E1||!Xf("--no-colors")&&!$S("no-color")&&(!Js||process.stdout.isTTY)&&(!Js||Xf("--color")||Va("COLORTERM")!==null||(Va("TERM")||"").includes("color")),k1=t=>new Uint8Array(t),x1=t=>{let e="";for(let n=0;n<t.byteLength;n++)e+=RS(t[n]);return btoa(e)},I1=t=>Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString("base64"),DW=b1?x1:I1,T1=t=>{const e=k1(t.byteLength);return e.set(t),e},A1=t=>NO(e=>Qs(e,t)),vm=t=>Gs(sr(t));class R1{constructor(e,n){this.left=e,this.right=n}}const Cn=(t,e)=>new R1(t,e),km=t=>t.next()>=.5,Xl=(t,e,n)=>fn(t.next()*(n+1-e)+e),BS=(t,e,n)=>fn(t.next()*(n+1-e)+e),Ip=(t,e,n)=>BS(t,e,n),C1=t=>RS(Ip(t,97,122)),O1=(t,e=0,n=20)=>{const r=Ip(t,e,n);let s="";for(let i=0;i<r;i++)s+=C1(t);return s},Zl=(t,e)=>e[Ip(t,0,e.length-1)],M1=Symbol("0schema");class L1{constructor(){this._rerrs=[]}extend(e,n,r,s=null){this._rerrs.push({path:e,expected:n,has:r,message:s})}toString(){const e=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];e.push(FO(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return e.join(`
`)}}const Zf=(t,e)=>t===e?!0:t==null||e==null||t.constructor!==e.constructor?!1:t[$o]?FS(t,e):Hs(t)?wp(t,n=>bp(e,r=>Zf(n,r))):l1(t)?ac(t,(n,r)=>Zf(n,e[r])):!1;class Mt{static _dilutes=!1;extends(e){let[n,r]=[this.shape,e.shape];return this.constructor._dilutes&&([r,n]=[n,r]),Zf(n,r)}equals(e){return this.constructor===e.constructor&&ma(this.shape,e.shape)}[M1](){return!0}[$o](e){return this.equals(e)}validate(e){return this.check(e)}check(e,n){hn()}get nullable(){return xi(this,Fu)}get optional(){return new VS(this)}cast(e){return xm(e,this),e}expect(e){return xm(e,this),e}}class Tp extends Mt{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n=void 0){const r=e?.constructor===this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const ot=(t,e=null)=>new Tp(t,e);ot(Tp);class Ap extends Mt{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape(e);return!r&&n?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),r}}const yt=t=>new Ap(t);ot(Ap);class Ou extends Mt{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape.some(s=>s===e);return!r&&n?.extend(null,this.shape.join(" | "),e.toString()),r}}const Mu=(...t)=>new Ou(t),qS=ot(Ou),D1=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),US=t=>{if(Ys.check(t))return[D1(t)];if(qS.check(t))return t.shape.map(e=>e+"");if(YS.check(t))return["[+-]?\\d+.?\\d*"];if(XS.check(t))return[".*"];if(ja.check(t))return t.shape.map(US).flat(1);Ht()};class F1 extends Mt{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(US).map(n=>`(${n.join("|")})`).join("")+"$")}check(e,n){const r=this._r.exec(e)!=null;return!r&&n?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),r}}ot(F1);const N1=Symbol("optional");class VS extends Mt{constructor(e){super(),this.shape=e}check(e,n){const r=e===void 0||this.shape.check(e);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[N1](){return!0}}const P1=ot(VS);class $1 extends Mt{check(e,n){return n?.extend(null,"never",typeof e),!1}}ot($1);class Lu extends Mt{constructor(e,n=!1){super(),this.shape=e,this._isPartial=n}static _dilutes=!0;get partial(){return new Lu(this.shape,!0)}check(e,n){return e==null?(n?.extend(null,"object","null"),!1):ac(this.shape,(r,s)=>{const i=this._isPartial&&!kp(e,s)||r.check(e[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof e[s],"Object property does not match"),i})}}const B1=t=>new Lu(t),q1=ot(Lu),U1=yt(t=>t!=null&&(t.constructor===Object||t.constructor==null));class jS extends Mt{constructor(e,n){super(),this.shape={keys:e,values:n}}check(e,n){return e!=null&&ac(e,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof e,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const KS=(t,e)=>new jS(t,e),V1=ot(jS);class WS extends Mt{constructor(e){super(),this.shape=e}check(e,n){return e!=null&&ac(this.shape,(r,s)=>{const i=r.check(e[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const j1=(...t)=>new WS(t);ot(WS);class zS extends Mt{constructor(e){super(),this.shape=e.length===1?e[0]:new Rp(e)}check(e,n){const r=Hs(e)&&wp(e,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const HS=(...t)=>new zS(t),K1=ot(zS),W1=yt(t=>Hs(t));class QS extends Mt{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n){const r=e instanceof this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name),r}}const z1=(t,e=null)=>new QS(t,e);ot(QS);const H1=z1(Mt);class Q1 extends Mt{constructor(e){super(),this.len=e.length-1,this.args=j1(...e.slice(-1)),this.res=e[this.len]}check(e,n){const r=e.constructor===Function&&e.length<=this.len;return!r&&n?.extend(null,"function",typeof e),r}}const G1=ot(Q1),J1=yt(t=>typeof t=="function");class Y1 extends Mt{constructor(e){super(),this.shape=e}check(e,n){const r=wp(this.shape,s=>s.check(e,n));return!r&&n?.extend(null,"Intersectinon",typeof e),r}}ot(Y1,t=>t.shape.length>0);class Rp extends Mt{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,n){const r=bp(this.shape,s=>s.check(e,n));return n?.extend(null,"Union",typeof e),r}}const xi=(...t)=>t.findIndex(e=>ja.check(e))>=0?xi(...t.map(e=>Bo(e)).map(e=>ja.check(e)?e.shape:[e]).flat(1)):t.length===1?t[0]:new Rp(t),ja=ot(Rp),GS=()=>!0,Ka=yt(GS),X1=ot(Ap,t=>t.shape===GS),Cp=yt(t=>typeof t=="bigint"),Z1=yt(t=>t===Cp),JS=yt(t=>typeof t=="symbol");yt(t=>t===JS);const Ms=yt(t=>typeof t=="number"),YS=yt(t=>t===Ms),Ys=yt(t=>typeof t=="string"),XS=yt(t=>t===Ys),Du=yt(t=>typeof t=="boolean"),eM=yt(t=>t===Du),ZS=Mu(void 0);ot(Ou,t=>t.shape.length===1&&t.shape[0]===void 0);Mu(void 0);const Fu=Mu(null),tM=ot(Ou,t=>t.shape.length===1&&t.shape[0]===null);ot(Uint8Array);ot(Tp,t=>t.shape===Uint8Array);const nM=xi(Ms,Ys,Fu,ZS,Cp,Du,JS);(()=>{const t=HS(Ka),e=KS(Ys,Ka),n=xi(Ms,Ys,Fu,Du,t,e);return t.shape=n,e.shape.values=n,n})();const Bo=t=>{if(H1.check(t))return t;if(U1.check(t)){const e={};for(const n in t)e[n]=Bo(t[n]);return B1(e)}else{if(W1.check(t))return xi(...t.map(Bo));if(nM.check(t))return Mu(t);if(J1.check(t))return ot(t)}Ht()},xm=S1?()=>{}:(t,e)=>{const n=new L1;if(!e.check(t,n))throw dn(`Expected value to be of type ${e.constructor.name}.
${n.toString()}`)};class rM{constructor(e){this.patterns=[],this.$state=e}if(e,n){return this.patterns.push({if:Bo(e),h:n}),this}else(e){return this.if(Ka,e)}done(){return(e,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(e))return s.h(e,n)}throw dn("Unhandled pattern")}}}const sM=t=>new rM(t),eE=sM(Ka).if(YS,(t,e)=>Xl(e,gm,qa)).if(XS,(t,e)=>O1(e)).if(eM,(t,e)=>km(e)).if(Z1,(t,e)=>BigInt(Xl(e,gm,qa))).if(ja,(t,e)=>Ss(e,Zl(e,t.shape))).if(q1,(t,e)=>{const n={};for(const r in t.shape){let s=t.shape[r];if(P1.check(s)){if(km(e))continue;s=s.shape}n[r]=eE(s,e)}return n}).if(K1,(t,e)=>{const n=[],r=BS(e,0,42);for(let s=0;s<r;s++)n.push(Ss(e,t.shape));return n}).if(qS,(t,e)=>Zl(e,t.shape)).if(tM,(t,e)=>null).if(G1,(t,e)=>{const n=Ss(e,t.res);return()=>n}).if(X1,(t,e)=>Ss(e,Zl(e,[Ms,Ys,Fu,ZS,Cp,Du,HS(Ms),KS(xi("a","b","c"),Ms)]))).if(V1,(t,e)=>{const n={},r=Xl(e,0,3);for(let s=0;s<r;s++){const i=Ss(e,t.shape.keys),o=Ss(e,t.shape.values);n[i]=o}return n}).done(),Ss=(t,e)=>eE(Bo(e),t),Nu=typeof document<"u"?document:{};yt(t=>t.nodeType===uM);typeof DOMParser<"u"&&new DOMParser;yt(t=>t.nodeType===oM);yt(t=>t.nodeType===cM);const iM=t=>_O(t,(e,n)=>`${n}:${e};`).join(""),oM=Nu.ELEMENT_NODE,cM=Nu.TEXT_NODE,aM=Nu.DOCUMENT_NODE,uM=Nu.DOCUMENT_FRAGMENT_NODE;yt(t=>t.nodeType===aM);const ir=Symbol,tE=ir(),nE=ir(),lM=ir(),hM=ir(),fM=ir(),rE=ir(),dM=ir(),Op=ir(),pM=ir(),gM=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let r=0;for(;r<t.length;r++){const s=t[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(e.join(""));r<t.length;r++){const s=t[r];s instanceof Symbol||n.push(s)}return n},yM={[tE]:Cn("font-weight","bold"),[nE]:Cn("font-weight","normal"),[lM]:Cn("color","blue"),[fM]:Cn("color","green"),[hM]:Cn("color","grey"),[rE]:Cn("color","red"),[dM]:Cn("color","purple"),[Op]:Cn("color","orange"),[pM]:Cn("color","black")},mM=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[],r=Bt();let s=[],i=0;for(;i<t.length;i++){const o=t[i],c=yM[o];if(c!==void 0)r.set(c.left,c.right);else{if(o===void 0)break;if(o.constructor===String||o.constructor===Number){const a=iM(r);i>0||a.length>0?(e.push("%c"+o),n.push(a)):e.push(o)}else break}}for(i>0&&(s=n,s.unshift(e.join("")));i<t.length;i++){const o=t[i];o instanceof Symbol||s.push(o)}return s},sE=v1?mM:gM,wM=(...t)=>{console.log(...sE(t)),oE.forEach(e=>e.print(t))},iE=(...t)=>{console.warn(...sE(t)),t.unshift(Op),oE.forEach(e=>e.print(t))},oE=zr(),cE=t=>({[Symbol.iterator](){return this},next:t}),bM=(t,e)=>cE(()=>{let n;do n=t.next();while(!n.done&&!e(n.value));return n}),eh=(t,e)=>cE(()=>{const{done:n,value:r}=t.next();return{done:n,value:n?void 0:e(r)}});class Mp{constructor(e,n){this.clock=e,this.len=n}}class Ii{constructor(){this.clients=new Map}}const Xs=(t,e,n)=>e.clients.forEach((r,s)=>{const i=t.doc.store.clients.get(s);if(i!=null){const o=i[i.length-1],c=o.id.clock+o.length;for(let a=0,u=r[a];a<r.length&&u.clock<c;u=r[++a])_E(t,i,u.clock,u.len,n)}}),_M=(t,e)=>{let n=0,r=t.length-1;for(;n<=r;){const s=fn((n+r)/2),i=t[s],o=i.clock;if(o<=e){if(e<o+i.len)return s;n=s+1}else r=s-1}return null},uc=(t,e)=>{const n=t.clients.get(e.client);return n!==void 0&&_M(n,e.clock)!==null},Lp=t=>{t.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<e.length;n++){const s=e[r-1],i=e[n];s.clock+s.len>=i.clock?s.len=us(s.len,i.clock+i.len-s.clock):(r<n&&(e[r]=i),r++)}e.length=r})},ed=t=>{const e=new Ii;for(let n=0;n<t.length;n++)t[n].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let o=n+1;o<t.length;o++)EO(i,t[o].clients.get(s)||[]);e.clients.set(s,i)}});return Lp(e),e},qo=(t,e,n,r)=>{rr(t.clients,e,()=>[]).push(new Mp(n,r))},SM=()=>new Ii,aE=t=>{const e=SM();return t.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const o=n[i];if(o.deleted){const c=o.id.clock;let a=o.length;if(i+1<n.length)for(let u=n[i+1];i+1<n.length&&u.deleted;u=n[++i+1])a+=u.length;s.push(new Mp(c,a))}}s.length>0&&e.clients.set(r,s)}),e},Ti=(t,e)=>{Le(t.restEncoder,e.clients.size),zn(e.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{t.resetDsCurVal(),Le(t.restEncoder,n);const s=r.length;Le(t.restEncoder,s);for(let i=0;i<s;i++){const o=r[i];t.writeDsClock(o.clock),t.writeDsLen(o.len)}})},Dp=t=>{const e=new Ii,n=Re(t.restDecoder);for(let r=0;r<n;r++){t.resetDsCurVal();const s=Re(t.restDecoder),i=Re(t.restDecoder);if(i>0){const o=rr(e.clients,s,()=>[]);for(let c=0;c<i;c++)o.push(new Mp(t.readDsClock(),t.readDsLen()))}}return e},Im=(t,e,n)=>{const r=new Ii,s=Re(t.restDecoder);for(let i=0;i<s;i++){t.resetDsCurVal();const o=Re(t.restDecoder),c=Re(t.restDecoder),a=n.clients.get(o)||[],u=tt(n,o);for(let h=0;h<c;h++){const l=t.readDsClock(),d=l+t.readDsLen();if(l<u){u<d&&qo(r,o,u,d-u);let f=En(a,l),p=a[f];for(!p.deleted&&p.id.clock<l&&(a.splice(f+1,0,Xa(e,p,l-p.id.clock)),f++);f<a.length&&(p=a[f++],p.id.clock<d);)p.deleted||(d<p.id.clock+p.length&&a.splice(f,0,Xa(e,p,d-p.id.clock)),p.delete(e))}else qo(r,o,l,d-l)}}if(r.clients.size>0){const i=new Qr;return Le(i.restEncoder,0),Ti(i,r),i.toUint8Array()}return null},uE=LS;class In extends xS{constructor({guid:e=s1(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:o=!1,shouldLoad:c=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=uE(),this.guid=e,this.collectionid=n,this.share=new Map,this.store=new wE,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=o,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=Hn(u=>{this.on("load",()=>{this.isLoaded=!0,u(this)})});const a=()=>Hn(u=>{const h=l=>{(l===void 0||l===!0)&&(this.off("sync",h),u())};this.on("sync",h)});this.on("sync",u=>{u===!1&&this.isSynced&&(this.whenSynced=a()),this.isSynced=u===void 0||u===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=a()}load(){const e=this._item;e!==null&&!this.shouldLoad&&Ue(e.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(zn(this.subdocs).map(e=>e.guid))}transact(e,n=null){return Ue(this,e,n)}get(e,n=pt){const r=rr(this.share,e,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==pt&&s!==n)if(s===pt){const i=new n;i._map=r._map,r._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=i}),i._start=r._start;for(let o=i._start;o!==null;o=o.right)o.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,Fs)}getText(e=""){return this.get(e,ei)}getMap(e=""){return this.get(e,br)}getXmlElement(e=""){return this.get(e,Gn)}getXmlFragment(e=""){return this.get(e,Qn)}toJSON(){const e={};return this.share.forEach((n,r)=>{e[r]=n.toJSON()}),e}destroy(){this.isDestroyed=!0,zn(this.subdocs).forEach(n=>n.destroy());const e=this._item;if(e!==null){this._item=null;const n=e.content;n.doc=new In({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=e,Ue(e.parent.doc,r=>{const s=n.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class lE{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return Re(this.restDecoder)}readDsLen(){return Re(this.restDecoder)}}class hE extends lE{readLeftID(){return xe(Re(this.restDecoder),Re(this.restDecoder))}readRightID(){return xe(Re(this.restDecoder),Re(this.restDecoder))}readClient(){return Re(this.restDecoder)}readInfo(){return Hr(this.restDecoder)}readString(){return Nr(this.restDecoder)}readParentInfo(){return Re(this.restDecoder)===1}readTypeRef(){return Re(this.restDecoder)}readLen(){return Re(this.restDecoder)}readAny(){return Gs(this.restDecoder)}readBuf(){return T1(Ft(this.restDecoder))}readJSON(){return JSON.parse(Nr(this.restDecoder))}readKey(){return Nr(this.restDecoder)}}class EM{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=Re(this.restDecoder),this.dsCurrVal}readDsLen(){const e=Re(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class Zs extends EM{constructor(e){super(e),this.keys=[],Re(e),this.keyClockDecoder=new Yl(Ft(e)),this.clientDecoder=new ya(Ft(e)),this.leftClockDecoder=new Yl(Ft(e)),this.rightClockDecoder=new Yl(Ft(e)),this.infoDecoder=new Sm(Ft(e),Hr),this.stringDecoder=new e1(Ft(e)),this.parentInfoDecoder=new Sm(Ft(e),Hr),this.typeRefDecoder=new ya(Ft(e)),this.lenDecoder=new ya(Ft(e))}readLeftID(){return new Ls(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ls(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Gs(this.restDecoder)}readBuf(){return Ft(this.restDecoder)}readJSON(){return Gs(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class fE{constructor(){this.restEncoder=ls()}toUint8Array(){return Kt(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){Le(this.restEncoder,e)}writeDsLen(e){Le(this.restEncoder,e)}}class lc extends fE{writeLeftID(e){Le(this.restEncoder,e.client),Le(this.restEncoder,e.clock)}writeRightID(e){Le(this.restEncoder,e.client),Le(this.restEncoder,e.clock)}writeClient(e){Le(this.restEncoder,e)}writeInfo(e){Po(this.restEncoder,e)}writeString(e){Fr(this.restEncoder,e)}writeParentInfo(e){Le(this.restEncoder,e?1:0)}writeTypeRef(e){Le(this.restEncoder,e)}writeLen(e){Le(this.restEncoder,e)}writeAny(e){Qs(this.restEncoder,e)}writeBuf(e){Dt(this.restEncoder,e)}writeJSON(e){Fr(this.restEncoder,JSON.stringify(e))}writeKey(e){Fr(this.restEncoder,e)}}class dE{constructor(){this.restEncoder=ls(),this.dsCurrVal=0}toUint8Array(){return Kt(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const n=e-this.dsCurrVal;this.dsCurrVal=e,Le(this.restEncoder,n)}writeDsLen(e){e===0&&Ht(),Le(this.restEncoder,e-1),this.dsCurrVal+=e}}class Qr extends dE{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Jl,this.clientEncoder=new ga,this.leftClockEncoder=new Jl,this.rightClockEncoder=new Jl,this.infoEncoder=new wm(Po),this.stringEncoder=new zO,this.parentInfoEncoder=new wm(Po),this.typeRefEncoder=new ga,this.lenEncoder=new ga}toUint8Array(){const e=ls();return Le(e,0),Dt(e,this.keyClockEncoder.toUint8Array()),Dt(e,this.clientEncoder.toUint8Array()),Dt(e,this.leftClockEncoder.toUint8Array()),Dt(e,this.rightClockEncoder.toUint8Array()),Dt(e,Kt(this.infoEncoder)),Dt(e,this.stringEncoder.toUint8Array()),Dt(e,Kt(this.parentInfoEncoder)),Dt(e,this.typeRefEncoder.toUint8Array()),Dt(e,this.lenEncoder.toUint8Array()),Ru(e,Kt(this.restEncoder)),Kt(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){Qs(this.restEncoder,e)}writeBuf(e){Dt(this.restEncoder,e)}writeJSON(e){Qs(this.restEncoder,e)}writeKey(e){const n=this.keyMap.get(e);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(n)}}const vM=(t,e,n,r)=>{r=us(r,e[0].id.clock);const s=En(e,r);Le(t.restEncoder,e.length-s),t.writeClient(n),Le(t.restEncoder,r);const i=e[s];i.write(t,r-i.id.clock);for(let o=s+1;o<e.length;o++)e[o].write(t,0)},Fp=(t,e,n)=>{const r=new Map;n.forEach((s,i)=>{tt(e,i)>s&&r.set(i,s)}),hc(e).forEach((s,i)=>{n.has(i)||r.set(i,0)}),Le(t.restEncoder,r.size),zn(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{vM(t,e.clients.get(s),s,i)})},kM=(t,e)=>{const n=Bt(),r=Re(t.restDecoder);for(let s=0;s<r;s++){const i=Re(t.restDecoder),o=new Array(i),c=t.readClient();let a=Re(t.restDecoder);n.set(c,{i:0,refs:o});for(let u=0;u<i;u++){const h=t.readInfo();switch(Au&h){case 0:{const l=t.readLen();o[u]=new sn(xe(c,a),l),a+=l;break}case 10:{const l=Re(t.restDecoder);o[u]=new on(xe(c,a),l),a+=l;break}default:{const l=(h&(Vn|Wt))===0,d=new Ve(xe(c,a),null,(h&Wt)===Wt?t.readLeftID():null,null,(h&Vn)===Vn?t.readRightID():null,l?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,l&&(h&Fo)===Fo?t.readString():null,qE(t,h));o[u]=d,a+=d.length}}}}return n},xM=(t,e,n)=>{const r=[];let s=zn(n.keys()).sort((f,p)=>f-p);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let f=n.get(s[s.length-1]);for(;f.refs.length===f.i;)if(s.pop(),s.length>0)f=n.get(s[s.length-1]);else return null;return f};let o=i();if(o===null)return null;const c=new wE,a=new Map,u=(f,p)=>{const w=a.get(f);(w==null||w>p)&&a.set(f,p)};let h=o.refs[o.i++];const l=new Map,d=()=>{for(const f of r){const p=f.id.client,w=n.get(p);w?(w.i--,c.clients.set(p,w.refs.slice(w.i)),n.delete(p),w.i=0,w.refs=[]):c.clients.set(p,[f]),s=s.filter(g=>g!==p)}r.length=0};for(;;){if(h.constructor!==on){const p=rr(l,h.id.client,()=>tt(e,h.id.client))-h.id.clock;if(p<0)r.push(h),u(h.id.client,h.id.clock-1),d();else{const w=h.getMissing(t,e);if(w!==null){r.push(h);const g=n.get(w)||{refs:[],i:0};if(g.refs.length===g.i)u(w,tt(e,w)),d();else{h=g.refs[g.i++];continue}}else(p===0||p<h.length)&&(h.integrate(t,p),l.set(h.id.client,h.id.clock+h.length))}}if(r.length>0)h=r.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=i(),o===null)break;h=o.refs[o.i++]}}if(c.clients.size>0){const f=new Qr;return Fp(f,c,new Map),Le(f.restEncoder,0),{missing:a,update:f.toUint8Array()}}return null},IM=(t,e)=>Fp(t,e.doc.store,e.beforeState),TM=(t,e,n,r=new Zs(t))=>Ue(e,s=>{s.local=!1;let i=!1;const o=s.doc,c=o.store,a=kM(r,o),u=xM(s,c,a),h=c.pendingStructs;if(h){for(const[d,f]of h.missing)if(f<tt(c,d)){i=!0;break}if(u){for(const[d,f]of u.missing){const p=h.missing.get(d);(p==null||p>f)&&h.missing.set(d,f)}h.update=Ha([h.update,u.update])}}else c.pendingStructs=u;const l=Im(r,s,c);if(c.pendingDs){const d=new Zs(sr(c.pendingDs));Re(d.restDecoder);const f=Im(d,s,c);l&&f?c.pendingDs=Ha([l,f]):c.pendingDs=l||f}else c.pendingDs=l;if(i){const d=c.pendingStructs.update;c.pendingStructs=null,Np(s.doc,d)}},n,!1),Np=(t,e,n,r=Zs)=>{const s=sr(e);TM(s,t,n,new r(s))},Pu=(t,e,n)=>Np(t,e,n,hE),AM=(t,e,n=new Map)=>{Fp(t,e.store,n),Ti(t,aE(e.store))},Wa=(t,e=new Uint8Array([0]),n=new Qr)=>{const r=pE(e);AM(n,t,r);const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(GM(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===lc)return HM(s.map((i,o)=>o===0?i:YM(i)));if(n.constructor===Qr)return Ha(s)}return s[0]},Uo=(t,e)=>Wa(t,e,new lc),RM=t=>{const e=new Map,n=Re(t.restDecoder);for(let r=0;r<n;r++){const s=Re(t.restDecoder),i=Re(t.restDecoder);e.set(s,i)}return e},pE=t=>RM(new lE(sr(t))),gE=(t,e)=>(Le(t.restEncoder,e.size),zn(e.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{Le(t.restEncoder,n),Le(t.restEncoder,r)}),t),CM=(t,e)=>gE(t,hc(e.store)),OM=(t,e=new dE)=>(t instanceof Map?gE(e,t):CM(e,t),e.toUint8Array()),Ai=t=>OM(t,new fE);class MM{constructor(){this.l=[]}}const Tm=()=>new MM,Am=(t,e)=>t.l.push(e),Rm=(t,e)=>{const n=t.l,r=n.length;t.l=n.filter(s=>e!==s),r===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},yE=(t,e,n)=>xp(t.l,[e,n]);class Ls{constructor(e,n){this.client=e,this.clock=n}}const Pc=(t,e)=>t===e||t!==null&&e!==null&&t.client===e.client&&t.clock===e.clock,xe=(t,e)=>new Ls(t,e),mE=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw Ht()},za=(t,e)=>{for(;e!==null;){if(e.parent===t)return!0;e=e.parent._item}return!1};class LM{constructor(e,n,r,s=0){this.type=e,this.tname=n,this.item=r,this.assoc=s}}class DM{constructor(e,n,r=0){this.type=e,this.index=n,this.assoc=r}}const FM=(t,e,n=0)=>new DM(t,e,n),$c=(t,e,n)=>{let r=null,s=null;return t._item===null?s=mE(t):r=xe(t._item.id.client,t._item.id.clock),new LM(r,s,e,n)},FW=(t,e,n=0)=>{let r=t._start;if(n<0){if(e===0)return $c(t,null,n);e--}for(;r!==null;){if(!r.deleted&&r.countable){if(r.length>e)return $c(t,xe(r.id.client,r.id.clock+e),n);e-=r.length}if(r.right===null&&n<0)return $c(t,r.lastId,n);r=r.right}return $c(t,null,n)},NM=(t,e)=>{const n=Ds(t,e),r=e.clock-n.id.clock;return{item:n,diff:r}},NW=(t,e,n=!0)=>{const r=e.store,s=t.item,i=t.type,o=t.tname,c=t.assoc;let a=null,u=0;if(s!==null){if(tt(r,s.client)<=s.clock)return null;const h=n?sd(r,s):NM(r,s),l=h.item;if(!(l instanceof Ve))return null;if(a=l.parent,a._item===null||!a._item.deleted){u=l.deleted||!l.countable?0:h.diff+(c>=0?0:1);let d=l.left;for(;d!==null;)!d.deleted&&d.countable&&(u+=d.length),d=d.left}}else{if(o!==null)a=e.get(o);else if(i!==null){if(tt(r,i.client)<=i.clock)return null;const{item:h}=n?sd(r,i):{item:Ds(r,i)};if(h instanceof Ve&&h.content instanceof Tn)a=h.content.type;else return null}else throw Ht();c>=0?u=a._length:u=0}return FM(a,u,t.assoc)};class PM{constructor(e,n){this.ds=e,this.sv=n}}const $M=(t,e)=>new PM(t,e),PW=t=>$M(aE(t.store),hc(t.store)),Cr=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!uc(e.ds,t.id),td=(t,e)=>{const n=rr(t.meta,td,zr),r=t.doc.store;n.has(e)||(e.sv.forEach((s,i)=>{s<tt(r,i)&&Pt(t,xe(i,s))}),Xs(t,e.ds,s=>{}),n.add(e))};class wE{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const hc=t=>{const e=new Map;return t.clients.forEach((n,r)=>{const s=n[n.length-1];e.set(r,s.id.clock+s.length)}),e},tt=(t,e)=>{const n=t.clients.get(e);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},bE=(t,e)=>{let n=t.clients.get(e.id.client);if(n===void 0)n=[],t.clients.set(e.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==e.id.clock)throw Ht()}n.push(e)},En=(t,e)=>{let n=0,r=t.length-1,s=t[r],i=s.id.clock;if(i===e)return r;let o=fn(e/(i+s.length-1)*r);for(;n<=r;){if(s=t[o],i=s.id.clock,i<=e){if(e<i+s.length)return o;n=o+1}else r=o-1;o=fn((n+r)/2)}throw Ht()},BM=(t,e)=>{const n=t.clients.get(e.client);return n[En(n,e.clock)]},Ds=BM,nd=(t,e,n)=>{const r=En(e,n),s=e[r];return s.id.clock<n&&s instanceof Ve?(e.splice(r+1,0,Xa(t,s,n-s.id.clock)),r+1):r},Pt=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[nd(t,n,e.clock)]},Cm=(t,e,n)=>{const r=e.clients.get(n.client),s=En(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==sn&&r.splice(s+1,0,Xa(t,i,n.clock-i.id.clock+1)),i},qM=(t,e,n)=>{const r=t.clients.get(e.id.client);r[En(r,e.id.clock)]=n},_E=(t,e,n,r,s)=>{if(r===0)return;const i=n+r;let o=nd(t,e,n),c;do c=e[o++],i<c.id.clock+c.length&&nd(t,e,i),s(c);while(o<e.length&&e[o].id.clock<i)};class UM{constructor(e,n,r){this.doc=e,this.deleteSet=new Ii,this.beforeState=hc(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const Om=(t,e)=>e.deleteSet.clients.size===0&&!SO(e.afterState,(n,r)=>e.beforeState.get(r)!==n)?!1:(Lp(e.deleteSet),IM(t,e),Ti(t,e.deleteSet),!0),Mm=(t,e,n)=>{const r=e._item;(r===null||r.id.clock<(t.beforeState.get(r.id.client)||0)&&!r.deleted)&&rr(t.changed,e,zr).add(n)},wa=(t,e)=>{let n=t[e],r=t[e-1],s=e;for(;s>0;n=r,r=t[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof Ve&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=e-s;return i&&t.splice(e+1-i,i),i},VM=(t,e,n)=>{for(const[r,s]of t.clients.entries()){const i=e.clients.get(r);for(let o=s.length-1;o>=0;o--){const c=s[o],a=c.clock+c.len;for(let u=En(i,c.clock),h=i[u];u<i.length&&h.id.clock<a;h=i[++u]){const l=i[u];if(c.clock+c.len<=l.id.clock)break;l instanceof Ve&&l.deleted&&!l.keep&&n(l)&&l.gc(e,!1)}}}},jM=(t,e)=>{t.clients.forEach((n,r)=>{const s=e.clients.get(r);for(let i=n.length-1;i>=0;i--){const o=n[i],c=IS(s.length-1,1+En(s,o.clock+o.len-1));for(let a=c,u=s[a];a>0&&u.id.clock>=o.clock;u=s[a])a-=1+wa(s,a)}})},SE=(t,e)=>{if(e<t.length){const n=t[e],r=n.doc,s=r.store,i=n.deleteSet,o=n._mergeStructs;try{Lp(i),n.afterState=hc(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const c=[];n.changed.forEach((a,u)=>c.push(()=>{(u._item===null||!u._item.deleted)&&u._callObserver(n,a)})),c.push(()=>{n.changedParentTypes.forEach((a,u)=>{u._dEH.l.length>0&&(u._item===null||!u._item.deleted)&&(a=a.filter(h=>h.target._item===null||!h.target._item.deleted),a.forEach(h=>{h.currentTarget=u,h._path=null}),a.sort((h,l)=>h.path.length-l.path.length),yE(u._dEH,a,n))})}),c.push(()=>r.emit("afterTransaction",[n,r])),xp(c,[]),n._needFormattingCleanup&&hL(n)}finally{r.gc&&VM(i,s,r.gcFilter),jM(i,s),n.afterState.forEach((h,l)=>{const d=n.beforeState.get(l)||0;if(d!==h){const f=s.clients.get(l),p=us(En(f,d),1);for(let w=f.length-1;w>=p;)w-=1+wa(f,w)}});for(let h=o.length-1;h>=0;h--){const{client:l,clock:d}=o[h].id,f=s.clients.get(l),p=En(f,d);p+1<f.length&&wa(f,p+1)>1||p>0&&wa(f,p)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&(wM(Op,tE,"[yjs] ",nE,rE,"Changed the client-id because another client seems to be using it."),r.clientID=uE()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const h=new lc;Om(h,n)&&r.emit("update",[h.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const h=new Qr;Om(h,n)&&r.emit("updateV2",[h.toUint8Array(),n.origin,r,n])}const{subdocsAdded:c,subdocsLoaded:a,subdocsRemoved:u}=n;(c.size>0||u.size>0||a.size>0)&&(c.forEach(h=>{h.clientID=r.clientID,h.collectionid==null&&(h.collectionid=r.collectionid),r.subdocs.add(h)}),u.forEach(h=>r.subdocs.delete(h)),r.emit("subdocs",[{loaded:a,added:c,removed:u},r,n]),u.forEach(h=>h.destroy())),t.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,t])):SE(t,e+1)}}},Ue=(t,e,n=null,r=!0)=>{const s=t._transactionCleanups;let i=!1,o=null;t._transaction===null&&(i=!0,t._transaction=new UM(t,n,r),s.push(t._transaction),s.length===1&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{o=e(t._transaction)}finally{if(i){const c=t._transaction===s[0];t._transaction=null,c&&SE(s,0)}}return o};class KM{constructor(e,n){this.insertions=n,this.deletions=e,this.meta=new Map}}const Lm=(t,e,n)=>{Xs(t,n.deletions,r=>{r instanceof Ve&&e.scope.some(s=>s===t.doc||za(s,r))&&Kp(r,!1)})},Dm=(t,e,n)=>{let r=null;const s=t.doc,i=t.scope;Ue(s,c=>{for(;e.length>0&&t.currStackItem===null;){const a=s.store,u=e.pop(),h=new Set,l=[];let d=!1;Xs(c,u.insertions,f=>{if(f instanceof Ve){if(f.redone!==null){let{item:p,diff:w}=sd(a,f.id);w>0&&(p=Pt(c,xe(p.id.client,p.id.clock+w))),f=p}!f.deleted&&i.some(p=>p===c.doc||za(p,f))&&l.push(f)}}),Xs(c,u.deletions,f=>{f instanceof Ve&&i.some(p=>p===c.doc||za(p,f))&&!uc(u.insertions,f.id)&&h.add(f)}),h.forEach(f=>{d=BE(c,f,h,u.insertions,t.ignoreRemoteMapChanges,t)!==null||d});for(let f=l.length-1;f>=0;f--){const p=l[f];t.deleteFilter(p)&&(p.delete(c),d=!0)}t.currStackItem=d?u:null}c.changed.forEach((a,u)=>{a.has(null)&&u._searchMarker&&(u._searchMarker.length=0)}),r=c},t);const o=t.currStackItem;if(o!=null){const c=r.changedParentTypes;t.emit("stack-item-popped",[{stackItem:o,type:n,changedParentTypes:c,origin:t},t]),t.currStackItem=null}return o};class WM extends xS{constructor(e,{captureTimeout:n=500,captureTransaction:r=a=>!0,deleteFilter:s=()=>!0,trackedOrigins:i=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:c=Hs(e)?e[0].doc:e instanceof In?e:e.doc}={}){super(),this.scope=[],this.doc=c,this.addToScope(e),this.deleteFilter=s,i.add(this),this.trackedOrigins=i,this.captureTransaction=r,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=n,this.afterTransactionHandler=a=>{if(!this.captureTransaction(a)||!this.scope.some(g=>a.changedParentTypes.has(g)||g===this.doc)||!this.trackedOrigins.has(a.origin)&&(!a.origin||!this.trackedOrigins.has(a.origin.constructor)))return;const u=this.undoing,h=this.redoing,l=u?this.redoStack:this.undoStack;u?this.stopCapturing():h||this.clear(!1,!0);const d=new Ii;a.afterState.forEach((g,m)=>{const _=a.beforeState.get(m)||0,v=g-_;v>0&&qo(d,m,_,v)});const f=i1();let p=!1;if(this.lastChange>0&&f-this.lastChange<this.captureTimeout&&l.length>0&&!u&&!h){const g=l[l.length-1];g.deletions=ed([g.deletions,a.deleteSet]),g.insertions=ed([g.insertions,d])}else l.push(new KM(a.deleteSet,d)),p=!0;!u&&!h&&(this.lastChange=f),Xs(a,a.deleteSet,g=>{g instanceof Ve&&this.scope.some(m=>m===a.doc||za(m,g))&&Kp(g,!0)});const w=[{stackItem:l[l.length-1],origin:a.origin,type:u?"redo":"undo",changedParentTypes:a.changedParentTypes},this];p?this.emit("stack-item-added",w):this.emit("stack-item-updated",w)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(e){const n=new Set(this.scope);e=Hs(e)?e:[e],e.forEach(r=>{n.has(r)||(n.add(r),(r instanceof pt?r.doc!==this.doc:r!==this.doc)&&iE("[yjs#509] Not same Y.Doc"),this.scope.push(r))})}addTrackedOrigin(e){this.trackedOrigins.add(e)}removeTrackedOrigin(e){this.trackedOrigins.delete(e)}clear(e=!0,n=!0){(e&&this.canUndo()||n&&this.canRedo())&&this.doc.transact(r=>{e&&(this.undoStack.forEach(s=>Lm(r,this,s)),this.undoStack=[]),n&&(this.redoStack.forEach(s=>Lm(r,this,s)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:e,redoStackCleared:n}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let e;try{e=Dm(this,this.undoStack,"undo")}finally{this.undoing=!1}return e}redo(){this.redoing=!0;let e;try{e=Dm(this,this.redoStack,"redo")}finally{this.redoing=!1}return e}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}function*zM(t){const e=Re(t.restDecoder);for(let n=0;n<e;n++){const r=Re(t.restDecoder),s=t.readClient();let i=Re(t.restDecoder);for(let o=0;o<r;o++){const c=t.readInfo();if(c===10){const a=Re(t.restDecoder);yield new on(xe(s,i),a),i+=a}else if((Au&c)!==0){const a=(c&(Vn|Wt))===0,u=new Ve(xe(s,i),null,(c&Wt)===Wt?t.readLeftID():null,null,(c&Vn)===Vn?t.readRightID():null,a?t.readParentInfo()?t.readString():t.readLeftID():null,a&&(c&Fo)===Fo?t.readString():null,qE(t,c));yield u,i+=u.length}else{const a=t.readLen();yield new sn(xe(s,i),a),i+=a}}}}class Pp{constructor(e,n){this.gen=zM(e),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===on);return this.curr}}class $p{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const HM=t=>Ha(t,hE,lc),QM=(t,e)=>{if(t.constructor===sn){const{client:n,clock:r}=t.id;return new sn(xe(n,r+e),t.length-e)}else if(t.constructor===on){const{client:n,clock:r}=t.id;return new on(xe(n,r+e),t.length-e)}else{const n=t,{client:r,clock:s}=n.id;return new Ve(xe(r,s+e),null,xe(r,s+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},Ha=(t,e=Zs,n=Qr)=>{if(t.length===1)return t[0];const r=t.map(h=>new e(sr(h)));let s=r.map(h=>new Pp(h,!0)),i=null;const o=new n,c=new $p(o);for(;s=s.filter(d=>d.curr!==null),s.sort((d,f)=>{if(d.curr.id.client===f.curr.id.client){const p=d.curr.id.clock-f.curr.id.clock;return p===0?d.curr.constructor===f.curr.constructor?0:d.curr.constructor===on?1:-1:p}else return f.curr.id.client-d.curr.id.client}),s.length!==0;){const h=s[0],l=h.curr.id.client;if(i!==null){let d=h.curr,f=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=h.next(),f=!0;if(d===null||d.id.client!==l||f&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(l!==i.struct.id.client)dr(c,i.struct,i.offset),i={struct:d,offset:0},h.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===on)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{dr(c,i.struct,i.offset);const p=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new on(xe(l,i.struct.id.clock+i.struct.length),p),offset:0}}else{const p=i.struct.id.clock+i.struct.length-d.id.clock;p>0&&(i.struct.constructor===on?i.struct.length-=p:d=QM(d,p)),i.struct.mergeWith(d)||(dr(c,i.struct,i.offset),i={struct:d,offset:0},h.next())}}else i={struct:h.curr,offset:0},h.next();for(let d=h.curr;d!==null&&d.id.client===l&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==on;d=h.next())dr(c,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(dr(c,i.struct,i.offset),i=null),Bp(c);const a=r.map(h=>Dp(h)),u=ed(a);return Ti(o,u),o.toUint8Array()},GM=(t,e,n=Zs,r=Qr)=>{const s=pE(e),i=new r,o=new $p(i),c=new n(sr(t)),a=new Pp(c,!1);for(;a.curr;){const h=a.curr,l=h.id.client,d=s.get(l)||0;if(a.curr.constructor===on){a.next();continue}if(h.id.clock+h.length>d)for(dr(o,h,us(d-h.id.clock,0)),a.next();a.curr&&a.curr.id.client===l;)dr(o,a.curr,0),a.next();else for(;a.curr&&a.curr.id.client===l&&a.curr.id.clock+a.curr.length<=d;)a.next()}Bp(o);const u=Dp(c);return Ti(i,u),i.toUint8Array()},EE=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:Kt(t.encoder.restEncoder)}),t.encoder.restEncoder=ls(),t.written=0)},dr=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&EE(t),t.written===0&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),Le(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n),t.written++},Bp=t=>{EE(t);const e=t.encoder.restEncoder;Le(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const r=t.clientStructs[n];Le(e,r.written),Ru(e,r.restEncoder)}},JM=(t,e,n,r)=>{const s=new n(sr(t)),i=new Pp(s,!1),o=new r,c=new $p(o);for(let u=i.curr;u!==null;u=i.next())dr(c,e(u),0);Bp(c);const a=Dp(s);return Ti(o,a),o.toUint8Array()},YM=t=>JM(t,m1,Zs,lc),Fm="You must not compute changes after the event-handler fired.";class $u{constructor(e,n){this.target=e,this.currentTarget=e,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=XM(this.currentTarget,this.target))}deletes(e){return uc(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw dn(Fm);const e=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let o,c;if(this.adds(i)){let a=i.left;for(;a!==null&&this.adds(a);)a=a.left;if(this.deletes(i))if(a!==null&&this.deletes(a))o="delete",c=Hl(a.content.getContent());else return;else a!==null&&this.deletes(a)?(o="update",c=Hl(a.content.getContent())):(o="add",c=void 0)}else if(this.deletes(i))o="delete",c=Hl(i.content.getContent());else return;e.set(s,{action:o,oldValue:c})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw dn(Fm);const n=this.target,r=zr(),s=zr(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let c=null;const a=()=>{c&&i.push(c)};for(let u=n._start;u!==null;u=u.right)u.deleted?this.deletes(u)&&!this.adds(u)&&((c===null||c.delete===void 0)&&(a(),c={delete:0}),c.delete+=u.length,s.add(u)):this.adds(u)?((c===null||c.insert===void 0)&&(a(),c={insert:[]}),c.insert=c.insert.concat(u.content.getContent()),r.add(u)):((c===null||c.retain===void 0)&&(a(),c={retain:0}),c.retain+=u.length);c!==null&&c.retain===void 0&&a()}this._changes=e}return e}}const XM=(t,e)=>{const n=[];for(;e._item!==null&&e!==t;){if(e._item.parentSub!==null)n.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}e=e._item.parent}return n},xt=()=>{iE("Invalid access: Add Yjs type to a document before reading data.")},vE=80;let qp=0;class ZM{constructor(e,n){e.marker=!0,this.p=e,this.index=n,this.timestamp=qp++}}const eL=t=>{t.timestamp=qp++},kE=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=qp++},tL=(t,e,n)=>{if(t.length>=vE){const r=t.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return kE(r,e,n),r}else{const r=new ZM(e,n);return t.push(r),r}},Bu=(t,e)=>{if(t._start===null||e===0||t._searchMarker===null)return null;const n=t._searchMarker.length===0?null:t._searchMarker.reduce((i,o)=>pa(e-i.index)<pa(e-o.index)?i:o);let r=t._start,s=0;for(n!==null&&(r=n.p,s=n.index,eL(n));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&pa(n.index-s)<r.parent.length/vE?(kE(n,r,s),n):tL(t._searchMarker,r,s)},Vo=(t,e,n)=>{for(let r=t.length-1;r>=0;r--){const s=t[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){t.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||n>0&&e===s.index)&&(s.index=us(e,s.index+n))}},qu=(t,e,n)=>{const r=t,s=e.changedParentTypes;for(;rr(s,t,()=>[]).push(n),t._item!==null;)t=t._item.parent;yE(r._eH,n,e)};class pt{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Tm(),this._dEH=Tm(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,n){this.doc=e,this._item=n}_copy(){throw hn()}clone(){throw hn()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,n){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){Am(this._eH,e)}observeDeep(e){Am(this._dEH,e)}unobserve(e){Rm(this._eH,e)}unobserveDeep(e){Rm(this._dEH,e)}toJSON(){}}const xE=(t,e,n)=>{t.doc??xt(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let r=n-e;const s=[];let i=t._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const o=i.content.getContent();if(o.length<=e)e-=o.length;else{for(let c=e;c<o.length&&r>0;c++)s.push(o[c]),r--;e=0}}i=i.right}return s},IE=t=>{t.doc??xt();const e=[];let n=t._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}n=n.right}return e},$W=(t,e)=>{const n=[];let r=t._start;for(;r!==null;){if(r.countable&&Cr(r,e)){const s=r.content.getContent();for(let i=0;i<s.length;i++)n.push(s[i])}r=r.right}return n},jo=(t,e)=>{let n=0,r=t._start;for(t.doc??xt();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],n++,t)}r=r.right}},TE=(t,e)=>{const n=[];return jo(t,(r,s)=>{n.push(e(r,s,t))}),n},nL=t=>{let e=t._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};n=e.content.getContent(),r=0,e=e.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},AE=(t,e)=>{t.doc??xt();const n=Bu(t,e);let r=t._start;for(n!==null&&(r=n.p,e-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},Qa=(t,e,n,r)=>{let s=n;const i=t.doc,o=i.clientID,c=i.store,a=n===null?e._start:n.right;let u=[];const h=()=>{u.length>0&&(s=new Ve(xe(o,tt(c,o)),s,s&&s.lastId,a,a&&a.id,e,null,new Jr(u)),s.integrate(t,0),u=[])};r.forEach(l=>{if(l===null)u.push(l);else switch(l.constructor){case Number:case Object:case Boolean:case Array:case String:u.push(l);break;default:switch(h(),l.constructor){case Uint8Array:case ArrayBuffer:s=new Ve(xe(o,tt(c,o)),s,s&&s.lastId,a,a&&a.id,e,null,new fc(new Uint8Array(l))),s.integrate(t,0);break;case In:s=new Ve(xe(o,tt(c,o)),s,s&&s.lastId,a,a&&a.id,e,null,new dc(l)),s.integrate(t,0);break;default:if(l instanceof pt)s=new Ve(xe(o,tt(c,o)),s,s&&s.lastId,a,a&&a.id,e,null,new Tn(l)),s.integrate(t,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},RE=()=>dn("Length exceeded!"),CE=(t,e,n,r)=>{if(n>e._length)throw RE();if(n===0)return e._searchMarker&&Vo(e._searchMarker,n,r.length),Qa(t,e,null,r);const s=n,i=Bu(e,n);let o=e._start;for(i!==null&&(o=i.p,n-=i.index,n===0&&(o=o.prev,n+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(n<=o.length){n<o.length&&Pt(t,xe(o.id.client,o.id.clock+n));break}n-=o.length}return e._searchMarker&&Vo(e._searchMarker,s,r.length),Qa(t,e,o,r)},rL=(t,e,n)=>{let s=(e._searchMarker||[]).reduce((i,o)=>o.index>i.index?o:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return Qa(t,e,s,n)},OE=(t,e,n,r)=>{if(r===0)return;const s=n,i=r,o=Bu(e,n);let c=e._start;for(o!==null&&(c=o.p,n-=o.index);c!==null&&n>0;c=c.right)!c.deleted&&c.countable&&(n<c.length&&Pt(t,xe(c.id.client,c.id.clock+n)),n-=c.length);for(;r>0&&c!==null;)c.deleted||(r<c.length&&Pt(t,xe(c.id.client,c.id.clock+r)),c.delete(t),r-=c.length),c=c.right;if(r>0)throw RE();e._searchMarker&&Vo(e._searchMarker,s,-i+r)},Ga=(t,e,n)=>{const r=e._map.get(n);r!==void 0&&r.delete(t)},Up=(t,e,n,r)=>{const s=e._map.get(n)||null,i=t.doc,o=i.clientID;let c;if(r==null)c=new Jr([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:c=new Jr([r]);break;case Uint8Array:c=new fc(r);break;case In:c=new dc(r);break;default:if(r instanceof pt)c=new Tn(r);else throw new Error("Unexpected content type")}new Ve(xe(o,tt(i.store,o)),s,s&&s.lastId,null,null,e,n,c).integrate(t,0)},Vp=(t,e)=>{t.doc??xt();const n=t._map.get(e);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},ME=t=>{const e={};return t.doc??xt(),t._map.forEach((n,r)=>{n.deleted||(e[r]=n.content.getContent()[n.length-1])}),e},LE=(t,e)=>{t.doc??xt();const n=t._map.get(e);return n!==void 0&&!n.deleted},sL=(t,e)=>{const n={};return t._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&Cr(i,e)&&(n[s]=i.content.getContent()[i.length-1])}),n},Bc=t=>(t.doc??xt(),bM(t._map.entries(),e=>!e[1].deleted));class iL extends $u{}class Fs extends pt{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const n=new Fs;return n.push(e),n}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Fs}clone(){const e=new Fs;return e.insert(0,this.toArray().map(n=>n instanceof pt?n.clone():n)),e}get length(){return this.doc??xt(),this._length}_callObserver(e,n){super._callObserver(e,n),qu(this,e,new iL(this,e))}insert(e,n){this.doc!==null?Ue(this.doc,r=>{CE(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}push(e){this.doc!==null?Ue(this.doc,n=>{rL(n,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,n=1){this.doc!==null?Ue(this.doc,r=>{OE(r,this,e,n)}):this._prelimContent.splice(e,n)}get(e){return AE(this,e)}toArray(){return IE(this)}slice(e=0,n=this.length){return xE(this,e,n)}toJSON(){return this.map(e=>e instanceof pt?e.toJSON():e)}map(e){return TE(this,e)}forEach(e){jo(this,e)}[Symbol.iterator](){return nL(this)}_write(e){e.writeTypeRef(CL)}}const oL=t=>new Fs;class cL extends $u{constructor(e,n,r){super(e,n),this.keysChanged=r}}class br extends pt{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,n){super._integrate(e,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new br}clone(){const e=new br;return this.forEach((n,r)=>{e.set(r,n instanceof pt?n.clone():n)}),e}_callObserver(e,n){qu(this,e,new cL(this,e,n))}toJSON(){this.doc??xt();const e={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];e[r]=s instanceof pt?s.toJSON():s}}),e}get size(){return[...Bc(this)].length}keys(){return eh(Bc(this),e=>e[0])}values(){return eh(Bc(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return eh(Bc(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??xt(),this._map.forEach((n,r)=>{n.deleted||e(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?Ue(this.doc,n=>{Ga(n,this,e)}):this._prelimContent.delete(e)}set(e,n){return this.doc!==null?Ue(this.doc,r=>{Up(r,this,e,n)}):this._prelimContent.set(e,n),n}get(e){return Vp(this,e)}has(e){return LE(this,e)}clear(){this.doc!==null?Ue(this.doc,e=>{this.forEach(function(n,r,s){Ga(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(OL)}}const aL=t=>new br,yr=(t,e)=>t===e||typeof t=="object"&&typeof e=="object"&&t&&e&&g1(t,e);class rd{constructor(e,n,r,s){this.left=e,this.right=n,this.index=r,this.currentAttributes=s}forward(){this.right===null&&Ht(),this.right.content.constructor===ht?this.right.deleted||Ri(this.currentAttributes,this.right.content):this.right.deleted||(this.index+=this.right.length),this.left=this.right,this.right=this.right.right}}const Nm=(t,e,n)=>{for(;e.right!==null&&n>0;)e.right.content.constructor===ht?e.right.deleted||Ri(e.currentAttributes,e.right.content):e.right.deleted||(n<e.right.length&&Pt(t,xe(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length),e.left=e.right,e.right=e.right.right;return e},qc=(t,e,n,r)=>{const s=new Map,i=r?Bu(e,n):null;if(i){const o=new rd(i.p.left,i.p,i.index,s);return Nm(t,o,n-i.index)}else{const o=new rd(null,e._start,0,s);return Nm(t,o,n)}},DE=(t,e,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===ht&&yr(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=t.doc,i=s.clientID;r.forEach((o,c)=>{const a=n.left,u=n.right,h=new Ve(xe(i,tt(s.store,i)),a,a&&a.lastId,u,u&&u.id,e,null,new ht(c,o));h.integrate(t,0),n.right=h,n.forward()})},Ri=(t,e)=>{const{key:n,value:r}=e;r===null?t.delete(n):t.set(n,r)},FE=(t,e)=>{for(;t.right!==null;){if(!(t.right.deleted||t.right.content.constructor===ht&&yr(e[t.right.content.key]??null,t.right.content.value)))break;t.forward()}},NE=(t,e,n,r)=>{const s=t.doc,i=s.clientID,o=new Map;for(const c in r){const a=r[c],u=n.currentAttributes.get(c)??null;if(!yr(u,a)){o.set(c,u);const{left:h,right:l}=n;n.right=new Ve(xe(i,tt(s.store,i)),h,h&&h.lastId,l,l&&l.id,e,null,new ht(c,a)),n.right.integrate(t,0),n.forward()}}return o},th=(t,e,n,r,s)=>{n.currentAttributes.forEach((d,f)=>{s[f]===void 0&&(s[f]=null)});const i=t.doc,o=i.clientID;FE(n,s);const c=NE(t,e,n,s),a=r.constructor===String?new vn(r):r instanceof pt?new Tn(r):new hs(r);let{left:u,right:h,index:l}=n;e._searchMarker&&Vo(e._searchMarker,n.index,a.getLength()),h=new Ve(xe(o,tt(i.store,o)),u,u&&u.lastId,h,h&&h.id,e,null,a),h.integrate(t,0),n.right=h,n.index=l,n.forward(),DE(t,e,n,c)},Pm=(t,e,n,r,s)=>{const i=t.doc,o=i.clientID;FE(n,s);const c=NE(t,e,n,s);e:for(;n.right!==null&&(r>0||c.size>0&&(n.right.deleted||n.right.content.constructor===ht));){if(!n.right.deleted)switch(n.right.content.constructor){case ht:{const{key:a,value:u}=n.right.content,h=s[a];if(h!==void 0){if(yr(h,u))c.delete(a);else{if(r===0)break e;c.set(a,u)}n.right.delete(t)}else n.currentAttributes.set(a,u);break}default:r<n.right.length&&Pt(t,xe(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let a="";for(;r>0;r--)a+=`
`;n.right=new Ve(xe(o,tt(i.store,o)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,e,null,new vn(a)),n.right.integrate(t,0),n.forward()}DE(t,e,n,c)},PE=(t,e,n,r,s)=>{let i=e;const o=Bt();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===ht){const u=i.content;o.set(u.key,u)}i=i.right}let c=0,a=!1;for(;e!==i;){if(n===e&&(a=!0),!e.deleted){const u=e.content;if(u.constructor===ht){const{key:h,value:l}=u,d=r.get(h)??null;(o.get(h)!==u||d===l)&&(e.delete(t),c++,!a&&(s.get(h)??null)===l&&d!==l&&(d===null?s.delete(h):s.set(h,d))),!a&&!e.deleted&&Ri(s,u)}}e=e.right}return c},uL=(t,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===ht){const r=e.content.key;n.has(r)?e.delete(t):n.add(r)}e=e.left}},lL=t=>{let e=0;return Ue(t.doc,n=>{let r=t._start,s=t._start,i=Bt();const o=Gf(i);for(;s;)s.deleted===!1&&(s.content.constructor===ht?Ri(o,s.content):(e+=PE(n,r,s,i,o),i=Gf(o),r=s)),s=s.right}),e},hL=t=>{const e=new Set,n=t.doc;for(const[r,s]of t.afterState.entries()){const i=t.beforeState.get(r)||0;s!==i&&_E(t,n.store.clients.get(r),i,s,o=>{!o.deleted&&o.content.constructor===ht&&o.constructor!==sn&&e.add(o.parent)})}Ue(n,r=>{Xs(t,t.deleteSet,s=>{if(s instanceof sn||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===ht?e.add(i):uL(r,s)});for(const s of e)lL(s)})},$m=(t,e,n)=>{const r=n,s=Gf(e.currentAttributes),i=e.right;for(;n>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case Tn:case hs:case vn:n<e.right.length&&Pt(t,xe(e.right.id.client,e.right.id.clock+n)),n-=e.right.length,e.right.delete(t);break}e.forward()}i&&PE(t,i,e.right,s,e.currentAttributes);const o=(e.left||e.right).parent;return o._searchMarker&&Vo(o._searchMarker,e.index,-r+n),e};class fL extends $u{constructor(e,n,r){super(e,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,n=[];Ue(e,r=>{const s=new Map,i=new Map;let o=this.target._start,c=null;const a={};let u="",h=0,l=0;const d=()=>{if(c!==null){let f=null;switch(c){case"delete":l>0&&(f={delete:l}),l=0;break;case"insert":(typeof u=="object"||u.length>0)&&(f={insert:u},s.size>0&&(f.attributes={},s.forEach((p,w)=>{p!==null&&(f.attributes[w]=p)}))),u="";break;case"retain":h>0&&(f={retain:h},p1(a)||(f.attributes=h1({},a))),h=0;break}f&&n.push(f),c=null}};for(;o!==null;){switch(o.content.constructor){case Tn:case hs:this.adds(o)?this.deletes(o)||(d(),c="insert",u=o.content.getContent()[0],d()):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),l+=1):o.deleted||(c!=="retain"&&(d(),c="retain"),h+=1);break;case vn:this.adds(o)?this.deletes(o)||(c!=="insert"&&(d(),c="insert"),u+=o.content.str):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),l+=o.length):o.deleted||(c!=="retain"&&(d(),c="retain"),h+=o.length);break;case ht:{const{key:f,value:p}=o.content;if(this.adds(o)){if(!this.deletes(o)){const w=s.get(f)??null;yr(w,p)?p!==null&&o.delete(r):(c==="retain"&&d(),yr(p,i.get(f)??null)?delete a[f]:a[f]=p)}}else if(this.deletes(o)){i.set(f,p);const w=s.get(f)??null;yr(w,p)||(c==="retain"&&d(),a[f]=w)}else if(!o.deleted){i.set(f,p);const w=a[f];w!==void 0&&(yr(w,p)?w!==null&&o.delete(r):(c==="retain"&&d(),p===null?delete a[f]:a[f]=p))}o.deleted||(c==="insert"&&d(),Ri(s,o.content));break}}o=o.right}for(d();n.length>0;){const f=n[n.length-1];if(f.retain!==void 0&&f.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class ei extends pt{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??xt(),this._length}_integrate(e,n){super._integrate(e,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new ei}clone(){const e=new ei;return e.applyDelta(this.toDelta()),e}_callObserver(e,n){super._callObserver(e,n);const r=new fL(this,e,n);qu(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??xt();let e="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===vn&&(e+=n.content.str),n=n.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:n=!0}={}){this.doc!==null?Ue(this.doc,r=>{const s=new rd(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const o=e[i];if(o.insert!==void 0){const c=!n&&typeof o.insert=="string"&&i===e.length-1&&s.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof c!="string"||c.length>0)&&th(r,this,s,c,o.attributes||{})}else o.retain!==void 0?Pm(r,this,s,o.retain,o.attributes||{}):o.delete!==void 0&&$m(r,s,o.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,n,r){this.doc??xt();const s=[],i=new Map,o=this.doc;let c="",a=this._start;function u(){if(c.length>0){const l={};let d=!1;i.forEach((p,w)=>{d=!0,l[w]=p});const f={insert:c};d&&(f.attributes=l),s.push(f),c=""}}const h=()=>{for(;a!==null;){if(Cr(a,e)||n!==void 0&&Cr(a,n))switch(a.content.constructor){case vn:{const l=i.get("ychange");e!==void 0&&!Cr(a,e)?(l===void 0||l.user!==a.id.client||l.type!=="removed")&&(u(),i.set("ychange",r?r("removed",a.id):{type:"removed"})):n!==void 0&&!Cr(a,n)?(l===void 0||l.user!==a.id.client||l.type!=="added")&&(u(),i.set("ychange",r?r("added",a.id):{type:"added"})):l!==void 0&&(u(),i.delete("ychange")),c+=a.content.str;break}case Tn:case hs:{u();const l={insert:a.content.getContent()[0]};if(i.size>0){const d={};l.attributes=d,i.forEach((f,p)=>{d[p]=f})}s.push(l);break}case ht:Cr(a,e)&&(u(),Ri(i,a.content));break}a=a.right}u()};return e||n?Ue(o,l=>{e&&td(l,e),n&&td(l,n),h()},"cleanup"):h(),s}insert(e,n,r){if(n.length<=0)return;const s=this.doc;s!==null?Ue(s,i=>{const o=qc(i,this,e,!r);r||(r={},o.currentAttributes.forEach((c,a)=>{r[a]=c})),th(i,this,o,n,r)}):this._pending.push(()=>this.insert(e,n,r))}insertEmbed(e,n,r){const s=this.doc;s!==null?Ue(s,i=>{const o=qc(i,this,e,!r);th(i,this,o,n,r||{})}):this._pending.push(()=>this.insertEmbed(e,n,r||{}))}delete(e,n){if(n===0)return;const r=this.doc;r!==null?Ue(r,s=>{$m(s,qc(s,this,e,!0),n)}):this._pending.push(()=>this.delete(e,n))}format(e,n,r){if(n===0)return;const s=this.doc;s!==null?Ue(s,i=>{const o=qc(i,this,e,!1);o.right!==null&&Pm(i,this,o,n,r)}):this._pending.push(()=>this.format(e,n,r))}removeAttribute(e){this.doc!==null?Ue(this.doc,n=>{Ga(n,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,n){this.doc!==null?Ue(this.doc,r=>{Up(r,this,e,n)}):this._pending.push(()=>this.setAttribute(e,n))}getAttribute(e){return Vp(this,e)}getAttributes(){return ME(this)}_write(e){e.writeTypeRef(ML)}}const dL=t=>new ei;class nh{constructor(e,n=()=>!0){this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??xt()}[Symbol.iterator](){return this}next(){let e=this._currentNode,n=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(n)))do if(n=e.content.type,!e.deleted&&(n.constructor===Gn||n.constructor===Qn)&&n._start!==null)e=n._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Qn extends pt{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Qn}clone(){const e=new Qn;return e.insert(0,this.toArray().map(n=>n instanceof pt?n.clone():n)),e}get length(){return this.doc??xt(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new nh(this,e)}querySelector(e){e=e.toUpperCase();const r=new nh(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),zn(new nh(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e))}_callObserver(e,n){qu(this,e,new yL(this,n,e))}toString(){return TE(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,n={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),jo(this,i=>{s.insertBefore(i.toDOM(e,n,r),null)}),s}insert(e,n){this.doc!==null?Ue(this.doc,r=>{CE(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}insertAfter(e,n){if(this.doc!==null)Ue(this.doc,r=>{const s=e&&e instanceof pt?e._item:e;Qa(r,this,s,n)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw dn("Reference item not found");r.splice(s,0,...n)}}delete(e,n=1){this.doc!==null?Ue(this.doc,r=>{OE(r,this,e,n)}):this._prelimContent.splice(e,n)}toArray(){return IE(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return AE(this,e)}slice(e=0,n=this.length){return xE(this,e,n)}forEach(e){jo(this,e)}_write(e){e.writeTypeRef(DL)}}const pL=t=>new Qn;class Gn extends Qn{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,n){super._integrate(e,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new Gn(this.nodeName)}clone(){const e=new Gn(this.nodeName),n=this.getAttributes();return d1(n,(r,s)=>{e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof pt?r.clone():r)),e}toString(){const e=this.getAttributes(),n=[],r=[];for(const c in e)r.push(c);r.sort();const s=r.length;for(let c=0;c<s;c++){const a=r[c];n.push(a+'="'+e[a]+'"')}const i=this.nodeName.toLocaleLowerCase(),o=n.length>0?" "+n.join(" "):"";return`<${i}${o}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?Ue(this.doc,n=>{Ga(n,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,n){this.doc!==null?Ue(this.doc,r=>{Up(r,this,e,n)}):this._prelimAttrs.set(e,n)}getAttribute(e){return Vp(this,e)}hasAttribute(e){return LE(this,e)}getAttributes(e){return e?sL(this,e):ME(this)}toDOM(e=document,n={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const o in i){const c=i[o];typeof c=="string"&&s.setAttribute(o,c)}return jo(this,o=>{s.appendChild(o.toDOM(e,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(LL),e.writeKey(this.nodeName)}}const gL=t=>new Gn(t.readKey());class yL extends $u{constructor(e,n,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class Ja extends br{constructor(e){super(),this.hookName=e}_copy(){return new Ja(this.hookName)}clone(){const e=new Ja(this.hookName);return this.forEach((n,r)=>{e.set(r,n)}),e}toDOM(e=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(FL),e.writeKey(this.hookName)}}const mL=t=>new Ja(t.readKey());class Gr extends ei{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new Gr}clone(){const e=new Gr;return e.applyDelta(this.toDelta()),e}toDOM(e=document,n,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const n=[];for(const s in e.attributes){const i=[];for(const o in e.attributes[s])i.push({key:o,value:e.attributes[s][o]});i.sort((o,c)=>o.key<c.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let o=0;o<i.attrs.length;o++){const c=i.attrs[o];r+=` ${c.key}="${c.value}"`}r+=">"}r+=e.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(NL)}}const wL=t=>new Gr;class jp{constructor(e,n){this.id=e,this.length=n}get deleted(){throw hn()}mergeWith(e){return!1}write(e,n,r){throw hn()}integrate(e,n){throw hn()}}const bL=0;class sn extends jp{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){n>0&&(this.id.clock+=n,this.length-=n),bE(e.doc.store,this)}write(e,n){e.writeInfo(bL),e.writeLen(this.length-n)}getMissing(e,n){return null}}class fc{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new fc(this.content)}splice(e){throw hn()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeBuf(this.content)}getRef(){return 3}}const _L=t=>new fc(t.readBuf());class Ko{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Ko(this.len)}splice(e){const n=new Ko(this.len-e);return this.len=e,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,n){qo(e.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(e){}gc(e){}write(e,n){e.writeLen(this.len-n)}getRef(){return 1}}const SL=t=>new Ko(t.readLen()),$E=(t,e)=>new In({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class dc{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const n={};this.opts=n,e.gc||(n.gc=!1),e.autoLoad&&(n.autoLoad=!0),e.meta!==null&&(n.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new dc($E(this.doc.guid,this.opts))}splice(e){throw hn()}mergeWith(e){return!1}integrate(e,n){this.doc._item=n,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,n){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const EL=t=>new dc($E(t.readString(),t.readAny()));class hs{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new hs(this.embed)}splice(e){throw hn()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeJSON(this.embed)}getRef(){return 5}}const vL=t=>new hs(t.readJSON());class ht{constructor(e,n){this.key=e,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new ht(this.key,this.value)}splice(e){throw hn()}mergeWith(e){return!1}integrate(e,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,n){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const kL=t=>new ht(t.readKey(),t.readJSON());class Ya{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ya(this.arr)}splice(e){const n=new Ya(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const xL=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++){const s=t.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new Ya(n)},IL=Va("node_env")==="development";class Jr{constructor(e){this.arr=e,IL&&NS(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Jr(this.arr)}splice(e){const n=new Jr(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const TL=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++)n.push(t.readAny());return new Jr(n)};class vn{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new vn(this.str)}splice(e){const n=new vn(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"ï¿½",n.str="ï¿½"+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const AL=t=>new vn(t.readString()),RL=[oL,aL,dL,gL,pL,mL,wL],CL=0,OL=1,ML=2,LL=3,DL=4,FL=5,NL=6;class Tn{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Tn(this.type._copy())}splice(e){throw hn()}mergeWith(e){return!1}integrate(e,n){this.type._integrate(e.doc,n)}delete(e){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(e.beforeState.get(n.id.client)||0)&&e._mergeStructs.push(n):n.delete(e),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let n=this.type._start;for(;n!==null;)n.gc(e,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,n){this.type._write(e)}getRef(){return 7}}const PL=t=>new Tn(RL[t.readTypeRef()](t)),sd=(t,e)=>{let n=e,r=0,s;do r>0&&(n=xe(n.client,n.clock+r)),s=Ds(t,n),r=n.clock-s.id.clock,n=s.redone;while(n!==null&&s instanceof Ve);return{item:s,diff:r}},Kp=(t,e)=>{for(;t!==null&&t.keep!==e;)t.keep=e,t=t.parent._item},Xa=(t,e,n)=>{const{client:r,clock:s}=e.id,i=new Ve(xe(r,s+n),e,xe(r,s+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=xe(e.redone.client,e.redone.clock+n)),e.right=i,i.right!==null&&(i.right.left=i),t._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=n,i},Bm=(t,e)=>bp(t,n=>uc(n.deletions,e)),BE=(t,e,n,r,s,i)=>{const o=t.doc,c=o.store,a=o.clientID,u=e.redone;if(u!==null)return Pt(t,u);let h=e.parent._item,l=null,d;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!n.has(h)||BE(t,h,n,r,s,i)===null))return null;for(;h.redone!==null;)h=Pt(t,h.redone)}const f=h===null?e.parent:h.content.type;if(e.parentSub===null){for(l=e.left,d=e;l!==null;){let m=l;for(;m!==null&&m.parent._item!==h;)m=m.redone===null?null:Pt(t,m.redone);if(m!==null&&m.parent._item===h){l=m;break}l=l.left}for(;d!==null;){let m=d;for(;m!==null&&m.parent._item!==h;)m=m.redone===null?null:Pt(t,m.redone);if(m!==null&&m.parent._item===h){d=m;break}d=d.right}}else if(d=null,e.right&&!s){for(l=e;l!==null&&l.right!==null&&(l.right.redone||uc(r,l.right.id)||Bm(i.undoStack,l.right.id)||Bm(i.redoStack,l.right.id));)for(l=l.right;l.redone;)l=Pt(t,l.redone);if(l&&l.right!==null)return null}else l=f._map.get(e.parentSub)||null;const p=tt(c,a),w=xe(a,p),g=new Ve(w,l,l&&l.lastId,d,d&&d.id,f,e.parentSub,e.content.copy());return e.redone=w,Kp(g,!0),g.integrate(t,0),g};class Ve extends jp{constructor(e,n,r,s,i,o,c,a){super(e,a.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=o,this.parentSub=c,this.redone=null,this.content=a,this.info=this.content.isCountable()?pm:0}set marker(e){(this.info&Gl)>0!==e&&(this.info^=Gl)}get marker(){return(this.info&Gl)>0}get keep(){return(this.info&dm)>0}set keep(e){this.keep!==e&&(this.info^=dm)}get countable(){return(this.info&pm)>0}get deleted(){return(this.info&Ql)>0}set deleted(e){this.deleted!==e&&(this.info^=Ql)}markDeleted(){this.info|=Ql}getMissing(e,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=tt(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=tt(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ls&&this.id.client!==this.parent.client&&this.parent.clock>=tt(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=Cm(e,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=Pt(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===sn||this.right&&this.right.constructor===sn)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===Ve?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===Ve&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ls){const r=Ds(n,this.parent);r.constructor===sn?this.parent=null:this.parent=r.content.type}return null}integrate(e,n){if(n>0&&(this.id.clock+=n,this.left=Cm(e,e.doc.store,xe(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,o=new Set;for(;s!==null&&s!==this.right;){if(o.add(s),i.add(s),Pc(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(Pc(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&o.has(Ds(e.doc.store,s.origin)))i.has(Ds(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),bE(e.doc.store,this),this.content.integrate(e,this),Mm(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new sn(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:xe(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&Pc(e.origin,this.lastId)&&this.right===e&&Pc(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),qo(e.deleteSet,this.id.client,this.id.clock,this.length),Mm(e,n,this.parentSub),this.content.delete(e)}}gc(e,n){if(!this.deleted)throw Ht();this.content.gc(e),n?qM(e,this,new sn(this.id,this.length)):this.content=new Ko(this.length)}write(e,n){const r=n>0?xe(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&Au|(r===null?0:Wt)|(s===null?0:Vn)|(i===null?0:Fo);if(e.writeInfo(o),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const c=this.parent;if(c._item!==void 0){const a=c._item;if(a===null){const u=mE(c);e.writeParentInfo(!0),e.writeString(u)}else e.writeParentInfo(!1),e.writeLeftID(a.id)}else c.constructor===String?(e.writeParentInfo(!0),e.writeString(c)):c.constructor===Ls?(e.writeParentInfo(!1),e.writeLeftID(c)):Ht();i!==null&&e.writeString(i)}this.content.write(e,n)}}const qE=(t,e)=>$L[e&Au](t),$L=[()=>{Ht()},SL,xL,_L,AL,vL,kL,PL,TL,EL,()=>{Ht()}],BL=10;class on extends jp{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){Ht()}write(e,n){e.writeInfo(BL),Le(e.restEncoder,this.length-n)}getMissing(e,n){return null}}const UE=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},VE="__ $YJS$ __";UE[VE]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");UE[VE]=!0;const qL=()=>{let t=!0;return(e,n)=>{if(t){t=!1;try{e()}finally{t=!0}}else n!==void 0&&n()}},UL=t=>typeof t=="function",Q=function(t,e){if(typeof t=="function")return function(){return t(arguments)?e.apply(this,arguments):n=>e(n,...arguments)};switch(t){case 0:case 1:throw new RangeError(`Invalid arity ${t}`);case 2:return function(n,r){return arguments.length>=2?e(n,r):function(s){return e(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?e(n,r,s):function(i){return e(i,n,r)}};case 4:return function(n,r,s,i){return arguments.length>=4?e(n,r,s,i):function(o){return e(o,n,r,s)}};case 5:return function(n,r,s,i,o){return arguments.length>=5?e(n,r,s,i,o):function(c){return e(c,n,r,s,i)}};default:return function(){if(arguments.length>=t)return e.apply(this,arguments);const n=arguments;return function(r){return e(r,...n)}}}},We=t=>t,Uu=t=>()=>t,qm=Uu(!0),id=Uu(!1),jE=Uu(void 0),VL=jE;function Z(t,e,n,r,s,i,o,c,a){switch(arguments.length){case 1:return t;case 2:return e(t);case 3:return n(e(t));case 4:return r(n(e(t)));case 5:return s(r(n(e(t))));case 6:return i(s(r(n(e(t)))));case 7:return o(i(s(r(n(e(t))))));case 8:return c(o(i(s(r(n(e(t)))))));case 9:return a(c(o(i(s(r(n(e(t))))))));default:{let u=arguments[0];for(let h=1;h<arguments.length;h++)u=arguments[h](u);return u}}}const Wp=t=>(e,n)=>e===n||t(e,n),jL=Q(2,(t,e)=>Wp((n,r)=>t(e(n),e(r)))),KL=t=>Wp((e,n)=>{if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(!t(e[r],n[r]))return!1;return!0}),Um="effect/GlobalValue";let zi;const Be=(t,e)=>(zi||(globalThis[Um]??=new Map,zi=globalThis[Um]),zi.has(t)||zi.set(t,e()),zi.get(t)),WL=t=>typeof t=="string",od=t=>typeof t=="number",zL=t=>typeof t=="bigint",Vu=UL,HL=t=>typeof t=="object"&&t!==null,ju=t=>HL(t)||Vu(t),Ae=Q(2,(t,e)=>ju(t)&&e in t),KE=Q(2,(t,e)=>Ae(t,"_tag")&&t._tag===e),Es=t=>t==null,WE=t=>typeof t=="string"||Ae(t,Symbol.iterator),QL=t=>Ae(t,"then")&&Vu(t.then),Ku=t=>`BUG: ${t} - please report an issue at https://github.com/Effect-TS/effect/issues`;let zE=class HE{self;called=!1;constructor(e){this.self=e}next(e){return this.called?{value:e,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(e){return{value:e,done:!0}}throw(e){throw e}[Symbol.iterator](){return new HE(this.self)}};const GL=335903614,JL=4150755663,YL=1481765933,XL=1284865837,ZL=9007199254740992,eD=134217728;class tD{_state;constructor(e,n,r,s){return Es(n)&&Es(e)?(n=Math.random()*4294967295>>>0,e=0):Es(n)&&(n=e,e=0),Es(s)&&Es(r)?(s=this._state?this._state[3]:JL,r=this._state?this._state[2]:GL):Es(s)&&(s=r,r=0),this._state=new Int32Array([0,0,r>>>0,((s||0)|1)>>>0]),this._next(),Vm(this._state,this._state[0],this._state[1],e>>>0,n>>>0),this._next(),this}getState(){return[this._state[0],this._state[1],this._state[2],this._state[3]]}setState(e){this._state[0]=e[0],this._state[1]=e[1],this._state[2]=e[2],this._state[3]=e[3]|1}integer(e){return Math.round(this.number()*Number.MAX_SAFE_INTEGER)%e}number(){const e=(this._next()&67108863)*1,n=(this._next()&134217727)*1;return(e*eD+n)/ZL}_next(){const e=this._state[0]>>>0,n=this._state[1]>>>0;nD(this._state,e,n,YL,XL),Vm(this._state,this._state[0],this._state[1],this._state[2],this._state[3]);let r=e>>>18,s=(n>>>18|e<<14)>>>0;r=(r^e)>>>0,s=(s^n)>>>0;const i=(s>>>27|r<<5)>>>0,o=e>>>27,c=(-o>>>0&31)>>>0;return(i>>>o|i<<c)>>>0}}function nD(t,e,n,r,s){let i=(n>>>16)*(s&65535)>>>0,o=(n&65535)*(s>>>16)>>>0,c=(n&65535)*(s&65535)>>>0,a=(n>>>16)*(s>>>16)+((o>>>16)+(i>>>16))>>>0;o=o<<16>>>0,c=c+o>>>0,c>>>0<o>>>0&&(a=a+1>>>0),i=i<<16>>>0,c=c+i>>>0,c>>>0<i>>>0&&(a=a+1>>>0),a=a+Math.imul(n,r)>>>0,a=a+Math.imul(e,s)>>>0,t[0]=a,t[1]=c}function Vm(t,e,n,r,s){let i=e+r>>>0;const o=n+s>>>0;o>>>0<n>>>0&&(i=i+1|0),t[0]=i,t[1]=o}const cd=Symbol.for("effect/Utils/YieldWrap");class pc{#e;constructor(e){this.#e=e}[cd](){return this.#e}}function rD(t){if(typeof t=="object"&&t!==null&&cd in t)return t[cd]();throw new Error(Ku("yieldWrapGet"))}const en=Be("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),QE={effect_internal_function:t=>t()},sD={effect_internal_function:t=>t()},iD=QE.effect_internal_function(()=>new Error().stack)?.includes("effect_internal_function")===!0,Tt=iD?QE.effect_internal_function:sD.effect_internal_function,rh=Be(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),Ce=Symbol.for("effect/Hash"),Se=t=>{if(en.enabled===!0)return 0;switch(typeof t){case"number":return Hp(t);case"bigint":return Ze(t.toString(10));case"boolean":return Ze(String(t));case"symbol":return Ze(String(t));case"string":return Ze(t);case"undefined":return Ze("undefined");case"function":case"object":return t===null?Ze("null"):t instanceof Date?Number.isNaN(t.getTime())?Ze("Invalid Date"):Se(t.toISOString()):t instanceof URL?Se(t.href):oD(t)?t[Ce]():zp(t);default:throw new Error(`BUG: unhandled typeof ${typeof t} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},zp=t=>(rh.has(t)||rh.set(t,Hp(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),rh.get(t)),$e=t=>e=>e*53^t,Wu=t=>t&3221225471|t>>>1&1073741824,oD=t=>Ae(t,Ce),Hp=t=>{if(t!==t||t===1/0)return 0;let e=t|0;for(e!==t&&(e^=t*4294967295);t>4294967295;)e^=t/=4294967295;return Wu(e)},Ze=t=>{let e=5381,n=t.length;for(;n;)e=e*33^t.charCodeAt(--n);return Wu(e)},cD=(t,e)=>{let n=12289;for(let r=0;r<e.length;r++)n^=Z(Ze(e[r]),$e(Se(t[e[r]])));return Wu(n)},GE=t=>cD(t,Object.keys(t)),gc=t=>{let e=6151;for(let n=0;n<t.length;n++)e=Z(e,$e(Se(t[n])));return Wu(e)},Ye=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,Ce,{value(){return r},enumerable:!1}),r}}const t=arguments[0],e=arguments[1];return Object.defineProperty(t,Ce,{value(){return e},enumerable:!1}),e},Ie=Symbol.for("effect/Equal");function Te(){return arguments.length===1?t=>Za(t,arguments[0]):Za(arguments[0],arguments[1])}function Za(t,e){if(t===e)return!0;const n=typeof t;if(n!==typeof e)return!1;if(n==="object"||n==="function"){if(t!==null&&e!==null){if(eu(t)&&eu(e))return Se(t)===Se(e)&&t[Ie](e)?!0:en.enabled&&en.tester?en.tester(t,e):!1;if(t instanceof Date&&e instanceof Date){const r=t.getTime(),s=e.getTime();return r===s||Number.isNaN(r)&&Number.isNaN(s)}else if(t instanceof URL&&e instanceof URL)return t.href===e.href}if(en.enabled){if(Array.isArray(t)&&Array.isArray(e))return t.length===e.length&&t.every((r,s)=>Za(r,e[s]));if(Object.getPrototypeOf(t)===Object.prototype&&Object.getPrototypeOf(t)===Object.prototype){const r=Object.keys(t),s=Object.keys(e);if(r.length===s.length){for(const i of r)if(!(i in e&&Za(t[i],e[i])))return en.tester?en.tester(t,e):!1;return!0}}return en.tester?en.tester(t,e):!1}}return en.enabled&&en.tester?en.tester(t,e):!1}const eu=t=>Ae(t,Ie),Qp=()=>Te,Xe=Symbol.for("nodejs.util.inspect.custom"),lt=t=>{try{if(Ae(t,"toJSON")&&Vu(t.toJSON)&&t.toJSON.length===0)return t.toJSON();if(Array.isArray(t))return t.map(lt)}catch{return{}}return uD(t)},gt=t=>JSON.stringify(t,null,2),ti=(t,e=2)=>{if(typeof t=="string")return t;try{return typeof t=="object"?JE(t,e):String(t)}catch{return String(t)}},JE=(t,e)=>{let n=[];const r=JSON.stringify(t,(s,i)=>typeof i=="object"&&i!==null?n.includes(i)?void 0:n.push(i)&&(Pr.fiberRefs!==void 0&&YE(i)?i[Gp](Pr.fiberRefs):i):i,e);return n=void 0,r},Gp=Symbol.for("effect/Inspectable/Redactable"),YE=t=>typeof t=="object"&&t!==null&&Gp in t,Pr=Be("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),aD=(t,e)=>{const n=Pr.fiberRefs;Pr.fiberRefs=t;try{return e()}finally{Pr.fiberRefs=n}},uD=t=>YE(t)&&Pr.fiberRefs!==void 0?t[Gp](Pr.fiberRefs):t,ve=(t,e)=>{switch(e.length){case 0:return t;case 1:return e[0](t);case 2:return e[1](e[0](t));case 3:return e[2](e[1](e[0](t)));case 4:return e[3](e[2](e[1](e[0](t))));case 5:return e[4](e[3](e[2](e[1](e[0](t)))));case 6:return e[5](e[4](e[3](e[2](e[1](e[0](t))))));case 7:return e[6](e[5](e[4](e[3](e[2](e[1](e[0](t)))))));case 8:return e[7](e[6](e[5](e[4](e[3](e[2](e[1](e[0](t))))))));case 9:return e[8](e[7](e[6](e[5](e[4](e[3](e[2](e[1](e[0](t)))))))));default:{let n=t;for(let r=0,s=e.length;r<s;r++)n=e[r](n);return n}}},So="Async",zu="Commit",At="Failure",sh="OnFailure",tu="OnSuccess",nu="OnSuccessAndFailure",Rt="Success",XE="Sync",lD="Tag",yc="UpdateRuntimeFlags",ru="While",Eo="Iterator",ZE="WithRuntime",ba="Yield",Jp="RevertFlags";let hD="3.19.12";const Yp=()=>hD,fD=Symbol.for("effect/Effect"),dD=Symbol.for("effect/Stream"),pD=Symbol.for("effect/Sink"),gD=Symbol.for("effect/Channel"),ni={_R:t=>t,_E:t=>t,_A:t=>t,_V:Yp()},yD={_A:t=>t,_In:t=>t,_L:t=>t,_E:t=>t,_R:t=>t},mD={_Env:t=>t,_InErr:t=>t,_InElem:t=>t,_InDone:t=>t,_OutErr:t=>t,_OutElem:t=>t,_OutDone:t=>t},mc={[fD]:ni,[dD]:ni,[pD]:yD,[gD]:mD,[Ie](t){return this===t},[Ce](){return Ye(this,zp(this))},[Symbol.iterator](){return new zE(new pc(this))},pipe(){return ve(this,arguments)}},Xp={[Ce](){return Ye(this,GE(this))},[Ie](t){const e=Object.keys(this),n=Object.keys(t);if(e.length!==n.length)return!1;for(const r of e)if(!(r in t&&Te(this[r],t[r])))return!1;return!0}},wc={...mc,_op:zu},wD={...wc,...Xp},bD=(function(){function t(){}return t.prototype=wc,t})(),e0=Symbol.for("effect/Option"),t0={...mc,[e0]:{_A:t=>t},[Xe](){return this.toJSON()},toString(){return gt(this.toJSON())}},_D=Object.assign(Object.create(t0),{_tag:"Some",_op:"Some",[Ie](t){return n0(t)&&s0(t)&&Te(this.value,t.value)},[Ce](){return Ye(this,$e(Se(this._tag))(Se(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:lt(this.value)}}}),SD=Se("None"),ED=Object.assign(Object.create(t0),{_tag:"None",_op:"None",[Ie](t){return n0(t)&&r0(t)},[Ce](){return SD},toJSON(){return{_id:"Option",_tag:this._tag}}}),n0=t=>Ae(t,e0),r0=t=>t._tag==="None",s0=t=>t._tag==="Some",i0=Object.create(ED),ad=t=>{const e=Object.create(_D);return e.value=t,e},o0=Symbol.for("effect/Either"),c0={...mc,[o0]:{_R:t=>t},[Xe](){return this.toJSON()},toString(){return gt(this.toJSON())}},vD=Object.assign(Object.create(c0),{_tag:"Right",_op:"Right",[Ie](t){return a0(t)&&l0(t)&&Te(this.right,t.right)},[Ce](){return $e(Se(this._tag))(Se(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:lt(this.right)}}}),kD=Object.assign(Object.create(c0),{_tag:"Left",_op:"Left",[Ie](t){return a0(t)&&u0(t)&&Te(this.left,t.left)},[Ce](){return $e(Se(this._tag))(Se(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:lt(this.left)}}}),a0=t=>Ae(t,o0),u0=t=>t._tag==="Left",l0=t=>t._tag==="Right",xD=t=>{const e=Object.create(kD);return e.left=t,e},ID=t=>{const e=Object.create(vD);return e.right=t,e},qn=ID,ri=xD,fo=u0,Uc=l0,TD=Q(2,(t,{onLeft:e,onRight:n})=>fo(t)?e(t.left):n(t.right)),AD=TD({onLeft:We,onRight:We}),h0=t=>t.length>0,f0=t=>(e,n)=>e===n?0:t(e,n),RD=f0((t,e)=>t<e?-1:1),CD=Q(2,(t,e)=>f0((n,r)=>t(e(n),e(r)))),OD=t=>Q(2,(e,n)=>t(e,n)===1),Ee=()=>i0,De=ad,Ct=r0,kn=s0,fs=Q(2,(t,{onNone:e,onSome:n})=>Ct(t)?e():n(t.value)),Sn=Q(2,(t,e)=>Ct(t)?e():t.value),MD=Q(2,(t,e)=>Ct(t)?De(e()):t),Hu=t=>t==null?Ee():De(t),Ar=Sn(jE),_a=Q(2,(t,e)=>Ct(t)?Ee():De(e(t.value))),LD=Q(2,(t,e)=>Ct(t)?Ee():e(t.value)),DD=t=>Q(2,(e,n)=>Ct(e)?!1:t(e.value,n)),FD=Qp(),ND=DD(FD),PD=(...t)=>t,Zp=t=>new Array(t),$D=Q(2,(t,e)=>{const n=Math.max(1,Math.floor(t)),r=new Array(n);for(let s=0;s<n;s++)r[s]=e(s);return r}),st=t=>Array.isArray(t)?t:Array.from(t),BD=t=>Array.isArray(t)?t:[t],su=Q(2,(t,e)=>[e,...t]),qD=Q(2,(t,e)=>[...t,e]),d0=Q(2,(t,e)=>st(t).concat(st(e))),UD=t=>t.length===0,VD=UD,jD=h0,Qt=h0,p0=(t,e)=>t<0||t>=e.length,KD=(t,e)=>Math.floor(Math.min(Math.max(0,t),e.length)),WD=Q(2,(t,e)=>{const n=Math.floor(e);return p0(n,t)?Ee():De(t[n])}),g0=Q(2,(t,e)=>{const n=Math.floor(e);if(p0(n,t))throw new Error(`Index ${n} out of bounds`);return t[n]}),vo=WD(0),qt=g0(0),zD=t=>Qt(t)?De(y0(t)):Ee(),y0=t=>t[t.length-1],si=t=>t.slice(1),HD=(t,e)=>{let n=0;for(const r of t){if(!e(r,n))break;n++}return n},QD=Q(2,(t,e)=>XD(t,HD(t,e))),GD=Q(2,(t,e)=>{const n=st(t);return n.slice(KD(e,n),n.length)}),jm=t=>Array.from(t).reverse(),iu=Q(2,(t,e)=>{const n=Array.from(t);return n.sort(e),n}),Km=Q(2,(t,e)=>JD(t,e,PD)),JD=Q(3,(t,e,n)=>{const r=st(t),s=st(e);if(Qt(r)&&Qt(s)){const i=[n(qt(r),qt(s))],o=Math.min(r.length,s.length);for(let c=1;c<o;c++)i[c]=n(r[c],s[c]);return i}return[]}),YD=Qp(),XD=Q(2,(t,e)=>{const n=Array.from(t),r=Math.floor(e);return Qt(n)?r>=1?ZD(n,r):[[],n]:[n,[]]}),ZD=Q(2,(t,e)=>{const n=Math.max(1,Math.floor(e));return n>=t.length?[eF(t),[]]:[su(t.slice(1,n),qt(t)),t.slice(n)]}),eF=t=>t.slice(),tF=Q(3,(t,e,n)=>{const r=st(t),s=st(e);return Qt(r)?Qt(s)?w0(n)(d0(r,s)):r:s}),Sa=Q(2,(t,e)=>tF(t,e,YD)),ii=()=>[],an=t=>[t],Ns=Q(2,(t,e)=>t.map(e)),nF=Q(2,(t,e)=>{if(VD(t))return[];const n=[];for(let r=0;r<t.length;r++){const s=e(t[r],r);for(let i=0;i<s.length;i++)n.push(s[i])}return n}),rF=nF(We),m0=Q(3,(t,e,n)=>st(t).reduce((r,s,i)=>n(r,s,i),e)),Wm=(t,e)=>{const n=[];let r=t,s;for(;kn(s=e(r));){const[i,o]=s.value;n.push(i),r=o}return n},eg=KL,w0=Q(2,(t,e)=>{const n=st(t);if(Qt(n)){const r=[qt(n)],s=si(n);for(const i of s)r.every(o=>!e(i,o))&&r.push(i);return r}return[]}),sF=t=>w0(t,Qp()),Ci=Q(2,(t,e)=>st(t).join(e)),Wo=RD,iF=t=>t.replace(/[/\\^$*+?.()|[\]{}]/g,"\\$&"),b0=Symbol.for("effect/Context/Tag"),ou=Symbol.for("effect/Context/Reference"),oF="effect/STM",cF=Symbol.for(oF),tg={...mc,_op:"Tag",[cF]:ni,[b0]:{_Service:t=>t,_Identifier:t=>t},toString(){return gt(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[Xe](){return this.toJSON()},of(t){return t},context(t){return E0(this,t)}},aF={...tg,[ou]:ou},uF=t=>{const e=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=e;const r=Object.create(tg);return Object.defineProperty(r,"stack",{get(){return n.stack}}),r.key=t,r},lF=t=>()=>{const e=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=e;function r(){}return Object.setPrototypeOf(r,tg),r.key=t,Object.defineProperty(r,"stack",{get(){return n.stack}}),r},hF=()=>(t,e)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,aF),s.key=t,s.defaultValue=e.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},_0=Symbol.for("effect/Context"),fF={[_0]:{_Services:t=>t},[Ie](t){if(S0(t)&&this.unsafeMap.size===t.unsafeMap.size){for(const e of this.unsafeMap.keys())if(!t.unsafeMap.has(e)||!Te(this.unsafeMap.get(e),t.unsafeMap.get(e)))return!1;return!0}return!1},[Ce](){return Ye(this,Hp(this.unsafeMap.size))},pipe(){return ve(this,arguments)},toString(){return gt(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(lt)}},[Xe](){return this.toJSON()}},Yr=t=>{const e=Object.create(fF);return e.unsafeMap=t,e},dF=t=>{const e=new Error(`Service not found${t.key?`: ${String(t.key)}`:""}`);if(t.stack){const n=t.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(e.message=e.message+` (defined at ${r[1]})`)}}if(e.stack){const n=e.stack.split(`
`);n.splice(1,3),e.stack=n.join(`
`)}return e},S0=t=>Ae(t,_0),pF=t=>Ae(t,b0),gF=t=>Ae(t,ou),yF=Yr(new Map),mF=()=>yF,E0=(t,e)=>Yr(new Map([[t.key,e]])),wF=Q(3,(t,e,n)=>{const r=new Map(t.unsafeMap);return r.set(e.key,n),Yr(r)}),ih=Be("effect/Context/defaultValueCache",()=>new Map),ng=t=>{if(ih.has(t.key))return ih.get(t.key);const e=t.defaultValue();return ih.set(t.key,e),e},bF=(t,e)=>t.unsafeMap.has(e.key)?t.unsafeMap.get(e.key):ng(e),v0=Q(2,(t,e)=>{if(!t.unsafeMap.has(e.key)){if(ou in e)return ng(e);throw dF(e)}return t.unsafeMap.get(e.key)}),_F=v0,SF=Q(2,(t,e)=>t.unsafeMap.has(e.key)?ad(t.unsafeMap.get(e.key)):gF(e)?ad(ng(e)):i0),EF=Q(2,(t,e)=>{const n=new Map(t.unsafeMap);for(const[r,s]of e.unsafeMap)n.set(r,s);return Yr(n)}),vF=(...t)=>{const e=new Map;for(let n=0;n<t.length;n++)t[n].unsafeMap.forEach((r,s)=>{e.set(s,r)});return Yr(e)},ds=uF,kF=S0,xF=pF,rg=mF,k0=E0,xs=wF,x0=_F,I0=v0,bc=SF,Qu=EF,IF=vF,T0=lF,sg=hF,A0=Symbol.for("effect/Chunk");function TF(t,e,n,r,s){for(let i=e;i<Math.min(t.length,e+s);i++)n[r+i-e]=t[i];return n}const R0=[],AF=t=>Wp((e,n)=>e.length===n.length&&$r(e).every((r,s)=>t(r,Ps(n,s)))),RF=AF(Te),CF={[A0]:{_A:t=>t},toString(){return gt(this.toJSON())},toJSON(){return{_id:"Chunk",values:$r(this).map(lt)}},[Xe](){return this.toJSON()},[Ie](t){return C0(t)&&RF(this,t)},[Ce](){return Ye(this,gc($r(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return R0[Symbol.iterator]();default:return $r(this)[Symbol.iterator]()}},pipe(){return ve(this,arguments)}},at=t=>{const e=Object.create(CF);switch(e.backing=t,t._tag){case"IEmpty":{e.length=0,e.depth=0,e.left=e,e.right=e;break}case"IConcat":{e.length=t.left.length+t.right.length,e.depth=1+Math.max(t.left.depth,t.right.depth),e.left=t.left,e.right=t.right;break}case"IArray":{e.length=t.array.length,e.depth=0,e.left=mn,e.right=mn;break}case"ISingleton":{e.length=1,e.depth=0,e.left=mn,e.right=mn;break}case"ISlice":{e.length=t.length,e.depth=t.chunk.depth+1,e.left=mn,e.right=mn;break}}return e},C0=t=>Ae(t,A0),mn=at({_tag:"IEmpty"}),Jn=()=>mn,oh=(...t)=>LF(t),Gt=t=>at({_tag:"ISingleton",a:t}),O0=t=>C0(t)?t:Gu(st(t)),ud=(t,e,n)=>{switch(t.backing._tag){case"IArray":{TF(t.backing.array,0,e,n,t.length);break}case"IConcat":{ud(t.left,e,n),ud(t.right,e,n+t.left.length);break}case"ISingleton":{e[n]=t.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<t.length;)e[s]=Ps(t,r),r+=1,s+=1;break}}},OF=t=>{switch(t.backing._tag){case"IEmpty":return R0;case"IArray":return t.backing.array;default:{const e=new Array(t.length);return ud(t,e,0),t.backing={_tag:"IArray",array:e},t.left=mn,t.right=mn,t.depth=0,e}}},$r=OF,MF=t=>{switch(t.backing._tag){case"IEmpty":case"ISingleton":return t;case"IArray":return at({_tag:"IArray",array:jm(t.backing.array)});case"IConcat":return at({_tag:"IConcat",left:oi(t.backing.right),right:oi(t.backing.left)});case"ISlice":return Gu(jm($r(t)))}},oi=MF,Gu=t=>t.length===0?Jn():t.length===1?Gt(t[0]):at({_tag:"IArray",array:t}),LF=t=>Gu(t),Ps=Q(2,(t,e)=>{switch(t.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(e!==0)throw new Error("Index out of bounds");return t.backing.a}case"IArray":{if(e>=t.length||e<0)throw new Error("Index out of bounds");return t.backing.array[e]}case"IConcat":return e<t.left.length?Ps(t.left,e):Ps(t.right,e-t.left.length);case"ISlice":return Ps(t.backing.chunk,e+t.backing.offset)}}),DF=Q(2,(t,e)=>un(t,Gt(e))),pn=Q(2,(t,e)=>un(Gt(e),t)),ld=Q(2,(t,e)=>{if(e<=0)return t;if(e>=t.length)return mn;switch(t.backing._tag){case"ISlice":return at({_tag:"ISlice",chunk:t.backing.chunk,offset:t.backing.offset+e,length:t.backing.length-e});case"IConcat":return e>t.left.length?ld(t.right,e-t.left.length):at({_tag:"IConcat",left:ld(t.left,e),right:t.right});default:return at({_tag:"ISlice",chunk:t,offset:e,length:t.length-e})}}),un=Q(2,(t,e)=>{if(t.backing._tag==="IEmpty")return e;if(e.backing._tag==="IEmpty")return t;const n=e.depth-t.depth;if(Math.abs(n)<=1)return at({_tag:"IConcat",left:t,right:e});if(n<-1)if(t.left.depth>=t.right.depth){const r=un(t.right,e);return at({_tag:"IConcat",left:t.left,right:r})}else{const r=un(t.right.right,e);if(r.depth===t.depth-3){const s=at({_tag:"IConcat",left:t.right.left,right:r});return at({_tag:"IConcat",left:t.left,right:s})}else{const s=at({_tag:"IConcat",left:t.left,right:t.right.left});return at({_tag:"IConcat",left:s,right:r})}}else if(e.right.depth>=e.left.depth){const r=un(t,e.left);return at({_tag:"IConcat",left:r,right:e.right})}else{const r=un(t,e.left.left);if(r.depth===e.depth-3){const s=at({_tag:"IConcat",left:r,right:e.left.right});return at({_tag:"IConcat",left:s,right:e.right})}else{const s=at({_tag:"IConcat",left:e.left.right,right:e.right});return at({_tag:"IConcat",left:r,right:s})}}}),FF=t=>t.length===0,ci=t=>t.length>0,M0=t=>Ps(t,0),ai=M0,Or=t=>ld(t,1),hd=Symbol.for("effect/Duration"),L0=BigInt(0),zm=BigInt(24),Vc=BigInt(60),fd=BigInt(1e3),Hm=BigInt(1e6),Qm=BigInt(1e9),NF=/^(-?\d+(?:\.\d+)?)\s+(nanos?|micros?|millis?|seconds?|minutes?|hours?|days?|weeks?)$/,Yn=t=>{if(D0(t))return t;if(od(t))return dd(t);if(zL(t))return ch(t);if(Array.isArray(t)&&t.length===2&&t.every(od))return t[0]===-1/0||t[1]===-1/0||Number.isNaN(t[0])||Number.isNaN(t[1])?F0:t[0]===1/0||t[1]===1/0?qF:ch(BigInt(Math.round(t[0]*1e9))+BigInt(Math.round(t[1])));if(WL(t)){const e=NF.exec(t);if(e){const[n,r,s]=e,i=Number(r);switch(s){case"nano":case"nanos":return ch(BigInt(r));case"micro":case"micros":return UF(BigInt(r));case"milli":case"millis":return dd(i);case"second":case"seconds":return VF(i);case"minute":case"minutes":return jF(i);case"hour":case"hours":return KF(i);case"day":case"days":return WF(i);case"week":case"weeks":return zF(i)}}}throw new Error("Invalid DurationInput")},Gm={_tag:"Millis",millis:0},PF={_tag:"Infinity"},$F={[hd]:hd,[Ce](){return Ye(this,GE(this.value))},[Ie](t){return D0(t)&&ZF(this,t)},toString(){return`Duration(${tN(this)})`},toJSON(){switch(this.value._tag){case"Millis":return{_id:"Duration",_tag:"Millis",millis:this.value.millis};case"Nanos":return{_id:"Duration",_tag:"Nanos",hrtime:QF(this)};case"Infinity":return{_id:"Duration",_tag:"Infinity"}}},[Xe](){return this.toJSON()},pipe(){return ve(this,arguments)}},An=t=>{const e=Object.create($F);return od(t)?isNaN(t)||t<=0?e.value=Gm:Number.isFinite(t)?Number.isInteger(t)?e.value={_tag:"Millis",millis:t}:e.value={_tag:"Nanos",nanos:BigInt(Math.round(t*1e6))}:e.value=PF:t<=L0?e.value=Gm:e.value={_tag:"Nanos",nanos:t},e},D0=t=>Ae(t,hd),BF=t=>{switch(t.value._tag){case"Millis":return t.value.millis===0;case"Nanos":return t.value.nanos===L0;case"Infinity":return!1}},F0=An(0),qF=An(1/0),ch=t=>An(t),UF=t=>An(t*fd),dd=t=>An(t),VF=t=>An(t*1e3),jF=t=>An(t*6e4),KF=t=>An(t*36e5),WF=t=>An(t*864e5),zF=t=>An(t*6048e5),pd=t=>GF(t,{onMillis:e=>e,onNanos:e=>Number(e)/1e6}),HF=t=>{const e=Yn(t);switch(e.value._tag){case"Infinity":throw new Error("Cannot convert infinite duration to nanos");case"Nanos":return e.value.nanos;case"Millis":return BigInt(Math.round(e.value.millis*1e6))}},QF=t=>{const e=Yn(t);switch(e.value._tag){case"Infinity":return[1/0,0];case"Nanos":return[Number(e.value.nanos/Qm),Number(e.value.nanos%Qm)];case"Millis":return[Math.floor(e.value.millis/1e3),Math.round(e.value.millis%1e3*1e6)]}},GF=Q(2,(t,e)=>{const n=Yn(t);switch(n.value._tag){case"Nanos":return e.onNanos(n.value.nanos);case"Infinity":return e.onMillis(1/0);case"Millis":return e.onMillis(n.value.millis)}}),ig=Q(3,(t,e,n)=>{const r=Yn(t),s=Yn(e);if(r.value._tag==="Infinity"||s.value._tag==="Infinity")return n.onMillis(pd(r),pd(s));if(r.value._tag==="Nanos"||s.value._tag==="Nanos"){const i=r.value._tag==="Nanos"?r.value.nanos:BigInt(Math.round(r.value.millis*1e6)),o=s.value._tag==="Nanos"?s.value.nanos:BigInt(Math.round(s.value.millis*1e6));return n.onNanos(i,o)}return n.onMillis(r.value.millis,s.value.millis)}),JF=(t,e)=>ig(t,e,{onMillis:(n,r)=>n===r,onNanos:(n,r)=>n===r}),YF=Q(2,(t,e)=>ig(t,e,{onMillis:(n,r)=>n<=r,onNanos:(n,r)=>n<=r})),XF=Q(2,(t,e)=>ig(t,e,{onMillis:(n,r)=>n>=r,onNanos:(n,r)=>n>=r})),ZF=Q(2,(t,e)=>JF(Yn(t),Yn(e))),eN=t=>{const e=Yn(t);if(e.value._tag==="Infinity")return{days:1/0,hours:1/0,minutes:1/0,seconds:1/0,millis:1/0,nanos:1/0};const n=HF(e),r=n/Hm,s=r/fd,i=s/Vc,o=i/Vc,c=o/zm;return{days:Number(c),hours:Number(o%zm),minutes:Number(i%Vc),seconds:Number(s%Vc),millis:Number(r%fd),nanos:Number(n%Hm)}},tN=t=>{const e=Yn(t);if(e.value._tag==="Infinity")return"Infinity";if(BF(e))return"0";const n=eN(e),r=[];return n.days!==0&&r.push(`${n.days}d`),n.hours!==0&&r.push(`${n.hours}h`),n.minutes!==0&&r.push(`${n.minutes}m`),n.seconds!==0&&r.push(`${n.seconds}s`),n.millis!==0&&r.push(`${n.millis}ms`),n.nanos!==0&&r.push(`${n.nanos}ns`),r.join(" ")},Xr=5,og=Math.pow(2,Xr),nN=og-1,rN=og/2,sN=og/4;function iN(t){return t-=t>>1&1431655765,t=(t&858993459)+(t>>2&858993459),t=t+(t>>4)&252645135,t+=t>>8,t+=t>>16,t&127}function ui(t,e){return e>>>t&nN}function As(t){return 1<<t}function N0(t,e){return iN(t&e-1)}const oN=(t,e)=>({value:t,previous:e});function $s(t,e,n,r){let s=r;if(!t){const i=r.length;s=new Array(i);for(let o=0;o<i;++o)s[o]=r[o]}return s[e]=n,s}function P0(t,e,n){const r=n.length-1;let s=0,i=0,o=n;if(t)s=i=e;else for(o=new Array(r);s<e;)o[i++]=n[s++];for(++s;s<=r;)o[i++]=n[s++];return t&&(o.length=r),o}function cN(t,e,n,r){const s=r.length;if(t){let a=s;for(;a>=e;)r[a--]=r[a];return r[e]=n,r}let i=0,o=0;const c=new Array(s+1);for(;i<e;)c[o++]=r[i++];for(c[e]=n;i<s;)c[++o]=r[i++];return c}class _r{_tag="EmptyNode";modify(e,n,r,s,i,o){const c=r(Ee());return Ct(c)?new _r:(++o.value,new Br(e,s,i,c))}}function ln(t){return KE(t,"EmptyNode")}function aN(t){return ln(t)||t._tag==="LeafNode"||t._tag==="CollisionNode"}function Ju(t,e){return ln(t)?!1:e===t.edit}class Br{edit;hash;key;value;_tag="LeafNode";constructor(e,n,r,s){this.edit=e,this.hash=n,this.key=r,this.value=s}modify(e,n,r,s,i,o){if(Te(i,this.key)){const a=r(this.value);return a===this.value?this:Ct(a)?(--o.value,new _r):Ju(this,e)?(this.value=a,this):new Br(e,s,i,a)}const c=r(Ee());return Ct(c)?this:(++o.value,$0(e,n,this.hash,this,s,new Br(e,s,i,c)))}}class cg{edit;hash;children;_tag="CollisionNode";constructor(e,n,r){this.edit=e,this.hash=n,this.children=r}modify(e,n,r,s,i,o){if(s===this.hash){const a=Ju(this,e),u=this.updateCollisionList(a,e,this.hash,this.children,r,i,o);return u===this.children?this:u.length>1?new cg(e,this.hash,u):u[0]}const c=r(Ee());return Ct(c)?this:(++o.value,$0(e,n,this.hash,this,s,new Br(e,s,i,c)))}updateCollisionList(e,n,r,s,i,o,c){const a=s.length;for(let h=0;h<a;++h){const l=s[h];if("key"in l&&Te(o,l.key)){const d=l.value,f=i(d);return f===d?s:Ct(f)?(--c.value,P0(e,h,s)):$s(e,h,new Br(n,r,o,f),s)}}const u=i(Ee());return Ct(u)?s:(++c.value,$s(e,a,new Br(n,r,o,u),s))}}class li{edit;mask;children;_tag="IndexedNode";constructor(e,n,r){this.edit=e,this.mask=n,this.children=r}modify(e,n,r,s,i,o){const c=this.mask,a=this.children,u=ui(n,s),h=As(u),l=N0(c,h),d=c&h,f=Ju(this,e);if(!d){const _=new _r().modify(e,n+Xr,r,s,i,o);return _?a.length>=rN?lN(e,u,_,c,a):new li(e,c|h,cN(f,l,_,a)):this}const p=a[l],w=p.modify(e,n+Xr,r,s,i,o);if(p===w)return this;let g=c,m;if(ln(w)){if(g&=~h,!g)return new _r;if(a.length<=2&&aN(a[l^1]))return a[l^1];m=P0(f,l,a)}else m=$s(f,l,w,a);return f?(this.mask=g,this.children=m,this):new li(e,g,m)}}class ag{edit;size;children;_tag="ArrayNode";constructor(e,n,r){this.edit=e,this.size=n,this.children=r}modify(e,n,r,s,i,o){let c=this.size;const a=this.children,u=ui(n,s),h=a[u],l=(h||new _r).modify(e,n+Xr,r,s,i,o);if(h===l)return this;const d=Ju(this,e);let f;if(ln(h)&&!ln(l))++c,f=$s(d,u,l,a);else if(!ln(h)&&ln(l)){if(--c,c<=sN)return uN(e,c,u,a);f=$s(d,u,new _r,a)}else f=$s(d,u,l,a);return d?(this.size=c,this.children=f,this):new ag(e,c,f)}}function uN(t,e,n,r){const s=new Array(e-1);let i=0,o=0;for(let c=0,a=r.length;c<a;++c)if(c!==n){const u=r[c];u&&!ln(u)&&(s[i++]=u,o|=1<<c)}return new li(t,o,s)}function lN(t,e,n,r,s){const i=[];let o=r,c=0;for(let a=0;o;++a)o&1&&(i[a]=s[c++]),o>>>=1;return i[e]=n,new ag(t,c+1,i)}function hN(t,e,n,r,s,i){if(n===s)return new cg(t,n,[i,r]);const o=ui(e,n),c=ui(e,s);if(o===c)return a=>new li(t,As(o)|As(c),[a]);{const a=o<c?[r,i]:[i,r];return new li(t,As(o)|As(c),a)}}function $0(t,e,n,r,s,i){let o,c=e;for(;;){const a=hN(t,c,n,r,s,i);if(typeof a=="function")o=oN(a,o),c=c+Xr;else{let u=a;for(;o!=null;)u=o.value(u),o=o.previous;return u}}}const B0="effect/HashMap",gd=Symbol.for(B0),fN={[gd]:gd,[Symbol.iterator](){return new Yu(this,(t,e)=>[t,e])},[Ce](){let t=Se(B0);for(const e of this)t^=Z(Se(e[0]),$e(Se(e[1])));return Ye(this,t)},[Ie](t){if(gN(t)){if(t._size!==this._size)return!1;for(const e of this){const n=Z(t,lg(e[0],Se(e[0])));if(Ct(n))return!1;if(!Te(e[1],n.value))return!1}return!0}return!1},toString(){return gt(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(lt)}},[Xe](){return this.toJSON()},pipe(){return ve(this,arguments)}},ug=(t,e,n,r)=>{const s=Object.create(fN);return s._editable=t,s._edit=e,s._root=n,s._size=r,s};class Yu{map;f;v;constructor(e,n){this.map=e,this.f=n,this.v=q0(this.map._root,this.f,void 0)}next(){if(Ct(this.v))return{done:!0,value:void 0};const e=this.v.value;return this.v=cu(e.cont),{done:!1,value:e.value}}[Symbol.iterator](){return new Yu(this.map,this.f)}}const cu=t=>t?U0(t[0],t[1],t[2],t[3],t[4]):Ee(),q0=(t,e,n=void 0)=>{switch(t._tag){case"LeafNode":return kn(t.value)?De({value:e(t.key,t.value.value),cont:n}):cu(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=t.children;return U0(r.length,r,0,e,n)}default:return cu(n)}},U0=(t,e,n,r,s)=>{for(;n<t;){const i=e[n++];if(i&&!ln(i))return q0(i,r,[t,e,n,r,s])}return cu(s)},dN=ug(!1,0,new _r,0),Xu=()=>dN,pN=t=>{const e=j0(Xu());for(const n of t)zo(e,n[0],n[1]);return _N(e)},gN=t=>Ae(t,gd),yN=t=>t&&ln(t._root),mN=Q(2,(t,e)=>lg(t,e,Se(e))),lg=Q(3,(t,e,n)=>{let r=t._root,s=0;for(;;)switch(r._tag){case"LeafNode":return Te(e,r.key)?r.value:Ee();case"CollisionNode":{if(n===r.hash){const i=r.children;for(let o=0,c=i.length;o<c;++o){const a=i[o];if("key"in a&&Te(e,a.key))return a.value}}return Ee()}case"IndexedNode":{const i=ui(s,n),o=As(i);if(r.mask&o){r=r.children[N0(r.mask,o)],s+=Xr;break}return Ee()}case"ArrayNode":{if(r=r.children[ui(s,n)],r){s+=Xr;break}return Ee()}default:return Ee()}}),wN=Q(2,(t,e)=>kn(lg(t,e,Se(e)))),zo=Q(3,(t,e,n)=>hg(t,e,()=>De(n))),bN=Q(3,(t,e,n)=>t._editable?(t._root=e,t._size=n,t):e===t._root?t:ug(t._editable,t._edit,e,n)),V0=t=>new Yu(t,e=>e),yd=t=>t._size,j0=t=>ug(!0,t._edit+1,t._root,t._size),_N=t=>(t._editable=!1,t),hg=Q(3,(t,e,n)=>SN(t,e,Se(e),n)),SN=Q(4,(t,e,n,r)=>{const s={value:t._size},i=t._root.modify(t._editable?t._edit:NaN,0,r,n,e,s);return Z(t,bN(i,s.value))}),Jm=Q(2,(t,e)=>hg(t,e,Ee)),EN=Q(2,(t,e)=>Zu(t,Xu(),(n,r,s)=>zo(n,s,e(r,s)))),vN=Q(2,(t,e)=>Zu(t,void 0,(n,r,s)=>e(r,s))),Zu=Q(3,(t,e,n)=>{const r=t._root;if(r._tag==="LeafNode")return kn(r.value)?n(e,r.value.value,r.key):e;if(r._tag==="EmptyNode")return e;const s=[r.children];let i;for(;i=s.pop();)for(let o=0,c=i.length;o<c;){const a=i[o++];a&&!ln(a)&&(a._tag==="LeafNode"?kn(a.value)&&(e=n(e,a.value.value,a.key)):s.push(a.children))}return e}),K0="effect/HashSet",md=Symbol.for(K0),kN={[md]:md,[Symbol.iterator](){return V0(this._keyMap)},[Ce](){return Ye(this,$e(Se(this._keyMap))(Se(K0)))},[Ie](t){return xN(t)?yd(this._keyMap)===yd(t._keyMap)&&Te(this._keyMap,t._keyMap):!1},toString(){return gt(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(lt)}},[Xe](){return this.toJSON()},pipe(){return ve(this,arguments)}},el=t=>{const e=Object.create(kN);return e._keyMap=t,e},xN=t=>Ae(t,md),IN=el(Xu()),tl=()=>IN,TN=t=>{const e=fg(tl());for(const n of t)Ho(e,n);return dg(e)},AN=(...t)=>{const e=fg(tl());for(const n of t)Ho(e,n);return dg(e)},RN=Q(2,(t,e)=>wN(t._keyMap,e)),CN=t=>yd(t._keyMap),fg=t=>el(j0(t._keyMap)),dg=t=>(t._keyMap._editable=!1,t),W0=Q(2,(t,e)=>{const n=fg(t);return e(n),dg(n)}),Ho=Q(2,(t,e)=>t._keyMap._editable?(zo(e,!0)(t._keyMap),t):el(zo(e,!0)(t._keyMap))),z0=Q(2,(t,e)=>t._keyMap._editable?(Jm(e)(t._keyMap),t):el(Jm(e)(t._keyMap))),ON=Q(2,(t,e)=>W0(t,n=>{for(const r of e)z0(n,r)})),MN=Q(2,(t,e)=>W0(tl(),n=>{LN(t,r=>Ho(n,r));for(const r of e)Ho(n,r)})),LN=Q(2,(t,e)=>vN(t._keyMap,(n,r)=>e(r))),DN=Q(3,(t,e,n)=>Zu(t._keyMap,e,(r,s,i)=>n(r,i))),Zr=tl,FN=TN,pg=AN,NN=RN,H0=CN,ko=Ho,Q0=z0,Ym=ON,Qo=MN,au=DN,Xm=Symbol.for("effect/MutableRef"),PN={[Xm]:Xm,toString(){return gt(this.toJSON())},toJSON(){return{_id:"MutableRef",current:lt(this.current)}},[Xe](){return this.toJSON()},pipe(){return ve(this,arguments)}},gg=t=>{const e=Object.create(PN);return e.current=t,e},es=t=>t.current,nl=Q(2,(t,e)=>(t.current=e,t)),yg="effect/FiberId",Go=Symbol.for(yg),uu="None",wd="Runtime",$N="Composite",BN=Ze(`${yg}-${uu}`);let qN=class{[Go]=Go;_tag=uu;id=-1;startTimeMillis=-1;[Ce](){return BN}[Ie](e){return G0(e)&&e._tag===uu}toString(){return gt(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag}}[Xe](){return this.toJSON()}};class UN{id;startTimeMillis;[Go]=Go;_tag=wd;constructor(e,n){this.id=e,this.startTimeMillis=n}[Ce](){return Ye(this,Ze(`${yg}-${this._tag}-${this.id}-${this.startTimeMillis}`))}[Ie](e){return G0(e)&&e._tag===wd&&this.id===e.id&&this.startTimeMillis===e.startTimeMillis}toString(){return gt(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,id:this.id,startTimeMillis:this.startTimeMillis}}[Xe](){return this.toJSON()}}const VN=new qN,G0=t=>Ae(t,Go),bd=t=>{switch(t._tag){case uu:return Zr();case wd:return pg(t.id);case $N:return Z(bd(t.left),Qo(bd(t.right)))}},Zm=Be(Symbol.for("effect/Fiber/Id/_fiberCounter"),()=>gg(0)),J0=t=>Array.from(bd(t)).map(n=>`#${n}`).join(","),jN=()=>{const t=es(Zm);return Z(Zm,nl(t+1)),new UN(t,Date.now())},hi=VN,KN=J0,Y0=jN,mg=Xu,WN=pN,zN=yN,X0=mN,Z0=zo,ev=V0,HN=hg,QN=EN,tv=Zu,Jo=Symbol.for("effect/List"),_d=t=>st(t),GN=t=>jL(eg(t),_d),JN=GN(Te),YN={[Jo]:Jo,_tag:"Cons",toString(){return gt(this.toJSON())},toJSON(){return{_id:"List",_tag:"Cons",values:_d(this).map(lt)}},[Xe](){return this.toJSON()},[Ie](t){return rv(t)&&this._tag===t._tag&&JN(this,t)},[Ce](){return Ye(this,gc(_d(this)))},[Symbol.iterator](){let t=!1,e=this;return{next(){if(t)return this.return();if(e._tag==="Nil")return t=!0,this.return();const n=e.head;return e=e.tail,{done:t,value:n}},return(n){return t||(t=!0),{done:!0,value:n}}}},pipe(){return ve(this,arguments)}},lu=(t,e)=>{const n=Object.create(YN);return n.head=t,n.tail=e,n},XN=Ze("Nil"),ZN={[Jo]:Jo,_tag:"Nil",toString(){return gt(this.toJSON())},toJSON(){return{_id:"List",_tag:"Nil"}},[Xe](){return this.toJSON()},[Ce](){return XN},[Ie](t){return rv(t)&&this._tag===t._tag},[Symbol.iterator](){return{next(){return{done:!0,value:void 0}}}},pipe(){return ve(this,arguments)}},nv=Object.create(ZN),rv=t=>Ae(t,Jo),jn=t=>t._tag==="Nil",eP=t=>t._tag==="Cons",tP=()=>nv,ts=(t,e)=>lu(t,e),fi=tP,wg=t=>lu(t,nv),nP=Q(2,(t,e)=>sP(e,t)),rP=Q(2,(t,e)=>ts(e,t)),sP=Q(2,(t,e)=>{if(jn(t))return e;if(jn(e))return t;{const n=lu(e.head,t);let r=n,s=e.tail;for(;!jn(s);){const i=lu(s.head,t);r.tail=i,r=i,s=s.tail}return n}}),iP=Q(3,(t,e,n)=>{let r=e,s=t;for(;!jn(s);)r=n(r,s.head),s=s.tail;return r}),oP=t=>{let e=fi(),n=t;for(;!jn(n);)e=rP(e,n.head),n=n.tail;return e},bg=(function(){function t(e){e&&Object.assign(this,e)}return t.prototype=Xp,t})(),cP=Symbol.for("effect/DifferContextPatch");function ew(t){return t}const _c={...bg.prototype,[cP]:{_Value:ew,_Patch:ew}},aP=Object.assign(Object.create(_c),{_tag:"Empty"}),uP=Object.create(aP),sv=()=>uP,lP=Object.assign(Object.create(_c),{_tag:"AndThen"}),hP=(t,e)=>{const n=Object.create(lP);return n.first=t,n.second=e,n},fP=Object.assign(Object.create(_c),{_tag:"AddService"}),dP=(t,e)=>{const n=Object.create(fP);return n.key=t,n.service=e,n},pP=Object.assign(Object.create(_c),{_tag:"RemoveService"}),gP=t=>{const e=Object.create(pP);return e.key=t,e},yP=Object.assign(Object.create(_c),{_tag:"UpdateService"}),mP=(t,e)=>{const n=Object.create(yP);return n.key=t,n.update=e,n},wP=(t,e)=>{const n=new Map(t.unsafeMap);let r=sv();for(const[s,i]of e.unsafeMap.entries())if(n.has(s)){const o=n.get(s);n.delete(s),Te(o,i)||(r=Ea(mP(s,()=>i))(r))}else n.delete(s),r=Ea(dP(s,i))(r);for(const[s]of n.entries())r=Ea(gP(s))(r);return r},Ea=Q(2,(t,e)=>hP(t,e)),bP=Q(2,(t,e)=>{if(t._tag==="Empty")return e;let n=!1,r=Gt(t);const s=new Map(e.unsafeMap);for(;ci(r);){const o=ai(r),c=Or(r);switch(o._tag){case"Empty":{r=c;break}case"AddService":{s.set(o.key,o.service),r=c;break}case"AndThen":{r=pn(pn(c,o.second),o.first);break}case"RemoveService":{s.delete(o.key),r=c;break}case"UpdateService":{s.set(o.key,o.update(s.get(o.key))),n=!0,r=c;break}}}if(!n)return Yr(s);const i=new Map;for(const[o]of e.unsafeMap)s.has(o)&&(i.set(o,s.get(o)),s.delete(o));for(const[o,c]of s)i.set(o,c);return Yr(i)}),_P=Symbol.for("effect/DifferHashSetPatch");function ah(t){return t}const rl={...bg.prototype,[_P]:{_Value:ah,_Key:ah,_Patch:ah}},SP=Object.assign(Object.create(rl),{_tag:"Empty"}),EP=Object.create(SP),iv=()=>EP,vP=Object.assign(Object.create(rl),{_tag:"AndThen"}),kP=(t,e)=>{const n=Object.create(vP);return n.first=t,n.second=e,n},xP=Object.assign(Object.create(rl),{_tag:"Add"}),IP=t=>{const e=Object.create(xP);return e.value=t,e},TP=Object.assign(Object.create(rl),{_tag:"Remove"}),AP=t=>{const e=Object.create(TP);return e.value=t,e},RP=(t,e)=>{const[n,r]=au([t,iv()],([s,i],o)=>NN(o)(s)?[Q0(o)(s),i]:[s,Sd(IP(o))(i)])(e);return au(r,(s,i)=>Sd(AP(i))(s))(n)},Sd=Q(2,(t,e)=>kP(t,e)),CP=Q(2,(t,e)=>{if(t._tag==="Empty")return e;let n=e,r=Gt(t);for(;ci(r);){const s=ai(r),i=Or(r);switch(s._tag){case"Empty":{r=i;break}case"AndThen":{r=pn(s.first)(pn(s.second)(i));break}case"Add":{n=ko(s.value)(n),r=i;break}case"Remove":n=Q0(s.value)(n),r=i}}return n}),OP=Symbol.for("effect/DifferReadonlyArrayPatch");function tw(t){return t}const Sc={...bg.prototype,[OP]:{_Value:tw,_Patch:tw}},MP=Object.assign(Object.create(Sc),{_tag:"Empty"}),LP=Object.create(MP),ov=()=>LP,DP=Object.assign(Object.create(Sc),{_tag:"AndThen"}),FP=(t,e)=>{const n=Object.create(DP);return n.first=t,n.second=e,n},NP=Object.assign(Object.create(Sc),{_tag:"Append"}),PP=t=>{const e=Object.create(NP);return e.values=t,e},$P=Object.assign(Object.create(Sc),{_tag:"Slice"}),BP=(t,e)=>{const n=Object.create($P);return n.from=t,n.until=e,n},qP=Object.assign(Object.create(Sc),{_tag:"Update"}),UP=(t,e)=>{const n=Object.create(qP);return n.index=t,n.patch=e,n},VP=t=>{let e=0,n=ov();for(;e<t.oldValue.length&&e<t.newValue.length;){const r=t.oldValue[e],s=t.newValue[e],i=t.differ.diff(r,s);Te(i,t.differ.empty)||(n=va(n,UP(e,i))),e=e+1}return e<t.oldValue.length&&(n=va(n,BP(0,e))),e<t.newValue.length&&(n=va(n,PP(GD(e)(t.newValue)))),n},va=Q(2,(t,e)=>FP(t,e)),jP=Q(3,(t,e,n)=>{if(t._tag==="Empty")return e;let r=e.slice(),s=an(t);for(;jD(s);){const i=qt(s),o=si(s);switch(i._tag){case"Empty":{s=o;break}case"AndThen":{o.unshift(i.first,i.second),s=o;break}case"Append":{for(const c of i.values)r.push(c);s=o;break}case"Slice":{r=r.slice(i.from,i.until),s=o;break}case"Update":{r[i.index]=n.patch(i.patch,r[i.index]),s=o;break}}}return r}),KP=Symbol.for("effect/Differ"),WP={[KP]:{_P:We,_V:We},pipe(){return ve(this,arguments)}},Oi=t=>{const e=Object.create(WP);return e.empty=t.empty,e.diff=t.diff,e.combine=t.combine,e.patch=t.patch,e},zP=()=>Oi({empty:sv(),combine:(t,e)=>Ea(e)(t),diff:(t,e)=>wP(t,e),patch:(t,e)=>bP(e)(t)}),HP=()=>Oi({empty:iv(),combine:(t,e)=>Sd(e)(t),diff:(t,e)=>RP(t,e),patch:(t,e)=>CP(e)(t)}),QP=t=>Oi({empty:ov(),combine:(e,n)=>va(e,n),diff:(e,n)=>VP({oldValue:e,newValue:n,differ:t}),patch:(e,n)=>jP(e,n,t)}),cv=()=>GP((t,e)=>e),GP=t=>Oi({empty:We,combine:(e,n)=>e===We?n:n===We?e:r=>n(e(r)),diff:(e,n)=>Te(e,n)?We:Uu(n),patch:(e,n)=>t(n,e(n))}),Yo=255,av=8,Ed=t=>t&Yo,vd=t=>t>>av&Yo,Ec=(t,e)=>(t&Yo)+((e&t&Yo)<<av),JP=Ec(0,0),YP=t=>Ec(t,t),XP=t=>Ec(t,0),ZP=Q(2,(t,e)=>Ec(Ed(t)&~e,vd(t))),e$=Q(2,(t,e)=>t|e),t$=t=>~t>>>0&Yo,n$=0,Mi=1,r$=2,uv=4,kd=16,lv=32,s$=t=>sl(t,lv),i$=Q(2,(t,e)=>t|e),fr=t=>hv(t)&&!c$(t),hv=t=>sl(t,Mi),sl=Q(2,(t,e)=>(t&e)!==0),fv=(...t)=>t.reduce((e,n)=>e|n,0),o$=fv(n$),nw=t=>sl(t,uv),c$=t=>sl(t,kd),Bs=Q(2,(t,e)=>Ec(t^e,e)),qs=Q(2,(t,e)=>t&(t$(Ed(e))|vd(e))|Ed(e)&vd(e)),rw=Oi({empty:JP,diff:(t,e)=>Bs(t,e),combine:(t,e)=>e$(e)(t),patch:(t,e)=>qs(e,t)}),a$=YP,dv=XP,sw=ZP,pv=(t,e)=>({_tag:"Par",left:t,right:e}),jc=(t,e)=>({_tag:"Seq",left:t,right:e}),u$=t=>{let e=wg(t),n=fi();for(;;){const[r,s]=iP(e,[gv(),fi()],([i,o],c)=>{const[a,u]=l$(c);return[g$(i,a),nP(o,u)]});if(n=h$(n,r),jn(s))return oP(n);e=s}throw new Error("BUG: BlockedRequests.flatten - please report an issue at https://github.com/Effect-TS/effect/issues")},l$=t=>{let e=t,n=gv(),r=fi(),s=fi();for(;;)switch(e._tag){case"Empty":{if(jn(r))return[n,s];e=r.head,r=r.tail;break}case"Par":{r=ts(e.right,r),e=e.left;break}case"Seq":{const i=e.left,o=e.right;switch(i._tag){case"Empty":{e=o;break}case"Par":{const c=i.left,a=i.right;e=pv(jc(c,o),jc(a,o));break}case"Seq":{const c=i.left,a=i.right;e=jc(c,jc(a,o));break}case"Single":{e=i,s=ts(o,s);break}}break}case"Single":{if(n=p$(n,e),jn(r))return[n,s];e=r.head,r=r.tail;break}}throw new Error("BUG: BlockedRequests.step - please report an issue at https://github.com/Effect-TS/effect/issues")},h$=(t,e)=>{if(jn(t))return wg(uh(e));if(y$(e))return t;const n=E$(t.head),r=m$(e);return n.length===1&&r.length===1&&Te(n[0],r[0])?ts(S$(t.head,uh(e)),t.tail):ts(uh(e),t)},f$=Symbol.for("effect/RequestBlock/RequestBlockParallel"),d$={_R:t=>t};class _g{map;[f$]=d$;constructor(e){this.map=e}}const gv=()=>new _g(mg()),p$=(t,e)=>new _g(HN(t.map,e.dataSource,n=>MD(_a(n,DF(e.blockedRequest)),()=>Gt(e.blockedRequest)))),g$=(t,e)=>new _g(tv(t.map,e.map,(n,r,s)=>Z0(n,s,fs(X0(n,s),{onNone:()=>r,onSome:i=>un(r,i)})))),y$=t=>zN(t.map),m$=t=>Array.from(ev(t.map)),uh=t=>_$(QN(t.map,e=>Gt(e))),w$=Symbol.for("effect/RequestBlock/RequestBlockSequential"),b$={_R:t=>t};class yv{map;[w$]=b$;constructor(e){this.map=e}}const _$=t=>new yv(t),S$=(t,e)=>new yv(tv(e.map,t.map,(n,r,s)=>Z0(n,s,fs(X0(n,s),{onNone:()=>Jn(),onSome:i=>un(i,r)})))),E$=t=>Array.from(ev(t.map)),v$=t=>Array.from(t.map),vc="Die",ns="Empty",Li="Fail",Di="Interrupt",di="Parallel",pi="Sequential",mv="effect/Cause",wv=Symbol.for(mv),k$={_E:t=>t},Fi={[wv]:k$,[Ce](){return Z(Se(mv),$e(Se(N$(this))),Ye(this))},[Ie](t){return bv(t)&&F$(this,t)},pipe(){return ve(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:lt(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:lt(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:lt(this.left),right:lt(this.right)}}},toString(){return kc(this)},[Xe](){return this.toJSON()}},rs=(()=>{const t=Object.create(Fi);return t._tag=ns,t})(),hu=t=>{const e=Object.create(Fi);return e._tag=Li,e.error=t,e},Kn=t=>{const e=Object.create(Fi);return e._tag=vc,e.defect=t,e},pr=t=>{const e=Object.create(Fi);return e._tag=Di,e.fiberId=t,e},il=(t,e)=>{const n=Object.create(Fi);return n._tag=di,n.left=t,n.right=e,n},$t=(t,e)=>{const n=Object.create(Fi);return n._tag=pi,n.left=t,n.right=e,n},bv=t=>Ae(t,wv),x$=t=>t._tag===ns,I$=t=>t._tag===ns?!0:gi(t,!0,(e,n)=>{switch(n._tag){case ns:return De(e);case vc:case Li:case Di:return De(!1);default:return Ee()}}),T$=t=>kn(L$(t)),Sg=t=>Eg(void 0,$$)(t),A$=t=>oi(gi(t,Jn(),(e,n)=>n._tag===Li?De(Z(e,pn(n.error))):Ee())),R$=t=>oi(gi(t,Jn(),(e,n)=>n._tag===vc?De(Z(e,pn(n.defect))):Ee())),C$=t=>gi(t,Zr(),(e,n)=>n._tag===Di?De(Z(e,ko(n.fiberId))):Ee()),O$=t=>_v(t,e=>e._tag===Li?De(e.error):Ee()),M$=t=>{const e=O$(t);switch(e._tag){case"None":return qn(t);case"Some":return ri(e.value)}},L$=t=>_v(t,e=>e._tag===Di?De(e.fiberId):Ee()),iw=t=>Sv(t,{onEmpty:rs,onFail:()=>rs,onDie:Kn,onInterrupt:pr,onSequential:$t,onParallel:il}),D$=t=>Sv(t,{onEmpty:rs,onFail:Kn,onDie:Kn,onInterrupt:pr,onSequential:$t,onParallel:il}),F$=(t,e)=>{let n=Gt(t),r=Gt(e);for(;ci(n)&&ci(r);){const[s,i]=Z(ai(n),gi([Zr(),Jn()],([a,u],h)=>{const[l,d]=xd(h);return De([Z(a,Qo(l)),Z(u,un(d))])})),[o,c]=Z(ai(r),gi([Zr(),Jn()],([a,u],h)=>{const[l,d]=xd(h);return De([Z(a,Qo(l)),Z(u,un(d))])}));if(!Te(s,o))return!1;n=i,r=c}return!0},N$=t=>P$(Gt(t),Jn()),P$=(t,e)=>{for(;;){const[n,r]=Z(t,m0([Zr(),Jn()],([i,o],c)=>{const[a,u]=xd(c);return[Z(i,Qo(a)),Z(o,un(u))]})),s=H0(n)>0?Z(e,pn(n)):e;if(FF(r))return oi(s);t=r,e=s}throw new Error(Ku("Cause.flattenCauseLoop"))},_v=Q(2,(t,e)=>{const n=[t];for(;n.length>0;){const r=n.pop(),s=e(r);switch(s._tag){case"None":{switch(r._tag){case pi:case di:{n.push(r.right),n.push(r.left);break}}break}case"Some":return s}}return Ee()}),xd=t=>{let e=t;const n=[];let r=Zr(),s=Jn();for(;e!==void 0;)switch(e._tag){case ns:{if(n.length===0)return[r,s];e=n.pop();break}case Li:{if(r=ko(r,oh(e._tag,e.error)),n.length===0)return[r,s];e=n.pop();break}case vc:{if(r=ko(r,oh(e._tag,e.defect)),n.length===0)return[r,s];e=n.pop();break}case Di:{if(r=ko(r,oh(e._tag,e.fiberId)),n.length===0)return[r,s];e=n.pop();break}case pi:{switch(e.left._tag){case ns:{e=e.right;break}case pi:{e=$t(e.left.left,$t(e.left.right,e.right));break}case di:{e=il($t(e.left.left,e.right),$t(e.left.right,e.right));break}default:{s=pn(s,e.right),e=e.left;break}}break}case di:{n.push(e.right),e=e.left;break}}throw new Error(Ku("Cause.evaluateCauseLoop"))},$$={emptyCase:qm,failCase:id,dieCase:id,interruptCase:qm,sequentialCase:(t,e,n)=>e&&n,parallelCase:(t,e,n)=>e&&n},ow="SequentialCase",cw="ParallelCase",Sv=Q(2,(t,{onDie:e,onEmpty:n,onFail:r,onInterrupt:s,onParallel:i,onSequential:o})=>Eg(t,void 0,{emptyCase:()=>n,failCase:(c,a)=>r(a),dieCase:(c,a)=>e(a),interruptCase:(c,a)=>s(a),sequentialCase:(c,a,u)=>o(a,u),parallelCase:(c,a,u)=>i(a,u)})),gi=Q(3,(t,e,n)=>{let r=e,s=t;const i=[];for(;s!==void 0;){const o=n(r,s);switch(r=kn(o)?o.value:r,s._tag){case pi:{i.push(s.right),s=s.left;break}case di:{i.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&i.length>0&&(s=i.pop())}return r}),Eg=Q(3,(t,e,n)=>{const r=[t],s=[];for(;r.length>0;){const o=r.pop();switch(o._tag){case ns:{s.push(qn(n.emptyCase(e)));break}case Li:{s.push(qn(n.failCase(e,o.error)));break}case vc:{s.push(qn(n.dieCase(e,o.defect)));break}case Di:{s.push(qn(n.interruptCase(e,o.fiberId)));break}case pi:{r.push(o.right),r.push(o.left),s.push(ri({_tag:ow}));break}case di:{r.push(o.right),r.push(o.left),s.push(ri({_tag:cw}));break}}}const i=[];for(;s.length>0;){const o=s.pop();switch(o._tag){case"Left":{switch(o.left._tag){case ow:{const c=i.pop(),a=i.pop(),u=n.sequentialCase(e,c,a);i.push(u);break}case cw:{const c=i.pop(),a=i.pop(),u=n.parallelCase(e,c,a);i.push(u);break}}break}case"Right":{i.push(o.right);break}}}if(i.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return i.pop()}),kc=(t,e)=>Sg(t)?"All fibers interrupted without errors.":vv(t).map(function(n){return e?.renderErrorCause!==!0||n.cause===void 0?n.stack:`${n.stack} {
${Ev(n.cause,"  ")}
}`}).join(`
`),Ev=(t,e)=>{const n=t.stack.split(`
`);let r=`${e}[cause]: ${n[0]}`;for(let s=1,i=n.length;s<i;s++)r+=`
${e}${n[s]}`;return t.cause&&(r+=` {
${Ev(t.cause,`${e}  `)}
${e}}`),r};class fu extends globalThis.Error{span=void 0;constructor(e){const n=typeof e=="object"&&e!==null,r=Error.stackTraceLimit;Error.stackTraceLimit=1,super(B$(e),n&&"cause"in e&&typeof e.cause<"u"?{cause:new fu(e.cause)}:void 0),this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=r,this.name=e instanceof Error?e.name:"Error",n&&(yi in e&&(this.span=e[yi]),Object.keys(e).forEach(s=>{s in this||(this[s]=e[s])})),this.stack=V$(`${this.name}: ${this.message}`,e instanceof Error&&e.stack?e.stack:"",this.span)}}const B$=t=>{if(typeof t=="string")return t;if(typeof t=="object"&&t!==null&&t instanceof Error)return t.message;try{if(Ae(t,"toString")&&Vu(t.toString)&&t.toString!==Object.prototype.toString&&t.toString!==globalThis.Array.prototype.toString)return t.toString()}catch{}return JE(t)},q$=/\((.*)\)/g,U$=Be("effect/Tracer/spanToTrace",()=>new WeakMap),V$=(t,e,n)=>{const r=[t],s=e.startsWith(t)?e.slice(t.length).split(`
`):e.split(`
`);for(let i=1;i<s.length;i++){if(s[i].includes(" at new BaseEffectError")||s[i].includes(" at new YieldableError")){i++;continue}if(s[i].includes("Generator.next")||s[i].includes("effect_internal_function"))break;r.push(s[i].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let i=n,o=0;for(;i&&i._tag==="Span"&&o<10;){const c=U$.get(i);if(typeof c=="function"){const a=c();if(typeof a=="string"){const u=a.matchAll(q$);let h=!1;for(const[,l]of u)h=!0,r.push(`    at ${i.name} (${l})`);h||r.push(`    at ${i.name} (${a.replace(/^at /,"")})`)}else r.push(`    at ${i.name}`)}else r.push(`    at ${i.name}`);i=Ar(i.parent),o++}}return r.join(`
`)},yi=Symbol.for("effect/SpanAnnotation"),vv=t=>Eg(t,void 0,{emptyCase:()=>[],dieCase:(e,n)=>[new fu(n)],failCase:(e,n)=>[new fu(n)],interruptCase:()=>[],parallelCase:(e,n,r)=>[...n,...r],sequentialCase:(e,n,r)=>[...n,...r]}),xc="Pending",vg="Done",j$="effect/Deferred",K$=Symbol.for(j$),W$={_E:t=>t,_A:t=>t},z$=t=>({_tag:xc,joiners:t}),kv=t=>({_tag:vg,effect:t});class Ic{self;called=!1;constructor(e){this.self=e}next(e){return this.called?{value:e,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(e){return{value:e,done:!0}}throw(e){throw e}[Symbol.iterator](){return new Ic(this.self)}}const xv=(t,e)=>{const n=new mt("Blocked");return n.effect_instruction_i0=t,n.effect_instruction_i1=e,n},H$=t=>{const e=new mt("RunBlocked");return e.effect_instruction_i0=t,e},mi=Symbol.for("effect/Effect");class Q${patch;op;_op=Jp;constructor(e,n){this.patch=e,this.op=n}}class mt{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[mi]=ni;constructor(e){this._op=e}[Ie](e){return this===e}[Ce](){return Ye(this,zp(this))}pipe(){return ve(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:lt(this.effect_instruction_i0),effect_instruction_i1:lt(this.effect_instruction_i1),effect_instruction_i2:lt(this.effect_instruction_i2)}}toString(){return gt(this.toJSON())}[Xe](){return this.toJSON()}[Symbol.iterator](){return new Ic(new pc(this))}}class Iv{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[mi]=ni;constructor(e){this._op=e,this._tag=e}[Ie](e){return ll(e)&&e._op==="Failure"&&Te(this.effect_instruction_i0,e.effect_instruction_i0)}[Ce](){return Z(Ze(this._tag),$e(Se(this.effect_instruction_i0)),Ye(this))}get cause(){return this.effect_instruction_i0}pipe(){return ve(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return gt(this.toJSON())}[Xe](){return this.toJSON()}[Symbol.iterator](){return new Ic(new pc(this))}}class Tv{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[mi]=ni;constructor(e){this._op=e,this._tag=e}[Ie](e){return ll(e)&&e._op==="Success"&&Te(this.effect_instruction_i0,e.effect_instruction_i0)}[Ce](){return Z(Ze(this._tag),$e(Se(this.effect_instruction_i0)),Ye(this))}get value(){return this.effect_instruction_i0}pipe(){return ve(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,value:lt(this.value)}}toString(){return gt(this.toJSON())}[Xe](){return this.toJSON()}[Symbol.iterator](){return new Ic(new pc(this))}}const ol=t=>Ae(t,mi),it=t=>{const e=new mt(ZE);return e.effect_instruction_i0=t,e},G$=Q(3,(t,e,n)=>er(r=>ye(t,s=>ye(Us(Ge(()=>r(e(s)))),i=>Ge(()=>n(s,i)).pipe(Zn({onFailure:o=>{switch(i._tag){case At:return Ot($t(i.effect_instruction_i0,o));case Rt:return Ot(o)}},onSuccess:()=>i})))))),Xn=Q(2,(t,e)=>ye(t,()=>Fe(e))),ps=t=>Xn(t,void 0),Av=function(){const t=new mt(zu);switch(arguments.length){case 2:{t.effect_instruction_i0=arguments[0],t.commit=arguments[1];break}case 3:{t.effect_instruction_i0=arguments[0],t.effect_instruction_i1=arguments[1],t.commit=arguments[2];break}case 4:{t.effect_instruction_i0=arguments[0],t.effect_instruction_i1=arguments[1],t.effect_instruction_i2=arguments[2],t.commit=arguments[3];break}default:throw new Error(Ku("you're not supposed to end up here"))}return t},du=(t,e=hi)=>{const n=new mt(So);let r;return n.effect_instruction_i0=s=>{r=t(s)},n.effect_instruction_i1=e,Fv(n,s=>ol(r)?r:nt)},Rv=(t,e=hi)=>Ge(()=>du(t,e)),ss=(t,e=hi)=>Av(t,function(){let n,r;function s(a){n?n(a):r===void 0&&(r=a)}const i=new mt(So);i.effect_instruction_i0=a=>{n=a,r&&a(r)},i.effect_instruction_i1=e;let o,c;return this.effect_instruction_i0.length!==1?(c=new AbortController,o=Tt(()=>this.effect_instruction_i0(s,c.signal))):o=Tt(()=>this.effect_instruction_i0(s)),o||c?Fv(i,a=>(c&&c.abort(),o??nt)):i}),Id=Q(2,(t,e)=>Ig(t,{onFailure:e,onSuccess:Fe})),aw=Symbol.for("effect/OriginalAnnotation"),Cv=(t,e)=>kn(e)?new Proxy(t,{has(n,r){return r===yi||r===aw||r in n},get(n,r){return r===yi?e.value:r===aw?t:n[r]}}):t,uw=t=>ju(t)&&!(yi in t)?it(e=>Ot(Kn(Cv(t,Yv(e))))):Ot(Kn(t)),J$=t=>Y$(()=>Kn(new CB(t))),Xo=t=>Ig(t,{onFailure:e=>Fe(ri(e)),onSuccess:e=>Fe(qn(e))}),Us=t=>Z$(t,{onFailure:Ke,onSuccess:et}),dt=t=>ju(t)&&!(yi in t)?it(e=>Ot(hu(Cv(t,Yv(e))))):Ot(hu(t)),kg=t=>ye(me(t),dt),Ot=t=>{const e=new Iv(At);return e.effect_instruction_i0=t,e},Y$=t=>ye(me(t),Ot),Ov=it(t=>Fe(t.id())),Mv=t=>it(e=>t(e.id())),ye=Q(2,(t,e)=>{const n=new mt(tu);return n.effect_instruction_i0=t,n.effect_instruction_i1=e,n}),X$=t=>{const e=new mt("OnStep");return e.effect_instruction_i0=t,e},xg=t=>ye(t,We),Z$=Q(2,(t,e)=>Zn(t,{onFailure:n=>Fe(e.onFailure(n)),onSuccess:n=>Fe(e.onSuccess(n))})),Zn=Q(2,(t,e)=>{const n=new mt(nu);return n.effect_instruction_i0=t,n.effect_instruction_i1=e.onFailure,n.effect_instruction_i2=e.onSuccess,n}),Ig=Q(2,(t,e)=>Zn(t,{onFailure:n=>{if(R$(n).length>0)return Ot(D$(n));const s=A$(n);return s.length>0?e.onFailure(M0(s)):Ot(n)},onSuccess:e.onSuccess})),Un=Q(2,(t,e)=>Ge(()=>{const n=st(t),r=Zp(n.length);let s=0;return Xn(Ag({while:()=>s<n.length,body:()=>e(n[s],s),step:i=>{r[s++]=i}}),r)})),cl=Q(2,(t,e)=>Ge(()=>{const n=st(t);let r=0;return Ag({while:()=>r<n.length,body:()=>e(n[r],r),step:()=>{r++}})})),Lv=t=>{const e=new mt(yc);return e.effect_instruction_i0=a$(Mi),e.effect_instruction_i1=()=>t,e},Qe=Q(2,(t,e)=>ye(t,n=>me(()=>e(n)))),Dv=Q(2,(t,e)=>Ig(t,{onFailure:n=>kg(()=>e.onFailure(n)),onSuccess:n=>me(()=>e.onSuccess(n))})),Tg=Q(2,(t,e)=>Zn(t,{onFailure:n=>{const r=M$(n);switch(r._tag){case"Left":return kg(()=>e(r.left));case"Right":return Ot(r.right)}},onSuccess:Fe})),wi=Q(2,(t,e)=>er(n=>Zn(n(t),{onFailure:r=>{const s=Ke(r);return Zn(e(s),{onFailure:i=>Ke($t(r,i)),onSuccess:()=>s})},onSuccess:r=>{const s=et(r);return wn(e(s),s)}}))),Fv=Q(2,(t,e)=>wi(t,Mg({onFailure:n=>Sg(n)?ps(e(C$(n))):nt,onSuccess:()=>nt}))),Fe=t=>{const e=new Tv(Rt);return e.effect_instruction_i0=t,e},Ge=t=>{const e=new mt(zu);return e.commit=t,e},me=t=>{const e=new mt(XE);return e.effect_instruction_i0=t,e},eB=Q(t=>t.length===3||t.length===2&&!(ju(t[1])&&"onlyEffect"in t[1]),(t,e)=>ye(t,n=>{const r=typeof e=="function"?e(n):e;return ol(r)?Xn(r,n):QL(r)?du(s=>{r.then(i=>s(Fe(n)),i=>s(dt(new Hv(i,"An unknown error occurred in Effect.tap"))))}):Fe(n)})),tB=t=>it(e=>{const n=e.getFiberRef(Rd),r=Z(n,Sn(()=>e.scope()));return t(Tc(Rd,De(r)))}),Nv=t=>{const e=new mt(yc);return e.effect_instruction_i0=dv(Mi),e.effect_instruction_i1=()=>t,e},er=t=>Av(t,function(){const e=new mt(yc);return e.effect_instruction_i0=dv(Mi),e.effect_instruction_i1=n=>hv(n)?Tt(()=>this.effect_instruction_i0(Lv)):Tt(()=>this.effect_instruction_i0(Nv)),e}),nt=Fe(void 0),nB=t=>{const e=new mt(yc);return e.effect_instruction_i0=t,e.effect_instruction_i1=void 0,e},rB=Q(2,(t,e)=>ye(e,n=>n?Z(t,Qe(De)):Fe(Ee()))),Ag=t=>{const e=new mt(ru);return e.effect_instruction_i0=t.while,e.effect_instruction_i1=t.body,e.effect_instruction_i2=t.step,e},Td=t=>Ge(()=>{const e=new mt(Eo);return e.effect_instruction_i0=t(),e}),Pv=function(){const t=arguments.length===1?arguments[0]:arguments[1].bind(arguments[0]);return Td(()=>t(Z))},sB=(t,...e)=>Object.defineProperty(e.length===0?function(...n){return Td(()=>t.apply(this,n))}:function(...n){let r=Td(()=>t.apply(this,n));for(const s of e)r=s(r,...n);return r},"length",{value:t.length,configurable:!0}),Rg=t=>{const e=new mt(ba);return typeof t?.priority<"u"?kB(e,t.priority):e},$v=Q(2,(t,e)=>ye(t,n=>Qe(e,r=>[n,r]))),Bv=Q(2,(t,e)=>ye(t,n=>Xn(e,n))),wn=Q(2,(t,e)=>ye(t,()=>e)),iB=Q(3,(t,e,n)=>ye(t,r=>Qe(e,s=>n(r,s)))),oB=t=>ye(Ov,e=>Z(t,qv(e))),qv=Q(2,(t,e)=>ye(t.interruptAsFork(e),()=>t.await)),cB={_tag:"All",syslog:0,label:"ALL",ordinal:Number.MIN_SAFE_INTEGER,pipe(){return ve(this,arguments)}},aB={_tag:"Fatal",syslog:2,label:"FATAL",ordinal:5e4,pipe(){return ve(this,arguments)}},uB={_tag:"Error",syslog:3,label:"ERROR",ordinal:4e4,pipe(){return ve(this,arguments)}},Uv={_tag:"Warning",syslog:4,label:"WARN",ordinal:3e4,pipe(){return ve(this,arguments)}},Vv={_tag:"Info",syslog:6,label:"INFO",ordinal:2e4,pipe(){return ve(this,arguments)}},jv={_tag:"Debug",syslog:7,label:"DEBUG",ordinal:1e4,pipe(){return ve(this,arguments)}},lB={_tag:"Trace",syslog:7,label:"TRACE",ordinal:0,pipe(){return ve(this,arguments)}},hB={_tag:"None",syslog:7,label:"OFF",ordinal:Number.MAX_SAFE_INTEGER,pipe(){return ve(this,arguments)}},fB="effect/FiberRef",dB=Symbol.for(fB),pB={_A:t=>t},Cg=t=>it(e=>et(e.getFiberRef(t))),al=Q(2,(t,e)=>ye(Cg(t),e)),lw=Q(2,(t,e)=>gB(t,()=>[void 0,e])),gB=Q(2,(t,e)=>it(n=>{const[r,s]=e(n.getFiberRef(t));return n.setFiberRef(t,s),Fe(r)})),Tc=Q(3,(t,e,n)=>G$(Bv(Cg(e),lw(e,n)),()=>t,r=>lw(e,r))),yB=Q(3,(t,e,n)=>al(e,r=>Tc(t,e,n(r)))),Vt=(t,e)=>Ni(t,{differ:cv(),fork:e?.fork??We,join:e?.join}),mB=t=>{const e=HP();return Ni(t,{differ:e,fork:e.empty})},wB=t=>{const e=QP(cv());return Ni(t,{differ:e,fork:e.empty})},Kv=t=>{const e=zP();return Ni(t,{differ:e,fork:e.empty})},Ni=(t,e)=>({...wc,[dB]:pB,initial:t,commit(){return Cg(this)},diff:(r,s)=>e.differ.diff(r,s),combine:(r,s)=>e.differ.combine(r,s),patch:r=>s=>e.differ.patch(r,s),fork:e.fork,join:e.join??((r,s)=>s)}),bB=t=>Ni(t,{differ:rw,fork:rw.empty}),gs=Be(Symbol.for("effect/FiberRef/currentContext"),()=>Kv(rg())),ul=Be(Symbol.for("effect/FiberRef/currentSchedulingPriority"),()=>Vt(0)),_B=Be(Symbol.for("effect/FiberRef/currentMaxOpsBeforeYield"),()=>Vt(2048)),SB=Be(Symbol.for("effect/FiberRef/currentLogAnnotation"),()=>Vt(mg())),EB=Be(Symbol.for("effect/FiberRef/currentLogLevel"),()=>Vt(Vv)),vB=Be(Symbol.for("effect/FiberRef/currentLogSpan"),()=>Vt(fi())),kB=Q(2,(t,e)=>Tc(t,ul,e)),xB=Be(Symbol.for("effect/FiberRef/currentConcurrency"),()=>Vt("unbounded")),IB=Be(Symbol.for("effect/FiberRef/currentRequestBatching"),()=>Vt(!0)),TB=Be(Symbol.for("effect/FiberRef/currentUnhandledErrorLogLevel"),()=>Vt(De(jv))),AB=Be(Symbol.for("effect/FiberRef/versionMismatchErrorLogLevel"),()=>Vt(De(Uv))),Ad=Be(Symbol.for("effect/FiberRef/currentMetricLabels"),()=>wB(ii())),Rd=Be(Symbol.for("effect/FiberRef/currentForkScopeOverride"),()=>Vt(Ee(),{fork:()=>Ee(),join:(t,e)=>t})),Kc=Be(Symbol.for("effect/FiberRef/currentInterruptedCause"),()=>Vt(rs,{fork:()=>rs,join:(t,e)=>t})),hw=Symbol.for("effect/Scope"),fw=Symbol.for("effect/CloseableScope"),RB=(t,e)=>t.addFinalizer(()=>ps(e)),dw=(t,e)=>t.addFinalizer(e),Cd=(t,e)=>t.close(e),Pn=(t,e)=>t.fork(e),Og=(function(){class t extends globalThis.Error{commit(){return dt(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[Xe](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?kc(hu(this),{renderErrorCause:!0}):this}}return Object.assign(t.prototype,wD),t})(),Wv=(t,e)=>{class n extends Og{_tag=e}return Object.assign(n.prototype,t),n.prototype.name=e,n},pw=Symbol.for("effect/Cause/errors/RuntimeException"),CB=Wv({[pw]:pw},"RuntimeException"),OB=Symbol.for("effect/Cause/errors/InterruptedException"),MB=t=>Ae(t,OB),gw=Symbol.for("effect/Cause/errors/NoSuchElement"),zv=Wv({[gw]:gw},"NoSuchElementException"),yw=Symbol.for("effect/Cause/errors/UnknownException"),Hv=(function(){class t extends Og{_tag="UnknownException";error;constructor(n,r){super(r??"An unknown error occurred",{cause:n}),this.error=n}}return Object.assign(t.prototype,{[yw]:yw,name:"UnknownException"}),t})(),ll=t=>ol(t)&&"_tag"in t&&(t._tag==="Success"||t._tag==="Failure"),LB=Q(2,(t,e)=>{switch(t._tag){case At:return Ke(t.effect_instruction_i0);case Rt:return et(e)}}),lh=t=>LB(t,void 0),xo=(t,e)=>PB(t,e?.parallel?il:$t),mw=t=>Ke(hu(t)),Ke=t=>{const e=new Iv(At);return e.effect_instruction_i0=t,e},DB=t=>Ke(pr(t)),hh=Q(2,(t,e)=>{switch(t._tag){case At:return Ke(t.effect_instruction_i0);case Rt:return et(e(t.effect_instruction_i0))}}),Mg=Q(2,(t,{onFailure:e,onSuccess:n})=>{switch(t._tag){case At:return e(t.effect_instruction_i0);case Rt:return n(t.effect_instruction_i0)}}),FB=Q(2,(t,{onFailure:e,onSuccess:n})=>{switch(t._tag){case At:return e(t.effect_instruction_i0);case Rt:return n(t.effect_instruction_i0)}}),et=t=>{const e=new Tv(Rt);return e.effect_instruction_i0=t,e},_n=et(void 0),NB=Q(3,(t,e,{onFailure:n,onSuccess:r})=>{switch(t._tag){case At:switch(e._tag){case Rt:return Ke(t.effect_instruction_i0);case At:return Ke(n(t.effect_instruction_i0,e.effect_instruction_i0))}case Rt:switch(e._tag){case Rt:return et(r(t.effect_instruction_i0,e.effect_instruction_i0));case At:return Ke(e.effect_instruction_i0)}}}),PB=(t,e)=>{const n=O0(t);return ci(n)?Z(Or(n),m0(Z(ai(n),hh(Gt)),(r,s)=>Z(r,NB(s,{onSuccess:(i,o)=>Z(i,pn(o)),onFailure:e}))),hh(oi),hh(r=>$r(r)),De):Ee()},Qv=t=>({...wc,[K$]:W$,state:gg(z$([])),commit(){return Lg(this)},blockingOn:t}),$B=()=>ye(Ov,t=>BB(t)),BB=t=>me(()=>Qv(t)),Lg=t=>Rv(e=>{const n=es(t.state);switch(n._tag){case vg:return e(n.effect);case xc:return n.joiners.push(e),VB(t,e)}},t.blockingOn),Gv=Q(2,(t,e)=>me(()=>{const n=es(t.state);switch(n._tag){case vg:return!1;case xc:{nl(t.state,kv(e));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](e);return!0}}})),qB=Q(2,(t,e)=>Gv(t,Ot(e))),UB=Q(2,(t,e)=>Gv(t,Fe(e))),Jv=(t,e)=>{const n=es(t.state);if(n._tag===xc){nl(t.state,kv(e));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](e)}},VB=(t,e)=>me(()=>{const n=es(t.state);if(n._tag===xc){const r=n.joiners.indexOf(e);r>=0&&n.joiners.splice(r,1)}}),jB=it(t=>et(t.currentContext)),KB=()=>jB,Pi=t=>ye(KB(),t),Dg=Q(2,(t,e)=>Tc(gs,e)(t)),Fg=Q(2,(t,e)=>yB(gs,n=>Qu(n,e))(t)),WB=Q(2,(t,e)=>Pi(n=>Dg(t,e(n)))),Yv=t=>{const e=t.currentSpan;return e!==void 0&&e._tag==="Span"?De(e):Ee()},ww=Symbol.for("effect/MutableHashMap"),zB={[ww]:ww,[Symbol.iterator](){return new Ng(this)},toString(){return gt(this.toJSON())},toJSON(){return{_id:"MutableHashMap",values:Array.from(this).map(lt)}},[Xe](){return this.toJSON()},pipe(){return ve(this,arguments)}};class Ng{self;referentialIterator;bucketIterator;constructor(e){this.self=e,this.referentialIterator=e.referential[Symbol.iterator]()}next(){if(this.bucketIterator!==void 0)return this.bucketIterator.next();const e=this.referentialIterator.next();return e.done?(this.bucketIterator=new HB(this.self.buckets.values()),this.next()):e}[Symbol.iterator](){return new Ng(this.self)}}class HB{backing;constructor(e){this.backing=e}currentBucket;next(){if(this.currentBucket===void 0){const n=this.backing.next();if(n.done)return n;this.currentBucket=n.value[Symbol.iterator]()}const e=this.currentBucket.next();return e.done?(this.currentBucket=void 0,this.next()):e}}const QB=()=>{const t=Object.create(zB);return t.referential=new Map,t.buckets=new Map,t.bucketsSize=0,t},Rr=Q(2,(t,e)=>{if(eu(e)===!1)return t.referential.has(e)?De(t.referential.get(e)):Ee();const n=e[Ce](),r=t.buckets.get(n);return r===void 0?Ee():GB(t,r,e)}),GB=(t,e,n,r=!1)=>{for(let s=0,i=e.length;s<i;s++)if(n[Ie](e[s][0])){const o=e[s][1];return r&&(e.splice(s,1),t.bucketsSize--),De(o)}return Ee()},Hi=Q(2,(t,e)=>kn(Rr(t,e))),Qi=Q(3,(t,e,n)=>{if(eu(e)===!1)return t.referential.set(e,n),t;const r=e[Ce](),s=t.buckets.get(r);return s===void 0?(t.buckets.set(r,[[e,n]]),t.bucketsSize++,t):(JB(t,s,e),s.push([e,n]),t.bucketsSize++,t)}),JB=(t,e,n)=>{for(let r=0,s=e.length;r<s;r++)if(n[Ie](e[r][0])){e.splice(r,1),t.bucketsSize--;return}},YB="effect/Clock",bw=Symbol.for(YB),Pg=ds("effect/Clock"),XB=2**31-1,_w={unsafeSchedule(t,e){const n=pd(e);if(n>XB)return id;let r=!1;const s=setTimeout(()=>{r=!0,t()},n);return()=>(clearTimeout(s),!r)}},Sw=(function(){const t=BigInt(1e6);if(typeof performance>"u"||typeof performance.now!="function")return()=>BigInt(Date.now())*t;let e;return()=>(e===void 0&&(e=BigInt(Date.now())*t-BigInt(Math.round(performance.now()*1e6))),e+BigInt(Math.round(performance.now()*1e6)))})(),ZB=(function(){const t=typeof process=="object"&&"hrtime"in process&&typeof process.hrtime.bigint=="function"?process.hrtime:void 0;if(!t)return Sw;const e=Sw()-t.bigint();return()=>e+t.bigint()})();class e2{[bw]=bw;unsafeCurrentTimeMillis(){return Date.now()}unsafeCurrentTimeNanos(){return ZB()}currentTimeMillis=me(()=>this.unsafeCurrentTimeMillis());currentTimeNanos=me(()=>this.unsafeCurrentTimeNanos());scheduler(){return Fe(_w)}sleep(e){return ss(n=>{const r=_w.unsafeSchedule(()=>n(nt),e);return ps(me(r))})}}const t2=()=>new e2,Xv="And",Zv="Or",ek="InvalidData",tk="MissingData",nk="SourceUnavailable",rk="Unsupported",n2="effect/ConfigError",Ew=Symbol.for(n2),$i={_tag:"ConfigError",[Ew]:Ew},sk=(t,e)=>{const n=Object.create($i);return n._op=Xv,n.left=t,n.right=e,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} and ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},ik=(t,e)=>{const n=Object.create($i);return n._op=Zv,n.left=t,n.right=e,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} or ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},r2=(t,e,n={pathDelim:"."})=>{const r=Object.create($i);return r._op=ek,r.path=t,r.message=e,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Invalid data at ${Z(this.path,Ci(n.pathDelim))}: "${this.message}")`}}),r},is=(t,e,n={pathDelim:"."})=>{const r=Object.create($i);return r._op=tk,r.path=t,r.message=e,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Missing data at ${Z(this.path,Ci(n.pathDelim))}: "${this.message}")`}}),r},s2=(t,e,n,r={pathDelim:"."})=>{const s=Object.create($i);return s._op=nk,s.path=t,s.message=e,s.cause=n,Object.defineProperty(s,"toString",{enumerable:!1,value(){return`(Source unavailable at ${Z(this.path,Ci(r.pathDelim))}: "${this.message}")`}}),s},i2=(t,e,n={pathDelim:"."})=>{const r=Object.create($i);return r._op=rk,r.path=t,r.message=e,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Unsupported operation at ${Z(this.path,Ci(n.pathDelim))}: "${this.message}")`}}),r},Mr=Q(2,(t,e)=>{switch(t._op){case Xv:return sk(Mr(t.left,e),Mr(t.right,e));case Zv:return ik(Mr(t.left,e),Mr(t.right,e));case ek:return r2([...e,...t.path],t.message);case tk:return is([...e,...t.path],t.message);case nk:return s2([...e,...t.path],t.message,t.cause);case rk:return i2([...e,...t.path],t.message)}}),o2={_tag:"Empty"},fh=Q(2,(t,e)=>{let n=wg(e),r=t;for(;eP(n);){const s=n.head;switch(s._tag){case"Empty":{n=n.tail;break}case"AndThen":{n=ts(s.first,ts(s.second,n.tail));break}case"MapName":{r=Ns(r,s.f),n=n.tail;break}case"Nested":{r=su(r,s.name),n=n.tail;break}case"Unnested":{if(Z(vo(r),ND(s.name)))r=si(r),n=n.tail;else return ri(is(r,`Expected ${s.name} to be in path in ConfigProvider#unnested`));break}}}return qn(r)}),c2="Constant",a2="Fail",u2="Fallback",l2="Described",h2="Lazy",f2="MapOrFail",d2="Nested",p2="Primitive",g2="Sequence",y2="HashMap",m2="ZipWith";var vw={};const pu=(t,e)=>[...t,...e],w2="effect/ConfigProvider",kw=Symbol.for(w2),b2=ds("effect/ConfigProvider"),_2="effect/ConfigProviderFlat",xw=Symbol.for(_2),S2=t=>({[kw]:kw,pipe(){return ve(this,arguments)},...t}),E2=t=>({[xw]:xw,patch:t.patch,load:(e,n,r=!0)=>t.load(e,n,r),enumerateChildren:t.enumerateChildren}),v2=t=>S2({load:e=>ye(tn(t,ii(),e,!1),n=>fs(vo(n),{onNone:()=>dt(is(ii(),`Expected a single value having structure: ${e}`)),onSome:Fe})),flattened:t}),k2=t=>{const{pathDelim:e,seqDelim:n}=Object.assign({},{pathDelim:"_",seqDelim:","},t),r=a=>Z(a,Ci(e)),s=a=>a.split(e),i=()=>typeof process<"u"&&"env"in process&&typeof vw=="object"?vw:{};return v2(E2({load:(a,u,h=!0)=>{const l=r(a),d=i(),f=l in d?De(d[l]):Ee();return Z(f,Tg(()=>is(a,`Expected ${l} to exist in the process context`)),ye(p=>R2(p,a,u,n,h)))},enumerateChildren:a=>me(()=>{const u=i(),d=Object.keys(u).map(f=>s(f.toUpperCase())).filter(f=>{for(let p=0;p<a.length;p++){const w=Z(a,g0(p)),g=f[p];if(g===void 0||w!==g)return!1}return!0}).flatMap(f=>f.slice(a.length,a.length+1));return FN(d)}),patch:o2}))},x2=(t,e,n,r)=>{const s=Wm(n.length,a=>a>=r.length?Ee():De([t(a),a+1])),i=Wm(r.length,a=>a>=n.length?Ee():De([e(a),a+1])),o=pu(n,s),c=pu(r,i);return[o,c]},I2=(t,e)=>{let n=e;if(n._tag==="Nested"){const r=t.slice();for(;n._tag==="Nested";)r.push(n.name),n=n.config;return r}return t},tn=(t,e,n,r)=>{const s=n;switch(s._tag){case c2:return Fe(an(s.value));case l2:return Ge(()=>tn(t,e,s.config,r));case a2:return dt(is(e,s.message));case u2:return Z(Ge(()=>tn(t,e,s.first,r)),Id(i=>s.condition(i)?Z(tn(t,e,s.second,r),Id(o=>dt(ik(i,o)))):dt(i)));case h2:return Ge(()=>tn(t,e,s.config(),r));case f2:return Ge(()=>Z(tn(t,e,s.original,r),ye(Un(i=>Z(s.mapOrFail(i),Tg(Mr(I2(e,s.original))))))));case d2:return Ge(()=>tn(t,pu(e,an(s.name)),s.config,r));case p2:return Z(fh(e,t.patch),ye(i=>Z(t.load(i,s,r),ye(o=>{if(o.length===0){const c=Z(zD(i),Sn(()=>"<n/a>"));return dt(is([],`Expected ${s.description} with name ${c}`))}return Fe(o)}))));case g2:return Z(fh(e,t.patch),ye(i=>Z(t.enumerateChildren(i),ye(O2),ye(o=>o.length===0?Ge(()=>Qe(tn(t,e,s.config,!0),an)):Z(Un(o,c=>tn(t,qD(e,`[${c}]`),s.config,!0)),Qe(c=>{const a=rF(c);return a.length===0?an(ii()):an(a)}))))));case y2:return Ge(()=>Z(fh(e,t.patch),ye(i=>Z(t.enumerateChildren(i),ye(o=>Z(o,Un(c=>tn(t,pu(i,an(c)),s.valueConfig,r)),Qe(c=>c.length===0?an(mg()):Z(C2(c),Ns(a=>WN(Km(st(o),a)))))))))));case m2:return Ge(()=>Z(tn(t,e,s.left,r),Xo,ye(i=>Z(tn(t,e,s.right,r),Xo,ye(o=>{if(fo(i)&&fo(o))return dt(sk(i.left,o.left));if(fo(i)&&Uc(o))return dt(i.left);if(Uc(i)&&fo(o))return dt(o.left);if(Uc(i)&&Uc(o)){const c=Z(e,Ci(".")),a=T2(e,c),[u,h]=x2(a,a,Z(i.right,Ns(qn)),Z(o.right,Ns(qn)));return Z(u,Km(h),Un(([l,d])=>Z($v(l,d),Qe(([f,p])=>s.zip(f,p)))))}throw new Error("BUG: ConfigProvider.fromFlatLoop - please report an issue at https://github.com/Effect-TS/effect/issues")})))))}},T2=(t,e)=>n=>ri(is(t,`The element at index ${n} in a sequence at path "${e}" was missing`)),A2=(t,e)=>t.split(new RegExp(`\\s*${iF(e)}\\s*`)),R2=(t,e,n,r,s)=>s?Z(A2(t,r),Un(i=>n.parse(i.trim())),Tg(Mr(e))):Z(n.parse(t),Dv({onFailure:Mr(e),onSuccess:an})),C2=t=>Object.keys(t[0]).map(e=>t.map(n=>n[e])),O2=t=>Z(Un(t,L2),Dv({onFailure:()=>ii(),onSuccess:iu(Wo)}),Xo,Qe(AD)),M2=/^(\[(\d+)\])$/,L2=t=>{const e=t.match(M2);if(e!==null){const n=e[2];return Z(n!==void 0&&n.length>0?De(n):Ee(),LD(D2))}return Ee()},D2=t=>{const e=Number.parseInt(t);return Number.isNaN(e)?Ee():De(e)},Iw=Symbol.for("effect/Console"),ok=ds("effect/Console"),F2={[Iw]:Iw,assert(t,...e){return me(()=>{console.assert(t,...e)})},clear:me(()=>{console.clear()}),count(t){return me(()=>{console.count(t)})},countReset(t){return me(()=>{console.countReset(t)})},debug(...t){return me(()=>{console.debug(...t)})},dir(t,e){return me(()=>{console.dir(t,e)})},dirxml(...t){return me(()=>{console.dirxml(...t)})},error(...t){return me(()=>{console.error(...t)})},group(t){return t?.collapsed?me(()=>console.groupCollapsed(t?.label)):me(()=>console.group(t?.label))},groupEnd:me(()=>{console.groupEnd()}),info(...t){return me(()=>{console.info(...t)})},log(...t){return me(()=>{console.log(...t)})},table(t,e){return me(()=>{console.table(t,e)})},time(t){return me(()=>console.time(t))},timeEnd(t){return me(()=>console.timeEnd(t))},timeLog(t,...e){return me(()=>{console.timeLog(t,...e)})},trace(...t){return me(()=>{console.trace(...t)})},warn(...t){return me(()=>{console.warn(...t)})},unsafe:console},N2="effect/Random",Tw=Symbol.for(N2),P2=ds("effect/Random");class $2{seed;[Tw]=Tw;PRNG;constructor(e){this.seed=e,this.PRNG=new tD(e)}get next(){return me(()=>this.PRNG.number())}get nextBoolean(){return Qe(this.next,e=>e>.5)}get nextInt(){return me(()=>this.PRNG.integer(Number.MAX_SAFE_INTEGER))}nextRange(e,n){return Qe(this.next,r=>(n-e)*r+e)}nextIntBetween(e,n){return me(()=>this.PRNG.integer(n-e)+e)}shuffle(e){return B2(e,n=>this.nextIntBetween(0,n))}}const B2=(t,e)=>Ge(()=>Z(me(()=>Array.from(t)),ye(n=>{const r=[];for(let s=n.length;s>=2;s=s-1)r.push(s);return Z(r,cl(s=>Z(e(s),Qe(i=>q2(n,s-1,i)))),Xn(O0(n)))}))),q2=(t,e,n)=>{const r=t[e];return t[e]=t[n],t[n]=r,t},U2=t=>new $2(Se(t)),Aw=Symbol.for("effect/Tracer"),V2=t=>({[Aw]:Aw,...t}),ck=ds("effect/Tracer"),ak=ds("effect/ParentSpan"),Rw=(function(){const t="abcdef0123456789",e=t.length;return function(n){let r="";for(let s=0;s<n;s++)r+=t.charAt(Math.floor(Math.random()*e));return r}})();class j2{name;parent;context;startTime;kind;_tag="Span";spanId;traceId="native";sampled=!0;status;attributes;events=[];links;constructor(e,n,r,s,i,o){this.name=e,this.parent=n,this.context=r,this.startTime=i,this.kind=o,this.status={_tag:"Started",startTime:i},this.attributes=new Map,this.traceId=n._tag==="Some"?n.value.traceId:Rw(32),this.spanId=Rw(16),this.links=Array.from(s)}end(e,n){this.status={_tag:"Ended",endTime:e,exit:n,startTime:this.status.startTime}}attribute(e,n){this.attributes.set(e,n)}event(e,n,r){this.events.push([e,n,r??{}])}addLinks(e){this.links.push(...e)}}const K2=V2({span:(t,e,n,r,s,i)=>new j2(t,e,n,r,s,i),context:t=>t()}),W2=Z(rg(),xs(Pg,t2()),xs(ok,F2),xs(P2,U2(Math.random())),xs(b2,k2()),xs(ck,K2)),gu=Be(Symbol.for("effect/DefaultServices/currentServices"),()=>Kv(W2));function z2(t){return new Sr(t)}function H2(){return z2(new Map)}const Cw=Symbol.for("effect/FiberRefs");class Sr{locals;[Cw]=Cw;constructor(e){this.locals=e}pipe(){return ve(this,arguments)}}const Q2=(t,e,n,r=!1)=>{const s=t;let i=e,o=n,c=r,a;for(;a===void 0;)if(Qt(i)&&Qt(o)){const u=qt(i)[0],h=si(i),l=qt(o)[0],d=qt(o)[1],f=si(o);u.startTimeMillis<l.startTimeMillis?(o=f,c=!0):u.startTimeMillis>l.startTimeMillis?i=h:u.id<l.id?(o=f,c=!0):u.id>l.id?i=h:a=[d,c]}else a=[s.initial,!0];return a},G2=Q(3,(t,e,n)=>{const r=new Map(t.locals);return n.locals.forEach((s,i)=>{const o=s[0][1];if(!s[0][0][Ie](e)){if(!r.has(i)){if(Te(o,i.initial))return;r.set(i,[[e,i.join(i.initial,o)]]);return}const c=r.get(i),[a,u]=Q2(i,c,s);if(u){const h=i.diff(a,o),l=c[0][1],d=i.join(l,i.patch(h)(l));if(!Te(l,d)){let f;const p=c[0][0];p[Ie](e)?f=[[p,d],...c.slice(1)]:f=[[e,d],...c],r.set(i,f)}}}}),new Sr(r)}),J2=Q(2,(t,e)=>{const n=new Map;return uk(t,n,e),new Sr(n)}),uk=(t,e,n)=>{t.locals.forEach((r,s)=>{const i=r[0][1],o=s.patch(s.fork)(i);Te(i,o)?e.set(s,r):e.set(s,[[n,o],...r])})},lk=Q(2,(t,e)=>{const n=new Map(t.locals);return n.delete(e),new Sr(n)}),Y2=Q(2,(t,e)=>t.locals.has(e)?De(qt(t.locals.get(e))[1]):Ee()),Zo=Q(2,(t,e)=>Z(Y2(t,e),Sn(()=>e.initial))),Od=Q(2,(t,{fiberId:e,fiberRef:n,value:r})=>{if(t.locals.size===0)return new Sr(new Map([[n,[[e,r]]]]));const s=new Map(t.locals);return Md(s,e,n,r),new Sr(s)}),Md=(t,e,n,r)=>{const s=t.get(n)??[];let i;if(Qt(s)){const[o,c]=qt(s);if(o[Ie](e)){if(Te(c,r))return;i=[[e,r],...s.slice(1)]}else i=[[e,r],...s]}else i=[[e,r]];t.set(n,i)},X2=Q(2,(t,{entries:e,forkAs:n})=>{if(t.locals.size===0)return new Sr(new Map(e));const r=new Map(t.locals);return n!==void 0&&uk(t,r,n),e.forEach(([s,i])=>{i.length===1?Md(r,i[0][0],s,i[0][1]):i.forEach(([o,c])=>{Md(r,o,s,c)})}),new Sr(r)}),Z2=Zo,eq=X2,tq=H2,nq=cB,rq=aB,hk=uB,fk=Uv,dk=Vv,pk=jv,sq=lB,iq=hB,oq=Z(Wo,CD(t=>t.ordinal)),cq=OD(oq),aq=t=>{switch(t){case"All":return nq;case"Debug":return pk;case"Error":return hk;case"Fatal":return rq;case"Info":return dk;case"Trace":return sq;case"None":return iq;case"Warning":return fk}},gk=t=>t.replace(/[\s="]/g,"_"),uq=t=>e=>`${gk(e.label)}=${t-e.startTime}ms`,lq=mc,hq=bD;class $g extends hq{}const yu=Symbol.for("effect/Readable"),yk=Symbol.for("effect/Ref"),mk={_A:t=>t};class fq extends $g{ref;commit(){return this.get}[yk]=mk;[yu]=yu;constructor(e){super(),this.ref=e,this.get=me(()=>es(this.ref))}get;modify(e){return me(()=>{const n=es(this.ref),[r,s]=e(n);return n!==s&&nl(s)(this.ref),r})}}const wk=t=>new fq(gg(t)),Ow=t=>me(()=>wk(t)),mu=t=>t.get,bk=Q(2,(t,e)=>t.modify(()=>[void 0,e])),dq=Q(2,(t,e)=>t.modify(e)),Mw=Q(2,(t,e)=>t.modify(n=>[void 0,e(n)])),_k="Empty",Sk="Add",Ek="Remove",vk="Update",kk="AndThen",pq={_tag:_k},xk=(t,e)=>{const n=new Map(t.locals);let r=pq;for(const[s,i]of e.locals.entries()){const o=qt(i)[1],c=n.get(s);if(c!==void 0){const a=qt(c)[1];Te(a,o)||(r=dh({_tag:vk,fiberRef:s,patch:s.diff(a,o)})(r))}else r=dh({_tag:Sk,fiberRef:s,value:o})(r);n.delete(s)}for(const[s]of n.entries())r=dh({_tag:Ek,fiberRef:s})(r);return r},dh=Q(2,(t,e)=>({_tag:kk,first:t,second:e})),Ik=Q(3,(t,e,n)=>{let r=n,s=an(t);for(;Qt(s);){const i=qt(s),o=si(s);switch(i._tag){case _k:{s=o;break}case Sk:{r=Od(r,{fiberId:e,fiberRef:i.fiberRef,value:i.value}),s=o;break}case Ek:{r=lk(r,i.fiberRef),s=o;break}case vk:{const c=Zo(r,i.fiberRef);r=Od(r,{fiberId:e,fiberRef:i.fiberRef,value:i.fiberRef.patch(i.patch)(c)}),s=o;break}case kk:{s=su(i.first)(su(i.second)(o));break}}}return r}),Tk="effect/MetricLabel",Ld=Symbol.for(Tk);class gq{key;value;[Ld]=Ld;_hash;constructor(e,n){this.key=e,this.value=n,this._hash=Ze(Tk+this.key+this.value)}[Ce](){return this._hash}[Ie](e){return mq(e)&&this.key===e.key&&this.value===e.value}pipe(){return ve(this,arguments)}}const yq=(t,e)=>new gq(t,e),mq=t=>Ae(t,Ld),wq=t=>Qe(t,De),bq=t=>Aq(t,_q,xk),_q=it(t=>Fe(t.getFiberRefs())),hl=t=>(...e)=>{const n=Hu(t);let r;for(let s=0,i=e.length;s<i;s++){const o=e[s];bv(o)&&(r!==void 0?r=$t(r,o):r=o,e=[...e.slice(0,s),...e.slice(s+1)],s--)}return r===void 0&&(r=rs),it(s=>(s.log(e,r,n),nt))},Sq=hl(pk),Eq=hl(dk),vq=hl(fk),kq=hl(hk),xq=t=>Cq((e,n)=>Z(t,Ik(e,n))),Iq=Q(3,(t,e,n)=>Pi(r=>Dg(t,xs(r,e,n)))),Tq=Fe(Ee()),Aq=Q(3,(t,e,n)=>ye(e,r=>ye(t,s=>Qe(e,i=>[n(r,i),s])))),Rq=t=>{let e,n;typeof t=="function"?e=t:(e=t.try,n=t.catch);const r=s=>n?kg(()=>n(s)):dt(new Hv(s,"An unknown error occurred in Effect.tryPromise"));return e.length>=1?ss((s,i)=>{try{e(i).then(o=>s(Fe(o)),o=>s(r(o)))}catch(o){s(r(o))}}):ss(s=>{try{e().then(i=>s(Fe(i)),i=>s(r(i)))}catch(i){s(r(i))}})},Cq=t=>it(e=>(e.setFiberRefs(t(e.id(),e.getFiberRefs())),nt)),Ak="Sequential",Rk="Parallel",Oq="ParallelN",qr={_tag:Ak},Dd={_tag:Rk},Mq=t=>({_tag:Oq,parallelism:t}),Lq=t=>t._tag===Ak,Dq=t=>t._tag===Rk,Fd=qr,Nd=Dd,Pd=Mq,$d=xk,Bd=Ik,fl="effect/FiberStatus",os=Symbol.for(fl),wu="Done",Lw="Running",Dw="Suspended",Fq=Ze(`${fl}-${wu}`);class Nq{[os]=os;_tag=wu;[Ce](){return Fq}[Ie](e){return Bg(e)&&e._tag===wu}}class Pq{runtimeFlags;[os]=os;_tag=Lw;constructor(e){this.runtimeFlags=e}[Ce](){return Z(Se(fl),$e(Se(this._tag)),$e(Se(this.runtimeFlags)),Ye(this))}[Ie](e){return Bg(e)&&e._tag===Lw&&this.runtimeFlags===e.runtimeFlags}}class $q{runtimeFlags;blockingOn;[os]=os;_tag=Dw;constructor(e,n){this.runtimeFlags=e,this.blockingOn=n}[Ce](){return Z(Se(fl),$e(Se(this._tag)),$e(Se(this.runtimeFlags)),$e(Se(this.blockingOn)),Ye(this))}[Ie](e){return Bg(e)&&e._tag===Dw&&this.runtimeFlags===e.runtimeFlags&&Te(this.blockingOn,e.blockingOn)}}const Bq=new Nq,qq=t=>new Pq(t),Uq=(t,e)=>new $q(t,e),Bg=t=>Ae(t,os),Vq=t=>t._tag===wu,jq=Bq,Ck=qq,Kq=Uq,Wq=Vq,zq=Symbol.for("effect/Micro"),bu=Symbol.for("effect/Micro/MicroExit"),Fw=Symbol.for("effect/Micro/MicroCause"),Hq={_E:We};class Ok extends globalThis.Error{_tag;traces;[Fw];constructor(e,n,r){const s=`MicroCause.${e}`;let i,o,c;if(n instanceof globalThis.Error){i=`(${s}) ${n.name}`,o=n.message;const a=o.split(`
`).length;c=n.stack?`(${s}) ${n.stack.split(`
`).slice(0,a+3).join(`
`)}`:`${i}: ${o}`}else i=s,o=ti(n,0),c=`${i}: ${o}`;r.length>0&&(c+=`
    ${r.join(`
    `)}`),super(o),this._tag=e,this.traces=r,this[Fw]=Hq,this.name=i,this.stack=c}pipe(){return ve(this,arguments)}toString(){return this.stack}[Xe](){return this.stack}}class Qq extends Ok{defect;constructor(e,n=[]){super("Die",e,n),this.defect=e}}const Gq=(t,e=[])=>new Qq(t,e);class Jq extends Ok{constructor(e=[]){super("Interrupt","interrupted",e)}}const Yq=(t=[])=>new Jq(t),Xq=t=>t._tag==="Interrupt",Nw=Symbol.for("effect/Micro/MicroFiber"),Zq={_A:We,_E:We};class eU{context;interruptible;[Nw];_stack=[];_observers=[];_exit;_children;currentOpCount=0;constructor(e,n=!0){this.context=e,this.interruptible=n,this[Nw]=Zq}getRef(e){return bF(this.context,e)}addObserver(e){return this._exit?(e(this._exit),VL):(this._observers.push(e),()=>{const n=this._observers.indexOf(e);n>=0&&this._observers.splice(n,1)})}_interrupted=!1;unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(Kg))}unsafePoll(){return this._exit}evaluate(e){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(e);if(n===Wc)return;const r=Pw.interruptChildren&&Pw.interruptChildren(this);if(r!==void 0)return this.evaluate(Su(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(e){let n=!1,r=e;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(Wg).shouldYield(this)){n=!0;const s=r;r=Su(iU,()=>s)}if(r=r[qd](this),r===Wc){const s=this._yielded;return bu in s?(this._yielded=void 0,s):Wc}}}catch(s){return Ae(r,qd)?Ud(s):Ud(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(e){for(;;){const n=this._stack.pop();if(!n)return;const r=n[_u]&&n[_u](this);if(r)return{[e]:r};if(n[e])return n}}_yielded=void 0;yieldWith(e){return this._yielded=e,Wc}children(){return this._children??=new Set}}const Pw=Be("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),Mk=Symbol.for("effect/Micro/identifier"),ut=Symbol.for("effect/Micro/args"),qd=Symbol.for("effect/Micro/evaluate"),bi=Symbol.for("effect/Micro/successCont"),Vs=Symbol.for("effect/Micro/failureCont"),_u=Symbol.for("effect/Micro/ensureCont"),Wc=Symbol.for("effect/Micro/Yield"),tU={_A:We,_E:We,_R:We},nU={...lq,_op:"Micro",[zq]:tU,pipe(){return ve(this,arguments)},[Symbol.iterator](){return new zE(new pc(this))},toJSON(){return{_id:"Micro",op:this[Mk],...ut in this?{args:this[ut]}:void 0}},toString(){return gt(this)},[Xe](){return gt(this)}};function rU(t){return Ud("Micro.evaluate: Not implemented")}const dl=t=>({...nU,[Mk]:t.op,[qd]:t.eval??rU,[bi]:t.contA,[Vs]:t.contE,[_u]:t.ensure}),qg=t=>{const e=dl(t);return function(){const n=Object.create(e);return n[ut]=t.single===!1?arguments:arguments[0],n}},Lk=t=>{const e={...dl(t),[bu]:bu,_tag:t.op,get[t.prop](){return this[ut]},toJSON(){return{_id:"MicroExit",_tag:t.op,[t.prop]:this[ut]}},[Ie](n){return aU(n)&&n._tag===t.op&&Te(this[ut],n[ut])},[Ce](){return Ye(this,$e(Ze(t.op))(Se(this[ut])))}};return function(n){const r=Object.create(e);return r[ut]=n,r[bi]=void 0,r[Vs]=void 0,r[_u]=void 0,r}},Ug=Lk({op:"Success",prop:"value",eval(t){const e=t.getCont(bi);return e?e[bi](this[ut],t):t.yieldWith(this)}}),Dk=Lk({op:"Failure",prop:"cause",eval(t){let e=t.getCont(Vs);for(;Xq(this[ut])&&e&&t.interruptible;)e=t.getCont(Vs);return e?e[Vs](this[ut],t):t.yieldWith(this)}}),sU=qg({op:"Yield",eval(t){let e=!1;return t.getRef(Wg).scheduleTask(()=>{e||t.evaluate(uU)},this[ut]??0),t.yieldWith(()=>{e=!0})}}),iU=sU(0),oU=Ug(void 0),Vg=qg({op:"WithMicroFiber",eval(t){return this[ut](t)}}),Su=Q(2,(t,e)=>{const n=Object.create(cU);return n[ut]=t,n[bi]=e,n}),cU=dl({op:"OnSuccess",eval(t){return t._stack.push(this),this[ut]}}),aU=t=>Ae(t,bu),Fk=Ug,jg=Dk,Kg=jg(Yq()),Ud=t=>jg(Gq(t)),uU=Fk(void 0),lU="setImmediate"in globalThis?globalThis.setImmediate:t=>setTimeout(t,0);class Nk{tasks=[];running=!1;scheduleTask(e,n){this.tasks.push(e),this.running||(this.running=!0,lU(this.afterScheduled))}afterScheduled=()=>{this.running=!1,this.runTasks()};runTasks(){const e=this.tasks;this.tasks=[];for(let n=0,r=e.length;n<r;n++)e[n]()}shouldYield(e){return e.currentOpCount>=e.getRef(dU)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const hU=Q(2,(t,e)=>Vg(n=>{const r=n.context;return n.context=e(r),yU(t,()=>(n.context=r,oU))})),fU=Q(2,(t,e)=>hU(t,Qu(e)));class dU extends sg()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class Wg extends sg()("effect/Micro/currentScheduler",{defaultValue:()=>new Nk}){}const pU=Q(2,(t,e)=>{const n=Object.create(gU);return n[ut]=t,n[bi]=e.onSuccess,n[Vs]=e.onFailure,n}),gU=dl({op:"OnSuccessAndFailure",eval(t){return t._stack.push(this),this[ut]}}),yU=Q(2,(t,e)=>wU(n=>pU(n(t),{onFailure:r=>Su(e(jg(r)),()=>Dk(r)),onSuccess:r=>Su(e(Fk(r)),()=>Ug(r))}))),Pk=qg({op:"SetInterruptible",ensure(t){if(t.interruptible=this[ut],t._interrupted&&t.interruptible)return()=>Kg}}),mU=t=>Vg(e=>e.interruptible?t:(e.interruptible=!0,e._stack.push(Pk(!1)),e._interrupted?Kg:t)),wU=t=>Vg(e=>e.interruptible?(e.interruptible=!1,e._stack.push(Pk(!0)),t(mU)):t(We)),bU=(t,e)=>{const n=new eU(Wg.context(new Nk));return n.evaluate(t),n};class _U{buckets=[];scheduleTask(e,n){const r=this.buckets.length;let s,i=0;for(;i<r&&this.buckets[i][0]<=n;i++)s=this.buckets[i];s&&s[0]===n?s[1].push(e):i===r?this.buckets.push([n,[e]]):this.buckets.splice(i,0,[n,[e]])}}class SU{maxNextTickBeforeTimer;running=!1;tasks=new _U;constructor(e){this.maxNextTickBeforeTimer=e}starveInternal(e){const n=this.tasks.buckets;this.tasks.buckets=[];for(const[r,s]of n)for(let i=0;i<s.length;i++)s[i]();this.tasks.buckets.length===0?this.running=!1:this.starve(e)}starve(e=0){e>=this.maxNextTickBeforeTimer?setTimeout(()=>this.starveInternal(0),0):Promise.resolve(void 0).then(()=>this.starveInternal(e+1))}shouldYield(e){return e.currentOpCount>e.getFiberRef(_B)?e.getFiberRef(ul):!1}scheduleTask(e,n){this.tasks.scheduleTask(e,n),this.running||(this.running=!0,this.starve())}}const EU=Be(Symbol.for("effect/Scheduler/defaultScheduler"),()=>new SU(2048)),zg=Be(Symbol.for("effect/FiberRef/currentScheduler"),()=>Vt(EU)),$k=Be(Symbol.for("effect/FiberRef/currentRequestMap"),()=>Vt(new Map)),$w=(t,e,n,r)=>{switch(t){case void 0:return e();case"unbounded":return n();case"inherit":return al(xB,s=>s==="unbounded"?n():s>1?r(s):e());default:return t>1?r(t):e()}},Hg="InterruptSignal",Qg="Stateful",Gg="Resume",Jg="YieldNow",ph=t=>({_tag:Hg,cause:t}),ka=t=>({_tag:Qg,onFiber:t}),vs=t=>({_tag:Gg,effect:t}),vU=()=>({_tag:Jg}),kU="effect/FiberScope",Eu=Symbol.for(kU);class xU{[Eu]=Eu;fiberId=hi;roots=new Set;add(e,n){this.roots.add(n),n.addObserver(()=>{this.roots.delete(n)})}}class IU{fiberId;parent;[Eu]=Eu;constructor(e,n){this.fiberId=e,this.parent=n}add(e,n){this.parent.tell(ka(r=>{r.addChild(n),n.addObserver(()=>{r.removeChild(n)})}))}}const TU=t=>new IU(t.id(),t),Yg=Be(Symbol.for("effect/FiberScope/Global"),()=>new xU),AU="effect/Fiber",RU=Symbol.for(AU),CU={_E:t=>t,_A:t=>t},OU="effect/Fiber",MU=Symbol.for(OU),Bk=t=>Bv(xg(t.await),t.inheritAll);({...wc});const Ir="effect/FiberCurrent",LU="effect/Logger",DU=Symbol.for(LU),FU={_Message:t=>t,_Output:t=>t},Xg=t=>({[DU]:FU,log:t,pipe(){return ve(this,arguments)}}),NU=/^[^\s"=]*$/,PU=(t,e)=>({annotations:n,cause:r,date:s,fiberId:i,logLevel:o,message:c,spans:a})=>{const u=p=>p.match(NU)?p:t(p),h=(p,w)=>`${gk(p)}=${u(w)}`,l=(p,w)=>" "+h(p,w);let d=h("timestamp",s.toISOString());d+=l("level",o.label),d+=l("fiber",J0(i));const f=BD(c);for(let p=0;p<f.length;p++)d+=l("message",ti(f[p],e));x$(r)||(d+=l("cause",kc(r,{renderErrorCause:!0})));for(const p of a)d+=" "+uq(s.getTime())(p);for(const[p,w]of n)d+=l(p,ti(w,e));return d},$U=t=>`"${t.replace(/\\([\s\S])|(")/g,"\\$1$2")}"`,BU=Xg(PU($U)),qU=typeof process=="object"&&process!==null&&typeof process.stdout=="object"&&process.stdout!==null;qU&&process.stdout.isTTY;const qk="effect/MetricBoundaries",Vd=Symbol.for(qk);class UU{values;[Vd]=Vd;constructor(e){this.values=e,this._hash=Z(Ze(qk),$e(gc(this.values)))}_hash;[Ce](){return this._hash}[Ie](e){return VU(e)&&Te(this.values,e.values)}pipe(){return ve(this,arguments)}}const VU=t=>Ae(t,Vd),jU=t=>{const e=Z(t,d0(Gt(Number.POSITIVE_INFINITY)),sF);return new UU(e)},KU=t=>Z($D(t.count-1,e=>t.start*Math.pow(t.factor,e)),Gu,jU),WU="effect/MetricKeyType",Uk=Symbol.for(WU),Vk="effect/MetricKeyType/Counter",jd=Symbol.for(Vk),zU="effect/MetricKeyType/Frequency",HU=Symbol.for(zU),QU="effect/MetricKeyType/Gauge",GU=Symbol.for(QU),jk="effect/MetricKeyType/Histogram",Kd=Symbol.for(jk),JU="effect/MetricKeyType/Summary",YU=Symbol.for(JU),Kk={_In:t=>t,_Out:t=>t};class XU{incremental;bigint;[Uk]=Kk;[jd]=jd;constructor(e,n){this.incremental=e,this.bigint=n,this._hash=Ze(Vk)}_hash;[Ce](){return this._hash}[Ie](e){return Wk(e)}pipe(){return ve(this,arguments)}}class ZU{boundaries;[Uk]=Kk;[Kd]=Kd;constructor(e){this.boundaries=e,this._hash=Z(Ze(jk),$e(Se(this.boundaries)))}_hash;[Ce](){return this._hash}[Ie](e){return zk(e)&&Te(this.boundaries,e.boundaries)}pipe(){return ve(this,arguments)}}const eV=t=>new XU(t?.incremental??!1,t?.bigint??!1),tV=t=>new ZU(t),Wk=t=>Ae(t,jd),nV=t=>Ae(t,HU),rV=t=>Ae(t,GU),zk=t=>Ae(t,Kd),sV=t=>Ae(t,YU),iV="effect/MetricKey",Hk=Symbol.for(iV),oV={_Type:t=>t},cV=eg(Te);class Zg{name;keyType;description;tags;[Hk]=oV;constructor(e,n,r,s=[]){this.name=e,this.keyType=n,this.description=r,this.tags=s,this._hash=Z(Ze(this.name+this.description),$e(Se(this.keyType)),$e(gc(this.tags)))}_hash;[Ce](){return this._hash}[Ie](e){return aV(e)&&this.name===e.name&&Te(this.keyType,e.keyType)&&Te(this.description,e.description)&&cV(this.tags,e.tags)}pipe(){return ve(this,arguments)}}const aV=t=>Ae(t,Hk),uV=(t,e)=>new Zg(t,eV(e),Hu(e?.description)),lV=(t,e,n)=>new Zg(t,tV(e),Hu(n)),hV=Q(2,(t,e)=>e.length===0?t:new Zg(t.name,t.keyType,t.description,Sa(t.tags,e))),fV="effect/MetricState",Ac=Symbol.for(fV),Qk="effect/MetricState/Counter",Wd=Symbol.for(Qk),Gk="effect/MetricState/Frequency",zd=Symbol.for(Gk),Jk="effect/MetricState/Gauge",Hd=Symbol.for(Jk),Yk="effect/MetricState/Histogram",Qd=Symbol.for(Yk),Xk="effect/MetricState/Summary",Gd=Symbol.for(Xk),Rc={_A:t=>t};class dV{count;[Ac]=Rc;[Wd]=Wd;constructor(e){this.count=e}[Ce](){return Z(Se(Qk),$e(Se(this.count)),Ye(this))}[Ie](e){return kV(e)&&this.count===e.count}pipe(){return ve(this,arguments)}}const pV=eg(Te);class gV{occurrences;[Ac]=Rc;[zd]=zd;constructor(e){this.occurrences=e}_hash;[Ce](){return Z(Ze(Gk),$e(gc(st(this.occurrences.entries()))),Ye(this))}[Ie](e){return xV(e)&&pV(st(this.occurrences.entries()),st(e.occurrences.entries()))}pipe(){return ve(this,arguments)}}class yV{value;[Ac]=Rc;[Hd]=Hd;constructor(e){this.value=e}[Ce](){return Z(Se(Jk),$e(Se(this.value)),Ye(this))}[Ie](e){return IV(e)&&this.value===e.value}pipe(){return ve(this,arguments)}}class mV{buckets;count;min;max;sum;[Ac]=Rc;[Qd]=Qd;constructor(e,n,r,s,i){this.buckets=e,this.count=n,this.min=r,this.max=s,this.sum=i}[Ce](){return Z(Se(Yk),$e(Se(this.buckets)),$e(Se(this.count)),$e(Se(this.min)),$e(Se(this.max)),$e(Se(this.sum)),Ye(this))}[Ie](e){return TV(e)&&Te(this.buckets,e.buckets)&&this.count===e.count&&this.min===e.min&&this.max===e.max&&this.sum===e.sum}pipe(){return ve(this,arguments)}}class wV{error;quantiles;count;min;max;sum;[Ac]=Rc;[Gd]=Gd;constructor(e,n,r,s,i,o){this.error=e,this.quantiles=n,this.count=r,this.min=s,this.max=i,this.sum=o}[Ce](){return Z(Se(Xk),$e(Se(this.error)),$e(Se(this.quantiles)),$e(Se(this.count)),$e(Se(this.min)),$e(Se(this.max)),$e(Se(this.sum)),Ye(this))}[Ie](e){return AV(e)&&this.error===e.error&&Te(this.quantiles,e.quantiles)&&this.count===e.count&&this.min===e.min&&this.max===e.max&&this.sum===e.sum}pipe(){return ve(this,arguments)}}const bV=t=>new dV(t),_V=t=>new gV(t),SV=t=>new yV(t),EV=t=>new mV(t.buckets,t.count,t.min,t.max,t.sum),vV=t=>new wV(t.error,t.quantiles,t.count,t.min,t.max,t.sum),kV=t=>Ae(t,Wd),xV=t=>Ae(t,zd),IV=t=>Ae(t,Hd),TV=t=>Ae(t,Qd),AV=t=>Ae(t,Gd),RV="effect/MetricHook",CV=Symbol.for(RV),OV={_In:t=>t,_Out:t=>t},Cc=t=>({[CV]:OV,pipe(){return ve(this,arguments)},...t}),Bw=BigInt(0),MV=t=>{let e=t.keyType.bigint?Bw:0;const n=t.keyType.incremental?t.keyType.bigint?s=>s>=Bw:s=>s>=0:s=>!0,r=s=>{n(s)&&(e=e+s)};return Cc({get:()=>bV(e),update:r,modify:r})},LV=t=>{const e=new Map;for(const r of t.keyType.preregisteredWords)e.set(r,0);const n=r=>{const s=e.get(r)??0;e.set(r,s+1)};return Cc({get:()=>_V(e),update:n,modify:n})},DV=(t,e)=>{let n=e;return Cc({get:()=>SV(n),update:r=>{n=r},modify:r=>{n=n+r}})},FV=t=>{const e=t.keyType.boundaries.values,n=e.length,r=new Uint32Array(n+1),s=new Float64Array(n);let i=0,o=0,c=Number.MAX_VALUE,a=Number.MIN_VALUE;Z(e,iu(Wo),Ns((l,d)=>{s[d]=l}));const u=l=>{let d=0,f=n;for(;d!==f;){const p=Math.floor(d+(f-d)/2),w=s[p];l<=w?f=p:d=p,f===d+1&&(l<=s[d]?f=d:d=f)}r[d]=r[d]+1,i=i+1,o=o+l,l<c&&(c=l),l>a&&(a=l)},h=()=>{const l=Zp(n);let d=0;for(let f=0;f<n;f++){const p=s[f],w=r[f];d=d+w,l[f]=[p,d]}return l};return Cc({get:()=>EV({buckets:h(),count:i,min:c,max:a,sum:o}),update:u,modify:u})},NV=t=>{const{error:e,maxAge:n,maxSize:r,quantiles:s}=t.keyType,i=Z(s,iu(Wo)),o=Zp(r);let c=0,a=0,u=0,h=0,l=0;const d=p=>{const w=[];let g=0;for(;g!==r-1;){const m=o[g];if(m!=null){const[_,v]=m,k=dd(p-_);XF(k,F0)&&YF(k,n)&&w.push(v)}g=g+1}return PV(e,i,iu(w,Wo))},f=(p,w)=>{if(r>0){c=c+1;const g=c%r;o[g]=[w,p]}h=a===0?p:Math.min(h,p),l=a===0?p:Math.max(l,p),a=a+1,u=u+p};return Cc({get:()=>vV({error:e,quantiles:d(Date.now()),count:a,min:h,max:l,sum:u}),update:([p,w])=>f(p,w),modify:([p,w])=>f(p,w)})},PV=(t,e,n)=>{const r=n.length;if(!Qt(e))return ii();const s=e[0],i=e.slice(1),o=qw(t,r,Ee(),0,s,n),c=an(o);return i.forEach(a=>{c.push(qw(t,r,o.value,o.consumed,a,o.rest))}),Ns(c,a=>[a.quantile,a.value])},qw=(t,e,n,r,s,i)=>{let o=t,c=e,a=n,u=r,h=s,l=i,d=t,f=e,p=n,w=r,g=s,m=i;for(;;){if(!Qt(l))return{quantile:h,value:Ee(),consumed:u,rest:[]};if(h===1)return{quantile:h,value:De(y0(l)),consumed:u+l.length,rest:[]};const _=qt(l),v=QD(l,D=>D===_),k=h*c,I=o/2*k,A=u+v[0].length,L=Math.abs(A-k);if(A<k-I){d=o,f=c,p=vo(l),w=A,g=h,m=v[1],o=d,c=f,a=p,u=w,h=g,l=m;continue}if(A>k+I){const D=Ct(a)?De(_):a;return{quantile:h,value:D,consumed:u,rest:l}}switch(a._tag){case"None":{d=o,f=c,p=vo(l),w=A,g=h,m=v[1],o=d,c=f,a=p,u=w,h=g,l=m;continue}case"Some":{const D=Math.abs(k-a.value);if(L<D){d=o,f=c,p=vo(l),w=A,g=h,m=v[1],o=d,c=f,a=p,u=w,h=g,l=m;continue}return{quantile:h,value:De(a.value),consumed:u,rest:l}}}}throw new Error("BUG: MetricHook.resolveQuantiles - please report an issue at https://github.com/Effect-TS/effect/issues")},$V="effect/MetricPair",BV=Symbol.for($V),qV={_Type:t=>t},UV=(t,e)=>({[BV]:qV,metricKey:t,metricState:e,pipe(){return ve(this,arguments)}}),VV="effect/MetricRegistry",Uw=Symbol.for(VV);class jV{[Uw]=Uw;map=QB();snapshot(){const e=[];for(const[n,r]of this.map)e.push(UV(n,r.get()));return e}get(e){const n=Z(this.map,Rr(e),Ar);if(n==null){if(Wk(e.keyType))return this.getCounter(e);if(rV(e.keyType))return this.getGauge(e);if(nV(e.keyType))return this.getFrequency(e);if(zk(e.keyType))return this.getHistogram(e);if(sV(e.keyType))return this.getSummary(e);throw new Error("BUG: MetricRegistry.get - unknown MetricKeyType - please report an issue at https://github.com/Effect-TS/effect/issues")}else return n}getCounter(e){let n=Z(this.map,Rr(e),Ar);if(n==null){const r=MV(e);Z(this.map,Hi(e))||Z(this.map,Qi(e,r)),n=r}return n}getFrequency(e){let n=Z(this.map,Rr(e),Ar);if(n==null){const r=LV(e);Z(this.map,Hi(e))||Z(this.map,Qi(e,r)),n=r}return n}getGauge(e){let n=Z(this.map,Rr(e),Ar);if(n==null){const r=DV(e,e.keyType.bigint?BigInt(0):0);Z(this.map,Hi(e))||Z(this.map,Qi(e,r)),n=r}return n}getHistogram(e){let n=Z(this.map,Rr(e),Ar);if(n==null){const r=FV(e);Z(this.map,Hi(e))||Z(this.map,Qi(e,r)),n=r}return n}getSummary(e){let n=Z(this.map,Rr(e),Ar);if(n==null){const r=NV(e);Z(this.map,Hi(e))||Z(this.map,Qi(e,r)),n=r}return n}}const KV=()=>new jV,WV="effect/Metric",zV=Symbol.for(WV),HV={_Type:t=>t,_In:t=>t,_Out:t=>t},Vw=Be(Symbol.for("effect/Metric/globalMetricRegistry"),()=>KV()),Zk=function(t,e,n,r){const s=Object.assign(i=>eB(i,o=>YV(s,o)),{[zV]:HV,keyType:t,unsafeUpdate:e,unsafeValue:n,unsafeModify:r,register(){return this.unsafeValue([]),this},pipe(){return ve(this,arguments)}});return s},pl=(t,e)=>ex(uV(t,e)),ex=t=>{let e;const n=new WeakMap,r=s=>{if(s.length===0)return e!==void 0||(e=Vw.get(t)),e;let i=n.get(s);return i!==void 0||(i=Vw.get(hV(t,s)),n.set(s,i)),i};return Zk(t.keyType,(s,i)=>r(i).update(s),s=>r(s).get(),(s,i)=>r(i).modify(s))},QV=(t,e,n)=>ex(lV(t,e,n)),GV=Q(3,(t,e,n)=>JV(t,[yq(e,n)])),JV=Q(2,(t,e)=>Zk(t.keyType,(n,r)=>t.unsafeUpdate(n,Sa(e,r)),n=>t.unsafeValue(Sa(e,n)),(n,r)=>t.unsafeModify(n,Sa(e,r)))),YV=Q(2,(t,e)=>al(Ad,n=>me(()=>t.unsafeUpdate(e,n))));({...Xp});const XV=Q(2,(t,e)=>al($k,n=>me(()=>{if(n.has(t)){const r=n.get(t);r.state.completed||(r.state.completed=!0,Jv(r.result,e))}}))),ZV="effect/Supervisor",gl=Symbol.for(ZV),ey={_T:t=>t};class yl{underlying;value0;[gl]=ey;constructor(e,n){this.underlying=e,this.value0=n}get value(){return this.value0}onStart(e,n,r,s){this.underlying.onStart(e,n,r,s)}onEnd(e,n){this.underlying.onEnd(e,n)}onEffect(e,n){this.underlying.onEffect(e,n)}onSuspend(e){this.underlying.onSuspend(e)}onResume(e){this.underlying.onResume(e)}map(e){return new yl(this,Z(this.value,Qe(e)))}zip(e){return new ml(this,e)}}class ml{left;right;_tag="Zip";[gl]=ey;constructor(e,n){this.left=e,this.right=n}get value(){return $v(this.left.value,this.right.value)}onStart(e,n,r,s){this.left.onStart(e,n,r,s),this.right.onStart(e,n,r,s)}onEnd(e,n){this.left.onEnd(e,n),this.right.onEnd(e,n)}onEffect(e,n){this.left.onEffect(e,n),this.right.onEffect(e,n)}onSuspend(e){this.left.onSuspend(e),this.right.onSuspend(e)}onResume(e){this.left.onResume(e),this.right.onResume(e)}map(e){return new yl(this,Z(this.value,Qe(e)))}zip(e){return new ml(this,e)}}const tx=t=>Ae(t,gl)&&KE(t,"Zip");class ej{effect;[gl]=ey;constructor(e){this.effect=e}get value(){return this.effect}onStart(e,n,r,s){}onEnd(e,n){}onEffect(e,n){}onSuspend(e){}onResume(e){}map(e){return new yl(this,Z(this.value,Qe(e)))}zip(e){return new ml(this,e)}onRun(e,n){return e()}}const tj=t=>new ej(t),wl=Be("effect/Supervisor/none",()=>tj(nt)),nj=Oi,nx="Empty",rx="AddSupervisor",sx="RemoveSupervisor",ix="AndThen",Io={_tag:nx},xa=(t,e)=>({_tag:ix,first:t,second:e}),rj=(t,e)=>sj(e,Gt(t)),sj=(t,e)=>{let n=t,r=e;for(;ci(r);){const s=ai(r);switch(s._tag){case nx:{r=Or(r);break}case rx:{n=n.zip(s.supervisor),r=Or(r);break}case sx:{n=Jd(n,s.supervisor),r=Or(r);break}case ix:{r=pn(s.first)(pn(s.second)(Or(r)));break}}}return n},Jd=(t,e)=>Te(t,e)?wl:tx(t)?Jd(t.left,e).zip(Jd(t.right,e)):t,vu=t=>Te(t,wl)?Zr():tx(t)?Z(vu(t.left),Qo(vu(t.right))):pg(t),ij=(t,e)=>{if(Te(t,e))return Io;const n=vu(t),r=vu(e),s=Z(r,Ym(n),au(Io,(o,c)=>xa(o,{_tag:rx,supervisor:c}))),i=Z(n,Ym(r),au(Io,(o,c)=>xa(o,{_tag:sx,supervisor:c})));return xa(s,i)},oj=nj({empty:Io,patch:rj,combine:xa,diff:ij}),cj=pl("effect_fiber_started",{incremental:!0}),jw=pl("effect_fiber_active"),aj=pl("effect_fiber_successes",{incremental:!0}),uj=pl("effect_fiber_failures",{incremental:!0}),lj=GV(QV("effect_fiber_lifetimes",KU({start:.5,factor:2,count:35})),"time_unit","milliseconds"),Gi="Continue",hj="Done",Kw="Yield",fj={_E:t=>t,_A:t=>t},zc=t=>{throw new Error(`BUG: FiberRuntime - ${ti(t)} - please report an issue at https://github.com/Effect-TS/effect/issues`)},On=Symbol.for("effect/internal/fiberRuntime/YieldedOp"),Mn=Be("effect/internal/fiberRuntime/yieldedOpChannel",()=>({currentOp:null})),Ji={[tu]:(t,e,n)=>Tt(()=>e.effect_instruction_i1(n)),OnStep:(t,e,n)=>et(et(n)),[nu]:(t,e,n)=>Tt(()=>e.effect_instruction_i2(n)),[Jp]:(t,e,n)=>(t.patchRuntimeFlags(t.currentRuntimeFlags,e.patch),fr(t.currentRuntimeFlags)&&t.isInterrupted()?Ke(t.getInterruptedCause()):et(n)),[ru]:(t,e,n)=>(Tt(()=>e.effect_instruction_i2(n)),Tt(()=>e.effect_instruction_i0())?(t.pushStack(e),Tt(()=>e.effect_instruction_i1())):nt),[Eo]:(t,e,n)=>{for(;;){const r=Tt(()=>e.effect_instruction_i0.next(n));if(r.done)return et(r.value);const s=rD(r.value);if(ll(s)){if(s._tag==="Failure")return s}else return t.pushStack(e),s;n=s.value}}},dj={[Hg]:(t,e,n,r)=>(t.processNewInterruptSignal(r.cause),fr(e)?Ke(r.cause):n),[Gg]:(t,e,n,r)=>{throw new Error("It is illegal to have multiple concurrent run loops in a single fiber")},[Qg]:(t,e,n,r)=>(r.onFiber(t,Ck(e)),n),[Jg]:(t,e,n,r)=>ye(Rg(),()=>n)},pj=t=>cl(u$(t),e=>mr(v$(e),([n,r])=>{const s=new Map,i=[];for(const c of r){i.push($r(c));for(const a of c)s.set(a.request,a)}const o=i.flat();return Tc(Fj(n.runAll(i),o,()=>o.forEach(c=>{c.listeners.interrupted=!0})),$k,s)},!1,!1)),gj=Yp();class ox extends $g{[RU]=CU;[MU]=fj;_fiberRefs;_fiberId;_queue=new Array;_children=null;_observers=new Array;_running=!1;_stack=[];_asyncInterruptor=null;_asyncBlockingOn=null;_exitValue=null;_steps=[];_isYielding=!1;currentRuntimeFlags;currentOpCount=0;currentSupervisor;currentScheduler;currentTracer;currentSpan;currentContext;currentDefaultServices;constructor(e,n,r){if(super(),this.currentRuntimeFlags=r,this._fiberId=e,this._fiberRefs=n,nw(r)){const s=this.getFiberRef(Ad);cj.unsafeUpdate(1,s),jw.unsafeUpdate(1,s)}this.refreshRefCache()}commit(){return Bk(this)}id(){return this._fiberId}resume(e){this.tell(vs(e))}get status(){return this.ask((e,n)=>n)}get runtimeFlags(){return this.ask((e,n)=>Wq(n)?e.currentRuntimeFlags:n.runtimeFlags)}scope(){return TU(this)}get children(){return this.ask(e=>Array.from(e.getChildren()))}getChildren(){return this._children===null&&(this._children=new Set),this._children}getInterruptedCause(){return this.getFiberRef(Kc)}fiberRefs(){return this.ask(e=>e.getFiberRefs())}ask(e){return Ge(()=>{const n=Qv(this._fiberId);return this.tell(ka((r,s)=>{Jv(n,me(()=>e(r,s)))})),Lg(n)})}tell(e){this._queue.push(e),this._running||(this._running=!0,this.drainQueueLaterOnExecutor())}get await(){return ss(e=>{const n=r=>e(Fe(r));return this.tell(ka((r,s)=>{r._exitValue!==null?n(this._exitValue):r.addObserver(n)})),me(()=>this.tell(ka((r,s)=>{r.removeObserver(n)})))},this.id())}get inheritAll(){return it((e,n)=>{const r=e.id(),s=e.getFiberRefs(),i=n.runtimeFlags,o=this.getFiberRefs(),c=G2(s,r,o);e.setFiberRefs(c);const a=e.getFiberRef(Qw),u=Z(Bs(i,a),sw(Mi),sw(kd));return nB(u)})}get poll(){return me(()=>Hu(this._exitValue))}unsafePoll(){return this._exitValue}interruptAsFork(e){return me(()=>this.tell(ph(pr(e))))}unsafeInterruptAsFork(e){this.tell(ph(pr(e)))}addObserver(e){this._exitValue!==null?e(this._exitValue):this._observers.push(e)}removeObserver(e){this._observers=this._observers.filter(n=>n!==e)}getFiberRefs(){return this.setFiberRef(Qw,this.currentRuntimeFlags),this._fiberRefs}unsafeDeleteFiberRef(e){this._fiberRefs=lk(this._fiberRefs,e)}getFiberRef(e){return this._fiberRefs.locals.has(e)?this._fiberRefs.locals.get(e)[0][1]:e.initial}setFiberRef(e,n){this._fiberRefs=Od(this._fiberRefs,{fiberId:this._fiberId,fiberRef:e,value:n}),this.refreshRefCache()}refreshRefCache(){this.currentDefaultServices=this.getFiberRef(gu),this.currentTracer=this.currentDefaultServices.unsafeMap.get(ck.key),this.currentSupervisor=this.getFiberRef(Dj),this.currentScheduler=this.getFiberRef(zg),this.currentContext=this.getFiberRef(gs),this.currentSpan=this.currentContext.unsafeMap.get(ak.key)}setFiberRefs(e){this._fiberRefs=e,this.refreshRefCache()}addChild(e){this.getChildren().add(e)}removeChild(e){this.getChildren().delete(e)}transferChildren(e){const n=this._children;if(this._children=null,n!==null&&n.size>0)for(const r of n)r._exitValue===null&&e.add(this.currentRuntimeFlags,r)}drainQueueOnCurrentThread(){let e=!0;for(;e;){let n=Gi;const r=globalThis[Ir];globalThis[Ir]=this;try{for(;n===Gi;)n=this._queue.length===0?hj:this.evaluateMessageWhileSuspended(this._queue.splice(0,1)[0])}finally{this._running=!1,globalThis[Ir]=r}this._queue.length>0&&!this._running?(this._running=!0,n===Kw?(this.drainQueueLaterOnExecutor(),e=!1):e=!0):e=!1}}drainQueueLaterOnExecutor(){this.currentScheduler.scheduleTask(this.run,this.getFiberRef(ul))}drainQueueWhileRunning(e,n){let r=n;for(;this._queue.length>0;){const s=this._queue.splice(0,1)[0];r=dj[s._tag](this,e,r,s)}return r}isInterrupted(){return!I$(this.getFiberRef(Kc))}addInterruptedCause(e){const n=this.getFiberRef(Kc);this.setFiberRef(Kc,$t(n,e))}processNewInterruptSignal(e){this.addInterruptedCause(e),this.sendInterruptSignalToAllChildren()}sendInterruptSignalToAllChildren(){if(this._children===null||this._children.size===0)return!1;let e=!1;for(const n of this._children)n.tell(ph(pr(this.id()))),e=!0;return e}interruptAllChildren(){if(this.sendInterruptSignalToAllChildren()){const e=this._children.values();this._children=null;let n=!1;return Ag({while:()=>!n,body:()=>{const s=e.next();return s.done?me(()=>{n=!0}):ps(s.value.await)},step:()=>{}})}return null}reportExitValue(e){if(nw(this.currentRuntimeFlags)){const n=this.getFiberRef(Ad),r=this.id().startTimeMillis,s=Date.now();switch(lj.unsafeUpdate(s-r,n),jw.unsafeUpdate(-1,n),e._tag){case Rt:{aj.unsafeUpdate(1,n);break}case At:{uj.unsafeUpdate(1,n);break}}}if(e._tag==="Failure"){const n=this.getFiberRef(TB);!Sg(e.cause)&&n._tag==="Some"&&this.log("Fiber terminated with an unhandled error",e.cause,n)}}setExitValue(e){this._exitValue=e,this.reportExitValue(e);for(let n=this._observers.length-1;n>=0;n--)this._observers[n](e);this._observers=[]}getLoggers(){return this.getFiberRef(_j)}log(e,n,r){const s=kn(r)?r.value:this.getFiberRef(EB),i=this.getFiberRef(yj);if(cq(i,s))return;const o=this.getFiberRef(vB),c=this.getFiberRef(SB),a=this.getLoggers(),u=this.getFiberRefs();if(H0(a)>0){const h=x0(this.getFiberRef(gu),Pg),l=new Date(h.unsafeCurrentTimeMillis());aD(u,()=>{for(const d of a)d.log({fiberId:this.id(),logLevel:s,message:e,cause:n,context:u,spans:o,annotations:c,date:l})})}}evaluateMessageWhileSuspended(e){switch(e._tag){case Jg:return Kw;case Hg:return this.processNewInterruptSignal(e.cause),this._asyncInterruptor!==null&&(this._asyncInterruptor(Ke(e.cause)),this._asyncInterruptor=null),Gi;case Gg:return this._asyncInterruptor=null,this._asyncBlockingOn=null,this.evaluateEffect(e.effect),Gi;case Qg:return e.onFiber(this,this._exitValue!==null?jq:Kq(this.currentRuntimeFlags,this._asyncBlockingOn)),Gi;default:return zc(e)}}evaluateEffect(e){this.currentSupervisor.onResume(this);try{let n=fr(this.currentRuntimeFlags)&&this.isInterrupted()?Ke(this.getInterruptedCause()):e;for(;n!==null;){const r=n,s=this.runLoop(r);if(s===On){const i=Mn.currentOp;Mn.currentOp=null,i._op===ba?s$(this.currentRuntimeFlags)?(this.tell(vU()),this.tell(vs(_n)),n=null):n=_n:i._op===So&&(n=null)}else{this.currentRuntimeFlags=Z(this.currentRuntimeFlags,i$(kd));const i=this.interruptAllChildren();i!==null?n=ye(i,()=>s):(this._queue.length===0?this.setExitValue(s):this.tell(vs(s)),n=null)}}}finally{this.currentSupervisor.onSuspend(this)}}start(e){if(this._running)this.tell(vs(e));else{this._running=!0;const n=globalThis[Ir];globalThis[Ir]=this;try{this.evaluateEffect(e)}finally{this._running=!1,globalThis[Ir]=n,this._queue.length>0&&this.drainQueueLaterOnExecutor()}}}startFork(e){this.tell(vs(e))}patchRuntimeFlags(e,n){const r=qs(e,n);return globalThis[Ir]=this,this.currentRuntimeFlags=r,r}initiateAsync(e,n){let r=!1;const s=i=>{r||(r=!0,this.tell(vs(i)))};fr(e)&&(this._asyncInterruptor=s);try{n(s)}catch(i){s(Ot(Kn(i)))}}pushStack(e){this._stack.push(e),e._op==="OnStep"&&this._steps.push({refs:this.getFiberRefs(),flags:this.currentRuntimeFlags})}popStack(){const e=this._stack.pop();if(e)return e._op==="OnStep"&&this._steps.pop(),e}getNextSuccessCont(){let e=this.popStack();for(;e;){if(e._op!==sh)return e;e=this.popStack()}}getNextFailCont(){let e=this.popStack();for(;e;){if(e._op!==tu&&e._op!==ru&&e._op!==Eo)return e;e=this.popStack()}}[lD](e){return me(()=>I0(this.currentContext,e))}Left(e){return dt(e.left)}None(e){return dt(new zv)}Right(e){return et(e.right)}Some(e){return et(e.value)}Micro(e){return du(n=>{let r=n;const s=bU(fU(e,this.currentContext));return s.addObserver(i=>{if(i._tag==="Success")return r(et(i.value));switch(i.cause._tag){case"Interrupt":return r(Ke(pr(hi)));case"Fail":return r(dt(i.cause.error));case"Die":return r(uw(i.cause.defect))}}),du(i=>{r=o=>{i(nt)},s.unsafeInterrupt()})})}[XE](e){const n=Tt(()=>e.effect_instruction_i0()),r=this.getNextSuccessCont();return r!==void 0?(r._op in Ji||zc(r),Ji[r._op](this,r,n)):(Mn.currentOp=et(n),On)}[Rt](e){const n=e,r=this.getNextSuccessCont();return r!==void 0?(r._op in Ji||zc(r),Ji[r._op](this,r,n.effect_instruction_i0)):(Mn.currentOp=n,On)}[At](e){const n=e.effect_instruction_i0,r=this.getNextFailCont();if(r!==void 0)switch(r._op){case sh:case nu:return fr(this.currentRuntimeFlags)&&this.isInterrupted()?Ke(iw(n)):Tt(()=>r.effect_instruction_i1(n));case"OnStep":return fr(this.currentRuntimeFlags)&&this.isInterrupted()?Ke(iw(n)):et(Ke(n));case Jp:return this.patchRuntimeFlags(this.currentRuntimeFlags,r.patch),fr(this.currentRuntimeFlags)&&this.isInterrupted()?Ke($t(n,this.getInterruptedCause())):Ke(n);default:zc(r)}else return Mn.currentOp=Ke(n),On}[ZE](e){return Tt(()=>e.effect_instruction_i0(this,Ck(this.currentRuntimeFlags)))}Blocked(e){const n=this.getFiberRefs(),r=this.currentRuntimeFlags;if(this._steps.length>0){const s=[],i=this._steps[this._steps.length-1];let o=this.popStack();for(;o&&o._op!=="OnStep";)s.push(o),o=this.popStack();this.setFiberRefs(i.refs),this.currentRuntimeFlags=i.flags;const c=$d(i.refs,n),a=Bs(i.flags,r);return et(xv(e.effect_instruction_i0,it(u=>{for(;s.length>0;)u.pushStack(s.pop());return u.setFiberRefs(Bd(u.id(),u.getFiberRefs())(c)),u.currentRuntimeFlags=qs(a)(u.currentRuntimeFlags),e.effect_instruction_i1})))}return er(s=>ye(ax(H$(e.effect_instruction_i0)),()=>s(e.effect_instruction_i1)))}RunBlocked(e){return pj(e.effect_instruction_i0)}[yc](e){const n=e.effect_instruction_i0,r=this.currentRuntimeFlags,s=qs(r,n);if(fr(s)&&this.isInterrupted())return Ke(this.getInterruptedCause());if(this.patchRuntimeFlags(this.currentRuntimeFlags,n),e.effect_instruction_i1){const i=Bs(s,r);return this.pushStack(new Q$(i,e)),Tt(()=>e.effect_instruction_i1(r))}else return _n}[tu](e){return this.pushStack(e),e.effect_instruction_i0}OnStep(e){return this.pushStack(e),e.effect_instruction_i0}[sh](e){return this.pushStack(e),e.effect_instruction_i0}[nu](e){return this.pushStack(e),e.effect_instruction_i0}[So](e){return this._asyncBlockingOn=e.effect_instruction_i1,this.initiateAsync(this.currentRuntimeFlags,e.effect_instruction_i0),Mn.currentOp=e,On}[ba](e){return this._isYielding=!1,Mn.currentOp=e,On}[ru](e){const n=e.effect_instruction_i0,r=e.effect_instruction_i1;return n()?(this.pushStack(e),r()):_n}[Eo](e){return Ji[Eo](this,e,void 0)}[zu](e){return Tt(()=>e.commit())}runLoop(e){let n=e;for(this.currentOpCount=0;;){if((this.currentRuntimeFlags&r$)!==0&&this.currentSupervisor.onEffect(this,n),this._queue.length>0&&(n=this.drainQueueWhileRunning(this.currentRuntimeFlags,n)),!this._isYielding){this.currentOpCount+=1;const r=this.currentScheduler.shouldYield(this);if(r!==!1){this._isYielding=!0,this.currentOpCount=0;const s=n;n=ye(Rg({priority:r}),()=>s)}}try{if(n=this.currentTracer.context(()=>{if(gj!==n[mi]._V){const r=this.getFiberRef(AB);if(r._tag==="Some"){const s=n[mi]._V;this.log(`Executing an Effect versioned ${s} with a Runtime of version ${Yp()}, you may want to dedupe the effect dependencies, you can use the language service plugin to detect this at compile time: https://github.com/Effect-TS/language-service`,rs,r)}}return this[n._op](n)},this),n===On){const r=Mn.currentOp;return r._op===ba||r._op===So?On:(Mn.currentOp=null,r._op===Rt||r._op===At?r:Ke(Kn(r)))}}catch(r){n!==On&&!Ae(n,"_op")||!(n._op in this)?n=J$(`Not a valid effect: ${ti(n)}`):MB(r)?n=Ke($t(Kn(r),pr(hi))):n=uw(r)}}}run=()=>{this.drainQueueOnCurrentThread()}}const yj=Be("effect/FiberRef/currentMinimumLogLevel",()=>Vt(aq("Info"))),mj=t=>Xg(e=>{const n=Z2(e.context,gu);x0(n,ok).unsafe.log(t.log(e))}),wj=Be(Symbol.for("effect/Logger/defaultLogger"),()=>mj(BU)),bj=Be(Symbol.for("effect/Logger/tracerLogger"),()=>Xg(({annotations:t,cause:e,context:n,fiberId:r,logLevel:s,message:i})=>{const o=bc(Zo(n,gs),ak);if(o._tag==="None"||o.value._tag==="ExternalSpan")return;const c=I0(Zo(n,gu),Pg),a={};for(const[u,h]of t)a[u]=h;a["effect.fiberId"]=KN(r),a["effect.logLevel"]=s.label,e!==null&&e._tag!=="Empty"&&(a["effect.cause"]=kc(e,{renderErrorCause:!0})),o.value.event(ti(Array.isArray(i)&&i.length===1?i[0]:i),c.unsafeCurrentTimeNanos(),a)})),_j=Be(Symbol.for("effect/FiberRef/currentLoggers"),()=>mB(pg(wj,bj))),Sj=t=>{if(Array.isArray(t)||WE(t))return[t,Ee()];const e=Object.keys(t),n=e.length;return[e.map(r=>t[r]),De(r=>{const s={};for(let i=0;i<n;i++)s[e[i]]=r[i];return s})]},Ej=(t,e,n)=>{const r=[];for(const s of t)r.push(Xo(s));return ye(ec(r,We,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>{const i=Ee(),o=s.length,c=new Array(o),a=new Array(o);let u=!1;for(let h=0;h<o;h++){const l=s[h];l._tag==="Left"?(c[h]=De(l.left),u=!0):(a[h]=l.right,c[h]=i)}return u?e._tag==="Some"?dt(e.value(c)):dt(c):n?.discard?nt:e._tag==="Some"?Fe(e.value(a)):Fe(a)})},vj=(t,e,n)=>{const r=[];for(const s of t)r.push(Xo(s));return n?.discard?ec(r,We,{concurrency:n?.concurrency,batching:n?.batching,discard:!0,concurrentFinalizers:n?.concurrentFinalizers}):Qe(ec(r,We,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>e._tag==="Some"?e.value(s):s)},kj=(t,e)=>{const[n,r]=Sj(t);return e?.mode==="validate"?Ej(n,r,e):e?.mode==="either"?vj(n,r,e):e?.discard!==!0&&r._tag==="Some"?Qe(ec(n,We,e),r.value):ec(n,We,e)},ec=Q(t=>WE(t[0]),(t,e,n)=>it(r=>{const s=n?.batching===!0||n?.batching==="inherit"&&r.getFiberRef(IB);return n?.discard?$w(n.concurrency,()=>ks(Fd,n?.concurrentFinalizers)(i=>s?mr(t,(o,c)=>i(e(o,c)),!0,!1,1):cl(t,(o,c)=>i(e(o,c)))),()=>ks(Nd,n?.concurrentFinalizers)(i=>mr(t,(o,c)=>i(e(o,c)),s,!1)),i=>ks(Pd(i),n?.concurrentFinalizers)(o=>mr(t,(c,a)=>o(e(c,a)),s,!1,i))):$w(n?.concurrency,()=>ks(Fd,n?.concurrentFinalizers)(i=>s?Yd(t,1,(o,c)=>i(e(o,c)),!0):Un(t,(o,c)=>i(e(o,c)))),()=>ks(Nd,n?.concurrentFinalizers)(i=>cx(t,(o,c)=>i(e(o,c)),s)),i=>ks(Pd(i),n?.concurrentFinalizers)(o=>Yd(t,i,(c,a)=>o(e(c,a)),s)))})),cx=(t,e,n)=>Ge(()=>{const r=st(t),s=new Array(r.length);return wn(mr(r,(o,c)=>ye(e(o,c),a=>me(()=>s[c]=a)),n,!1),Fe(s))}),mr=(t,e,n,r,s)=>er(i=>tB(o=>it(c=>{let a=Array.from(t).reverse(),u=a.length;if(u===0)return nt;let h=0,l=!1;const d=s?Math.min(a.length,s):a.length,f=new Set,p=new Array,w=()=>f.forEach(D=>{D.currentScheduler.scheduleTask(()=>{D.unsafeInterruptAsFork(c.id())},0)}),g=new Array,m=new Array,_=new Array,v=()=>{const D=p.filter(({exit:K})=>K._tag==="Failure").sort((K,O)=>K.index<O.index?-1:K.index===O.index?0:1).map(({exit:K})=>K);return D.length===0&&D.push(_n),D},k=(D,K=!1)=>{const O=Nv(o(D)),N=Ij(O,c,c.currentRuntimeFlags,Yg);return c.currentScheduler.scheduleTask(()=>{K&&N.unsafeInterruptAsFork(c.id()),N.resume(O)},0),N},I=()=>{r||(u-=a.length,a=[]),l=!0,w()},A=n?X$:Us,L=k(ss(D=>{const K=(N,W)=>{N._op==="Blocked"?_.push(N):(p.push({index:W,exit:N}),N._op==="Failure"&&!l&&I())},O=()=>{if(a.length>0){const N=a.pop();let W=h++;const q=()=>{const B=a.pop();return W=h++,ye(Rg(),()=>ye(A(i(e(B,W))),te))},te=B=>a.length>0&&(K(B,W),a.length>0)?q():Fe(B),T=ye(A(i(e(N,W))),te),$=k(T);g.push($),f.add($),l&&$.currentScheduler.scheduleTask(()=>{$.unsafeInterruptAsFork(c.id())},0),$.addObserver(B=>{let S;if(B._op==="Failure"?S=B:S=B.effect_instruction_i0,m.push($),f.delete($),K(S,W),p.length===u)D(Fe(Sn(xo(v(),{parallel:!0}),()=>_n)));else if(_.length+p.length===u){const R=v(),E=_.map(P=>P.effect_instruction_i0).reduce(pv);D(Fe(xv(E,mr([Sn(xo(R,{parallel:!0}),()=>_n),..._.map(P=>P.effect_instruction_i1)],P=>P,n,!0,s))))}else O()})}};for(let N=0;N<d;N++)O()}));return ps(wi(xg(i(Bk(L))),Mg({onFailure:D=>{I();const K=_.length+1,O=Math.min(typeof s=="number"?s:_.length,_.length),N=Array.from(_);return ss(W=>{let q=0,te=0;const T=(B,S)=>R=>{q++,q===K&&W(et(Ke(D))),N.length>0&&S&&$()},$=()=>{k(N.pop(),!0).addObserver(T(te,!0)),te++};L.addObserver(T(te,!1)),te++;for(let B=0;B<O;B++)$()})},onSuccess:()=>Un(m,D=>D.inheritAll)})))}))),Yd=(t,e,n,r)=>Ge(()=>{const s=st(t),i=new Array(s.length);return wn(mr(s,(c,a)=>Qe(n(c,a),u=>i[a]=u),r,!1,e),Fe(i))}),ax=t=>Tj(t,Yg),xj=(t,e,n,r=null)=>{const s=ux(t,e,n,r);return s.resume(t),s},Ij=(t,e,n,r=null)=>ux(t,e,n,r),ux=(t,e,n,r=null)=>{const s=Y0(),i=e.getFiberRefs(),o=J2(i,s),c=new ox(s,o,n),a=Zo(o,gs),u=c.currentSupervisor;return u.onStart(a,t,De(e),c),c.addObserver(l=>u.onEnd(l,c)),(r!==null?r:Z(e.getFiberRef(Rd),Sn(()=>e.scope()))).add(n,c),c},Tj=(t,e)=>it((n,r)=>Fe(xj(t,n,r.runtimeFlags,e))),Ww=t=>Pi(e=>fs(bc(e,Bi),{onNone:()=>t,onSome:n=>{switch(n.strategy._tag){case"Parallel":return t;case"Sequential":case"ParallelN":return ye(Pn(n,Nd),r=>bl(t,r))}}})),zw=t=>e=>Pi(n=>fs(bc(n,Bi),{onNone:()=>e,onSome:r=>r.strategy._tag==="ParallelN"&&r.strategy.parallelism===t?e:ye(Pn(r,Pd(t)),s=>bl(e,s))})),ks=(t,e)=>n=>Pi(r=>fs(bc(r,Bi),{onNone:()=>n(We),onSome:s=>{if(e===!0){const i=t._tag==="Parallel"?Ww:t._tag==="Sequential"?Hw:zw(t.parallelism);switch(s.strategy._tag){case"Parallel":return i(n(Ww));case"Sequential":return i(n(Hw));case"ParallelN":return i(n(zw(s.strategy.parallelism)))}}else return n(We)}})),Aj=t=>ye(Bi,t),Rj=t=>ye(hx(),e=>wi(t(e),n=>e.close(n))),Hw=t=>Pi(e=>fs(bc(e,Bi),{onNone:()=>t,onSome:n=>{switch(n.strategy._tag){case"Sequential":return t;case"Parallel":case"ParallelN":return ye(Pn(n,Fd),r=>bl(t,r))}}})),Cj=Q(t=>ol(t[1]),(t,e,n,r)=>Qe(kj([t,e],{concurrency:r?.concurrent?2:1,batching:r?.batching,concurrentFinalizers:r?.concurrentFinalizers}),([s,i])=>n(s,i))),Bi=ds("effect/Scope"),Oj=(t,e)=>{t.state._tag==="Open"&&t.state.finalizers.set({},e)},Mj={[hw]:hw,[fw]:fw,pipe(){return ve(this,arguments)},fork(t){return me(()=>{const e=lx(t);if(this.state._tag==="Closed")return e.state=this.state,e;const n={},r=s=>e.close(s);return this.state.finalizers.set(n,r),Oj(e,s=>me(()=>{this.state._tag==="Open"&&this.state.finalizers.delete(n)})),e})},close(t){return Ge(()=>{if(this.state._tag==="Closed")return nt;const e=Array.from(this.state.finalizers.values()).reverse();return this.state={_tag:"Closed",exit:t},e.length===0?nt:Lq(this.strategy)?Z(Un(e,n=>Us(n(t))),ye(n=>Z(xo(n),_a(lh),Sn(()=>_n)))):Dq(this.strategy)?Z(cx(e,n=>Us(n(t)),!1),ye(n=>Z(xo(n,{parallel:!0}),_a(lh),Sn(()=>_n)))):Z(Yd(e,this.strategy.parallelism,n=>Us(n(t)),!1),ye(n=>Z(xo(n,{parallel:!0}),_a(lh),Sn(()=>_n))))})},addFinalizer(t){return Ge(()=>this.state._tag==="Closed"?t(this.state.exit):(this.state.finalizers.set({},t),nt))}},lx=(t=qr)=>{const e=Object.create(Mj);return e.strategy=t,e.state={_tag:"Open",finalizers:new Map},e},hx=(t=qr)=>me(()=>lx(t)),bl=Q(2,(t,e)=>WB(t,Qu(k0(Bi,e)))),Lj=t=>Ni(t,{differ:oj,fork:Io}),Qw=bB(o$),Dj=Lj(wl),Xd=Q(2,(t,e)=>er(n=>Zn(n(t),{onFailure:r=>Zn(e,{onFailure:s=>Ot($t(r,s)),onSuccess:()=>Ot(r)}),onSuccess:r=>Xn(e,r)}))),Fj=(t,e,n)=>Mv(r=>ye(ye(ax(Lv(t)),s=>ss(i=>{const o=e.map(u=>u.listeners.count),c=()=>{o.every(u=>u===0)&&e.every(u=>u.result.state.current._tag==="Pending"?!0:!!(u.result.state.current._tag==="Done"&&ll(u.result.state.current.effect)&&u.result.state.current.effect._tag==="Failure"&&T$(u.result.state.current.effect.cause)))&&(a.forEach(u=>u()),n?.(),i(oB(s)))};s.addObserver(u=>{a.forEach(h=>h()),i(u)});const a=e.map((u,h)=>{const l=d=>{o[h]=d,c()};return u.listeners.addObserver(l),()=>u.listeners.removeObserver(l)});return c(),me(()=>{a.forEach(u=>u())})})),()=>Ge(()=>{const s=e.flatMap(i=>i.state.completed?[]:[i]);return cl(s,i=>XV(i.request,DB(r)))}))),Nj=Cd,Pj=Pn;class $j{permits;waiters=new Set;taken=0;constructor(e){this.permits=e}get free(){return this.permits-this.taken}take=e=>Rv(n=>{if(this.free<e){const r=()=>{this.free<e||(this.waiters.delete(r),this.taken+=e,n(Fe(e)))};return this.waiters.add(r),me(()=>{this.waiters.delete(r)})}return this.taken+=e,n(Fe(e))});updateTakenUnsafe(e,n){return this.taken=n(this.taken),this.waiters.size>0&&e.getFiberRef(zg).scheduleTask(()=>{const r=this.waiters.values();let s=r.next();for(;s.done===!1&&this.free>0;)s.value(),s=r.next()},e.getFiberRef(ul)),Fe(this.free)}updateTaken(e){return it(n=>this.updateTakenUnsafe(n,e))}resize=e=>ps(it(n=>(this.permits=e,this.free<0?nt:this.updateTakenUnsafe(n,r=>r))));release=e=>this.updateTaken(n=>n-e);releaseAll=this.updateTaken(e=>0);withPermits=e=>n=>er(r=>ye(r(this.take(e)),s=>Xd(r(n),this.release(s))));withPermitsIfAvailable=e=>n=>er(r=>Ge(()=>this.free<e?Tq:(this.taken+=e,Xd(r(wq(n)),this.release(e)))))}const Bj=t=>new $j(t),qj="effect/Ref/SynchronizedRef",Uj=Symbol.for(qj),Vj={_A:t=>t};class jj extends $g{ref;withLock;[Uj]=Vj;[yk]=mk;[yu]=yu;constructor(e,n){super(),this.ref=e,this.withLock=n,this.get=mu(this.ref)}get;commit(){return this.get}modify(e){return this.modifyEffect(n=>Fe(e(n)))}modifyEffect(e){return this.withLock(Z(ye(mu(this.ref),e),ye(([n,r])=>Xn(bk(this.ref,r),n))))}}const Kj=t=>me(()=>fx(t)),fx=t=>{const e=wk(t),n=Bj(1);return new jj(e,n.withPermits(1))},Wj=Symbol.for("effect/ManagedRuntime"),zj="Fresh",Hj="FromEffect",Qj="MergeAll",ty=t=>function(){if(arguments.length===1){const e=arguments[0];return(n,...r)=>t(e,n,...r)}return t.apply(this,arguments)},Gj=ty((t,e,n)=>{const r=Y0(),s=[[gs,[[r,t.context]]]];n?.scheduler&&s.push([zg,[[r,n.scheduler]]]);let i=eq(t.fiberRefs,{entries:s,forkAs:r});n?.updateRefs&&(i=n.updateRefs(i,r));const o=new ox(r,i,t.runtimeFlags);let c=e;n?.scope&&(c=ye(Pj(n.scope,qr),u=>wn(RB(u,Mv(h=>Te(h,o.id())?nt:qv(o,h))),wi(e,h=>Nj(u,h)))));const a=o.currentSupervisor;return a!==wl&&(a.onStart(t.context,c,Ee(),o),o.addObserver(u=>a.onEnd(u,o))),Yg.add(t.runtimeFlags,o),n?.immediate===!1?o.resume(c):o.start(c),o}),gh=Symbol.for("effect/Runtime/FiberFailure"),Hc=Symbol.for("effect/Runtime/FiberFailure/Cause");class Jj extends Error{[gh];[Hc];constructor(e){const n=vv(e)[0];super(n?.message||"An error has occurred"),this[gh]=gh,this[Hc]=e,this.name=n?`(FiberFailure) ${n.name}`:"FiberFailure",n?.stack&&(this.stack=n.stack)}toJSON(){return{_id:"FiberFailure",cause:this[Hc].toJSON()}}toString(){return"(FiberFailure) "+kc(this[Hc],{renderErrorCause:!0})}[Xe](){return this.toString()}}const Yj=t=>{const e=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new Jj(t);return Error.stackTraceLimit=e,n},Xj=t=>{const e=t;switch(e._op){case"Failure":case"Success":return e;case"Left":return mw(e.left);case"Right":return et(e.right);case"Some":return et(e.value);case"None":return mw(new zv)}},Zj=ty((t,e,n)=>eK(t,e,n).then(r=>{switch(r._tag){case Rt:return r.effect_instruction_i0;case At:throw Yj(r.effect_instruction_i0)}})),eK=ty((t,e,n)=>new Promise(r=>{const s=Xj(e);s&&r(s);const i=Gj(t)(e);i.addObserver(o=>{r(o)}),n?.signal!==void 0&&(n.signal.aborted?i.unsafeInterruptAsFork(i.id()):n.signal.addEventListener("abort",()=>{i.unsafeInterruptAsFork(i.id())},{once:!0}))}));class tK{context;runtimeFlags;fiberRefs;constructor(e,n,r){this.context=e,this.runtimeFlags=n,this.fiberRefs=r}pipe(){return ve(this,arguments)}}const nK=t=>new tK(t.context,t.runtimeFlags,t.fiberRefs),rK=fv(Mi,lv,uv),Zd=nK({context:rg(),runtimeFlags:rK,fiberRefs:tq()}),sK=Zj(Zd),iK=Q(2,(t,e)=>t.modifyEffect(e)),oK="effect/Layer",dx=Symbol.for(oK),cK={_RIn:t=>t,_E:t=>t,_ROut:t=>t},px={[dx]:cK,pipe(){return ve(this,arguments)}},aK="effect/Layer/MemoMap",yh=Symbol.for(aK),uK=sg()("effect/Layer/CurrentMemoMap",{defaultValue:()=>dK()}),lK=t=>Ae(t,dx),hK=t=>t._op_layer===zj;class gx{ref;[yh];constructor(e){this.ref=e,this[yh]=yh}getOrElseMemoize(e,n){return Z(iK(this.ref,r=>{const s=r.get(e);if(s!==void 0){const[i,o]=s,c=Z(i,ye(([a,u])=>Z(xq(a),Xn(u))),wi(Mg({onFailure:()=>nt,onSuccess:()=>dw(n,o)})));return Fe([c,r])}return Z(Ow(0),ye(i=>Z($B(),ye(o=>Z(Ow(()=>nt),Qe(c=>{const a=er(h=>Z(hx(),ye(l=>Z(h(ye(mx(e,l,!0),d=>bq(d(this)))),Us,ye(d=>{switch(d._tag){case At:return Z(qB(o,d.effect_instruction_i0),wn(Cd(l,d)),wn(Ot(d.effect_instruction_i0)));case Rt:return Z(bk(c,f=>Z(Cd(l,f),rB(dq(i,p=>[p===1,p-1])),ps)),wn(Mw(i,f=>f+1)),wn(dw(n,f=>Z(me(()=>r.delete(e)),wn(mu(c)),ye(p=>p(f))))),wn(UB(o,d.effect_instruction_i0)),Xn(d.effect_instruction_i0[1]))}}))))),u=[Z(Lg(o),wi(FB({onFailure:()=>nt,onSuccess:()=>Mw(i,h=>h+1)}))),h=>Z(mu(c),ye(l=>l(h)))];return[a,hK(e)?r:r.set(e,u)]}))))))}),xg)}}const fK=Ge(()=>Qe(Kj(new Map),t=>new gx(t))),dK=()=>new gx(fx(new Map)),yx=Q(2,(t,e)=>ye(fK,n=>pK(t,n,e))),pK=Q(3,(t,e,n)=>ye(mx(t,n),r=>Iq(r(e),uK,e))),mx=(t,e,n=!1)=>{const r=t;switch(r._op_layer){case"Locally":return me(()=>s=>r.f(s.getOrElseMemoize(r.self,e)));case"ExtendScope":return me(()=>s=>Aj(i=>s.getOrElseMemoize(r.layer,i)));case"Fold":return me(()=>s=>Z(s.getOrElseMemoize(r.layer,e),Zn({onFailure:i=>s.getOrElseMemoize(r.failureK(i),e),onSuccess:i=>s.getOrElseMemoize(r.successK(i),e)})));case"Fresh":return me(()=>s=>Z(r.layer,yx(e)));case"FromEffect":return me(n?()=>s=>r.effect:()=>s=>s.getOrElseMemoize(t,e));case"Provide":return me(()=>s=>Z(s.getOrElseMemoize(r.first,e),ye(i=>Z(s.getOrElseMemoize(r.second,e),Dg(i)))));case"Scoped":return me(n?()=>s=>bl(r.effect,e):()=>s=>s.getOrElseMemoize(t,e));case"Suspend":return me(()=>s=>s.getOrElseMemoize(r.evaluate(),e));case"ProvideMerge":return me(()=>s=>Z(s.getOrElseMemoize(r.first,e),iB(s.getOrElseMemoize(r.second,e),r.zipK)));case"ZipWith":return Pv(function*(){const s=yield*Pn(e,Dd),i=yield*Pn(s,qr),o=yield*Pn(s,qr);return c=>Z(c.getOrElseMemoize(r.first,i),Cj(c.getOrElseMemoize(r.second,o),r.zipK,{concurrent:!0}))});case"MergeAll":{const s=r.layers;return Qe(Pn(e,Dd),i=>o=>{const c=new Array(s.length);return Qe(mr(s,sB(function*(a,u){const h=yield*Pn(i,qr),l=yield*o.getOrElseMemoize(a,h);c[u]=l}),!1,!1),()=>IF(...c))})}}};function gK(t){const e=Object.create(px);return e._op_layer=Hj,e.effect=t,e}const wx=(...t)=>{const e=Object.create(px);return e._op_layer=Qj,e.layers=t,e},yK=Q(2,(t,e)=>{const n=xF(t);return gK(Fe(k0(n?t:e,n?e:t)))}),Gw=Q(2,(t,e)=>Rj(n=>ye(yx(e,n),r=>Fg(t,r)))),Jw=Q(2,(t,e)=>{const n=$d(Zd.fiberRefs,e.fiberRefs),r=Bs(Zd.runtimeFlags,e.runtimeFlags);return er(s=>it(i=>{const o=i.getFiberRef(gs),c=i.getFiberRefs(),a=Bd(i.id(),c)(n),u=i.currentRuntimeFlags,h=qs(r)(u),l=$d(a,c),d=Bs(h,u);return i.setFiberRefs(a),i.currentRuntimeFlags=h,Xd(Fg(s(t),Qu(o,e.context)),it(f=>(f.setFiberRefs(Bd(f.id(),f.getFiberRefs())(l)),f.currentRuntimeFlags=qs(d)(f.currentRuntimeFlags),nt)))}))}),mK=Q(2,(t,e)=>Array.isArray(e)?Gw(t,wx(...e)):lK(e)?Gw(t,e):kF(e)?Fg(t,e):Wj in e?ye(e.runtimeEffect,n=>Jw(t,n)):Jw(t,e)),wK=(function(){const t=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends Og{constructor(n){super(n?.message,n?.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,t,{value:n,enumerable:!1}))}toJSON(){return{...this[t],...this}}}}.BaseEffectError})(),qi=t=>{const e={BaseEffectError:class extends wK{_tag=t}};return e.BaseEffectError.prototype.name=t,e.BaseEffectError},bK=dt,Ur=Pv,bx=Id,Ia=Rq,Yw=mK,po=Sq,_K=Eq,SK=vq,EK=kq,Xw=sK,vK=wx,_x=yK,Zw=["trace","debug","info","warning","error","fatal"];function eb(t,e){const n=Zw.indexOf(t);if(n<0)throw new TypeError(`Invalid log level: ${JSON.stringify(t)}.`);const r=Zw.indexOf(e);if(r<0)throw new TypeError(`Invalid log level: ${JSON.stringify(e)}.`);return n-r}function kK(t=[]){return Sx.getLogger(t)}const mh=Symbol.for("logtape.rootLogger");var Sx=class lr{parent;children;category;sinks;parentSinks="inherit";filters;lowestLevel="trace";contextLocalStorage;static getLogger(e=[]){let n=mh in globalThis?globalThis[mh]??null:null;return n==null&&(n=new lr(null,[]),globalThis[mh]=n),typeof e=="string"?n.getChild(e):e.length===0?n:n.getChild(e)}constructor(e,n){this.parent=e,this.children={},this.category=n,this.sinks=[],this.filters=[]}getChild(e){const n=typeof e=="string"?e:e[0],r=this.children[n];let s=r instanceof lr?r:r?.deref();return s==null&&(s=new lr(this,[...this.category,n]),this.children[n]="WeakRef"in globalThis?new WeakRef(s):s),typeof e=="string"||e.length===1?s:s.getChild(e.slice(1))}reset(){for(;this.sinks.length>0;)this.sinks.shift();for(this.parentSinks="inherit";this.filters.length>0;)this.filters.shift();this.lowestLevel="trace"}resetDescendants(){for(const e of Object.values(this.children)){const n=e instanceof lr?e:e.deref();n?.resetDescendants()}this.reset()}with(e){return new xK(this,{...e})}filter(e){for(const n of this.filters)if(!n(e))return!1;return this.filters.length<1?this.parent?.filter(e)??!0:!0}*getSinks(e){if(!(this.lowestLevel===null||eb(e,this.lowestLevel)<0)){if(this.parent!=null&&this.parentSinks==="inherit")for(const n of this.parent.getSinks(e))yield n;for(const n of this.sinks)yield n}}emit(e,n){const r="category"in e?e:{...e,category:this.category};if(!(this.lowestLevel===null||eb(r.level,this.lowestLevel)<0||!this.filter(r))){for(const s of this.getSinks(r.level))if(!n?.has(s))try{s(r)}catch(i){const o=new Set(n);o.add(s),IK.log("fatal","Failed to emit a log record to sink {sink}: {error}",{sink:s,error:i,record:r},o)}}}log(e,n,r,s){const i=lr.getLogger().contextLocalStorage?.getStore()??{};let o;const c=typeof r=="function"?{category:this.category,level:e,timestamp:Date.now(),get message(){return tb(n,this.properties)},rawMessage:n,get properties(){return o==null&&(o={...i,...r()}),o}}:{category:this.category,level:e,timestamp:Date.now(),message:tb(n,{...i,...r}),rawMessage:n,properties:{...i,...r}};this.emit(c,s)}logLazily(e,n,r={}){const s=lr.getLogger().contextLocalStorage?.getStore()??{};let i,o;function c(){if((o==null||i==null)&&(o=n((a,...u)=>(i=a,nb(a,u))),i==null))throw new TypeError("No log record was made.");return[o,i]}this.emit({category:this.category,level:e,get message(){return c()[0]},get rawMessage(){return c()[1]},timestamp:Date.now(),properties:{...s,...r}})}logTemplate(e,n,r,s={}){const i=lr.getLogger().contextLocalStorage?.getStore()??{};this.emit({category:this.category,level:e,message:nb(n,r),rawMessage:n,timestamp:Date.now(),properties:{...i,...s}})}trace(e,...n){typeof e=="string"?this.log("trace",e,n[0]??{}):typeof e=="function"?this.logLazily("trace",e):Array.isArray(e)?this.logTemplate("trace",e,n):this.log("trace","{*}",e)}debug(e,...n){typeof e=="string"?this.log("debug",e,n[0]??{}):typeof e=="function"?this.logLazily("debug",e):Array.isArray(e)?this.logTemplate("debug",e,n):this.log("debug","{*}",e)}info(e,...n){typeof e=="string"?this.log("info",e,n[0]??{}):typeof e=="function"?this.logLazily("info",e):Array.isArray(e)?this.logTemplate("info",e,n):this.log("info","{*}",e)}warn(e,...n){typeof e=="string"?this.log("warning",e,n[0]??{}):typeof e=="function"?this.logLazily("warning",e):Array.isArray(e)?this.logTemplate("warning",e,n):this.log("warning","{*}",e)}warning(e,...n){this.warn(e,...n)}error(e,...n){typeof e=="string"?this.log("error",e,n[0]??{}):typeof e=="function"?this.logLazily("error",e):Array.isArray(e)?this.logTemplate("error",e,n):this.log("error","{*}",e)}fatal(e,...n){typeof e=="string"?this.log("fatal",e,n[0]??{}):typeof e=="function"?this.logLazily("fatal",e):Array.isArray(e)?this.logTemplate("fatal",e,n):this.log("fatal","{*}",e)}},xK=class Ex{logger;properties;constructor(e,n){this.logger=e,this.properties=n}get category(){return this.logger.category}get parent(){return this.logger.parent}getChild(e){return this.logger.getChild(e).with(this.properties)}with(e){return new Ex(this.logger,{...this.properties,...e})}log(e,n,r,s){this.logger.log(e,n,typeof r=="function"?()=>({...this.properties,...r()}):{...this.properties,...r},s)}logLazily(e,n){this.logger.logLazily(e,n,this.properties)}logTemplate(e,n,r){this.logger.logTemplate(e,n,r,this.properties)}emit(e){const n={...e,properties:{...this.properties,...e.properties}};this.logger.emit(n)}trace(e,...n){typeof e=="string"?this.log("trace",e,n[0]??{}):typeof e=="function"?this.logLazily("trace",e):Array.isArray(e)?this.logTemplate("trace",e,n):this.log("trace","{*}",e)}debug(e,...n){typeof e=="string"?this.log("debug",e,n[0]??{}):typeof e=="function"?this.logLazily("debug",e):Array.isArray(e)?this.logTemplate("debug",e,n):this.log("debug","{*}",e)}info(e,...n){typeof e=="string"?this.log("info",e,n[0]??{}):typeof e=="function"?this.logLazily("info",e):Array.isArray(e)?this.logTemplate("info",e,n):this.log("info","{*}",e)}warn(e,...n){typeof e=="string"?this.log("warning",e,n[0]??{}):typeof e=="function"?this.logLazily("warning",e):Array.isArray(e)?this.logTemplate("warning",e,n):this.log("warning","{*}",e)}warning(e,...n){this.warn(e,...n)}error(e,...n){typeof e=="string"?this.log("error",e,n[0]??{}):typeof e=="function"?this.logLazily("error",e):Array.isArray(e)?this.logTemplate("error",e,n):this.log("error","{*}",e)}fatal(e,...n){typeof e=="string"?this.log("fatal",e,n[0]??{}):typeof e=="function"?this.logLazily("fatal",e):Array.isArray(e)?this.logTemplate("fatal",e,n):this.log("fatal","{*}",e)}};const IK=Sx.getLogger(["logtape","meta"]);function TK(t){return t.includes(".")||t.includes("[")||t.includes("?.")}function AK(t,e){if(!(e==="__proto__"||e==="prototype"||e==="constructor")&&(typeof t=="object"||typeof t=="function")&&t!==null)return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0}function RK(t,e){const n=t.length;let r=e;if(r>=n)return null;let s;if(t[r]==="["){if(r++,r>=n)return null;if(t[r]==='"'||t[r]==="'"){const i=t[r];r++;let o="";for(;r<n&&t[r]!==i;)if(t[r]==="\\"){if(r++,r<n){const c=t[r];switch(c){case"n":o+=`
`;break;case"t":o+="	";break;case"r":o+="\r";break;case"b":o+="\b";break;case"f":o+="\f";break;case"v":o+="\v";break;case"0":o+="\0";break;case"\\":o+="\\";break;case'"':o+='"';break;case"'":o+="'";break;case"u":if(r+4<n){const a=t.slice(r+1,r+5),u=Number.parseInt(a,16);Number.isNaN(u)?o+=c:(o+=String.fromCharCode(u),r+=4)}else o+=c;break;default:o+=c}r++}}else o+=t[r],r++;if(r>=n)return null;s=o,r++}else{const i=r;for(;r<n&&t[r]!=="]"&&t[r]!=="'"&&t[r]!=='"';)r++;if(r>=n)return null;const o=t.slice(i,r);if(o.length===0)return null;const c=Number(o);s=Number.isNaN(c)?o:c}for(;r<n&&t[r]!=="]";)r++;r<n&&r++}else{const i=r;for(;r<n&&t[r]!=="."&&t[r]!=="["&&t[r]!=="?"&&t[r]!=="]";)r++;if(s=t.slice(i,r),s.length===0)return null}return r<n&&t[r]==="."&&r++,{segment:s,nextIndex:r}}function CK(t,e){if(typeof e=="string")return AK(t,e);if(Array.isArray(t)&&e>=0&&e<t.length)return t[e]}function OK(t,e){if(t==null||e.length===0||e.endsWith("."))return;let n=t,r=0;const s=e.length;for(;r<s;){if(e.slice(r,r+2)==="?."){if(r+=2,n==null)return}else if(n==null)return;const o=RK(e,r);if(o===null)return;const{segment:c,nextIndex:a}=o;if(r=a,n=CK(n,c),n===void 0)return}return n}function tb(t,e){const n=t.length;if(n===0)return[""];if(!t.includes("{"))return[t];const r=[];let s=0;for(let o=0;o<n;o++){const c=t[o];if(c==="{"){if((o+1<n?t[o+1]:"")==="{"){o++;continue}const u=t.indexOf("}",o+1);if(u===-1)continue;const h=t.slice(s,o);r.push(h.replace(/{{/g,"{").replace(/}}/g,"}"));const l=t.slice(o+1,u);let d;const f=l.trim();f==="*"?d=l in e?e[l]:"*"in e?e["*"]:e:(l!==f?d=l in e?e[l]:e[f]:d=e[l],d===void 0&&TK(f)&&(d=OK(e,f))),r.push(d),o=u,s=o+1}else c==="}"&&o+1<n&&t[o+1]==="}"&&o++}const i=t.slice(s);return r.push(i.replace(/{{/g,"{").replace(/}}/g,"}")),r}function nb(t,e){const n=[];for(let r=0;r<t.length;r++)n.push(t[r]),r<e.length&&n.push(e[r]);return n}const ys=t=>Hn((e,n)=>{t.onerror=r=>n(new Error(r.target.error)),t.onsuccess=r=>e(r.target.result)}),MK=(t,e)=>Hn((n,r)=>{const s=indexedDB.open(t);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(dn(i.target.error)),s.onsuccess=i=>{const o=i.target.result;o.onversionchange=()=>{o.close()},n(o)}}),LK=t=>ys(indexedDB.deleteDatabase(t)),DK=(t,e)=>e.forEach(n=>t.createObjectStore.apply(t,n)),go=(t,e,n="readwrite")=>{const r=t.transaction(e,n);return e.map(s=>VK(r,s))},vx=(t,e)=>ys(t.count(e)),FK=(t,e)=>ys(t.get(e)),kx=(t,e)=>ys(t.delete(e)),NK=(t,e,n)=>ys(t.put(e,n)),ep=(t,e)=>ys(t.add(e)),PK=(t,e,n)=>ys(t.getAll(e,n)),$K=(t,e,n)=>{let r=null;return UK(t,e,s=>(r=s,!1),n).then(()=>r)},BK=(t,e=null)=>$K(t,e,"prev"),qK=(t,e)=>Hn((n,r)=>{t.onerror=r,t.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return n();i.continue()}}),UK=(t,e,n,r="next")=>qK(t.openKeyCursor(e,r),s=>n(s.key)),VK=(t,e)=>t.objectStore(e),jK=(t,e)=>IDBKeyRange.upperBound(t,e),KK=(t,e)=>IDBKeyRange.lowerBound(t,e),wh="custom",xx="updates",Ix=500,Tx=(t,e=()=>{},n=()=>{})=>{const[r]=go(t.db,[xx]);return PK(r,KK(t._dbref,!1)).then(s=>{t._destroyed||(e(r),Ue(t.doc,()=>{s.forEach(i=>Pu(t.doc,i))},t,!1),n(r))}).then(()=>BK(r).then(s=>{t._dbref=s+1})).then(()=>vx(r).then(s=>{t._dbsize=s})).then(()=>r)},WK=(t,e=!0)=>Tx(t).then(n=>{(e||t._dbsize>=Ix)&&ep(n,Uo(t.doc)).then(()=>kx(n,jK(t._dbref,!0))).then(()=>vx(n).then(r=>{t._dbsize=r}))});class zK extends kO{constructor(e,n){super(),this.doc=n,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=MK(e,r=>DK(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=Hn(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,Tx(this,o=>ep(o,Uo(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=go(this.db,[xx]);ep(i,r),++this._dbsize>=Ix&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{WK(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{LK(this.name)})}get(e){return this._db.then(n=>{const[r]=go(n,[wh],"readonly");return FK(r,e)})}set(e,n){return this._db.then(r=>{const[s]=go(r,[wh]);return NK(s,n,e)})}del(e){return this._db.then(n=>{const[r]=go(n,[wh]);return kx(r,e)})}}var HK=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},bh={},Ln={},Qc={},_h={},rb;function QK(){return rb||(rb=1,_h.supports=function(...e){const n=e.reduce((i,o)=>Object.assign(i,o),{}),r=n.implicitSnapshots||n.snapshots||!1,s=n.explicitSnapshots||!1;return Object.assign(n,{implicitSnapshots:r,explicitSnapshots:s,snapshots:r,has:n.has||!1,permanence:n.permanence||!1,seek:n.seek||!1,createIfMissing:n.createIfMissing||!1,errorIfExists:n.errorIfExists||!1,deferredOpen:n.deferredOpen||!1,streams:n.streams||!1,encodings:Object.assign({},n.encodings),events:Object.assign({},n.events),additionalMethods:Object.assign({},n.additionalMethods),signals:Object.assign({},n.signals)})}),_h}var Sh={},Eh,sb;function wt(){return sb||(sb=1,Eh=class extends Error{constructor(e,n){super(e||""),typeof n=="object"&&n!==null&&(n.code&&(this.code=String(n.code)),n.expected&&(this.expected=!0),n.transient&&(this.transient=!0),n.cause&&(this.cause=n.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}),Eh}var ar={},vh={},Yi={},ib;function GK(){if(ib)return Yi;ib=1,Yi.byteLength=c,Yi.toByteArray=u,Yi.fromByteArray=d;for(var t=[],e=[],n=typeof Uint8Array<"u"?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,i=r.length;s<i;++s)t[s]=r[s],e[r.charCodeAt(s)]=s;e[45]=62,e[95]=63;function o(f){var p=f.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var w=f.indexOf("=");w===-1&&(w=p);var g=w===p?0:4-w%4;return[w,g]}function c(f){var p=o(f),w=p[0],g=p[1];return(w+g)*3/4-g}function a(f,p,w){return(p+w)*3/4-w}function u(f){var p,w=o(f),g=w[0],m=w[1],_=new n(a(f,g,m)),v=0,k=m>0?g-4:g,I;for(I=0;I<k;I+=4)p=e[f.charCodeAt(I)]<<18|e[f.charCodeAt(I+1)]<<12|e[f.charCodeAt(I+2)]<<6|e[f.charCodeAt(I+3)],_[v++]=p>>16&255,_[v++]=p>>8&255,_[v++]=p&255;return m===2&&(p=e[f.charCodeAt(I)]<<2|e[f.charCodeAt(I+1)]>>4,_[v++]=p&255),m===1&&(p=e[f.charCodeAt(I)]<<10|e[f.charCodeAt(I+1)]<<4|e[f.charCodeAt(I+2)]>>2,_[v++]=p>>8&255,_[v++]=p&255),_}function h(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function l(f,p,w){for(var g,m=[],_=p;_<w;_+=3)g=(f[_]<<16&16711680)+(f[_+1]<<8&65280)+(f[_+2]&255),m.push(h(g));return m.join("")}function d(f){for(var p,w=f.length,g=w%3,m=[],_=16383,v=0,k=w-g;v<k;v+=_)m.push(l(f,v,v+_>k?k:v+_));return g===1?(p=f[w-1],m.push(t[p>>2]+t[p<<4&63]+"==")):g===2&&(p=(f[w-2]<<8)+f[w-1],m.push(t[p>>10]+t[p>>4&63]+t[p<<2&63]+"=")),m.join("")}return Yi}var Gc={};var ob;function JK(){return ob||(ob=1,Gc.read=function(t,e,n,r,s){var i,o,c=s*8-r-1,a=(1<<c)-1,u=a>>1,h=-7,l=n?s-1:0,d=n?-1:1,f=t[e+l];for(l+=d,i=f&(1<<-h)-1,f>>=-h,h+=c;h>0;i=i*256+t[e+l],l+=d,h-=8);for(o=i&(1<<-h)-1,i>>=-h,h+=r;h>0;o=o*256+t[e+l],l+=d,h-=8);if(i===0)i=1-u;else{if(i===a)return o?NaN:(f?-1:1)*(1/0);o=o+Math.pow(2,r),i=i-u}return(f?-1:1)*o*Math.pow(2,i-r)},Gc.write=function(t,e,n,r,s,i){var o,c,a,u=i*8-s-1,h=(1<<u)-1,l=h>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,p=r?1:-1,w=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(c=isNaN(e)?1:0,o=h):(o=Math.floor(Math.log(e)/Math.LN2),e*(a=Math.pow(2,-o))<1&&(o--,a*=2),o+l>=1?e+=d/a:e+=d*Math.pow(2,1-l),e*a>=2&&(o++,a/=2),o+l>=h?(c=0,o=h):o+l>=1?(c=(e*a-1)*Math.pow(2,s),o=o+l):(c=e*Math.pow(2,l-1)*Math.pow(2,s),o=0));s>=8;t[n+f]=c&255,f+=p,c/=256,s-=8);for(o=o<<s|c,u+=s;u>0;t[n+f]=o&255,f+=p,o/=256,u-=8);t[n+f-p]|=w*128}),Gc}var cb;function Yt(){return cb||(cb=1,(function(t){const e=GK(),n=JK(),r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=_,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s,c.TYPED_ARRAY_SUPPORT=i(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function i(){try{const x=new Uint8Array(1),y={foo:function(){return 42}};return Object.setPrototypeOf(y,Uint8Array.prototype),Object.setPrototypeOf(x,y),x.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function o(x){if(x>s)throw new RangeError('The value "'+x+'" is invalid for option "size"');const y=new Uint8Array(x);return Object.setPrototypeOf(y,c.prototype),y}function c(x,y,b){if(typeof x=="number"){if(typeof y=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return l(x)}return a(x,y,b)}c.poolSize=8192;function a(x,y,b){if(typeof x=="string")return d(x,y);if(ArrayBuffer.isView(x))return p(x);if(x==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x);if(re(x,ArrayBuffer)||x&&re(x.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(re(x,SharedArrayBuffer)||x&&re(x.buffer,SharedArrayBuffer)))return w(x,y,b);if(typeof x=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const M=x.valueOf&&x.valueOf();if(M!=null&&M!==x)return c.from(M,y,b);const V=g(x);if(V)return V;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof x[Symbol.toPrimitive]=="function")return c.from(x[Symbol.toPrimitive]("string"),y,b);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x)}c.from=function(x,y,b){return a(x,y,b)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function u(x){if(typeof x!="number")throw new TypeError('"size" argument must be of type number');if(x<0)throw new RangeError('The value "'+x+'" is invalid for option "size"')}function h(x,y,b){return u(x),x<=0?o(x):y!==void 0?typeof b=="string"?o(x).fill(y,b):o(x).fill(y):o(x)}c.alloc=function(x,y,b){return h(x,y,b)};function l(x){return u(x),o(x<0?0:m(x)|0)}c.allocUnsafe=function(x){return l(x)},c.allocUnsafeSlow=function(x){return l(x)};function d(x,y){if((typeof y!="string"||y==="")&&(y="utf8"),!c.isEncoding(y))throw new TypeError("Unknown encoding: "+y);const b=v(x,y)|0;let M=o(b);const V=M.write(x,y);return V!==b&&(M=M.slice(0,V)),M}function f(x){const y=x.length<0?0:m(x.length)|0,b=o(y);for(let M=0;M<y;M+=1)b[M]=x[M]&255;return b}function p(x){if(re(x,Uint8Array)){const y=new Uint8Array(x);return w(y.buffer,y.byteOffset,y.byteLength)}return f(x)}function w(x,y,b){if(y<0||x.byteLength<y)throw new RangeError('"offset" is outside of buffer bounds');if(x.byteLength<y+(b||0))throw new RangeError('"length" is outside of buffer bounds');let M;return y===void 0&&b===void 0?M=new Uint8Array(x):b===void 0?M=new Uint8Array(x,y):M=new Uint8Array(x,y,b),Object.setPrototypeOf(M,c.prototype),M}function g(x){if(c.isBuffer(x)){const y=m(x.length)|0,b=o(y);return b.length===0||x.copy(b,0,0,y),b}if(x.length!==void 0)return typeof x.length!="number"||Ne(x.length)?o(0):f(x);if(x.type==="Buffer"&&Array.isArray(x.data))return f(x.data)}function m(x){if(x>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return x|0}function _(x){return+x!=x&&(x=0),c.alloc(+x)}c.isBuffer=function(y){return y!=null&&y._isBuffer===!0&&y!==c.prototype},c.compare=function(y,b){if(re(y,Uint8Array)&&(y=c.from(y,y.offset,y.byteLength)),re(b,Uint8Array)&&(b=c.from(b,b.offset,b.byteLength)),!c.isBuffer(y)||!c.isBuffer(b))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(y===b)return 0;let M=y.length,V=b.length;for(let Y=0,ie=Math.min(M,V);Y<ie;++Y)if(y[Y]!==b[Y]){M=y[Y],V=b[Y];break}return M<V?-1:V<M?1:0},c.isEncoding=function(y){switch(String(y).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(y,b){if(!Array.isArray(y))throw new TypeError('"list" argument must be an Array of Buffers');if(y.length===0)return c.alloc(0);let M;if(b===void 0)for(b=0,M=0;M<y.length;++M)b+=y[M].length;const V=c.allocUnsafe(b);let Y=0;for(M=0;M<y.length;++M){let ie=y[M];if(re(ie,Uint8Array))Y+ie.length>V.length?(c.isBuffer(ie)||(ie=c.from(ie)),ie.copy(V,Y)):Uint8Array.prototype.set.call(V,ie,Y);else if(c.isBuffer(ie))ie.copy(V,Y);else throw new TypeError('"list" argument must be an Array of Buffers');Y+=ie.length}return V};function v(x,y){if(c.isBuffer(x))return x.length;if(ArrayBuffer.isView(x)||re(x,ArrayBuffer))return x.byteLength;if(typeof x!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof x);const b=x.length,M=arguments.length>2&&arguments[2]===!0;if(!M&&b===0)return 0;let V=!1;for(;;)switch(y){case"ascii":case"latin1":case"binary":return b;case"utf8":case"utf-8":return he(x).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return b*2;case"hex":return b>>>1;case"base64":return oe(x).length;default:if(V)return M?-1:he(x).length;y=(""+y).toLowerCase(),V=!0}}c.byteLength=v;function k(x,y,b){let M=!1;if((y===void 0||y<0)&&(y=0),y>this.length||((b===void 0||b>this.length)&&(b=this.length),b<=0)||(b>>>=0,y>>>=0,b<=y))return"";for(x||(x="utf8");;)switch(x){case"hex":return R(this,y,b);case"utf8":case"utf-8":return te(this,y,b);case"ascii":return B(this,y,b);case"latin1":case"binary":return S(this,y,b);case"base64":return q(this,y,b);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,y,b);default:if(M)throw new TypeError("Unknown encoding: "+x);x=(x+"").toLowerCase(),M=!0}}c.prototype._isBuffer=!0;function I(x,y,b){const M=x[y];x[y]=x[b],x[b]=M}c.prototype.swap16=function(){const y=this.length;if(y%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let b=0;b<y;b+=2)I(this,b,b+1);return this},c.prototype.swap32=function(){const y=this.length;if(y%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let b=0;b<y;b+=4)I(this,b,b+3),I(this,b+1,b+2);return this},c.prototype.swap64=function(){const y=this.length;if(y%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let b=0;b<y;b+=8)I(this,b,b+7),I(this,b+1,b+6),I(this,b+2,b+5),I(this,b+3,b+4);return this},c.prototype.toString=function(){const y=this.length;return y===0?"":arguments.length===0?te(this,0,y):k.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(y){if(!c.isBuffer(y))throw new TypeError("Argument must be a Buffer");return this===y?!0:c.compare(this,y)===0},c.prototype.inspect=function(){let y="";const b=t.INSPECT_MAX_BYTES;return y=this.toString("hex",0,b).replace(/(.{2})/g,"$1 ").trim(),this.length>b&&(y+=" ... "),"<Buffer "+y+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(y,b,M,V,Y){if(re(y,Uint8Array)&&(y=c.from(y,y.offset,y.byteLength)),!c.isBuffer(y))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof y);if(b===void 0&&(b=0),M===void 0&&(M=y?y.length:0),V===void 0&&(V=0),Y===void 0&&(Y=this.length),b<0||M>y.length||V<0||Y>this.length)throw new RangeError("out of range index");if(V>=Y&&b>=M)return 0;if(V>=Y)return-1;if(b>=M)return 1;if(b>>>=0,M>>>=0,V>>>=0,Y>>>=0,this===y)return 0;let ie=Y-V,ke=M-b;const ze=Math.min(ie,ke),je=this.slice(V,Y),He=y.slice(b,M);for(let qe=0;qe<ze;++qe)if(je[qe]!==He[qe]){ie=je[qe],ke=He[qe];break}return ie<ke?-1:ke<ie?1:0};function A(x,y,b,M,V){if(x.length===0)return-1;if(typeof b=="string"?(M=b,b=0):b>2147483647?b=2147483647:b<-2147483648&&(b=-2147483648),b=+b,Ne(b)&&(b=V?0:x.length-1),b<0&&(b=x.length+b),b>=x.length){if(V)return-1;b=x.length-1}else if(b<0)if(V)b=0;else return-1;if(typeof y=="string"&&(y=c.from(y,M)),c.isBuffer(y))return y.length===0?-1:L(x,y,b,M,V);if(typeof y=="number")return y=y&255,typeof Uint8Array.prototype.indexOf=="function"?V?Uint8Array.prototype.indexOf.call(x,y,b):Uint8Array.prototype.lastIndexOf.call(x,y,b):L(x,[y],b,M,V);throw new TypeError("val must be string, number or Buffer")}function L(x,y,b,M,V){let Y=1,ie=x.length,ke=y.length;if(M!==void 0&&(M=String(M).toLowerCase(),M==="ucs2"||M==="ucs-2"||M==="utf16le"||M==="utf-16le")){if(x.length<2||y.length<2)return-1;Y=2,ie/=2,ke/=2,b/=2}function ze(He,qe){return Y===1?He[qe]:He.readUInt16BE(qe*Y)}let je;if(V){let He=-1;for(je=b;je<ie;je++)if(ze(x,je)===ze(y,He===-1?0:je-He)){if(He===-1&&(He=je),je-He+1===ke)return He*Y}else He!==-1&&(je-=je-He),He=-1}else for(b+ke>ie&&(b=ie-ke),je=b;je>=0;je--){let He=!0;for(let qe=0;qe<ke;qe++)if(ze(x,je+qe)!==ze(y,qe)){He=!1;break}if(He)return je}return-1}c.prototype.includes=function(y,b,M){return this.indexOf(y,b,M)!==-1},c.prototype.indexOf=function(y,b,M){return A(this,y,b,M,!0)},c.prototype.lastIndexOf=function(y,b,M){return A(this,y,b,M,!1)};function D(x,y,b,M){b=Number(b)||0;const V=x.length-b;M?(M=Number(M),M>V&&(M=V)):M=V;const Y=y.length;M>Y/2&&(M=Y/2);let ie;for(ie=0;ie<M;++ie){const ke=parseInt(y.substr(ie*2,2),16);if(Ne(ke))return ie;x[b+ie]=ke}return ie}function K(x,y,b,M){return ae(he(y,x.length-b),x,b,M)}function O(x,y,b,M){return ae(fe(y),x,b,M)}function N(x,y,b,M){return ae(oe(y),x,b,M)}function W(x,y,b,M){return ae(j(y,x.length-b),x,b,M)}c.prototype.write=function(y,b,M,V){if(b===void 0)V="utf8",M=this.length,b=0;else if(M===void 0&&typeof b=="string")V=b,M=this.length,b=0;else if(isFinite(b))b=b>>>0,isFinite(M)?(M=M>>>0,V===void 0&&(V="utf8")):(V=M,M=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const Y=this.length-b;if((M===void 0||M>Y)&&(M=Y),y.length>0&&(M<0||b<0)||b>this.length)throw new RangeError("Attempt to write outside buffer bounds");V||(V="utf8");let ie=!1;for(;;)switch(V){case"hex":return D(this,y,b,M);case"utf8":case"utf-8":return K(this,y,b,M);case"ascii":case"latin1":case"binary":return O(this,y,b,M);case"base64":return N(this,y,b,M);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return W(this,y,b,M);default:if(ie)throw new TypeError("Unknown encoding: "+V);V=(""+V).toLowerCase(),ie=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function q(x,y,b){return y===0&&b===x.length?e.fromByteArray(x):e.fromByteArray(x.slice(y,b))}function te(x,y,b){b=Math.min(x.length,b);const M=[];let V=y;for(;V<b;){const Y=x[V];let ie=null,ke=Y>239?4:Y>223?3:Y>191?2:1;if(V+ke<=b){let ze,je,He,qe;switch(ke){case 1:Y<128&&(ie=Y);break;case 2:ze=x[V+1],(ze&192)===128&&(qe=(Y&31)<<6|ze&63,qe>127&&(ie=qe));break;case 3:ze=x[V+1],je=x[V+2],(ze&192)===128&&(je&192)===128&&(qe=(Y&15)<<12|(ze&63)<<6|je&63,qe>2047&&(qe<55296||qe>57343)&&(ie=qe));break;case 4:ze=x[V+1],je=x[V+2],He=x[V+3],(ze&192)===128&&(je&192)===128&&(He&192)===128&&(qe=(Y&15)<<18|(ze&63)<<12|(je&63)<<6|He&63,qe>65535&&qe<1114112&&(ie=qe))}}ie===null?(ie=65533,ke=1):ie>65535&&(ie-=65536,M.push(ie>>>10&1023|55296),ie=56320|ie&1023),M.push(ie),V+=ke}return $(M)}const T=4096;function $(x){const y=x.length;if(y<=T)return String.fromCharCode.apply(String,x);let b="",M=0;for(;M<y;)b+=String.fromCharCode.apply(String,x.slice(M,M+=T));return b}function B(x,y,b){let M="";b=Math.min(x.length,b);for(let V=y;V<b;++V)M+=String.fromCharCode(x[V]&127);return M}function S(x,y,b){let M="";b=Math.min(x.length,b);for(let V=y;V<b;++V)M+=String.fromCharCode(x[V]);return M}function R(x,y,b){const M=x.length;(!y||y<0)&&(y=0),(!b||b<0||b>M)&&(b=M);let V="";for(let Y=y;Y<b;++Y)V+=St[x[Y]];return V}function E(x,y,b){const M=x.slice(y,b);let V="";for(let Y=0;Y<M.length-1;Y+=2)V+=String.fromCharCode(M[Y]+M[Y+1]*256);return V}c.prototype.slice=function(y,b){const M=this.length;y=~~y,b=b===void 0?M:~~b,y<0?(y+=M,y<0&&(y=0)):y>M&&(y=M),b<0?(b+=M,b<0&&(b=0)):b>M&&(b=M),b<y&&(b=y);const V=this.subarray(y,b);return Object.setPrototypeOf(V,c.prototype),V};function P(x,y,b){if(x%1!==0||x<0)throw new RangeError("offset is not uint");if(x+y>b)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(y,b,M){y=y>>>0,b=b>>>0,M||P(y,b,this.length);let V=this[y],Y=1,ie=0;for(;++ie<b&&(Y*=256);)V+=this[y+ie]*Y;return V},c.prototype.readUintBE=c.prototype.readUIntBE=function(y,b,M){y=y>>>0,b=b>>>0,M||P(y,b,this.length);let V=this[y+--b],Y=1;for(;b>0&&(Y*=256);)V+=this[y+--b]*Y;return V},c.prototype.readUint8=c.prototype.readUInt8=function(y,b){return y=y>>>0,b||P(y,1,this.length),this[y]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(y,b){return y=y>>>0,b||P(y,2,this.length),this[y]|this[y+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(y,b){return y=y>>>0,b||P(y,2,this.length),this[y]<<8|this[y+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(y,b){return y=y>>>0,b||P(y,4,this.length),(this[y]|this[y+1]<<8|this[y+2]<<16)+this[y+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(y,b){return y=y>>>0,b||P(y,4,this.length),this[y]*16777216+(this[y+1]<<16|this[y+2]<<8|this[y+3])},c.prototype.readBigUInt64LE=Oe(function(y){y=y>>>0,U(y,"offset");const b=this[y],M=this[y+7];(b===void 0||M===void 0)&&z(y,this.length-8);const V=b+this[++y]*2**8+this[++y]*2**16+this[++y]*2**24,Y=this[++y]+this[++y]*2**8+this[++y]*2**16+M*2**24;return BigInt(V)+(BigInt(Y)<<BigInt(32))}),c.prototype.readBigUInt64BE=Oe(function(y){y=y>>>0,U(y,"offset");const b=this[y],M=this[y+7];(b===void 0||M===void 0)&&z(y,this.length-8);const V=b*2**24+this[++y]*2**16+this[++y]*2**8+this[++y],Y=this[++y]*2**24+this[++y]*2**16+this[++y]*2**8+M;return(BigInt(V)<<BigInt(32))+BigInt(Y)}),c.prototype.readIntLE=function(y,b,M){y=y>>>0,b=b>>>0,M||P(y,b,this.length);let V=this[y],Y=1,ie=0;for(;++ie<b&&(Y*=256);)V+=this[y+ie]*Y;return Y*=128,V>=Y&&(V-=Math.pow(2,8*b)),V},c.prototype.readIntBE=function(y,b,M){y=y>>>0,b=b>>>0,M||P(y,b,this.length);let V=b,Y=1,ie=this[y+--V];for(;V>0&&(Y*=256);)ie+=this[y+--V]*Y;return Y*=128,ie>=Y&&(ie-=Math.pow(2,8*b)),ie},c.prototype.readInt8=function(y,b){return y=y>>>0,b||P(y,1,this.length),this[y]&128?(255-this[y]+1)*-1:this[y]},c.prototype.readInt16LE=function(y,b){y=y>>>0,b||P(y,2,this.length);const M=this[y]|this[y+1]<<8;return M&32768?M|4294901760:M},c.prototype.readInt16BE=function(y,b){y=y>>>0,b||P(y,2,this.length);const M=this[y+1]|this[y]<<8;return M&32768?M|4294901760:M},c.prototype.readInt32LE=function(y,b){return y=y>>>0,b||P(y,4,this.length),this[y]|this[y+1]<<8|this[y+2]<<16|this[y+3]<<24},c.prototype.readInt32BE=function(y,b){return y=y>>>0,b||P(y,4,this.length),this[y]<<24|this[y+1]<<16|this[y+2]<<8|this[y+3]},c.prototype.readBigInt64LE=Oe(function(y){y=y>>>0,U(y,"offset");const b=this[y],M=this[y+7];(b===void 0||M===void 0)&&z(y,this.length-8);const V=this[y+4]+this[y+5]*2**8+this[y+6]*2**16+(M<<24);return(BigInt(V)<<BigInt(32))+BigInt(b+this[++y]*2**8+this[++y]*2**16+this[++y]*2**24)}),c.prototype.readBigInt64BE=Oe(function(y){y=y>>>0,U(y,"offset");const b=this[y],M=this[y+7];(b===void 0||M===void 0)&&z(y,this.length-8);const V=(b<<24)+this[++y]*2**16+this[++y]*2**8+this[++y];return(BigInt(V)<<BigInt(32))+BigInt(this[++y]*2**24+this[++y]*2**16+this[++y]*2**8+M)}),c.prototype.readFloatLE=function(y,b){return y=y>>>0,b||P(y,4,this.length),n.read(this,y,!0,23,4)},c.prototype.readFloatBE=function(y,b){return y=y>>>0,b||P(y,4,this.length),n.read(this,y,!1,23,4)},c.prototype.readDoubleLE=function(y,b){return y=y>>>0,b||P(y,8,this.length),n.read(this,y,!0,52,8)},c.prototype.readDoubleBE=function(y,b){return y=y>>>0,b||P(y,8,this.length),n.read(this,y,!1,52,8)};function X(x,y,b,M,V,Y){if(!c.isBuffer(x))throw new TypeError('"buffer" argument must be a Buffer instance');if(y>V||y<Y)throw new RangeError('"value" argument is out of bounds');if(b+M>x.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(y,b,M,V){if(y=+y,b=b>>>0,M=M>>>0,!V){const ke=Math.pow(2,8*M)-1;X(this,y,b,M,ke,0)}let Y=1,ie=0;for(this[b]=y&255;++ie<M&&(Y*=256);)this[b+ie]=y/Y&255;return b+M},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(y,b,M,V){if(y=+y,b=b>>>0,M=M>>>0,!V){const ke=Math.pow(2,8*M)-1;X(this,y,b,M,ke,0)}let Y=M-1,ie=1;for(this[b+Y]=y&255;--Y>=0&&(ie*=256);)this[b+Y]=y/ie&255;return b+M},c.prototype.writeUint8=c.prototype.writeUInt8=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,1,255,0),this[b]=y&255,b+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,2,65535,0),this[b]=y&255,this[b+1]=y>>>8,b+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,2,65535,0),this[b]=y>>>8,this[b+1]=y&255,b+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,4,4294967295,0),this[b+3]=y>>>24,this[b+2]=y>>>16,this[b+1]=y>>>8,this[b]=y&255,b+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,4,4294967295,0),this[b]=y>>>24,this[b+1]=y>>>16,this[b+2]=y>>>8,this[b+3]=y&255,b+4};function H(x,y,b,M,V){be(y,M,V,x,b,7);let Y=Number(y&BigInt(4294967295));x[b++]=Y,Y=Y>>8,x[b++]=Y,Y=Y>>8,x[b++]=Y,Y=Y>>8,x[b++]=Y;let ie=Number(y>>BigInt(32)&BigInt(4294967295));return x[b++]=ie,ie=ie>>8,x[b++]=ie,ie=ie>>8,x[b++]=ie,ie=ie>>8,x[b++]=ie,b}function G(x,y,b,M,V){be(y,M,V,x,b,7);let Y=Number(y&BigInt(4294967295));x[b+7]=Y,Y=Y>>8,x[b+6]=Y,Y=Y>>8,x[b+5]=Y,Y=Y>>8,x[b+4]=Y;let ie=Number(y>>BigInt(32)&BigInt(4294967295));return x[b+3]=ie,ie=ie>>8,x[b+2]=ie,ie=ie>>8,x[b+1]=ie,ie=ie>>8,x[b]=ie,b+8}c.prototype.writeBigUInt64LE=Oe(function(y,b=0){return H(this,y,b,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=Oe(function(y,b=0){return G(this,y,b,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(y,b,M,V){if(y=+y,b=b>>>0,!V){const ze=Math.pow(2,8*M-1);X(this,y,b,M,ze-1,-ze)}let Y=0,ie=1,ke=0;for(this[b]=y&255;++Y<M&&(ie*=256);)y<0&&ke===0&&this[b+Y-1]!==0&&(ke=1),this[b+Y]=(y/ie>>0)-ke&255;return b+M},c.prototype.writeIntBE=function(y,b,M,V){if(y=+y,b=b>>>0,!V){const ze=Math.pow(2,8*M-1);X(this,y,b,M,ze-1,-ze)}let Y=M-1,ie=1,ke=0;for(this[b+Y]=y&255;--Y>=0&&(ie*=256);)y<0&&ke===0&&this[b+Y+1]!==0&&(ke=1),this[b+Y]=(y/ie>>0)-ke&255;return b+M},c.prototype.writeInt8=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,1,127,-128),y<0&&(y=255+y+1),this[b]=y&255,b+1},c.prototype.writeInt16LE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,2,32767,-32768),this[b]=y&255,this[b+1]=y>>>8,b+2},c.prototype.writeInt16BE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,2,32767,-32768),this[b]=y>>>8,this[b+1]=y&255,b+2},c.prototype.writeInt32LE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,4,2147483647,-2147483648),this[b]=y&255,this[b+1]=y>>>8,this[b+2]=y>>>16,this[b+3]=y>>>24,b+4},c.prototype.writeInt32BE=function(y,b,M){return y=+y,b=b>>>0,M||X(this,y,b,4,2147483647,-2147483648),y<0&&(y=4294967295+y+1),this[b]=y>>>24,this[b+1]=y>>>16,this[b+2]=y>>>8,this[b+3]=y&255,b+4},c.prototype.writeBigInt64LE=Oe(function(y,b=0){return H(this,y,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=Oe(function(y,b=0){return G(this,y,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function se(x,y,b,M,V,Y){if(b+M>x.length)throw new RangeError("Index out of range");if(b<0)throw new RangeError("Index out of range")}function ce(x,y,b,M,V){return y=+y,b=b>>>0,V||se(x,y,b,4),n.write(x,y,b,M,23,4),b+4}c.prototype.writeFloatLE=function(y,b,M){return ce(this,y,b,!0,M)},c.prototype.writeFloatBE=function(y,b,M){return ce(this,y,b,!1,M)};function ue(x,y,b,M,V){return y=+y,b=b>>>0,V||se(x,y,b,8),n.write(x,y,b,M,52,8),b+8}c.prototype.writeDoubleLE=function(y,b,M){return ue(this,y,b,!0,M)},c.prototype.writeDoubleBE=function(y,b,M){return ue(this,y,b,!1,M)},c.prototype.copy=function(y,b,M,V){if(!c.isBuffer(y))throw new TypeError("argument should be a Buffer");if(M||(M=0),!V&&V!==0&&(V=this.length),b>=y.length&&(b=y.length),b||(b=0),V>0&&V<M&&(V=M),V===M||y.length===0||this.length===0)return 0;if(b<0)throw new RangeError("targetStart out of bounds");if(M<0||M>=this.length)throw new RangeError("Index out of range");if(V<0)throw new RangeError("sourceEnd out of bounds");V>this.length&&(V=this.length),y.length-b<V-M&&(V=y.length-b+M);const Y=V-M;return this===y&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(b,M,V):Uint8Array.prototype.set.call(y,this.subarray(M,V),b),Y},c.prototype.fill=function(y,b,M,V){if(typeof y=="string"){if(typeof b=="string"?(V=b,b=0,M=this.length):typeof M=="string"&&(V=M,M=this.length),V!==void 0&&typeof V!="string")throw new TypeError("encoding must be a string");if(typeof V=="string"&&!c.isEncoding(V))throw new TypeError("Unknown encoding: "+V);if(y.length===1){const ie=y.charCodeAt(0);(V==="utf8"&&ie<128||V==="latin1")&&(y=ie)}}else typeof y=="number"?y=y&255:typeof y=="boolean"&&(y=Number(y));if(b<0||this.length<b||this.length<M)throw new RangeError("Out of range index");if(M<=b)return this;b=b>>>0,M=M===void 0?this.length:M>>>0,y||(y=0);let Y;if(typeof y=="number")for(Y=b;Y<M;++Y)this[Y]=y;else{const ie=c.isBuffer(y)?y:c.from(y,V),ke=ie.length;if(ke===0)throw new TypeError('The value "'+y+'" is invalid for argument "value"');for(Y=0;Y<M-b;++Y)this[Y+b]=ie[Y%ke]}return this};const J={};function ne(x,y,b){J[x]=class extends b{constructor(){super(),Object.defineProperty(this,"message",{value:y.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${x}]`,this.stack,delete this.name}get code(){return x}set code(V){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:V,writable:!0})}toString(){return`${this.name} [${x}]: ${this.message}`}}}ne("ERR_BUFFER_OUT_OF_BOUNDS",function(x){return x?`${x} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ne("ERR_INVALID_ARG_TYPE",function(x,y){return`The "${x}" argument must be of type number. Received type ${typeof y}`},TypeError),ne("ERR_OUT_OF_RANGE",function(x,y,b){let M=`The value of "${x}" is out of range.`,V=b;return Number.isInteger(b)&&Math.abs(b)>2**32?V=de(String(b)):typeof b=="bigint"&&(V=String(b),(b>BigInt(2)**BigInt(32)||b<-(BigInt(2)**BigInt(32)))&&(V=de(V)),V+="n"),M+=` It must be ${y}. Received ${V}`,M},RangeError);function de(x){let y="",b=x.length;const M=x[0]==="-"?1:0;for(;b>=M+4;b-=3)y=`_${x.slice(b-3,b)}${y}`;return`${x.slice(0,b)}${y}`}function we(x,y,b){U(y,"offset"),(x[y]===void 0||x[y+b]===void 0)&&z(y,x.length-(b+1))}function be(x,y,b,M,V,Y){if(x>b||x<y){const ie=typeof y=="bigint"?"n":"";let ke;throw y===0||y===BigInt(0)?ke=`>= 0${ie} and < 2${ie} ** ${(Y+1)*8}${ie}`:ke=`>= -(2${ie} ** ${(Y+1)*8-1}${ie}) and < 2 ** ${(Y+1)*8-1}${ie}`,new J.ERR_OUT_OF_RANGE("value",ke,x)}we(M,V,Y)}function U(x,y){if(typeof x!="number")throw new J.ERR_INVALID_ARG_TYPE(y,"number",x)}function z(x,y,b){throw Math.floor(x)!==x?(U(x,b),new J.ERR_OUT_OF_RANGE("offset","an integer",x)):y<0?new J.ERR_BUFFER_OUT_OF_BOUNDS:new J.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${y}`,x)}const ee=/[^+/0-9A-Za-z-_]/g;function le(x){if(x=x.split("=")[0],x=x.trim().replace(ee,""),x.length<2)return"";for(;x.length%4!==0;)x=x+"=";return x}function he(x,y){y=y||1/0;let b;const M=x.length;let V=null;const Y=[];for(let ie=0;ie<M;++ie){if(b=x.charCodeAt(ie),b>55295&&b<57344){if(!V){if(b>56319){(y-=3)>-1&&Y.push(239,191,189);continue}else if(ie+1===M){(y-=3)>-1&&Y.push(239,191,189);continue}V=b;continue}if(b<56320){(y-=3)>-1&&Y.push(239,191,189),V=b;continue}b=(V-55296<<10|b-56320)+65536}else V&&(y-=3)>-1&&Y.push(239,191,189);if(V=null,b<128){if((y-=1)<0)break;Y.push(b)}else if(b<2048){if((y-=2)<0)break;Y.push(b>>6|192,b&63|128)}else if(b<65536){if((y-=3)<0)break;Y.push(b>>12|224,b>>6&63|128,b&63|128)}else if(b<1114112){if((y-=4)<0)break;Y.push(b>>18|240,b>>12&63|128,b>>6&63|128,b&63|128)}else throw new Error("Invalid code point")}return Y}function fe(x){const y=[];for(let b=0;b<x.length;++b)y.push(x.charCodeAt(b)&255);return y}function j(x,y){let b,M,V;const Y=[];for(let ie=0;ie<x.length&&!((y-=2)<0);++ie)b=x.charCodeAt(ie),M=b>>8,V=b%256,Y.push(V),Y.push(M);return Y}function oe(x){return e.toByteArray(le(x))}function ae(x,y,b,M){let V;for(V=0;V<M&&!(V+b>=y.length||V>=x.length);++V)y[V+b]=x[V];return V}function re(x,y){return x instanceof y||x!=null&&x.constructor!=null&&x.constructor.name!=null&&x.constructor.name===y.name}function Ne(x){return x!==x}const St=(function(){const x="0123456789abcdef",y=new Array(256);for(let b=0;b<16;++b){const M=b*16;for(let V=0;V<16;++V)y[M+V]=x[b]+x[V]}return y})();function Oe(x){return typeof BigInt>"u"?It:x}function It(){throw new Error("BigInt not supported")}})(vh)),vh}var kh,ab;function Ax(){if(ab)return kh;ab=1;let t=null;return kh=function(){return t===null&&(t={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),t},kh}var Xi={},xh={},ub;function Rx(){if(ub)return xh;ub=1;const t=wt(),e=new Set(["buffer","view","utf8"]);class n{constructor(s){if(this.encode=s.encode||this.encode,this.decode=s.decode||this.decode,this.name=s.name||this.name,this.format=s.format||this.format,typeof this.encode!="function")throw new TypeError("The 'encode' property must be a function");if(typeof this.decode!="function")throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),typeof this.name!="string"||this.name==="")throw new TypeError("The 'name' property must be a string");if(typeof this.format!="string"||!e.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");s.createViewTranscoder&&(this.createViewTranscoder=s.createViewTranscoder),s.createBufferTranscoder&&(this.createBufferTranscoder=s.createBufferTranscoder),s.createUTF8Transcoder&&(this.createUTF8Transcoder=s.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new t(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new t(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new t(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}}return xh.Encoding=n,xh}var lb;function Cx(){if(lb)return Xi;lb=1;const{Buffer:t}=Yt()||{},{Encoding:e}=Rx(),n=Ax();class r extends e{constructor(c){super({...c,format:"buffer"})}createViewTranscoder(){return new s({encode:this.encode,decode:c=>this.decode(t.from(c.buffer,c.byteOffset,c.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}}class s extends e{constructor(c){super({...c,format:"view"})}createBufferTranscoder(){return new r({encode:c=>{const a=this.encode(c);return t.from(a.buffer,a.byteOffset,a.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}}class i extends e{constructor(c){super({...c,format:"utf8"})}createBufferTranscoder(){return new r({encode:c=>t.from(this.encode(c),"utf8"),decode:c=>this.decode(c.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:c,textDecoder:a}=n();return new s({encode:u=>c.encode(this.encode(u)),decode:u=>this.decode(a.decode(u)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}}return Xi.BufferFormat=r,Xi.ViewFormat=s,Xi.UTF8Format=i,Xi}var hb;function YK(){if(hb)return ar;hb=1;const{Buffer:t}=Yt()||{Buffer:{isBuffer:()=>!1}},{textEncoder:e,textDecoder:n}=Ax()(),{BufferFormat:r,ViewFormat:s,UTF8Format:i}=Cx(),o=c=>c;return ar.utf8=new i({encode:function(c){return t.isBuffer(c)?c.toString("utf8"):ArrayBuffer.isView(c)?n.decode(c):String(c)},decode:o,name:"utf8",createViewTranscoder(){return new s({encode:function(c){return ArrayBuffer.isView(c)?c:e.encode(c)},decode:function(c){return n.decode(c)},name:`${this.name}+view`})},createBufferTranscoder(){return new r({encode:function(c){return t.isBuffer(c)?c:ArrayBuffer.isView(c)?t.from(c.buffer,c.byteOffset,c.byteLength):t.from(String(c),"utf8")},decode:function(c){return c.toString("utf8")},name:`${this.name}+buffer`})}}),ar.json=new i({encode:JSON.stringify,decode:JSON.parse,name:"json"}),ar.buffer=new r({encode:function(c){return t.isBuffer(c)?c:ArrayBuffer.isView(c)?t.from(c.buffer,c.byteOffset,c.byteLength):t.from(String(c),"utf8")},decode:o,name:"buffer",createViewTranscoder(){return new s({encode:function(c){return ArrayBuffer.isView(c)?c:t.from(String(c),"utf8")},decode:function(c){return t.from(c.buffer,c.byteOffset,c.byteLength)},name:`${this.name}+view`})}}),ar.view=new s({encode:function(c){return ArrayBuffer.isView(c)?c:e.encode(c)},decode:o,name:"view",createBufferTranscoder(){return new r({encode:function(c){return t.isBuffer(c)?c:ArrayBuffer.isView(c)?t.from(c.buffer,c.byteOffset,c.byteLength):t.from(String(c),"utf8")},decode:o,name:`${this.name}+buffer`})}}),ar.hex=new r({encode:function(c){return t.isBuffer(c)?c:t.from(String(c),"hex")},decode:function(c){return c.toString("hex")},name:"hex"}),ar.base64=new r({encode:function(c){return t.isBuffer(c)?c:t.from(String(c),"base64")},decode:function(c){return c.toString("base64")},name:"base64"}),ar}var fb;function Ox(){if(fb)return Sh;fb=1;const t=wt(),e=YK(),{Encoding:n}=Rx(),{BufferFormat:r,ViewFormat:s,UTF8Format:i}=Cx(),o=Symbol("formats"),c=Symbol("encodings"),a=new Set(["buffer","view","utf8"]);class u{constructor(g){if(Array.isArray(g)){if(!g.every(m=>a.has(m)))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}else throw new TypeError("The first argument 'formats' must be an array");this[c]=new Map,this[o]=new Set(g);for(const m in e)try{this.encoding(m)}catch(_){if(_.code!=="LEVEL_ENCODING_NOT_SUPPORTED")throw _}}encodings(){return Array.from(new Set(this[c].values()))}encoding(g){let m=this[c].get(g);if(m===void 0){if(typeof g=="string"&&g!==""){if(m=f[g],!m)throw new t(`Encoding '${g}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if(typeof g!="object"||g===null)throw new TypeError("First argument 'encoding' must be a string or object");m=h(g)}const{name:_,format:v}=m;if(!this[o].has(v))if(this[o].has("view"))m=m.createViewTranscoder();else if(this[o].has("buffer"))m=m.createBufferTranscoder();else if(this[o].has("utf8"))m=m.createUTF8Transcoder();else throw new t(`Encoding '${_}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});for(const k of[g,_,m.name,m.commonName])this[c].set(k,m)}return m}}Sh.Transcoder=u;function h(w){if(w instanceof n)return w;const g="type"in w&&typeof w.type=="string"?w.type:void 0,m=w.name||g||`anonymous-${p++}`;switch(l(w)){case"view":return new s({...w,name:m});case"utf8":return new i({...w,name:m});case"buffer":return new r({...w,name:m});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}function l(w){return"format"in w&&w.format!==void 0?w.format:"buffer"in w&&typeof w.buffer=="boolean"?w.buffer?"buffer":"utf8":"code"in w&&Number.isInteger(w.code)?"view":"buffer"}const d={binary:e.buffer,"utf-8":e.utf8},f={...e,...d};let p=0;return Sh}var Jc={exports:{}},db;function Ui(){if(db)return Jc.exports;db=1;var t=typeof Reflect=="object"?Reflect:null,e=t&&typeof t.apply=="function"?t.apply:function(I,A,L){return Function.prototype.apply.call(I,A,L)},n;t&&typeof t.ownKeys=="function"?n=t.ownKeys:Object.getOwnPropertySymbols?n=function(I){return Object.getOwnPropertyNames(I).concat(Object.getOwnPropertySymbols(I))}:n=function(I){return Object.getOwnPropertyNames(I)};function r(k){console&&console.warn&&console.warn(k)}var s=Number.isNaN||function(I){return I!==I};function i(){i.init.call(this)}Jc.exports=i,Jc.exports.once=m,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function c(k){if(typeof k!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof k)}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(k){if(typeof k!="number"||k<0||s(k))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+k+".");o=k}}),i.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(I){if(typeof I!="number"||I<0||s(I))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+I+".");return this._maxListeners=I,this};function a(k){return k._maxListeners===void 0?i.defaultMaxListeners:k._maxListeners}i.prototype.getMaxListeners=function(){return a(this)},i.prototype.emit=function(I){for(var A=[],L=1;L<arguments.length;L++)A.push(arguments[L]);var D=I==="error",K=this._events;if(K!==void 0)D=D&&K.error===void 0;else if(!D)return!1;if(D){var O;if(A.length>0&&(O=A[0]),O instanceof Error)throw O;var N=new Error("Unhandled error."+(O?" ("+O.message+")":""));throw N.context=O,N}var W=K[I];if(W===void 0)return!1;if(typeof W=="function")e(W,this,A);else for(var q=W.length,te=p(W,q),L=0;L<q;++L)e(te[L],this,A);return!0};function u(k,I,A,L){var D,K,O;if(c(A),K=k._events,K===void 0?(K=k._events=Object.create(null),k._eventsCount=0):(K.newListener!==void 0&&(k.emit("newListener",I,A.listener?A.listener:A),K=k._events),O=K[I]),O===void 0)O=K[I]=A,++k._eventsCount;else if(typeof O=="function"?O=K[I]=L?[A,O]:[O,A]:L?O.unshift(A):O.push(A),D=a(k),D>0&&O.length>D&&!O.warned){O.warned=!0;var N=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(I)+" listeners added. Use emitter.setMaxListeners() to increase limit");N.name="MaxListenersExceededWarning",N.emitter=k,N.type=I,N.count=O.length,r(N)}return k}i.prototype.addListener=function(I,A){return u(this,I,A,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(I,A){return u(this,I,A,!0)};function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(k,I,A){var L={fired:!1,wrapFn:void 0,target:k,type:I,listener:A},D=h.bind(L);return D.listener=A,L.wrapFn=D,D}i.prototype.once=function(I,A){return c(A),this.on(I,l(this,I,A)),this},i.prototype.prependOnceListener=function(I,A){return c(A),this.prependListener(I,l(this,I,A)),this},i.prototype.removeListener=function(I,A){var L,D,K,O,N;if(c(A),D=this._events,D===void 0)return this;if(L=D[I],L===void 0)return this;if(L===A||L.listener===A)--this._eventsCount===0?this._events=Object.create(null):(delete D[I],D.removeListener&&this.emit("removeListener",I,L.listener||A));else if(typeof L!="function"){for(K=-1,O=L.length-1;O>=0;O--)if(L[O]===A||L[O].listener===A){N=L[O].listener,K=O;break}if(K<0)return this;K===0?L.shift():w(L,K),L.length===1&&(D[I]=L[0]),D.removeListener!==void 0&&this.emit("removeListener",I,N||A)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(I){var A,L,D;if(L=this._events,L===void 0)return this;if(L.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):L[I]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete L[I]),this;if(arguments.length===0){var K=Object.keys(L),O;for(D=0;D<K.length;++D)O=K[D],O!=="removeListener"&&this.removeAllListeners(O);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(A=L[I],typeof A=="function")this.removeListener(I,A);else if(A!==void 0)for(D=A.length-1;D>=0;D--)this.removeListener(I,A[D]);return this};function d(k,I,A){var L=k._events;if(L===void 0)return[];var D=L[I];return D===void 0?[]:typeof D=="function"?A?[D.listener||D]:[D]:A?g(D):p(D,D.length)}i.prototype.listeners=function(I){return d(this,I,!0)},i.prototype.rawListeners=function(I){return d(this,I,!1)},i.listenerCount=function(k,I){return typeof k.listenerCount=="function"?k.listenerCount(I):f.call(k,I)},i.prototype.listenerCount=f;function f(k){var I=this._events;if(I!==void 0){var A=I[k];if(typeof A=="function")return 1;if(A!==void 0)return A.length}return 0}i.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function p(k,I){for(var A=new Array(I),L=0;L<I;++L)A[L]=k[L];return A}function w(k,I){for(;I+1<k.length;I++)k[I]=k[I+1];k.pop()}function g(k){for(var I=new Array(k.length),A=0;A<I.length;++A)I[A]=k[A].listener||k[A];return I}function m(k,I){return new Promise(function(A,L){function D(O){k.removeListener(I,K),L(O)}function K(){typeof k.removeListener=="function"&&k.removeListener("error",D),A([].slice.call(arguments))}v(k,I,K,{once:!0}),I!=="error"&&_(k,D,{once:!0})})}function _(k,I,A){typeof k.on=="function"&&v(k,"error",I,A)}function v(k,I,A,L){if(typeof k.on=="function")L.once?k.once(I,A):k.on(I,A);else if(typeof k.addEventListener=="function")k.addEventListener(I,function D(K){L.once&&k.removeEventListener(I,D),A(K)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof k)}return Jc.exports}var Ih,pb;function ny(){if(pb)return Ih;pb=1;const t=Symbol("kErrors");Ih=function(u){if(u=u.filter(s),u.length!==0)return u.length===1?u[0]:new e(u)};class e extends Error{constructor(h){const l=new Set(h.map(i).filter(Boolean)),d=Array.from(l).join("; ");super(d),n(this,"name","CombinedError"),n(this,t,h),r(this,"stack",()=>h.map(o).join(`

`)),r(this,"transient",()=>h.length>0&&h.every(c)),r(this,"expected",()=>h.length>0&&h.every(a))}[Symbol.iterator](){return this[t][Symbol.iterator]()}}function n(u,h,l){Object.defineProperty(u,h,{value:l})}function r(u,h,l){Object.defineProperty(u,h,{get:l})}function s(u){return u!=null}function i(u){return u.message}function o(u){return u.stack}function c(u){return u.transient===!0}function a(u){return u.expected===!0}return Ih}var Zi={},Tr={},gb;function ms(){if(gb)return Tr;gb=1;const t=wt(),e=new Set;return Tr.getOptions=function(n,r){return typeof n=="object"&&n!==null?n:r!==void 0?r:{}},Tr.emptyOptions=Object.freeze({}),Tr.noop=function(){},Tr.resolvedPromise=Promise.resolve(),Tr.deprecate=function(n){if(!e.has(n)){e.add(n);const r=globalThis.console;typeof r<"u"&&typeof r.warn=="function"&&r.warn(new t(n,{code:"LEVEL_LEGACY"}))}},Tr}var Th={},yb;function Mx(){if(yb)return Th;yb=1;const t=wt();class e extends t{constructor(r){super("Operation has been aborted",{code:"LEVEL_ABORTED",cause:r})}get name(){return"AbortError"}}return Th.AbortError=e,Th}var mb;function Vr(){if(mb)return Zi;mb=1;const t=wt(),e=ny(),{getOptions:n,emptyOptions:r,noop:s}=ms(),{AbortError:i}=Mx(),o=Symbol("decodeOne"),c=Symbol("decodeMany"),a=Symbol("keyEncoding"),u=Symbol("valueEncoding");class h{#e=!1;#t=null;#n=null;#r=0;#c;#s;#o;#i;constructor(g,m){if(typeof g!="object"||g===null){const _=g===null?"null":typeof g;throw new TypeError(`The first argument must be an abstract-level database, received ${_}`)}if(typeof m!="object"||m===null)throw new TypeError("The second argument must be an options object");this[a]=m[a],this[u]=m[u],this.#s=Number.isInteger(m.limit)&&m.limit>=0?m.limit:1/0,this.#c=m.signal!=null?m.signal:null,this.#i=m.snapshot!=null?m.snapshot:null,this.#o=!1,this.db=g,this.db.attachResource(this)}get count(){return this.#r}get limit(){return this.#s}async next(){this.#u();try{if(this.#o||this.#r>=this.#s){this.#o=!0;return}let g=await this._next();if(g===void 0){this.#o=!0;return}try{g=this[o](g)}catch(m){throw new p(m)}return this.#r++,g}finally{this.#a()}}async _next(){}async nextv(g,m){if(!Number.isInteger(g))throw new TypeError("The first argument 'size' must be an integer");m=n(m,r),g<1&&(g=1),this.#s<1/0&&(g=Math.min(g,this.#s-this.#r)),this.#u();try{if(this.#o||g<=0)return this.#o=!0,[];const _=await this._nextv(g,m);if(_.length===0)return this.#o=!0,_;try{this[c](_)}catch(v){throw new p(v)}return this.#r+=_.length,_}finally{this.#a()}}async _nextv(g,m){const _=[];for(;_.length<g;){const v=await this._next(m);if(v!==void 0)_.push(v);else{this.#o=!0;break}}return _}async all(g){g=n(g,r),this.#u();try{if(this.#o||this.#r>=this.#s)return[];const m=await this._all(g);try{this[c](m)}catch(_){throw new p(_)}return this.#r+=m.length,m}catch(m){this.#a(),await this.#f(m)}finally{this.#o=!0,this.#e&&(this.#a(),await this.close())}}async _all(g){let m=this.#r;const _=[];for(;;){const v=this.#s<1/0?Math.min(1e3,this.#s-m):1e3;if(v<=0)return _;const k=await this._nextv(v,g);if(k.length===0)return _;_.push.apply(_,k),m+=k.length}}seek(g,m){if(m=n(m,r),this.#n===null){if(this.#e)throw new t("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const _=this.db.keyEncoding(m.keyEncoding||this[a]),v=_.format;m.keyEncoding!==v&&(m={...m,keyEncoding:v});const k=this.db.prefixKey(_.encode(g),v,!1);this._seek(k,m),this.#o=!1}}}_seek(g,m){throw new t("Iterator does not implement seek()",{code:"LEVEL_NOT_SUPPORTED"})}async close(){return this.#n!==null?this.#n.catch(s):(this.#n=new Promise((g,m)=>{this.#t=()=>{this.#t=null,this.#h().then(g,m)}}),this.#e||this.#t(),this.#n)}async _close(){}async*[Symbol.asyncIterator](){try{let g;for(;(g=await this.next())!==void 0;)yield g}catch(g){await this.#f(g)}finally{await this.close()}}#u(){if(this.#n!==null)throw new t("Iterator is not open: cannot read after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"});if(this.#e)throw new t("Iterator is busy: cannot read until previous read has completed",{code:"LEVEL_ITERATOR_BUSY"});if(this.#c?.aborted)throw new i;this.#i?.ref(),this.#e=!0}#a(){this.#e=!1,this.#t?.(),this.#i?.unref()}async#h(){await this._close(),this.db.detachResource(this)}async#f(g){try{await this.close()}catch(m){throw e([g,m])}throw g}}typeof Symbol.asyncDispose=="symbol"&&(h.prototype[Symbol.asyncDispose]=async function(){return this.close()});class l extends h{#e;#t;constructor(g,m){super(g,m),this.#e=m.keys!==!1,this.#t=m.values!==!1}[o](g){const m=g[0],_=g[1];return m!==void 0&&(g[0]=this.#e?this[a].decode(m):void 0),_!==void 0&&(g[1]=this.#t?this[u].decode(_):void 0),g}[c](g){const m=this[a],_=this[u];for(const v of g){const k=v[0],I=v[1];k!==void 0&&(v[0]=this.#e?m.decode(k):void 0),I!==void 0&&(v[1]=this.#t?_.decode(I):void 0)}}}class d extends h{[o](g){return this[a].decode(g)}[c](g){const m=this[a];for(let _=0;_<g.length;_++){const v=g[_];v!==void 0&&(g[_]=m.decode(v))}}}class f extends h{[o](g){return this[u].decode(g)}[c](g){const m=this[u];for(let _=0;_<g.length;_++){const v=g[_];v!==void 0&&(g[_]=m.decode(v))}}}class p extends t{constructor(g){super("Iterator could not decode data",{code:"LEVEL_DECODE_ERROR",cause:g})}}return l.keyEncoding=a,l.valueEncoding=u,Zi.AbstractIterator=l,Zi.AbstractKeyIterator=d,Zi.AbstractValueIterator=f,Zi}var Yc={},wb;function XK(){if(wb)return Yc;wb=1;const{AbstractKeyIterator:t,AbstractValueIterator:e}=Vr(),n=Symbol("iterator"),r=Symbol("handleOne"),s=Symbol("handleMany");class i extends t{constructor(a,u){super(a,u),this[n]=a.iterator({...u,keys:!0,values:!1})}[r](a){return a[0]}[s](a){for(let u=0;u<a.length;u++)a[u]=a[u][0]}}class o extends e{constructor(a,u){super(a,u),this[n]=a.iterator({...u,keys:!1,values:!0})}[r](a){return a[1]}[s](a){for(let u=0;u<a.length;u++)a[u]=a[u][1]}}for(const c of[i,o])c.prototype._next=async function(){const a=await this[n].next();return a===void 0?a:this[r](a)},c.prototype._nextv=async function(a,u){const h=await this[n].nextv(a,u);return this[s](h),h},c.prototype._all=async function(a){const u=await this[n].all(a);return this[s](u),u},c.prototype._seek=function(a,u){this[n].seek(a,u)},c.prototype._close=async function(){return this[n].close()};return Yc.DefaultKeyIterator=i,Yc.DefaultValueIterator=o,Yc}var eo={},bb;function ZK(){if(bb)return eo;bb=1;const{AbstractIterator:t,AbstractKeyIterator:e,AbstractValueIterator:n}=Vr(),r=wt(),s=Symbol("nut"),i=Symbol("undefer"),o=Symbol("factory"),c=Symbol("signalOptions");class a extends t{constructor(d,f){super(d,f),this[s]=null,this[o]=()=>d.iterator(f),this[c]={signal:f.signal},this.db.defer(()=>this[i](),this[c])}}class u extends e{constructor(d,f){super(d,f),this[s]=null,this[o]=()=>d.keys(f),this[c]={signal:f.signal},this.db.defer(()=>this[i](),this[c])}}class h extends n{constructor(d,f){super(d,f),this[s]=null,this[o]=()=>d.values(f),this[c]={signal:f.signal},this.db.defer(()=>this[i](),this[c])}}for(const l of[a,u,h])l.prototype[i]=function(){this.db.status==="open"&&(this[s]=this[o]())},l.prototype._next=async function(){if(this[s]!==null)return this[s].next();if(this.db.status==="opening")return this.db.deferAsync(()=>this._next(),this[c]);throw new r("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})},l.prototype._nextv=async function(d,f){if(this[s]!==null)return this[s].nextv(d,f);if(this.db.status==="opening")return this.db.deferAsync(()=>this._nextv(d,f),this[c]);throw new r("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})},l.prototype._all=async function(d){if(this[s]!==null)return this[s].all();if(this.db.status==="opening")return this.db.deferAsync(()=>this._all(d),this[c]);throw new r("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})},l.prototype._seek=function(d,f){this[s]!==null?this[s]._seek(d,f):this.db.status==="opening"&&this.db.defer(()=>this._seek(d,f),this[c])},l.prototype._close=async function(){if(this[s]!==null)return this[s].close();if(this.db.status==="opening")return this.db.deferAsync(()=>this._close())};return eo.DeferredIterator=a,eo.DeferredKeyIterator=u,eo.DeferredValueIterator=h,eo}var Ah={},Rh={},Xc={},_b;function ry(){return _b||(_b=1,Xc.prefixDescendantKey=function(t,e,n,r){for(;n!==null&&n!==r;)t=n.prefixKey(t,e,!0),n=n.parent;return t},Xc.isDescendant=function(t,e){for(;;){if(t.parent==null)return!1;if(t.parent===e)return!0;t=t.parent}}),Xc}var Ch={},Sb;function Lx(){if(Sb)return Ch;Sb=1;const{prefixDescendantKey:t,isDescendant:e}=ry();class n{#e;#t;#n;constructor(s,i,o){this.#e=s,this.#t=i,this.#n=o}add(s){const i=s.type==="put",o=s.sublevel!=null,c=o?s.sublevel:this.#e;if(c._assertValidKey(s.key),s.keyEncoding=c.keyEncoding(s.keyEncoding),i)c._assertValidValue(s.value),s.valueEncoding=c.valueEncoding(s.valueEncoding);else if(s.type!=="del")throw new TypeError("A batch operation must have a type property that is 'put' or 'del'");const a=s.keyEncoding,u=a.encode(s.key),h=a.format,l=o&&!e(s.sublevel,this.#e)&&s.sublevel!==this.#e,d=o&&!l?t(u,h,c,this.#e):u;o&&!l&&(s.sublevel=null);let f=null;if(this.#n!==null&&!l&&(f={...s},f.encodedKey=d,o&&(f.key=d,f.keyEncoding=this.#e.keyEncoding(h)),this.#n.push(f)),s.key=l?d:this.#e.prefixKey(d,h,!0),s.keyEncoding=h,i){const p=s.valueEncoding,w=p.encode(s.value),g=p.format;s.value=w,s.valueEncoding=g,f!==null&&(f.encodedValue=w,o&&(f.value=w,f.valueEncoding=this.#e.valueEncoding(g)))}return this.#t.push(s),this}}return Ch.PrewriteBatch=n,Ch}var Eb;function Dx(){if(Eb)return Rh;Eb=1;const t=ny(),e=wt(),{getOptions:n,emptyOptions:r,noop:s}=ms(),{prefixDescendantKey:i,isDescendant:o}=ry(),{PrewriteBatch:c}=Lx(),a=Symbol("publicOperations"),u=Symbol("privateOperations");class h{#e="open";#t=0;#n=null;#r;#c;#s;#o;#i;constructor(f,p){if(typeof f!="object"||f===null){const m=f===null?"null":typeof f;throw new TypeError(`The first argument must be an abstract-level database, received ${m}`)}const w=f.listenerCount("write")>0,g=!f.hooks.prewrite.noop;if(this.#r=w?[]:null,this.#i=n(p,r).add===!0,g){const m=new l([],w?[]:null);this.#o=m,this.#s=new c(f,m[u],m[a]),this.#c=f.hooks.prewrite.run}else this.#o=null,this.#s=null,this.#c=null;this.db=f,this.db.attachResource(this)}get length(){return this.#o!==null?this.#t+this.#o.length:this.#t}put(f,p,w){this.#u(),w=n(w,r);const g=w.sublevel!=null,m=g?w.sublevel:this.db;m._assertValidKey(f),m._assertValidValue(p);const _={...w,type:"put",key:f,value:p,keyEncoding:m.keyEncoding(w.keyEncoding),valueEncoding:m.valueEncoding(w.valueEncoding)};if(this.#c!==null)try{this.#c(_,this.#s),_.keyEncoding=m.keyEncoding(_.keyEncoding),_.valueEncoding=m.valueEncoding(_.valueEncoding)}catch(N){throw new e("The prewrite hook failed on batch.put()",{code:"LEVEL_HOOK_ERROR",cause:N})}const v=_.keyEncoding,k=v.encode(_.key),I=v.format,A=g&&!o(_.sublevel,this.db)&&_.sublevel!==this.db,L=g&&!A?i(k,I,m,this.db):k,D=_.valueEncoding,K=D.encode(_.value),O=D.format;if(g&&!A&&(_.sublevel=null),this.#r!==null&&!A){const N={..._};N.encodedKey=L,N.encodedValue=K,g&&(N.key=L,N.value=K,N.keyEncoding=this.db.keyEncoding(I),N.valueEncoding=this.db.valueEncoding(O)),this.#r.push(N)}return _.key=A?L:this.db.prefixKey(L,I,!0),_.value=K,_.keyEncoding=I,_.valueEncoding=O,this.#i?this._add(_):this._put(_.key,K,_),this.#t++,this}_put(f,p,w){}del(f,p){this.#u(),p=n(p,r);const w=p.sublevel!=null,g=w?p.sublevel:this.db;g._assertValidKey(f);const m={...p,type:"del",key:f,keyEncoding:g.keyEncoding(p.keyEncoding)};if(this.#c!==null)try{this.#c(m,this.#s),m.keyEncoding=g.keyEncoding(m.keyEncoding)}catch(A){throw new e("The prewrite hook failed on batch.del()",{code:"LEVEL_HOOK_ERROR",cause:A})}const _=m.keyEncoding,v=_.encode(m.key),k=_.format,I=w?i(v,k,g,this.db):v;if(w&&(m.sublevel=null),this.#r!==null){const A={...m};A.encodedKey=I,w&&(A.key=I,A.keyEncoding=this.db.keyEncoding(k)),this.#r.push(A)}return m.key=this.db.prefixKey(I,k,!0),m.keyEncoding=k,this.#i?this._add(m):this._del(m.key,m),this.#t++,this}_del(f,p){}_add(f){}clear(){return this.#u(),this._clear(),this.#r!==null&&(this.#r=[]),this.#o!==null&&this.#o.clear(),this.#t=0,this}_clear(){}async write(f){if(this.#u(),f=n(f),this.#t===0)return this.close();{this.#e="writing";const p=this.#a();try{if(this.#o!==null){const w=this.#o[a],g=this.#o[u],m=this.#o.length;for(let _=0;_<m;_++){const v=g[_];this.#i?this._add(v):v.type==="put"?this._put(v.key,v.value,v):this._del(v.key,v)}w!==null&&m!==0&&(this.#r=this.#r.concat(w))}await this._write(f)}catch(w){p();try{await this.#n}catch(g){w=t([w,g])}throw w}return p(),this.#r!==null&&this.db.emit("write",this.#r),this.#n}}async _write(f){}async close(){return this.#n!==null?this.#n.catch(s):(this.#a()(),this.#n)}async _close(){}#u(){if(this.#e!=="open")throw new e("Batch is not open: cannot change operations after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});if(this.db.status!=="open")throw new e("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})}#a(){let f;return this.#n=new Promise((p,w)=>{f=()=>{this.#h().then(p,w)}}),f}async#h(){this.#e="closing",await this._close(),this.db.detachResource(this)}}typeof Symbol.asyncDispose=="symbol"&&(h.prototype[Symbol.asyncDispose]=async function(){return this.close()});class l{constructor(f,p){this[u]=f,this[a]=p}get length(){return this[u].length}clear(){for(const f of[a,u]){const p=this[f];p!==null&&p.splice(0,p.length)}}}return Rh.AbstractChainedBatch=h,Rh}var vb;function e8(){if(vb)return Ah;vb=1;const{AbstractChainedBatch:t}=Dx();class e extends t{#e=[];constructor(r){super(r,{add:!0})}_add(r){this.#e.push(r)}_clear(){this.#e=[]}async _write(r){return this.db._batch(this.#e,r)}}return Ah.DefaultChainedBatch=e,Ah}var Oh={},kb;function t8(){if(kb)return Oh;kb=1;const{noop:t}=ms();class e{constructor(){this.postopen=new n({async:!0}),this.prewrite=new n({async:!1}),this.newsub=new n({async:!1})}}class n{#e=new Set;#t;constructor(i){this.#t=i.async,this.noop=!0,this.run=this.#n()}add(i){r(i),this.#e.add(i),this.noop=!1,this.run=this.#n()}delete(i){r(i),this.#e.delete(i),this.noop=this.#e.size===0,this.run=this.#n()}#n(){if(this.noop)return t;if(this.#e.size===1){const[i]=this.#e;return i}else return this.#t?(async function(o,...c){for(const a of o)await a(...c)}).bind(null,Array.from(this.#e)):(function(o,...c){for(const a of o)a(...c)}).bind(null,Array.from(this.#e))}}const r=function(s){if(typeof s!="function"){const i=s===null?"null":typeof s;throw new TypeError(`The first argument must be a function, received ${i}`)}};return Oh.DatabaseHooks=e,Oh}var Mh={},xb;function n8(){if(xb)return Mh;xb=1;const{deprecate:t}=ms();return Mh.EventMonitor=class{constructor(n){this.write=!1;const r=i=>{i==="write"&&(this.write=!0),(i==="put"||i==="del"||i==="batch")&&t(`The '${i}' event has been removed in favor of 'write'`)},s=i=>{i==="write"&&(this.write=n.listenerCount("write")>0)};n.on("newListener",r),n.on("removeListener",s)}},Mh}var Lh={},Ib;function r8(){if(Ib)return Lh;Ib=1;const{getOptions:t,emptyOptions:e}=ms(),{AbortError:n}=Mx();class r{constructor(o,c){this.fn=o,this.signal=c}}class s{#e;#t;constructor(){this.#e=[],this.#t=new Set}add(o,c){c=t(c,e);const a=c.signal;if(a==null){this.#e.push(new r(o,null));return}if(a.aborted){o(new n);return}this.#t.has(a)||(this.#t.add(a),a.addEventListener("abort",this.#n,{once:!0})),this.#e.push(new r(o,a))}drain(){const o=this.#e,c=this.#t;this.#e=[],this.#t=new Set;for(const a of c)a.removeEventListener("abort",this.#n);for(const a of o)a.fn.call(null)}#n=o=>{const c=o.target,a=new n,u=[];this.#e=this.#e.filter(function(h){return h.signal!==null&&h.signal===c?(u.push(h),!1):!0}),this.#t.delete(c);for(const h of u)h.fn.call(null,a)}}return Lh.DeferredQueue=s,Lh}var Dh,Tb;function s8(){if(Tb)return Dh;Tb=1;const t=Object.prototype.hasOwnProperty,e=new Set(["lt","lte","gt","gte"]);return Dh=function(n,r){const s={};for(const i in n)t.call(n,i)&&(i==="keyEncoding"||i==="valueEncoding"||(e.has(i)?s[i]=r.encode(n[i]):s[i]=n[i]));return s.reverse=!!s.reverse,s.limit=Number.isInteger(s.limit)&&s.limit>=0?s.limit:-1,s},Dh}var to={},Ab;function i8(){if(Ab)return to;Ab=1;const{AbstractIterator:t,AbstractKeyIterator:e,AbstractValueIterator:n}=Vr();class r extends t{#e;#t;constructor(c,a,u,h){super(c,a),this.#e=u,this.#t=h}async _next(){const c=await this.#e.next();if(c!==void 0){const a=c[0];a!==void 0&&(c[0]=this.#t(a))}return c}async _nextv(c,a){const u=await this.#e.nextv(c,a),h=this.#t;for(const l of u){const d=l[0];d!==void 0&&(l[0]=h(d))}return u}async _all(c){const a=await this.#e.all(c),u=this.#t;for(const h of a){const l=h[0];l!==void 0&&(h[0]=u(l))}return a}_seek(c,a){this.#e.seek(c,a)}async _close(){return this.#e.close()}}class s extends e{#e;#t;constructor(c,a,u,h){super(c,a),this.#e=u,this.#t=h}async _next(){const c=await this.#e.next();return c===void 0?c:this.#t(c)}async _nextv(c,a){const u=await this.#e.nextv(c,a),h=this.#t;for(let l=0;l<u.length;l++){const d=u[l];d!==void 0&&(u[l]=h(d))}return u}async _all(c){const a=await this.#e.all(c),u=this.#t;for(let h=0;h<a.length;h++){const l=a[h];l!==void 0&&(a[h]=u(l))}return a}_seek(c,a){this.#e.seek(c,a)}async _close(){return this.#e.close()}}class i extends n{#e;constructor(c,a,u){super(c,a),this.#e=u}async _next(){return this.#e.next()}async _nextv(c,a){return this.#e.nextv(c,a)}async _all(c){return this.#e.all(c)}_seek(c,a){this.#e.seek(c,a)}async _close(){return this.#e.close()}}return to.AbstractSublevelIterator=r,to.AbstractSublevelKeyIterator=s,to.AbstractSublevelValueIterator=i,to}var Fh,Rb;function o8(){if(Rb)return Fh;Rb=1;const t=wt(),{Buffer:e}=Yt()||{},{AbstractSublevelIterator:n,AbstractSublevelKeyIterator:r,AbstractSublevelValueIterator:s}=i8(),i=Symbol("root"),o=new TextEncoder,c={separator:"!"};Fh=function({AbstractLevel:f}){class p extends f{#e;#t;#n;#r;#c;#s;#o;static defaults(g){return g==null?c:g.separator?g:{...g,separator:"!"}}constructor(g,m,_){const{separator:v,manifest:k,...I}=p.defaults(_),A=[].concat(m).map(W=>d(W,v)),L=v.charCodeAt(0)+1,D=g[i]||g;if(!A.every(W=>o.encode(W).every(q=>q>L&&q<127)))throw new t(`Sublevel name must use bytes > ${L} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(a(g,k),I);const K=A.map(W=>v+W+v).join(""),O=(g.prefix||"")+K,N=O.slice(0,-1)+String.fromCharCode(L);this[i]=D,this.#s=g,this.#n=A,this.#r=g.prefix?g.path().concat(A):A,this.#e=new h(O),this.#c=new h(N),this.#t=new h(K),this.#o=new l}prefixKey(g,m,_){const v=_?this.#t:this.#e;if(m==="utf8")return v.utf8+g;if(g.byteLength===0)return v[m];if(m==="view"){const k=v.view,I=new Uint8Array(k.byteLength+g.byteLength);return I.set(k,0),I.set(g,k.byteLength),I}else{const k=v.buffer;return e.concat([k,g],k.byteLength+g.byteLength)}}#i(g,m){g.gte!==void 0?g.gte=this.prefixKey(g.gte,m,!1):g.gt!==void 0?g.gt=this.prefixKey(g.gt,m,!1):g.gte=this.#e[m],g.lte!==void 0?g.lte=this.prefixKey(g.lte,m,!1):g.lt!==void 0?g.lt=this.prefixKey(g.lt,m,!1):g.lte=this.#c[m]}get prefix(){return this.#e.utf8}get db(){return this[i]}get parent(){return this.#s}path(g=!1){return g?this.#n:this.#r}async _open(g){await this.#s.open({passive:!0}),this.#s.attachResource(this)}async _close(){this.#s.detachResource(this)}async _put(g,m,_){return this.#s.put(g,m,_)}async _get(g,m){return this.#s.get(g,m)}_getSync(g,m){return this.#s.getSync(g,m)}async _getMany(g,m){return this.#s.getMany(g,m)}async _has(g,m){return this.#s.has(g,m)}async _hasMany(g,m){return this.#s.hasMany(g,m)}async _del(g,m){return this.#s.del(g,m)}async _batch(g,m){return this.#s.batch(g,m)}async _clear(g){return this.#i(g,g.keyEncoding),this[i].clear(g)}_iterator(g){this.#i(g,g.keyEncoding);const m=this[i].iterator(g),_=this.#o.get(this.#e.utf8.length,g.keyEncoding);return new n(this,g,m,_)}_keys(g){this.#i(g,g.keyEncoding);const m=this[i].keys(g),_=this.#o.get(this.#e.utf8.length,g.keyEncoding);return new r(this,g,m,_)}_values(g){this.#i(g,g.keyEncoding);const m=this[i].values(g);return new s(this,g,m)}_snapshot(g){return this[i].snapshot(g)}}return{AbstractSublevel:p}};const a=function(f,p){return{...f.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...p,encodings:{utf8:u(f,"utf8"),buffer:u(f,"buffer"),view:u(f,"view")}}},u=function(f,p){return f.supports.encodings[p]?f.keyEncoding(p).name===p:!1};class h{constructor(p){this.utf8=p,this.view=o.encode(p),this.buffer=e?e.from(this.view.buffer,0,this.view.byteLength):{}}}class l{constructor(){this.cache=new Map}get(p,w){let g=this.cache.get(w);return g===void 0&&(w==="view"?g=(function(m,_){return _.subarray(m)}).bind(null,p):g=(function(m,_){return _.slice(m)}).bind(null,p),this.cache.set(w,g)),g}}const d=function(f,p){let w=0,g=f.length;for(;w<g&&f[w]===p;)w++;for(;g>w&&f[g-1]===p;)g--;return f.slice(w,g)};return Fh}var Cb;function Ob(){if(Cb)return Qc;Cb=1;const{supports:t}=QK(),{Transcoder:e}=Ox(),{EventEmitter:n}=Ui(),r=wt(),s=ny(),{AbstractIterator:i}=Vr(),{DefaultKeyIterator:o,DefaultValueIterator:c}=XK(),{DeferredIterator:a,DeferredKeyIterator:u,DeferredValueIterator:h}=ZK(),{DefaultChainedBatch:l}=e8(),{DatabaseHooks:d}=t8(),{PrewriteBatch:f}=Lx(),{EventMonitor:p}=n8(),{getOptions:w,noop:g,emptyOptions:m,resolvedPromise:_}=ms(),{prefixDescendantKey:v,isDescendant:k}=ry(),{DeferredQueue:I}=r8(),A=s8();class L extends n{#e="opening";#t=!0;#n=null;#r=!1;#c;#s;#o;#i;#u;#a;#h;#f;constructor(T,$){if(super(),typeof T!="object"||T===null)throw new TypeError("The first argument 'manifest' must be an object");$=w($);const{keyEncoding:B,valueEncoding:S,passive:R,...E}=$;this.#c=new Set,this.#s=new I,this.#o=E;const P=T.snapshots!==!1&&T.implicitSnapshots!==!1;this.hooks=new d,this.supports=t(T,{deferredOpen:!0,seek:!0,implicitSnapshots:P,permanence:T.permanence!==!1,encodings:T.encodings||{},events:{...T.events,opening:!0,open:!0,closing:!0,closed:!0,write:!0,clear:!0}}),this.#f=new p(this),this.#u=new e(K(this)),this.#a=this.#u.encoding(B||"utf8"),this.#h=this.#u.encoding(S||"utf8");for(const X of this.#u.encodings())this.supports.encodings[X.commonName]||(this.supports.encodings[X.commonName]=!0);this.#i={empty:m,entry:Object.freeze({keyEncoding:this.#a.commonName,valueEncoding:this.#h.commonName}),entryFormat:Object.freeze({keyEncoding:this.#a.format,valueEncoding:this.#h.format}),key:Object.freeze({keyEncoding:this.#a.commonName}),keyFormat:Object.freeze({keyEncoding:this.#a.format}),owner:Object.freeze({owner:this})},queueMicrotask(()=>{this.#t&&this.open({passive:!1}).catch(g)})}get status(){return this.#e}get parent(){return null}keyEncoding(T){return this.#u.encoding(T??this.#a)}valueEncoding(T){return this.#u.encoding(T??this.#h)}async open(T){T={...this.#o,...w(T)},T.createIfMissing=T.createIfMissing!==!1,T.errorIfExists=!!T.errorIfExists;const $=this.hooks.postopen.noop?null:this.hooks.postopen.run,B=T.passive;for(B&&this.#t&&await void 0,this.#d();this.#n!==null;)await this.#n.catch(g);if(this.#d(),B){if(this.#e!=="open")throw new W}else if(this.#e==="closed"||this.#t){this.#t=!1,this.#n=_,this.#n=(async()=>{this.#e="opening";try{this.emit("opening"),await this._open(T)}catch(S){this.#e="closed",this.#s.drain();try{await this.#p()}catch(R){S=s([S,R])}throw new W(S)}if(this.#e="open",$!==null){let S;try{this.#r=!0,await $(T)}catch(R){S=N(R)}finally{this.#r=!1}if(S){this.#e="closing",this.#s.drain();try{await this.#p(),await this._close()}catch(R){this.#r=!0,S=s([S,R])}throw this.#e="closed",new r("The postopen hook failed on open()",{code:"LEVEL_HOOK_ERROR",cause:S})}}this.#s.drain(),this.emit("open")})();try{await this.#n}finally{this.#n=null}}else if(this.#e!=="open")throw new W}async _open(T){}async close(){for(this.#d();this.#n!==null;)await this.#n.catch(g);if(this.#d(),this.#e==="open"||this.#t){const T=this.#t;this.#t=!1,this.#n=_,this.#n=(async()=>{this.#e="closing",this.#s.drain();try{this.emit("closing"),await this.#p(),T||await this._close()}catch($){throw this.#e="open",this.#s.drain(),new q($)}this.#e="closed",this.#s.drain(),this.emit("closed")})();try{await this.#n}finally{this.#n=null}}else if(this.#e!=="closed")throw new q}async#p(){if(this.#c.size===0)return;const T=Array.from(this.#c),$=T.map(O),B=await Promise.allSettled($),S=[];for(let R=0;R<B.length;R++)B[R].status==="fulfilled"?this.#c.delete(T[R]):S.push(N(B[R].reason));if(S.length>0)throw s(S)}async _close(){}async get(T,$){if($=w($,this.#i.entry),this.#e==="opening")return this.deferAsync(()=>this.get(T,$));this.#l(),this._assertValidKey(T);const B=$.snapshot,S=this.keyEncoding($.keyEncoding),R=this.valueEncoding($.valueEncoding),E=S.format,P=R.format;$===this.#i.entry?$=this.#i.entryFormat:($.keyEncoding!==E||$.valueEncoding!==P)&&($={...$,keyEncoding:E,valueEncoding:P});const X=S.encode(T),H=this.prefixKey(X,E,!0);B?.ref();let G;try{G=await this._get(H,$)}finally{B?.unref()}try{return G===void 0?G:R.decode(G)}catch(se){throw new r("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:se})}}async _get(T,$){}getSync(T,$){if(this.status!=="open")throw new r("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});if(this._assertValidKey(T),$==null){const se=this.#a.encode(T),ce=this.prefixKey(se,this.#a.format,!0),ue=this._getSync(ce,this.#i.entryFormat);try{return ue!==void 0?this.#h.decode(ue):void 0}catch(J){throw new r("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:J})}}const B=$.snapshot,S=this.keyEncoding($.keyEncoding),R=this.valueEncoding($.valueEncoding),E=S.format,P=R.format;($.keyEncoding!==E||$.valueEncoding!==P)&&($={...$,keyEncoding:E,valueEncoding:P});const X=S.encode(T),H=this.prefixKey(X,E,!0);let G;B?.ref();try{G=this._getSync(H,$)}finally{B?.unref()}try{return G!==void 0?R.decode(G):void 0}catch(se){throw new r("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:se})}}_getSync(T,$){throw new r("Database does not support getSync()",{code:"LEVEL_NOT_SUPPORTED"})}async getMany(T,$){if($=w($,this.#i.entry),this.#e==="opening")return this.deferAsync(()=>this.getMany(T,$));if(this.#l(),!Array.isArray(T))throw new TypeError("The first argument 'keys' must be an array");if(T.length===0)return[];const B=$.snapshot,S=this.keyEncoding($.keyEncoding),R=this.valueEncoding($.valueEncoding),E=S.format,P=R.format;$===this.#i.entry?$=this.#i.entryFormat:($.keyEncoding!==E||$.valueEncoding!==P)&&($={...$,keyEncoding:E,valueEncoding:P});const X=new Array(T.length);for(let G=0;G<T.length;G++){const se=T[G];this._assertValidKey(se),X[G]=this.prefixKey(S.encode(se),E,!0)}B?.ref();let H;try{H=await this._getMany(X,$)}finally{B?.unref()}try{for(let G=0;G<H.length;G++)H[G]!==void 0&&(H[G]=R.decode(H[G]))}catch(G){throw new r(`Could not decode one or more of ${H.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:G})}return H}async _getMany(T,$){return new Array(T.length).fill(void 0)}async has(T,$){if($=w($,this.#i.key),this.#e==="opening")return this.deferAsync(()=>this.has(T,$));this.#l(),this._assertValidKey(T);const B=$.snapshot,S=this.keyEncoding($.keyEncoding),R=S.format;$===this.#i.key?$=this.#i.keyFormat:$.keyEncoding!==R&&($={...$,keyEncoding:R});const E=S.encode(T),P=this.prefixKey(E,R,!0);B?.ref();try{return this._has(P,$)}finally{B?.unref()}}async _has(T,$){throw new r("Database does not support has()",{code:"LEVEL_NOT_SUPPORTED"})}async hasMany(T,$){if($=w($,this.#i.key),this.#e==="opening")return this.deferAsync(()=>this.hasMany(T,$));if(this.#l(),!Array.isArray(T))throw new TypeError("The first argument 'keys' must be an array");if(T.length===0)return[];const B=$.snapshot,S=this.keyEncoding($.keyEncoding),R=S.format;$===this.#i.key?$=this.#i.keyFormat:$.keyEncoding!==R&&($={...$,keyEncoding:R});const E=new Array(T.length);for(let P=0;P<T.length;P++){const X=T[P];this._assertValidKey(X),E[P]=this.prefixKey(S.encode(X),R,!0)}B?.ref();try{return this._hasMany(E,$)}finally{B?.unref()}}async _hasMany(T,$){throw new r("Database does not support hasMany()",{code:"LEVEL_NOT_SUPPORTED"})}async put(T,$,B){if(!this.hooks.prewrite.noop)return this.batch([{type:"put",key:T,value:$}],B);if(B=w(B,this.#i.entry),this.#e==="opening")return this.deferAsync(()=>this.put(T,$,B));this.#l(),this._assertValidKey(T),this._assertValidValue($);const S=this.keyEncoding(B.keyEncoding),R=this.valueEncoding(B.valueEncoding),E=S.format,P=R.format,X=this.#f.write,H=B;B===this.#i.entry?B=this.#i.entryFormat:(B.keyEncoding!==E||B.valueEncoding!==P)&&(B={...B,keyEncoding:E,valueEncoding:P});const G=S.encode(T),se=this.prefixKey(G,E,!0),ce=R.encode($);if(await this._put(se,ce,B),X){const ue={...H,type:"put",key:T,value:$,keyEncoding:S,valueEncoding:R,encodedKey:G,encodedValue:ce};this.emit("write",[ue])}}async _put(T,$,B){}async del(T,$){if(!this.hooks.prewrite.noop)return this.batch([{type:"del",key:T}],$);if($=w($,this.#i.key),this.#e==="opening")return this.deferAsync(()=>this.del(T,$));this.#l(),this._assertValidKey(T);const B=this.keyEncoding($.keyEncoding),S=B.format,R=this.#f.write,E=$;$===this.#i.key?$=this.#i.keyFormat:$.keyEncoding!==S&&($={...$,keyEncoding:S});const P=B.encode(T),X=this.prefixKey(P,S,!0);if(await this._del(X,$),R){const H={...E,type:"del",key:T,keyEncoding:B,encodedKey:P};this.emit("write",[H])}}async _del(T,$){}batch(T,$){return arguments.length?($=w($,this.#i.empty),this.#g(T,$)):(this.#l(),this._chainedBatch())}async#g(T,$){if(this.#e==="opening")return this.deferAsync(()=>this.#g(T,$));if(this.#l(),!Array.isArray(T))throw new TypeError("The first argument 'operations' must be an array");if(T.length===0)return;const B=T.length,S=!this.hooks.prewrite.noop,R=this.#f.write,E=R?new Array(B):null,P=new Array(B),X=S?new f(this,P,E):null;for(let H=0;H<B;H++){const G={...$,...T[H]},se=G.type==="put",ce=G.sublevel!=null,ue=ce?G.sublevel:this;if(ue._assertValidKey(G.key),G.keyEncoding=ue.keyEncoding(G.keyEncoding),se)ue._assertValidValue(G.value),G.valueEncoding=ue.valueEncoding(G.valueEncoding);else if(G.type!=="del")throw new TypeError("A batch operation must have a type property that is 'put' or 'del'");if(S)try{this.hooks.prewrite.run(G,X),G.keyEncoding=ue.keyEncoding(G.keyEncoding),se&&(G.valueEncoding=ue.valueEncoding(G.valueEncoding))}catch(z){throw new r("The prewrite hook failed on batch()",{code:"LEVEL_HOOK_ERROR",cause:z})}const J=G.keyEncoding,ne=J.encode(G.key),de=J.format,we=ce&&!k(G.sublevel,this)&&G.sublevel!==this,be=ce&&!we?v(ne,de,ue,this):ne;ce&&!we&&(G.sublevel=null);let U=null;if(R&&!we&&(U={...G},U.encodedKey=be,ce&&(U.key=be,U.keyEncoding=this.keyEncoding(de)),E[H]=U),G.key=we?be:this.prefixKey(be,de,!0),G.keyEncoding=de,se){const z=G.valueEncoding,ee=z.encode(G.value),le=z.format;G.value=ee,G.valueEncoding=le,R&&!we&&(U.encodedValue=ee,ce&&(U.value=ee,U.valueEncoding=this.valueEncoding(le)))}P[H]=G}await this._batch(P,$),R&&this.emit("write",E)}async _batch(T,$){}sublevel(T,$){const B=D.defaults($),S=this._sublevel(T,B);if(!this.hooks.newsub.noop)try{this.hooks.newsub.run(S,B)}catch(R){throw new r("The newsub hook failed on sublevel()",{code:"LEVEL_HOOK_ERROR",cause:R})}return S}_sublevel(T,$){return new D(this,T,$)}prefixKey(T,$,B){return T}async clear(T){if(T=w(T,this.#i.empty),this.#e==="opening")return this.deferAsync(()=>this.clear(T));this.#l();const $=T,B=this.keyEncoding(T.keyEncoding),S=T.snapshot;if(T=A(T,B),T.keyEncoding=B.format,T.limit!==0){S?.ref();try{await this._clear(T)}finally{S?.unref()}this.emit("clear",$)}}async _clear(T){}iterator(T){const $=this.keyEncoding(T?.keyEncoding),B=this.valueEncoding(T?.valueEncoding);return T=A(T,$),T.keys=T.keys!==!1,T.values=T.values!==!1,T[i.keyEncoding]=$,T[i.valueEncoding]=B,T.keyEncoding=$.format,T.valueEncoding=B.format,this.#e==="opening"?new a(this,T):(this.#l(),this._iterator(T))}_iterator(T){return new i(this,T)}keys(T){const $=this.keyEncoding(T?.keyEncoding),B=this.valueEncoding(T?.valueEncoding);return T=A(T,$),T[i.keyEncoding]=$,T[i.valueEncoding]=B,T.keyEncoding=$.format,T.valueEncoding=B.format,this.#e==="opening"?new u(this,T):(this.#l(),this._keys(T))}_keys(T){return new o(this,T)}values(T){const $=this.keyEncoding(T?.keyEncoding),B=this.valueEncoding(T?.valueEncoding);return T=A(T,$),T[i.keyEncoding]=$,T[i.valueEncoding]=B,T.keyEncoding=$.format,T.valueEncoding=B.format,this.#e==="opening"?new h(this,T):(this.#l(),this._values(T))}_values(T){return new c(this,T)}snapshot(T){return this.#l(),typeof T!="object"||T===null?T=this.#i.owner:T.owner==null&&(T={...T,owner:this}),this._snapshot(T)}_snapshot(T){throw new r("Database does not support explicit snapshots",{code:"LEVEL_NOT_SUPPORTED"})}defer(T,$){if(typeof T!="function")throw new TypeError("The first argument must be a function");this.#s.add(function(B){B||T()},$)}deferAsync(T,$){if(typeof T!="function")throw new TypeError("The first argument must be a function");return new Promise((B,S)=>{this.#s.add(function(R){R?S(R):T().then(B,S)},$)})}attachResource(T){if(typeof T!="object"||T===null||typeof T.close!="function")throw new TypeError("The first argument must be a resource object");this.#c.add(T)}detachResource(T){this.#c.delete(T)}_chainedBatch(){return new l(this)}_assertValidKey(T){if(T==null)throw new r("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_assertValidValue(T){if(T==null)throw new r("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}#l(){if(this.#e!=="open")throw new r("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})}#d(){if(this.#r)throw new r("Database status is locked",{code:"LEVEL_STATUS_LOCKED"})}}const{AbstractSublevel:D}=o8()({AbstractLevel:L});Qc.AbstractLevel=L,Qc.AbstractSublevel=D,typeof Symbol.asyncDispose=="symbol"&&(L.prototype[Symbol.asyncDispose]=async function(){return this.close()});const K=function(te){return Object.keys(te.supports.encodings).filter(T=>!!te.supports.encodings[T])},O=function(te){return te.close()},N=function(te){if(te instanceof Error||Object.prototype.toString.call(te)==="[object Error]")return te;const $=`Promise rejection reason must be an Error, received ${te===null?"null":typeof te}`;return new TypeError($)};class W extends r{constructor(T){super("Database failed to open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:T})}}class q extends r{constructor(T){super("Database failed to close",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:T})}}return Qc}var Nh={},Mb;function c8(){if(Mb)return Nh;Mb=1;const t=wt(),{noop:e}=ms();class n{#e=!0;#t=0;#n=null;#r=null;#c;constructor(i){const o=i.owner;if(typeof o!="object"||o===null){const c=o===null?"null":typeof o;throw new TypeError(`Owner must be an abstract-level database, received ${c}`)}this.#c=o,this.#c.attachResource(this)}ref(){if(!this.#e)throw new t("Snapshot is not open: cannot use snapshot after close()",{code:"LEVEL_SNAPSHOT_NOT_OPEN"});this.#t++}unref(){--this.#t===0&&this.#n?.()}async close(){return this.#r!==null?this.#r.catch(e):(this.#e=!1,this.#r=new Promise((i,o)=>{this.#n=()=>{this.#n=null,r(this,this.#c).then(i,o)}}),this.#t===0&&this.#n(),this.#r)}async _close(){}}typeof Symbol.asyncDispose=="symbol"&&(n.prototype[Symbol.asyncDispose]=async function(){return this.close()});const r=async function(s,i){await s._close(),i.detachResource(s)};return Nh.AbstractSnapshot=n,Nh}var Lb;function sy(){return Lb||(Lb=1,Ln.AbstractLevel=Ob().AbstractLevel,Ln.AbstractSublevel=Ob().AbstractSublevel,Ln.AbstractIterator=Vr().AbstractIterator,Ln.AbstractKeyIterator=Vr().AbstractKeyIterator,Ln.AbstractValueIterator=Vr().AbstractValueIterator,Ln.AbstractChainedBatch=Dx().AbstractChainedBatch,Ln.AbstractSnapshot=c8().AbstractSnapshot),Ln}var Ph={},$h,Db;function Fx(){return Db||(Db=1,$h=function(e){const n=e.gte!==void 0?e.gte:e.gt!==void 0?e.gt:void 0,r=e.lte!==void 0?e.lte:e.lt!==void 0?e.lt:void 0,s=e.gte===void 0,i=e.lte===void 0;return n!==void 0&&r!==void 0?IDBKeyRange.bound(n,r,s,i):n!==void 0?IDBKeyRange.lowerBound(n,s):r!==void 0?IDBKeyRange.upperBound(r,i):null}),$h}var Bh,Fb;function Nx(){if(Fb)return Bh;Fb=1;const t=new TextEncoder;return Bh=function(e){return e===void 0||e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):t.encode(e)},Bh}var Nb;function a8(){if(Nb)return Ph;Nb=1;const{AbstractIterator:t}=sy(),e=Fx(),n=Nx(),r=Symbol("cache"),s=Symbol("finished"),i=Symbol("options"),o=Symbol("currentOptions"),c=Symbol("position"),a=Symbol("location"),u=Symbol("first"),h={};class l extends t{constructor(p,w,g){super(p,g),this[r]=[],this[s]=this.limit===0,this[i]=g,this[o]={...g},this[c]=void 0,this[a]=w,this[u]=!0}async _nextv(p,w){if(this[u]=!1,this[s])return[];if(this[r].length>0)return p=Math.min(p,this[r].length),this[r].splice(0,p);this[c]!==void 0&&(this[i].reverse?(this[o].lt=this[c],this[o].lte=void 0):(this[o].gt=this[c],this[o].gte=void 0));let g;try{g=e(this[o])}catch{return this[s]=!0,[]}const m=this.db.db.transaction([this[a]],"readonly"),_=m.objectStore(this[a]),v=[],k=new Promise(function(I,A){m.onabort=()=>{A(m.error||new Error("aborted by user"))},m.oncomplete=()=>{I(v)}});if(this[i].reverse){const I=!this[i].values&&_.openKeyCursor?"openKeyCursor":"openCursor";_[I](g,"prev").onsuccess=A=>{const L=A.target.result;if(L){const{key:D,value:K}=L;this[c]=D,v.push([this[i].keys&&D!==void 0?n(D):void 0,this[i].values&&K!==void 0?n(K):void 0]),v.length<p?L.continue():d(m)}else this[s]=!0}}else{let I,A;const L=()=>{if(I===void 0||A===void 0)return;const D=Math.max(I.length,A.length);D===0||p===1/0?this[s]=!0:this[c]=I[D-1],v.length=D;for(let K=0;K<D;K++){const O=I[K],N=A[K];v[K]=[this[i].keys?n(O):void 0,this[i].values?n(N):void 0]}d(m)};this[i].keys||p<1/0?_.getAllKeys(g,p<1/0?p:void 0).onsuccess=D=>{I=D.target.result,L()}:(I=[],L()),this[i].values?_.getAll(g,p<1/0?p:void 0).onsuccess=D=>{A=D.target.result,L()}:(A=[],L())}return k}async _next(){if(this[r].length>0)return this[r].shift();if(!this[s]){let p=Math.min(100,this.limit-this.count);return this[u]&&(this[u]=!1,p=1),this[r]=await this._nextv(p,h),this[r].shift()}}async _all(p){this[u]=!1;const w=this[r].splice(0,this[r].length),g=this.limit-this.count-w.length;if(g<=0)return w;let m=await this._nextv(g,h);return w.length>0&&(m=w.concat(m)),m}_seek(p,w){this[u]=!0,this[r]=[],this[s]=!1,this[c]=void 0,this[o]={...this[i]};let g;try{g=e(this[i])}catch{this[s]=!0;return}g!==null&&!g.includes(p)?this[s]=!0:this[i].reverse?this[o].lte=p:this[o].gte=p}}Ph.Iterator=l;function d(f){typeof f.commit=="function"&&f.commit()}return Ph}var qh,Pb;function u8(){return Pb||(Pb=1,qh=async function(e,n,r,s){if(s.limit===0)return;const i=e.db.transaction([n],"readwrite"),o=i.objectStore(n);let c=0;const a=new Promise(function(l,d){i.oncomplete=l,i.onabort=function(){d(i.error||new Error("aborted by user"))}}),u=o.openKeyCursor?"openKeyCursor":"openCursor",h=s.reverse?"prev":"next";return o[u](r,h).onsuccess=function(l){const d=l.target.result;d&&(o.delete(d.key).onsuccess=function(){(s.limit<=0||++c<s.limit)&&d.continue()})},a}),qh}var $b;function l8(){if($b)return bh;$b=1;const{AbstractLevel:t}=sy(),{Iterator:e}=a8(),n=Nx(),r=u8(),s=Fx(),i="level-js-",o=Symbol("idb"),c=Symbol("namePrefix"),a=Symbol("location"),u=Symbol("version"),h=Symbol("store"),l=Symbol("onComplete");class d extends t{constructor(p,w){const{prefix:g,version:m,..._}=w||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0,has:!0,getSync:!1},_),typeof p!="string"||p==="")throw new TypeError("The first argument 'location' must be a non-empty string");this[a]=p,this[c]=g??i,this[u]=parseInt(m||1,10),this[o]=null}get location(){return this[a]}get namePrefix(){return this[c]}get version(){return this[u]}get db(){return this[o]}get type(){return"browser-level"}async _open(p){const w=indexedDB.open(this[c]+this[a],this[u]);return w.onupgradeneeded=g=>{const m=g.target.result;m.objectStoreNames.contains(this[a])||m.createObjectStore(this[a])},new Promise((g,m)=>{w.onerror=function(){m(w.error||new Error("unknown error"))},w.onsuccess=()=>{this[o]=w.result,g()}})}[h](p){return this[o].transaction([this[a]],p).objectStore(this[a])}[l](p){const w=p.transaction;return new Promise(function(g,m){w.onabort=function(){m(w.error||new Error("aborted by user"))},w.oncomplete=function(){g(p.result)}})}async _get(p,w){const m=this[h]("readonly").get(p),_=await this[l](m);return n(_)}async _getMany(p,w){const g=this[h]("readonly"),m=p.values(),_=Math.min(16,p.length),v=new Array(_),k=new Array(p.length);let I=0,A=!1;const L=async function(){try{for(const D of m){if(A)break;const K=I++,O=g.get(D);await new Promise(function(N,W){O.onsuccess=()=>{k[K]=n(O.result),N()},O.onerror=q=>{q.stopPropagation(),W(O.error)}})}}catch(D){throw A=!0,D}};for(let D=0;D<_;D++)v[D]=L();return await Promise.allSettled(v),k}async _has(p,w){const m=this[h]("readonly").count(p);return await this[l](m)===1}async _hasMany(p,w){const g=this[h]("readonly"),m=p.values(),_=Math.min(16,p.length),v=new Array(_),k=new Array(p.length);let I=0,A=!1;const L=async function(){try{for(const D of m){if(A)break;const K=I++,O=g.count(D);await new Promise(function(N,W){O.onsuccess=()=>{k[K]=O.result===1,N()},O.onerror=q=>{q.stopPropagation(),W(O.error)}})}}catch(D){throw A=!0,D}};for(let D=0;D<_;D++)v[D]=L();return await Promise.allSettled(v),k}async _del(p,w){const m=this[h]("readwrite").delete(p);return this[l](m)}async _put(p,w,g){const _=this[h]("readwrite").put(w,p);return this[l](_)}_iterator(p){return new e(this,this[a],p)}async _batch(p,w){const g=this[h]("readwrite"),m=g.transaction;let _=0,v;const k=new Promise(function(A,L){m.onabort=function(){L(v||m.error||new Error("aborted by user"))},m.oncomplete=A});function I(){const A=p[_++],L=A.key;let D;try{D=A.type==="del"?g.delete(L):g.put(A.value,L)}catch(K){v=K,m.abort();return}_<p.length?D.onsuccess=I:typeof m.commit=="function"&&m.commit()}return I(),k}async _clear(p){let w;try{w=s(p)}catch{return}if(p.limit>=0)return r(this,this[a],w,p);const g=this[h]("readwrite"),m=w?g.delete(w):g.clear();return this[l](m)}async _close(){this[o].close()}}return d.destroy=async function(f,p){p==null&&(p=i);const w=indexedDB.deleteDatabase(p+f);return new Promise(function(g,m){w.onsuccess=g,w.onerror=m})},bh.BrowserLevel=d,bh}var h8=l8(),Uh={},Vh={},ur={},Zc={},jh={},Bb;function f8(){return Bb||(Bb=1,jh.supports=function(...e){const n=e.reduce((r,s)=>Object.assign(r,s),{});return Object.assign(n,{snapshots:n.snapshots||!1,permanence:n.permanence||!1,seek:n.seek||!1,clear:n.clear||!1,getMany:n.getMany||!1,keyIterator:n.keyIterator||!1,valueIterator:n.valueIterator||!1,iteratorNextv:n.iteratorNextv||!1,iteratorAll:n.iteratorAll||!1,status:n.status||!1,createIfMissing:n.createIfMissing||!1,errorIfExists:n.errorIfExists||!1,deferredOpen:n.deferredOpen||!1,promises:n.promises||!1,streams:n.streams||!1,encodings:Object.assign({},n.encodings),events:Object.assign({},n.events),additionalMethods:Object.assign({},n.additionalMethods)})}),jh}var ea={},Kh,qb;function d8(){return qb||(qb=1,Kh=typeof queueMicrotask=="function"?queueMicrotask:t=>Promise.resolve().then(t)),Kh}var Ub;function _l(){if(Ub)return ea;Ub=1;var t=d8();return ea.fromCallback=function(e,n){if(e===void 0){var r=new Promise(function(s,i){e=function(o,c){o?i(o):s(c)}});e[n!==void 0?n:"promise"]=r}else if(typeof e!="function")throw new TypeError("Callback must be a function");return e},ea.fromPromise=function(e,n){if(n===void 0)return e;e.then(function(r){t(()=>n(null,r))}).catch(function(r){t(()=>n(r))})},ea}var no={},ta={},Vb;function iy(){return Vb||(Vb=1,ta.getCallback=function(t,e){return typeof t=="function"?t:e},ta.getOptions=function(t,e){return typeof t=="object"&&t!==null?t:e!==void 0?e:{}}),ta}var jb;function jr(){if(jb)return no;jb=1;const{fromCallback:t}=_l(),e=wt(),{getOptions:n,getCallback:r}=iy(),s=Symbol("promise"),i=Symbol("callback"),o=Symbol("working"),c=Symbol("handleOne"),a=Symbol("handleMany"),u=Symbol("autoClose"),h=Symbol("finishWork"),l=Symbol("returnMany"),d=Symbol("closing"),f=Symbol("handleClose"),p=Symbol("closed"),w=Symbol("closeCallbacks"),g=Symbol("keyEncoding"),m=Symbol("valueEncoding"),_=Symbol("abortOnClose"),v=Symbol("legacy"),k=Symbol("keys"),I=Symbol("values"),A=Symbol("limit"),L=Symbol("count"),D=Object.freeze({}),K=()=>{};let O=!1;class N{constructor(B,S,R){if(typeof B!="object"||B===null){const E=B===null?"null":typeof B;throw new TypeError(`The first argument must be an abstract-level database, received ${E}`)}if(typeof S!="object"||S===null)throw new TypeError("The second argument must be an options object");this[p]=!1,this[w]=[],this[o]=!1,this[d]=!1,this[u]=!1,this[i]=null,this[c]=this[c].bind(this),this[a]=this[a].bind(this),this[f]=this[f].bind(this),this[g]=S[g],this[m]=S[m],this[v]=R,this[A]=Number.isInteger(S.limit)&&S.limit>=0?S.limit:1/0,this[L]=0,this[_]=!!S.abortOnClose,this.db=B,this.db.attachResource(this),this.nextTick=B.nextTick}get count(){return this[L]}get limit(){return this[A]}next(B){let S;if(B===void 0)S=new Promise((R,E)=>{B=(P,X,H)=>{P?E(P):this[v]?X===void 0&&H===void 0?R():R([X,H]):R(X)}});else if(typeof B!="function")throw new TypeError("Callback must be a function");return this[d]?this.nextTick(B,new e("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[o]?this.nextTick(B,new e("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[o]=!0,this[i]=B,this[L]>=this[A]?this.nextTick(this[c],null):this._next(this[c])),S}_next(B){this.nextTick(B)}nextv(B,S,R){return R=r(S,R),R=t(R,s),S=n(S,D),Number.isInteger(B)?(this[d]?this.nextTick(R,new e("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[o]?this.nextTick(R,new e("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(B<1&&(B=1),this[A]<1/0&&(B=Math.min(B,this[A]-this[L])),this[o]=!0,this[i]=R,B<=0?this.nextTick(this[a],null,[]):this._nextv(B,S,this[a])),R[s]):(this.nextTick(R,new TypeError("The first argument 'size' must be an integer")),R[s])}_nextv(B,S,R){const E=[],P=(X,H,G)=>{if(X)return R(X);if(this[v]?H===void 0&&G===void 0:H===void 0)return R(null,E);E.push(this[v]?[H,G]:H),E.length===B?R(null,E):this._next(P)};this._next(P)}all(B,S){return S=r(B,S),S=t(S,s),B=n(B,D),this[d]?this.nextTick(S,new e("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[o]?this.nextTick(S,new e("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[o]=!0,this[i]=S,this[u]=!0,this[L]>=this[A]?this.nextTick(this[a],null,[]):this._all(B,this[a])),S[s]}_all(B,S){let R=this[L];const E=[],P=()=>{const H=this[A]<1/0?Math.min(1e3,this[A]-R):1e3;H<=0?this.nextTick(S,null,E):this._nextv(H,D,X)},X=(H,G)=>{H?S(H):G.length===0?S(null,E):(E.push.apply(E,G),R+=G.length,P())};P()}[h](){const B=this[i];return this[_]&&B===null?K:(this[o]=!1,this[i]=null,this[d]&&this._close(this[f]),B)}[l](B,S,R){this[u]?this.close(B.bind(null,S,R)):B(S,R)}seek(B,S){if(S=n(S,D),!this[d]){if(this[o])throw new e("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const R=this.db.keyEncoding(S.keyEncoding||this[g]),E=R.format;S.keyEncoding!==E&&(S={...S,keyEncoding:E});const P=this.db.prefixKey(R.encode(B),E);this._seek(P,S)}}}_seek(B,S){throw new e("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(B){return B=t(B,s),this[p]?this.nextTick(B):this[d]?this[w].push(B):(this[d]=!0,this[w].push(B),this[o]?this[_]&&this[h]()(new e("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[f])),B[s]}_close(B){this.nextTick(B)}[f](){this[p]=!0,this.db.detachResource(this);const B=this[w];this[w]=[];for(const S of B)S()}async*[Symbol.asyncIterator](){try{let B;for(;(B=await this.next())!==void 0;)yield B}finally{this[p]||await this.close()}}}class W extends N{constructor(B,S){super(B,S,!0),this[k]=S.keys!==!1,this[I]=S.values!==!1}[c](B,S,R){const E=this[h]();if(B)return E(B);try{S=this[k]&&S!==void 0?this[g].decode(S):void 0,R=this[I]&&R!==void 0?this[m].decode(R):void 0}catch(P){return E(new T("entry",P))}S===void 0&&R===void 0||this[L]++,E(null,S,R)}[a](B,S){const R=this[h]();if(B)return this[l](R,B);try{for(const E of S){const P=E[0],X=E[1];E[0]=this[k]&&P!==void 0?this[g].decode(P):void 0,E[1]=this[I]&&X!==void 0?this[m].decode(X):void 0}}catch(E){return this[l](R,new T("entries",E))}this[L]+=S.length,this[l](R,null,S)}end(B){return!O&&typeof console<"u"&&(O=!0,console.warn(new e("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(B)}}class q extends N{constructor(B,S){super(B,S,!1)}[c](B,S){const R=this[h]();if(B)return R(B);try{S=S!==void 0?this[g].decode(S):void 0}catch(E){return R(new T("key",E))}S!==void 0&&this[L]++,R(null,S)}[a](B,S){const R=this[h]();if(B)return this[l](R,B);try{for(let E=0;E<S.length;E++){const P=S[E];S[E]=P!==void 0?this[g].decode(P):void 0}}catch(E){return this[l](R,new T("keys",E))}this[L]+=S.length,this[l](R,null,S)}}class te extends N{constructor(B,S){super(B,S,!1)}[c](B,S){const R=this[h]();if(B)return R(B);try{S=S!==void 0?this[m].decode(S):void 0}catch(E){return R(new T("value",E))}S!==void 0&&this[L]++,R(null,S)}[a](B,S){const R=this[h]();if(B)return this[l](R,B);try{for(let E=0;E<S.length;E++){const P=S[E];S[E]=P!==void 0?this[m].decode(P):void 0}}catch(E){return this[l](R,new T("values",E))}this[L]+=S.length,this[l](R,null,S)}}class T extends e{constructor(B,S){super(`Iterator could not decode ${B}`,{code:"LEVEL_DECODE_ERROR",cause:S})}}for(const $ of["_ended property","_nexting property","_end method"])Object.defineProperty(W.prototype,$.split(" ")[0],{get(){throw new e(`The ${$} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new e(`The ${$} has been removed`,{code:"LEVEL_LEGACY"})}});return W.keyEncoding=g,W.valueEncoding=m,no.AbstractIterator=W,no.AbstractKeyIterator=q,no.AbstractValueIterator=te,no}var na={},Kb;function p8(){if(Kb)return na;Kb=1;const{AbstractKeyIterator:t,AbstractValueIterator:e}=jr(),n=Symbol("iterator"),r=Symbol("callback"),s=Symbol("handleOne"),i=Symbol("handleMany");class o extends t{constructor(u,h){super(u,h),this[n]=u.iterator({...h,keys:!0,values:!1}),this[s]=this[s].bind(this),this[i]=this[i].bind(this)}}class c extends e{constructor(u,h){super(u,h),this[n]=u.iterator({...h,keys:!1,values:!0}),this[s]=this[s].bind(this),this[i]=this[i].bind(this)}}for(const a of[o,c]){const u=a===o,h=u?l=>l[0]:l=>l[1];a.prototype._next=function(l){this[r]=l,this[n].next(this[s])},a.prototype[s]=function(l,d,f){const p=this[r];l?p(l):p(null,u?d:f)},a.prototype._nextv=function(l,d,f){this[r]=f,this[n].nextv(l,d,this[i])},a.prototype._all=function(l,d){this[r]=d,this[n].all(l,this[i])},a.prototype[i]=function(l,d){const f=this[r];l?f(l):f(null,d.map(h))},a.prototype._seek=function(l,d){this[n].seek(l,d)},a.prototype._close=function(l){this[n].close(l)}}return na.DefaultKeyIterator=o,na.DefaultValueIterator=c,na}var ro={},Wb;function g8(){if(Wb)return ro;Wb=1;const{AbstractIterator:t,AbstractKeyIterator:e,AbstractValueIterator:n}=jr(),r=wt(),s=Symbol("nut"),i=Symbol("undefer"),o=Symbol("factory");class c extends t{constructor(l,d){super(l,d),this[s]=null,this[o]=()=>l.iterator(d),this.db.defer(()=>this[i]())}}class a extends e{constructor(l,d){super(l,d),this[s]=null,this[o]=()=>l.keys(d),this.db.defer(()=>this[i]())}}class u extends n{constructor(l,d){super(l,d),this[s]=null,this[o]=()=>l.values(d),this.db.defer(()=>this[i]())}}for(const h of[c,a,u])h.prototype[i]=function(){this.db.status==="open"&&(this[s]=this[o]())},h.prototype._next=function(l){this[s]!==null?this[s].next(l):this.db.status==="opening"?this.db.defer(()=>this._next(l)):this.nextTick(l,new r("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},h.prototype._nextv=function(l,d,f){this[s]!==null?this[s].nextv(l,d,f):this.db.status==="opening"?this.db.defer(()=>this._nextv(l,d,f)):this.nextTick(f,new r("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},h.prototype._all=function(l,d){this[s]!==null?this[s].all(d):this.db.status==="opening"?this.db.defer(()=>this._all(l,d)):this.nextTick(d,new r("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},h.prototype._seek=function(l,d){this[s]!==null?this[s]._seek(l,d):this.db.status==="opening"&&this.db.defer(()=>this._seek(l,d))},h.prototype._close=function(l){this[s]!==null?this[s].close(l):this.db.status==="opening"?this.db.defer(()=>this._close(l)):this.nextTick(l)};return ro.DeferredIterator=c,ro.DeferredKeyIterator=a,ro.DeferredValueIterator=u,ro}var Wh={},zh={},zb;function Px(){if(zb)return zh;zb=1;const{fromCallback:t}=_l(),e=wt(),{getCallback:n,getOptions:r}=iy(),s=Symbol("promise"),i=Symbol("status"),o=Symbol("operations"),c=Symbol("finishClose"),a=Symbol("closeCallbacks");class u{constructor(l){if(typeof l!="object"||l===null){const d=l===null?"null":typeof l;throw new TypeError(`The first argument must be an abstract-level database, received ${d}`)}this[o]=[],this[a]=[],this[i]="open",this[c]=this[c].bind(this),this.db=l,this.db.attachResource(this),this.nextTick=l.nextTick}get length(){return this[o].length}put(l,d,f){if(this[i]!=="open")throw new e("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const p=this.db._checkKey(l)||this.db._checkValue(d);if(p)throw p;const w=f&&f.sublevel!=null?f.sublevel:this.db,g=f,m=w.keyEncoding(f&&f.keyEncoding),_=w.valueEncoding(f&&f.valueEncoding),v=m.format;f={...f,keyEncoding:v,valueEncoding:_.format},w!==this.db&&(f.sublevel=null);const k=w.prefixKey(m.encode(l),v),I=_.encode(d);return this._put(k,I,f),this[o].push({...g,type:"put",key:l,value:d}),this}_put(l,d,f){}del(l,d){if(this[i]!=="open")throw new e("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const f=this.db._checkKey(l);if(f)throw f;const p=d&&d.sublevel!=null?d.sublevel:this.db,w=d,g=p.keyEncoding(d&&d.keyEncoding),m=g.format;return d={...d,keyEncoding:m},p!==this.db&&(d.sublevel=null),this._del(p.prefixKey(g.encode(l),m),d),this[o].push({...w,type:"del",key:l}),this}_del(l,d){}clear(){if(this[i]!=="open")throw new e("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[o]=[],this}_clear(){}write(l,d){return d=n(l,d),d=t(d,s),l=r(l),this[i]!=="open"?this.nextTick(d,new e("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):this.length===0?this.close(d):(this[i]="writing",this._write(l,f=>{this[i]="closing",this[a].push(()=>d(f)),f||this.db.emit("batch",this[o]),this._close(this[c])})),d[s]}_write(l,d){}close(l){return l=t(l,s),this[i]==="closing"?this[a].push(l):this[i]==="closed"?this.nextTick(l):(this[a].push(l),this[i]!=="writing"&&(this[i]="closing",this._close(this[c]))),l[s]}_close(l){this.nextTick(l)}[c](){this[i]="closed",this.db.detachResource(this);const l=this[a];this[a]=[];for(const d of l)d()}}return zh.AbstractChainedBatch=u,zh}var Hb;function y8(){if(Hb)return Wh;Hb=1;const{AbstractChainedBatch:t}=Px(),e=wt(),n=Symbol("encoded");class r extends t{constructor(i){super(i),this[n]=[]}_put(i,o,c){this[n].push({...c,type:"put",key:i,value:o})}_del(i,o){this[n].push({...o,type:"del",key:i})}_clear(){this[n]=[]}_write(i,o){this.db.status==="opening"?this.db.defer(()=>this._write(i,o)):this.db.status==="open"?this[n].length===0?this.nextTick(o):this.db._batch(this[n],i,o):this.nextTick(o,new e("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}}return Wh.DefaultChainedBatch=r,Wh}var Hh,Qb;function m8(){if(Qb)return Hh;Qb=1;const t=wt(),e=Object.prototype.hasOwnProperty,n=new Set(["lt","lte","gt","gte"]);return Hh=function(r,s){const i={};for(const o in r)if(e.call(r,o)&&!(o==="keyEncoding"||o==="valueEncoding")){if(o==="start"||o==="end")throw new t(`The legacy range option '${o}' has been removed`,{code:"LEVEL_LEGACY"});if(o==="encoding")throw new t("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});n.has(o)?i[o]=s.encode(r[o]):i[o]=r[o]}return i.reverse=!!i.reverse,i.limit=Number.isInteger(i.limit)&&i.limit>=0?i.limit:-1,i},Hh}var Qh,Gb;function $x(){if(Gb)return Qh;Gb=1;let t;return Qh=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:HK):e=>(t||(t=Promise.resolve())).then(e).catch(n=>setTimeout(()=>{throw n},0)),Qh}var Gh,Jb;function w8(){if(Jb)return Gh;Jb=1;const t=$x();return Gh=function(e,...n){n.length===0?t(e):t(()=>e(...n))},Gh}var so={},Yb;function b8(){if(Yb)return so;Yb=1;const{AbstractIterator:t,AbstractKeyIterator:e,AbstractValueIterator:n}=jr(),r=Symbol("unfix"),s=Symbol("iterator"),i=Symbol("handleOne"),o=Symbol("handleMany"),c=Symbol("callback");class a extends t{constructor(d,f,p,w){super(d,f),this[s]=p,this[r]=w,this[i]=this[i].bind(this),this[o]=this[o].bind(this),this[c]=null}[i](d,f,p){const w=this[c];if(d)return w(d);f!==void 0&&(f=this[r](f)),w(d,f,p)}[o](d,f){const p=this[c];if(d)return p(d);for(const w of f){const g=w[0];g!==void 0&&(w[0]=this[r](g))}p(d,f)}}class u extends e{constructor(d,f,p,w){super(d,f),this[s]=p,this[r]=w,this[i]=this[i].bind(this),this[o]=this[o].bind(this),this[c]=null}[i](d,f){const p=this[c];if(d)return p(d);f!==void 0&&(f=this[r](f)),p(d,f)}[o](d,f){const p=this[c];if(d)return p(d);for(let w=0;w<f.length;w++){const g=f[w];g!==void 0&&(f[w]=this[r](g))}p(d,f)}}class h extends n{constructor(d,f,p){super(d,f),this[s]=p}}for(const l of[a,u])l.prototype._next=function(d){this[c]=d,this[s].next(this[i])},l.prototype._nextv=function(d,f,p){this[c]=p,this[s].nextv(d,f,this[o])},l.prototype._all=function(d,f){this[c]=f,this[s].all(d,this[o])};for(const l of[h])l.prototype._next=function(d){this[s].next(d)},l.prototype._nextv=function(d,f,p){this[s].nextv(d,f,p)},l.prototype._all=function(d,f){this[s].all(d,f)};for(const l of[a,u,h])l.prototype._seek=function(d,f){this[s].seek(d,f)},l.prototype._close=function(d){this[s].close(d)};return so.AbstractSublevelIterator=a,so.AbstractSublevelKeyIterator=u,so.AbstractSublevelValueIterator=h,so}var Jh,Xb;function _8(){if(Xb)return Jh;Xb=1;const t=wt(),{Buffer:e}=Yt()||{},{AbstractSublevelIterator:n,AbstractSublevelKeyIterator:r,AbstractSublevelValueIterator:s}=b8(),i=Symbol("prefix"),o=Symbol("upperBound"),c=Symbol("prefixRange"),a=Symbol("parent"),u=Symbol("unfix"),h=new TextEncoder,l={separator:"!"};Jh=function({AbstractLevel:m}){class _ extends m{static defaults(k){if(typeof k=="string")throw new t("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(k&&k.open)throw new t("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return k==null?l:k.separator?k:{...k,separator:"!"}}constructor(k,I,A){const{separator:L,manifest:D,...K}=_.defaults(A);I=g(I,L);const O=L.charCodeAt(0)+1,N=k[a]||k;if(!h.encode(I).every(te=>te>O&&te<127))throw new t(`Prefix must use bytes > ${O} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(d(N,D),K);const W=(k.prefix||"")+L+I+L,q=W.slice(0,-1)+String.fromCharCode(O);this[a]=N,this[i]=new p(W),this[o]=new p(q),this[u]=new w,this.nextTick=N.nextTick}prefixKey(k,I){if(I==="utf8")return this[i].utf8+k;if(k.byteLength===0)return this[i][I];if(I==="view"){const A=this[i].view,L=new Uint8Array(A.byteLength+k.byteLength);return L.set(A,0),L.set(k,A.byteLength),L}else{const A=this[i].buffer;return e.concat([A,k],A.byteLength+k.byteLength)}}[c](k,I){k.gte!==void 0?k.gte=this.prefixKey(k.gte,I):k.gt!==void 0?k.gt=this.prefixKey(k.gt,I):k.gte=this[i][I],k.lte!==void 0?k.lte=this.prefixKey(k.lte,I):k.lt!==void 0?k.lt=this.prefixKey(k.lt,I):k.lte=this[o][I]}get prefix(){return this[i].utf8}get db(){return this[a]}_open(k,I){this[a].open({passive:!0},I)}_put(k,I,A,L){this[a].put(k,I,A,L)}_get(k,I,A){this[a].get(k,I,A)}_getMany(k,I,A){this[a].getMany(k,I,A)}_del(k,I,A){this[a].del(k,I,A)}_batch(k,I,A){this[a].batch(k,I,A)}_clear(k,I){this[c](k,k.keyEncoding),this[a].clear(k,I)}_iterator(k){this[c](k,k.keyEncoding);const I=this[a].iterator(k),A=this[u].get(this[i].utf8.length,k.keyEncoding);return new n(this,k,I,A)}_keys(k){this[c](k,k.keyEncoding);const I=this[a].keys(k),A=this[u].get(this[i].utf8.length,k.keyEncoding);return new r(this,k,I,A)}_values(k){this[c](k,k.keyEncoding);const I=this[a].values(k);return new s(this,k,I)}}return{AbstractSublevel:_}};const d=function(m,_){return{...m.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},..._,encodings:{utf8:f(m,"utf8"),buffer:f(m,"buffer"),view:f(m,"view")}}},f=function(m,_){return m.supports.encodings[_]?m.keyEncoding(_).name===_:!1};class p{constructor(_){this.utf8=_,this.view=h.encode(_),this.buffer=e?e.from(this.view.buffer,0,this.view.byteLength):{}}}class w{constructor(){this.cache=new Map}get(_,v){let k=this.cache.get(v);return k===void 0&&(v==="view"?k=(function(I,A){return A.subarray(I)}).bind(null,_):k=(function(I,A){return A.slice(I)}).bind(null,_),this.cache.set(v,k)),k}}const g=function(m,_){let v=0,k=m.length;for(;v<k&&m[v]===_;)v++;for(;k>v&&m[k-1]===_;)k--;return m.slice(v,k)};return Jh}var Zb;function e_(){if(Zb)return Zc;Zb=1;const{supports:t}=f8(),{Transcoder:e}=Ox(),{EventEmitter:n}=Ui(),{fromCallback:r}=_l(),s=wt(),{AbstractIterator:i}=jr(),{DefaultKeyIterator:o,DefaultValueIterator:c}=p8(),{DeferredIterator:a,DeferredKeyIterator:u,DeferredValueIterator:h}=g8(),{DefaultChainedBatch:l}=y8(),{getCallback:d,getOptions:f}=iy(),p=m8(),w=Symbol("promise"),g=Symbol("landed"),m=Symbol("resources"),_=Symbol("closeResources"),v=Symbol("operations"),k=Symbol("undefer"),I=Symbol("deferOpen"),A=Symbol("options"),L=Symbol("status"),D=Symbol("defaultOptions"),K=Symbol("transcoder"),O=Symbol("keyEncoding"),N=Symbol("valueEncoding"),W=()=>{};class q extends n{constructor(S,R){if(super(),typeof S!="object"||S===null)throw new TypeError("The first argument 'manifest' must be an object");R=f(R);const{keyEncoding:E,valueEncoding:P,passive:X,...H}=R;this[m]=new Set,this[v]=[],this[I]=!0,this[A]=H,this[L]="opening",this.supports=t(S,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:S.snapshots!==!1,permanence:S.permanence!==!1,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:S.encodings||{},events:Object.assign({},S.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[K]=new e($(this)),this[O]=this[K].encoding(E||"utf8"),this[N]=this[K].encoding(P||"utf8");for(const G of this[K].encodings())this.supports.encodings[G.commonName]||(this.supports.encodings[G.commonName]=!0);this[D]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[O].commonName,valueEncoding:this[N].commonName}),key:Object.freeze({keyEncoding:this[O].commonName})},this.nextTick(()=>{this[I]&&this.open({passive:!1},W)})}get status(){return this[L]}keyEncoding(S){return this[K].encoding(S??this[O])}valueEncoding(S){return this[K].encoding(S??this[N])}open(S,R){R=d(S,R),R=r(R,w),S={...this[A],...f(S)},S.createIfMissing=S.createIfMissing!==!1,S.errorIfExists=!!S.errorIfExists;const E=P=>{this[L]==="closing"||this[L]==="opening"?this.once(g,P?()=>E(P):E):this[L]!=="open"?R(new s("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:P})):R()};return S.passive?this[L]==="opening"?this.once(g,E):this.nextTick(E):this[L]==="closed"||this[I]?(this[I]=!1,this[L]="opening",this.emit("opening"),this._open(S,P=>{if(P){this[L]="closed",this[_](()=>{this.emit(g),E(P)}),this[k]();return}this[L]="open",this[k](),this.emit(g),this[L]==="open"&&this.emit("open"),this[L]==="open"&&this.emit("ready"),E()})):this[L]==="open"?this.nextTick(E):this.once(g,()=>this.open(S,R)),R[w]}_open(S,R){this.nextTick(R)}close(S){S=r(S,w);const R=E=>{this[L]==="opening"||this[L]==="closing"?this.once(g,E?R(E):R):this[L]!=="closed"?S(new s("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:E})):S()};if(this[L]==="open"){this[L]="closing",this.emit("closing");const E=P=>{this[L]="open",this[k](),this.emit(g),R(P)};this[_](()=>{this._close(P=>{if(P)return E(P);this[L]="closed",this[k](),this.emit(g),this[L]==="closed"&&this.emit("closed"),R()})})}else this[L]==="closed"?this.nextTick(R):this.once(g,()=>this.close(S));return S[w]}[_](S){if(this[m].size===0)return this.nextTick(S);let R=this[m].size,E=!0;const P=()=>{--R===0&&(E?this.nextTick(S):S())};for(const X of this[m])X.close(P);E=!1,this[m].clear()}_close(S){this.nextTick(S)}get(S,R,E){if(E=d(R,E),E=r(E,w),R=f(R,this[D].entry),this[L]==="opening")return this.defer(()=>this.get(S,R,E)),E[w];if(T(this,E))return E[w];const P=this._checkKey(S);if(P)return this.nextTick(E,P),E[w];const X=this.keyEncoding(R.keyEncoding),H=this.valueEncoding(R.valueEncoding),G=X.format,se=H.format;return(R.keyEncoding!==G||R.valueEncoding!==se)&&(R=Object.assign({},R,{keyEncoding:G,valueEncoding:se})),this._get(this.prefixKey(X.encode(S),G),R,(ce,ue)=>{if(ce)return(ce.code==="LEVEL_NOT_FOUND"||ce.notFound||/NotFound/i.test(ce))&&(ce.code||(ce.code="LEVEL_NOT_FOUND"),ce.notFound||(ce.notFound=!0),ce.status||(ce.status=404)),E(ce);try{ue=H.decode(ue)}catch(J){return E(new s("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:J}))}E(null,ue)}),E[w]}_get(S,R,E){this.nextTick(E,new Error("NotFound"))}getMany(S,R,E){if(E=d(R,E),E=r(E,w),R=f(R,this[D].entry),this[L]==="opening")return this.defer(()=>this.getMany(S,R,E)),E[w];if(T(this,E))return E[w];if(!Array.isArray(S))return this.nextTick(E,new TypeError("The first argument 'keys' must be an array")),E[w];if(S.length===0)return this.nextTick(E,null,[]),E[w];const P=this.keyEncoding(R.keyEncoding),X=this.valueEncoding(R.valueEncoding),H=P.format,G=X.format;(R.keyEncoding!==H||R.valueEncoding!==G)&&(R=Object.assign({},R,{keyEncoding:H,valueEncoding:G}));const se=new Array(S.length);for(let ce=0;ce<S.length;ce++){const ue=S[ce],J=this._checkKey(ue);if(J)return this.nextTick(E,J),E[w];se[ce]=this.prefixKey(P.encode(ue),H)}return this._getMany(se,R,(ce,ue)=>{if(ce)return E(ce);try{for(let J=0;J<ue.length;J++)ue[J]!==void 0&&(ue[J]=X.decode(ue[J]))}catch(J){return E(new s(`Could not decode one or more of ${ue.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:J}))}E(null,ue)}),E[w]}_getMany(S,R,E){this.nextTick(E,null,new Array(S.length).fill(void 0))}put(S,R,E,P){if(P=d(E,P),P=r(P,w),E=f(E,this[D].entry),this[L]==="opening")return this.defer(()=>this.put(S,R,E,P)),P[w];if(T(this,P))return P[w];const X=this._checkKey(S)||this._checkValue(R);if(X)return this.nextTick(P,X),P[w];const H=this.keyEncoding(E.keyEncoding),G=this.valueEncoding(E.valueEncoding),se=H.format,ce=G.format;(E.keyEncoding!==se||E.valueEncoding!==ce)&&(E=Object.assign({},E,{keyEncoding:se,valueEncoding:ce}));const ue=this.prefixKey(H.encode(S),se),J=G.encode(R);return this._put(ue,J,E,ne=>{if(ne)return P(ne);this.emit("put",S,R),P()}),P[w]}_put(S,R,E,P){this.nextTick(P)}del(S,R,E){if(E=d(R,E),E=r(E,w),R=f(R,this[D].key),this[L]==="opening")return this.defer(()=>this.del(S,R,E)),E[w];if(T(this,E))return E[w];const P=this._checkKey(S);if(P)return this.nextTick(E,P),E[w];const X=this.keyEncoding(R.keyEncoding),H=X.format;return R.keyEncoding!==H&&(R=Object.assign({},R,{keyEncoding:H})),this._del(this.prefixKey(X.encode(S),H),R,G=>{if(G)return E(G);this.emit("del",S),E()}),E[w]}_del(S,R,E){this.nextTick(E)}batch(S,R,E){if(!arguments.length){if(this[L]==="opening")return new l(this);if(this[L]!=="open")throw new s("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(typeof S=="function"?E=S:E=d(R,E),E=r(E,w),R=f(R,this[D].empty),this[L]==="opening")return this.defer(()=>this.batch(S,R,E)),E[w];if(T(this,E))return E[w];if(!Array.isArray(S))return this.nextTick(E,new TypeError("The first argument 'operations' must be an array")),E[w];if(S.length===0)return this.nextTick(E),E[w];const P=new Array(S.length),{keyEncoding:X,valueEncoding:H,...G}=R;for(let se=0;se<S.length;se++){if(typeof S[se]!="object"||S[se]===null)return this.nextTick(E,new TypeError("A batch operation must be an object")),E[w];const ce=Object.assign({},S[se]);if(ce.type!=="put"&&ce.type!=="del")return this.nextTick(E,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),E[w];const ue=this._checkKey(ce.key);if(ue)return this.nextTick(E,ue),E[w];const J=ce.sublevel!=null?ce.sublevel:this,ne=J.keyEncoding(ce.keyEncoding||X),de=ne.format;if(ce.key=J.prefixKey(ne.encode(ce.key),de),ce.keyEncoding=de,ce.type==="put"){const we=this._checkValue(ce.value);if(we)return this.nextTick(E,we),E[w];const be=J.valueEncoding(ce.valueEncoding||H);ce.value=be.encode(ce.value),ce.valueEncoding=be.format}J!==this&&(ce.sublevel=null),P[se]=ce}return this._batch(P,G,se=>{if(se)return E(se);this.emit("batch",S),E()}),E[w]}_batch(S,R,E){this.nextTick(E)}sublevel(S,R){return this._sublevel(S,te.defaults(R))}_sublevel(S,R){return new te(this,S,R)}prefixKey(S,R){return S}clear(S,R){if(R=d(S,R),R=r(R,w),S=f(S,this[D].empty),this[L]==="opening")return this.defer(()=>this.clear(S,R)),R[w];if(T(this,R))return R[w];const E=S,P=this.keyEncoding(S.keyEncoding);return S=p(S,P),S.keyEncoding=P.format,S.limit===0?this.nextTick(R):this._clear(S,X=>{if(X)return R(X);this.emit("clear",E),R()}),R[w]}_clear(S,R){this.nextTick(R)}iterator(S){const R=this.keyEncoding(S&&S.keyEncoding),E=this.valueEncoding(S&&S.valueEncoding);if(S=p(S,R),S.keys=S.keys!==!1,S.values=S.values!==!1,S[i.keyEncoding]=R,S[i.valueEncoding]=E,S.keyEncoding=R.format,S.valueEncoding=E.format,this[L]==="opening")return new a(this,S);if(this[L]!=="open")throw new s("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(S)}_iterator(S){return new i(this,S)}keys(S){const R=this.keyEncoding(S&&S.keyEncoding),E=this.valueEncoding(S&&S.valueEncoding);if(S=p(S,R),S[i.keyEncoding]=R,S[i.valueEncoding]=E,S.keyEncoding=R.format,S.valueEncoding=E.format,this[L]==="opening")return new u(this,S);if(this[L]!=="open")throw new s("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(S)}_keys(S){return new o(this,S)}values(S){const R=this.keyEncoding(S&&S.keyEncoding),E=this.valueEncoding(S&&S.valueEncoding);if(S=p(S,R),S[i.keyEncoding]=R,S[i.valueEncoding]=E,S.keyEncoding=R.format,S.valueEncoding=E.format,this[L]==="opening")return new h(this,S);if(this[L]!=="open")throw new s("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(S)}_values(S){return new c(this,S)}defer(S){if(typeof S!="function")throw new TypeError("The first argument must be a function");this[v].push(S)}[k](){if(this[v].length===0)return;const S=this[v];this[v]=[];for(const R of S)R()}attachResource(S){if(typeof S!="object"||S===null||typeof S.close!="function")throw new TypeError("The first argument must be a resource object");this[m].add(S)}detachResource(S){this[m].delete(S)}_chainedBatch(){return new l(this)}_checkKey(S){if(S==null)return new s("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(S){if(S==null)return new s("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}}q.prototype.nextTick=w8();const{AbstractSublevel:te}=_8()({AbstractLevel:q});Zc.AbstractLevel=q,Zc.AbstractSublevel=te;const T=function(B,S){return B[L]!=="open"?(B.nextTick(S,new s("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0):!1},$=function(B){return Object.keys(B.supports.encodings).filter(S=>!!B.supports.encodings[S])};return Zc}var t_;function Bx(){return t_||(t_=1,ur.AbstractLevel=e_().AbstractLevel,ur.AbstractSublevel=e_().AbstractSublevel,ur.AbstractIterator=jr().AbstractIterator,ur.AbstractKeyIterator=jr().AbstractKeyIterator,ur.AbstractValueIterator=jr().AbstractValueIterator,ur.AbstractChainedBatch=Px().AbstractChainedBatch),ur}var Yh,n_;function S8(){if(n_)return Yh;n_=1,Yh=e;const t=$x();function e(n,r,s){if(typeof r!="number")throw new Error("second argument must be a Number");let i,o,c,a,u,h=!0,l;Array.isArray(n)?(i=[],c=o=n.length):(a=Object.keys(n),i={},c=o=a.length);function d(p){function w(){s&&s(p,i),s=null}h?t(w):w()}function f(p,w,g){if(i[p]=g,w&&(u=!0),--c===0||w)d(w);else if(!u&&l<o){let m;a?(m=a[l],l+=1,n[m](function(_,v){f(m,_,v)})):(m=l,l+=1,n[m](function(_,v){f(m,_,v)}))}}l=r,c?a?a.some(function(p,w){return n[p](function(g,m){f(p,g,m)}),w===r-1}):n.some(function(p,w){return p(function(g,m){f(w,g,m)}),w===r-1}):d(null),h=!1}return Yh}var Xh={},Zh,r_;function qx(){return r_||(r_=1,Zh=function(e){const n=e.gte!==void 0?e.gte:e.gt!==void 0?e.gt:void 0,r=e.lte!==void 0?e.lte:e.lt!==void 0?e.lt:void 0,s=e.gte===void 0,i=e.lte===void 0;return n!==void 0&&r!==void 0?IDBKeyRange.bound(n,r,s,i):n!==void 0?IDBKeyRange.lowerBound(n,s):r!==void 0?IDBKeyRange.upperBound(r,i):null}),Zh}var ef,s_;function Ux(){if(s_)return ef;s_=1;const t=new TextEncoder;return ef=function(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):t.encode(e)},ef}var i_;function E8(){if(i_)return Xh;i_=1;const{AbstractIterator:t}=Bx(),e=qx(),n=Ux(),r=Symbol("cache"),s=Symbol("finished"),i=Symbol("options"),o=Symbol("currentOptions"),c=Symbol("position"),a=Symbol("location"),u=Symbol("first"),h={};class l extends t{constructor(p,w,g){super(p,g),this[r]=[],this[s]=this.limit===0,this[i]=g,this[o]={...g},this[c]=void 0,this[a]=w,this[u]=!0}_nextv(p,w,g){if(this[u]=!1,this[s])return this.nextTick(g,null,[]);if(this[r].length>0)return p=Math.min(p,this[r].length),this.nextTick(g,null,this[r].splice(0,p));this[c]!==void 0&&(this[i].reverse?(this[o].lt=this[c],this[o].lte=void 0):(this[o].gt=this[c],this[o].gte=void 0));let m;try{m=e(this[o])}catch{return this[s]=!0,this.nextTick(g,null,[])}const _=this.db.db.transaction([this[a]],"readonly"),v=_.objectStore(this[a]),k=[];if(this[i].reverse){const I=!this[i].values&&v.openKeyCursor?"openKeyCursor":"openCursor";v[I](m,"prev").onsuccess=A=>{const L=A.target.result;if(L){const{key:D,value:K}=L;this[c]=D,k.push([this[i].keys&&D!==void 0?n(D):void 0,this[i].values&&K!==void 0?n(K):void 0]),k.length<p?L.continue():d(_)}else this[s]=!0}}else{let I,A;const L=()=>{if(I===void 0||A===void 0)return;const D=Math.max(I.length,A.length);D===0||p===1/0?this[s]=!0:this[c]=I[D-1],k.length=D;for(let K=0;K<D;K++){const O=I[K],N=A[K];k[K]=[this[i].keys&&O!==void 0?n(O):void 0,this[i].values&&N!==void 0?n(N):void 0]}d(_)};this[i].keys||p<1/0?v.getAllKeys(m,p<1/0?p:void 0).onsuccess=D=>{I=D.target.result,L()}:(I=[],this.nextTick(L)),this[i].values?v.getAll(m,p<1/0?p:void 0).onsuccess=D=>{A=D.target.result,L()}:(A=[],this.nextTick(L))}_.onabort=()=>{g(_.error||new Error("aborted by user")),g=null},_.oncomplete=()=>{g(null,k),g=null}}_next(p){if(this[r].length>0){const[w,g]=this[r].shift();this.nextTick(p,null,w,g)}else if(this[s])this.nextTick(p);else{let w=Math.min(100,this.limit-this.count);this[u]&&(this[u]=!1,w=1),this._nextv(w,h,(g,m)=>{if(g)return p(g);this[r]=m,this._next(p)})}}_all(p,w){this[u]=!1;const g=this[r].splice(0,this[r].length),m=this.limit-this.count-g.length;if(m<=0)return this.nextTick(w,null,g);this._nextv(m,h,(_,v)=>{if(_)return w(_);g.length>0&&(v=g.concat(v)),w(null,v)})}_seek(p,w){this[u]=!0,this[r]=[],this[s]=!1,this[c]=void 0,this[o]={...this[i]};let g;try{g=e(this[i])}catch{this[s]=!0;return}g!==null&&!g.includes(p)?this[s]=!0:this[i].reverse?this[o].lte=p:this[o].gte=p}}Xh.Iterator=l;function d(f){typeof f.commit=="function"&&f.commit()}return Xh}var tf,o_;function v8(){return o_||(o_=1,tf=function(e,n,r,s,i){if(s.limit===0)return e.nextTick(i);const o=e.db.transaction([n],"readwrite"),c=o.objectStore(n);let a=0;o.oncomplete=function(){i()},o.onabort=function(){i(o.error||new Error("aborted by user"))};const u=c.openKeyCursor?"openKeyCursor":"openCursor",h=s.reverse?"prev":"next";c[u](r,h).onsuccess=function(l){const d=l.target.result;d&&(c.delete(d.key).onsuccess=function(){(s.limit<=0||++a<s.limit)&&d.continue()})}}),tf}var c_;function k8(){if(c_)return Vh;c_=1;const{AbstractLevel:t}=Bx(),e=wt(),n=S8(),{fromCallback:r}=_l(),{Iterator:s}=E8(),i=Ux(),o=v8(),c=qx(),a="level-js-",u=Symbol("idb"),h=Symbol("namePrefix"),l=Symbol("location"),d=Symbol("version"),f=Symbol("store"),p=Symbol("onComplete"),w=Symbol("promise");class g extends t{constructor(_,v,k){if(typeof v=="function"||typeof k=="function")throw new e("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:I,version:A,...L}=v||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},L),typeof _!="string")throw new Error("constructor requires a location string argument");this[l]=_,this[h]=I??a,this[d]=parseInt(A||1,10),this[u]=null}get location(){return this[l]}get namePrefix(){return this[h]}get version(){return this[d]}get db(){return this[u]}get type(){return"browser-level"}_open(_,v){const k=indexedDB.open(this[h]+this[l],this[d]);k.onerror=function(){v(k.error||new Error("unknown error"))},k.onsuccess=()=>{this[u]=k.result,v()},k.onupgradeneeded=I=>{const A=I.target.result;A.objectStoreNames.contains(this[l])||A.createObjectStore(this[l])}}[f](_){return this[u].transaction([this[l]],_).objectStore(this[l])}[p](_,v){const k=_.transaction;k.onabort=function(){v(k.error||new Error("aborted by user"))},k.oncomplete=function(){v(null,_.result)}}_get(_,v,k){const I=this[f]("readonly");let A;try{A=I.get(_)}catch(L){return this.nextTick(k,L)}this[p](A,function(L,D){if(L)return k(L);if(D===void 0)return k(new e("Entry not found",{code:"LEVEL_NOT_FOUND"}));k(null,i(D))})}_getMany(_,v,k){const I=this[f]("readonly"),A=_.map(L=>D=>{let K;try{K=I.get(L)}catch(O){return D(O)}K.onsuccess=()=>{const O=K.result;D(null,O===void 0?O:i(O))},K.onerror=O=>{O.stopPropagation(),D(K.error)}});n(A,16,k)}_del(_,v,k){const I=this[f]("readwrite");let A;try{A=I.delete(_)}catch(L){return this.nextTick(k,L)}this[p](A,k)}_put(_,v,k,I){const A=this[f]("readwrite");let L;try{L=A.put(v,_)}catch(D){return this.nextTick(I,D)}this[p](L,I)}_iterator(_){return new s(this,this[l],_)}_batch(_,v,k){const I=this[f]("readwrite"),A=I.transaction;let L=0,D;A.onabort=function(){k(D||A.error||new Error("aborted by user"))},A.oncomplete=function(){k()};function K(){const O=_[L++],N=O.key;let W;try{W=O.type==="del"?I.delete(N):I.put(O.value,N)}catch(q){D=q,A.abort();return}L<_.length?W.onsuccess=K:typeof A.commit=="function"&&A.commit()}K()}_clear(_,v){let k,I;try{k=c(_)}catch{return this.nextTick(v)}if(_.limit>=0)return o(this,this[l],k,_,v);try{const A=this[f]("readwrite");I=k?A.delete(k):A.clear()}catch(A){return this.nextTick(v,A)}this[p](I,v)}_close(_){this[u].close(),this.nextTick(_)}}return g.destroy=function(m,_,v){typeof _=="function"&&(v=_,_=a),v=r(v,w);const k=indexedDB.deleteDatabase(_+m);return k.onsuccess=function(){v()},k.onerror=function(I){v(I)},v[w]},Vh.BrowserLevel=g,Vh}var a_;function x8(){return a_||(a_=1,Uh.Level=k8().BrowserLevel),Uh}var I8=x8(),io={},nf={exports:{}},rf={exports:{}},sf,u_;function Je(){if(u_)return sf;u_=1;class t extends Error{constructor(n){if(!Array.isArray(n))throw new TypeError(`Expected input to be an Array, got ${typeof n}`);let r="";for(let s=0;s<n.length;s++)r+=`    ${n[s].stack}
`;super(r),this.name="AggregateError",this.errors=n}}return sf={AggregateError:t,ArrayIsArray(e){return Array.isArray(e)},ArrayPrototypeIncludes(e,n){return e.includes(n)},ArrayPrototypeIndexOf(e,n){return e.indexOf(n)},ArrayPrototypeJoin(e,n){return e.join(n)},ArrayPrototypeMap(e,n){return e.map(n)},ArrayPrototypePop(e,n){return e.pop(n)},ArrayPrototypePush(e,n){return e.push(n)},ArrayPrototypeSlice(e,n,r){return e.slice(n,r)},Error,FunctionPrototypeCall(e,n,...r){return e.call(n,...r)},FunctionPrototypeSymbolHasInstance(e,n){return Function.prototype[Symbol.hasInstance].call(e,n)},MathFloor:Math.floor,Number,NumberIsInteger:Number.isInteger,NumberIsNaN:Number.isNaN,NumberMAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,NumberMIN_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,NumberParseInt:Number.parseInt,ObjectDefineProperties(e,n){return Object.defineProperties(e,n)},ObjectDefineProperty(e,n,r){return Object.defineProperty(e,n,r)},ObjectGetOwnPropertyDescriptor(e,n){return Object.getOwnPropertyDescriptor(e,n)},ObjectKeys(e){return Object.keys(e)},ObjectSetPrototypeOf(e,n){return Object.setPrototypeOf(e,n)},Promise,PromisePrototypeCatch(e,n){return e.catch(n)},PromisePrototypeThen(e,n,r){return e.then(n,r)},PromiseReject(e){return Promise.reject(e)},PromiseResolve(e){return Promise.resolve(e)},ReflectApply:Reflect.apply,RegExpPrototypeTest(e,n){return e.test(n)},SafeSet:Set,String,StringPrototypeSlice(e,n,r){return e.slice(n,r)},StringPrototypeToLowerCase(e){return e.toLowerCase()},StringPrototypeToUpperCase(e){return e.toUpperCase()},StringPrototypeTrim(e){return e.trim()},Symbol,SymbolFor:Symbol.for,SymbolAsyncIterator:Symbol.asyncIterator,SymbolHasInstance:Symbol.hasInstance,SymbolIterator:Symbol.iterator,SymbolDispose:Symbol.dispose||Symbol("Symbol.dispose"),SymbolAsyncDispose:Symbol.asyncDispose||Symbol("Symbol.asyncDispose"),TypedArrayPrototypeSet(e,n,r){return e.set(n,r)},Boolean,Uint8Array},sf}var of={exports:{}},cf,l_;function Vx(){return l_||(l_=1,cf={format(t,...e){return t.replace(/%([sdifj])/g,function(...[n,r]){const s=e.shift();return r==="f"?s.toFixed(6):r==="j"?JSON.stringify(s):r==="s"&&typeof s=="object"?`${s.constructor!==Object?s.constructor.name:""} {}`.trim():s.toString()})},inspect(t){switch(typeof t){case"string":if(t.includes("'"))if(t.includes('"')){if(!t.includes("`")&&!t.includes("${"))return`\`${t}\``}else return`"${t}"`;return`'${t}'`;case"number":return isNaN(t)?"NaN":Object.is(t,-0)?String(t):t;case"bigint":return`${String(t)}n`;case"boolean":case"undefined":return String(t);case"object":return"{}"}}}),cf}var af,h_;function Lt(){if(h_)return af;h_=1;const{format:t,inspect:e}=Vx(),{AggregateError:n}=Je(),r=globalThis.AggregateError||n,s=Symbol("kIsNodeError"),i=["string","function","number","object","Function","Object","boolean","bigint","symbol"],o=/^([A-Z][a-z0-9]*)+$/,c="__node_internal_",a={};function u(g,m){if(!g)throw new a.ERR_INTERNAL_ASSERTION(m)}function h(g){let m="",_=g.length;const v=g[0]==="-"?1:0;for(;_>=v+4;_-=3)m=`_${g.slice(_-3,_)}${m}`;return`${g.slice(0,_)}${m}`}function l(g,m,_){if(typeof m=="function")return u(m.length<=_.length,`Code: ${g}; The provided arguments length (${_.length}) does not match the required ones (${m.length}).`),m(..._);const v=(m.match(/%[dfijoOs]/g)||[]).length;return u(v===_.length,`Code: ${g}; The provided arguments length (${_.length}) does not match the required ones (${v}).`),_.length===0?m:t(m,..._)}function d(g,m,_){_||(_=Error);class v extends _{constructor(...I){super(l(g,m,I))}toString(){return`${this.name} [${g}]: ${this.message}`}}Object.defineProperties(v.prototype,{name:{value:_.name,writable:!0,enumerable:!1,configurable:!0},toString:{value(){return`${this.name} [${g}]: ${this.message}`},writable:!0,enumerable:!1,configurable:!0}}),v.prototype.code=g,v.prototype[s]=!0,a[g]=v}function f(g){const m=c+g.name;return Object.defineProperty(g,"name",{value:m}),g}function p(g,m){if(g&&m&&g!==m){if(Array.isArray(m.errors))return m.errors.push(g),m;const _=new r([m,g],m.message);return _.code=m.code,_}return g||m}class w extends Error{constructor(m="The operation was aborted",_=void 0){if(_!==void 0&&typeof _!="object")throw new a.ERR_INVALID_ARG_TYPE("options","Object",_);super(m,_),this.code="ABORT_ERR",this.name="AbortError"}}return d("ERR_ASSERTION","%s",Error),d("ERR_INVALID_ARG_TYPE",(g,m,_)=>{u(typeof g=="string","'name' must be a string"),Array.isArray(m)||(m=[m]);let v="The ";g.endsWith(" argument")?v+=`${g} `:v+=`"${g}" ${g.includes(".")?"property":"argument"} `,v+="must be ";const k=[],I=[],A=[];for(const D of m)u(typeof D=="string","All expected entries have to be of type string"),i.includes(D)?k.push(D.toLowerCase()):o.test(D)?I.push(D):(u(D!=="object",'The value "object" should be written as "Object"'),A.push(D));if(I.length>0){const D=k.indexOf("object");D!==-1&&(k.splice(k,D,1),I.push("Object"))}if(k.length>0){switch(k.length){case 1:v+=`of type ${k[0]}`;break;case 2:v+=`one of type ${k[0]} or ${k[1]}`;break;default:{const D=k.pop();v+=`one of type ${k.join(", ")}, or ${D}`}}(I.length>0||A.length>0)&&(v+=" or ")}if(I.length>0){switch(I.length){case 1:v+=`an instance of ${I[0]}`;break;case 2:v+=`an instance of ${I[0]} or ${I[1]}`;break;default:{const D=I.pop();v+=`an instance of ${I.join(", ")}, or ${D}`}}A.length>0&&(v+=" or ")}switch(A.length){case 0:break;case 1:A[0].toLowerCase()!==A[0]&&(v+="an "),v+=`${A[0]}`;break;case 2:v+=`one of ${A[0]} or ${A[1]}`;break;default:{const D=A.pop();v+=`one of ${A.join(", ")}, or ${D}`}}if(_==null)v+=`. Received ${_}`;else if(typeof _=="function"&&_.name)v+=`. Received function ${_.name}`;else if(typeof _=="object"){var L;if((L=_.constructor)!==null&&L!==void 0&&L.name)v+=`. Received an instance of ${_.constructor.name}`;else{const D=e(_,{depth:-1});v+=`. Received ${D}`}}else{let D=e(_,{colors:!1});D.length>25&&(D=`${D.slice(0,25)}...`),v+=`. Received type ${typeof _} (${D})`}return v},TypeError),d("ERR_INVALID_ARG_VALUE",(g,m,_="is invalid")=>{let v=e(m);return v.length>128&&(v=v.slice(0,128)+"..."),`The ${g.includes(".")?"property":"argument"} '${g}' ${_}. Received ${v}`},TypeError),d("ERR_INVALID_RETURN_VALUE",(g,m,_)=>{var v;const k=_!=null&&(v=_.constructor)!==null&&v!==void 0&&v.name?`instance of ${_.constructor.name}`:`type ${typeof _}`;return`Expected ${g} to be returned from the "${m}" function but got ${k}.`},TypeError),d("ERR_MISSING_ARGS",(...g)=>{u(g.length>0,"At least one arg needs to be specified");let m;const _=g.length;switch(g=(Array.isArray(g)?g:[g]).map(v=>`"${v}"`).join(" or "),_){case 1:m+=`The ${g[0]} argument`;break;case 2:m+=`The ${g[0]} and ${g[1]} arguments`;break;default:{const v=g.pop();m+=`The ${g.join(", ")}, and ${v} arguments`}break}return`${m} must be specified`},TypeError),d("ERR_OUT_OF_RANGE",(g,m,_)=>{u(m,'Missing "range" argument');let v;if(Number.isInteger(_)&&Math.abs(_)>2**32)v=h(String(_));else if(typeof _=="bigint"){v=String(_);const k=BigInt(2)**BigInt(32);(_>k||_<-k)&&(v=h(v)),v+="n"}else v=e(_);return`The value of "${g}" is out of range. It must be ${m}. Received ${v}`},RangeError),d("ERR_MULTIPLE_CALLBACK","Callback called multiple times",Error),d("ERR_METHOD_NOT_IMPLEMENTED","The %s method is not implemented",Error),d("ERR_STREAM_ALREADY_FINISHED","Cannot call %s after a stream was finished",Error),d("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable",Error),d("ERR_STREAM_DESTROYED","Cannot call %s after a stream was destroyed",Error),d("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),d("ERR_STREAM_PREMATURE_CLOSE","Premature close",Error),d("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF",Error),d("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event",Error),d("ERR_STREAM_WRITE_AFTER_END","write after end",Error),d("ERR_UNKNOWN_ENCODING","Unknown encoding: %s",TypeError),af={AbortError:w,aggregateTwoErrors:f(p),hideStackFrames:f,codes:a},af}var oo={exports:{}},f_;function tc(){if(f_)return oo.exports;f_=1;const{AbortController:t,AbortSignal:e}=typeof self<"u"?self:typeof window<"u"?window:void 0;return oo.exports=t,oo.exports.AbortSignal=e,oo.exports.default=t,oo.exports}var d_;function Ut(){return d_||(d_=1,(function(t){const e=Yt(),{format:n,inspect:r}=Vx(),{codes:{ERR_INVALID_ARG_TYPE:s}}=Lt(),{kResistStopPropagation:i,AggregateError:o,SymbolDispose:c}=Je(),a=globalThis.AbortSignal||tc().AbortSignal,u=globalThis.AbortController||tc().AbortController,h=Object.getPrototypeOf(async function(){}).constructor,l=globalThis.Blob||e.Blob,d=typeof l<"u"?function(g){return g instanceof l}:function(g){return!1},f=(w,g)=>{if(w!==void 0&&(w===null||typeof w!="object"||!("aborted"in w)))throw new s(g,"AbortSignal",w)},p=(w,g)=>{if(typeof w!="function")throw new s(g,"Function",w)};t.exports={AggregateError:o,kEmptyObject:Object.freeze({}),once(w){let g=!1;return function(...m){g||(g=!0,w.apply(this,m))}},createDeferredPromise:function(){let w,g;return{promise:new Promise((_,v)=>{w=_,g=v}),resolve:w,reject:g}},promisify(w){return new Promise((g,m)=>{w((_,...v)=>_?m(_):g(...v))})},debuglog(){return function(){}},format:n,inspect:r,types:{isAsyncFunction(w){return w instanceof h},isArrayBufferView(w){return ArrayBuffer.isView(w)}},isBlob:d,deprecate(w,g){return w},addAbortListener:Ui().addAbortListener||function(g,m){if(g===void 0)throw new s("signal","AbortSignal",g);f(g,"signal"),p(m,"listener");let _;return g.aborted?queueMicrotask(()=>m()):(g.addEventListener("abort",m,{__proto__:null,once:!0,[i]:!0}),_=()=>{g.removeEventListener("abort",m)}),{__proto__:null,[c](){var v;(v=_)===null||v===void 0||v()}}},AbortSignalAny:a.any||function(g){if(g.length===1)return g[0];const m=new u,_=()=>m.abort();return g.forEach(v=>{f(v,"signals"),v.addEventListener("abort",_,{once:!0})}),m.signal.addEventListener("abort",()=>{g.forEach(v=>v.removeEventListener("abort",_))},{once:!0}),m.signal}},t.exports.promisify.custom=Symbol.for("nodejs.util.promisify.custom")})(of)),of.exports}var ra={},uf,p_;function Oc(){if(p_)return uf;p_=1;const{ArrayIsArray:t,ArrayPrototypeIncludes:e,ArrayPrototypeJoin:n,ArrayPrototypeMap:r,NumberIsInteger:s,NumberIsNaN:i,NumberMAX_SAFE_INTEGER:o,NumberMIN_SAFE_INTEGER:c,NumberParseInt:a,ObjectPrototypeHasOwnProperty:u,RegExpPrototypeExec:h,String:l,StringPrototypeToUpperCase:d,StringPrototypeTrim:f}=Je(),{hideStackFrames:p,codes:{ERR_SOCKET_BAD_PORT:w,ERR_INVALID_ARG_TYPE:g,ERR_INVALID_ARG_VALUE:m,ERR_OUT_OF_RANGE:_,ERR_UNKNOWN_SIGNAL:v}}=Lt(),{normalizeEncoding:k}=Ut(),{isAsyncFunction:I,isArrayBufferView:A}=Ut().types,L={};function D(j){return j===(j|0)}function K(j){return j===j>>>0}const O=/^[0-7]+$/,N="must be a 32-bit unsigned integer or an octal string";function W(j,oe,ae){if(typeof j>"u"&&(j=ae),typeof j=="string"){if(h(O,j)===null)throw new m(oe,j,N);j=a(j,8)}return T(j,oe),j}const q=p((j,oe,ae=c,re=o)=>{if(typeof j!="number")throw new g(oe,"number",j);if(!s(j))throw new _(oe,"an integer",j);if(j<ae||j>re)throw new _(oe,`>= ${ae} && <= ${re}`,j)}),te=p((j,oe,ae=-2147483648,re=2147483647)=>{if(typeof j!="number")throw new g(oe,"number",j);if(!s(j))throw new _(oe,"an integer",j);if(j<ae||j>re)throw new _(oe,`>= ${ae} && <= ${re}`,j)}),T=p((j,oe,ae=!1)=>{if(typeof j!="number")throw new g(oe,"number",j);if(!s(j))throw new _(oe,"an integer",j);const re=ae?1:0,Ne=4294967295;if(j<re||j>Ne)throw new _(oe,`>= ${re} && <= ${Ne}`,j)});function $(j,oe){if(typeof j!="string")throw new g(oe,"string",j)}function B(j,oe,ae=void 0,re){if(typeof j!="number")throw new g(oe,"number",j);if(ae!=null&&j<ae||re!=null&&j>re||(ae!=null||re!=null)&&i(j))throw new _(oe,`${ae!=null?`>= ${ae}`:""}${ae!=null&&re!=null?" && ":""}${re!=null?`<= ${re}`:""}`,j)}const S=p((j,oe,ae)=>{if(!e(ae,j)){const Ne="must be one of: "+n(r(ae,St=>typeof St=="string"?`'${St}'`:l(St)),", ");throw new m(oe,j,Ne)}});function R(j,oe){if(typeof j!="boolean")throw new g(oe,"boolean",j)}function E(j,oe,ae){return j==null||!u(j,oe)?ae:j[oe]}const P=p((j,oe,ae=null)=>{const re=E(ae,"allowArray",!1),Ne=E(ae,"allowFunction",!1);if(!E(ae,"nullable",!1)&&j===null||!re&&t(j)||typeof j!="object"&&(!Ne||typeof j!="function"))throw new g(oe,"Object",j)}),X=p((j,oe)=>{if(j!=null&&typeof j!="object"&&typeof j!="function")throw new g(oe,"a dictionary",j)}),H=p((j,oe,ae=0)=>{if(!t(j))throw new g(oe,"Array",j);if(j.length<ae){const re=`must be longer than ${ae}`;throw new m(oe,j,re)}});function G(j,oe){H(j,oe);for(let ae=0;ae<j.length;ae++)$(j[ae],`${oe}[${ae}]`)}function se(j,oe){H(j,oe);for(let ae=0;ae<j.length;ae++)R(j[ae],`${oe}[${ae}]`)}function ce(j,oe){H(j,oe);for(let ae=0;ae<j.length;ae++){const re=j[ae],Ne=`${oe}[${ae}]`;if(re==null)throw new g(Ne,"AbortSignal",re);we(re,Ne)}}function ue(j,oe="signal"){if($(j,oe),L[j]===void 0)throw L[d(j)]!==void 0?new v(j+" (signals must use all capital letters)"):new v(j)}const J=p((j,oe="buffer")=>{if(!A(j))throw new g(oe,["Buffer","TypedArray","DataView"],j)});function ne(j,oe){const ae=k(oe),re=j.length;if(ae==="hex"&&re%2!==0)throw new m("encoding",oe,`is invalid for data of length ${re}`)}function de(j,oe="Port",ae=!0){if(typeof j!="number"&&typeof j!="string"||typeof j=="string"&&f(j).length===0||+j!==+j>>>0||j>65535||j===0&&!ae)throw new w(oe,j,ae);return j|0}const we=p((j,oe)=>{if(j!==void 0&&(j===null||typeof j!="object"||!("aborted"in j)))throw new g(oe,"AbortSignal",j)}),be=p((j,oe)=>{if(typeof j!="function")throw new g(oe,"Function",j)}),U=p((j,oe)=>{if(typeof j!="function"||I(j))throw new g(oe,"Function",j)}),z=p((j,oe)=>{if(j!==void 0)throw new g(oe,"undefined",j)});function ee(j,oe,ae){if(!e(ae,j))throw new g(oe,`('${n(ae,"|")}')`,j)}const le=/^(?:<[^>]*>)(?:\s*;\s*[^;"\s]+(?:=(")?[^;"\s]*\1)?)*$/;function he(j,oe){if(typeof j>"u"||!h(le,j))throw new m(oe,j,'must be an array or string of format "</styles.css>; rel=preload; as=style"')}function fe(j){if(typeof j=="string")return he(j,"hints"),j;if(t(j)){const oe=j.length;let ae="";if(oe===0)return ae;for(let re=0;re<oe;re++){const Ne=j[re];he(Ne,"hints"),ae+=Ne,re!==oe-1&&(ae+=", ")}return ae}throw new m("hints",j,'must be an array or string of format "</styles.css>; rel=preload; as=style"')}return uf={isInt32:D,isUint32:K,parseFileMode:W,validateArray:H,validateStringArray:G,validateBooleanArray:se,validateAbortSignalArray:ce,validateBoolean:R,validateBuffer:J,validateDictionary:X,validateEncoding:ne,validateFunction:be,validateInt32:te,validateInteger:q,validateNumber:B,validateObject:P,validateOneOf:S,validatePlainFunction:U,validatePort:de,validateSignalName:ue,validateString:$,validateUint32:T,validateUndefined:z,validateUnion:ee,validateAbortSignal:we,validateLinkHeaderValue:fe},uf}var sa={exports:{}},lf={exports:{}},g_;function ws(){if(g_)return lf.exports;g_=1;var t=lf.exports={},e,n;function r(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?e=setTimeout:e=r}catch{e=r}try{typeof clearTimeout=="function"?n=clearTimeout:n=s}catch{n=s}})();function i(w){if(e===setTimeout)return setTimeout(w,0);if((e===r||!e)&&setTimeout)return e=setTimeout,setTimeout(w,0);try{return e(w,0)}catch{try{return e.call(null,w,0)}catch{return e.call(this,w,0)}}}function o(w){if(n===clearTimeout)return clearTimeout(w);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(w);try{return n(w)}catch{try{return n.call(null,w)}catch{return n.call(this,w)}}}var c=[],a=!1,u,h=-1;function l(){!a||!u||(a=!1,u.length?c=u.concat(c):h=-1,c.length&&d())}function d(){if(!a){var w=i(l);a=!0;for(var g=c.length;g;){for(u=c,c=[];++h<g;)u&&u[h].run();h=-1,g=c.length}u=null,a=!1,o(w)}}t.nextTick=function(w){var g=new Array(arguments.length-1);if(arguments.length>1)for(var m=1;m<arguments.length;m++)g[m-1]=arguments[m];c.push(new f(w,g)),c.length===1&&!a&&i(d)};function f(w,g){this.fun=w,this.array=g}f.prototype.run=function(){this.fun.apply(null,this.array)},t.title="browser",t.browser=!0,t.env={},t.argv=[],t.version="",t.versions={};function p(){}return t.on=p,t.addListener=p,t.once=p,t.off=p,t.removeListener=p,t.removeAllListeners=p,t.emit=p,t.prependListener=p,t.prependOnceListener=p,t.listeners=function(w){return[]},t.binding=function(w){throw new Error("process.binding is not supported")},t.cwd=function(){return"/"},t.chdir=function(w){throw new Error("process.chdir is not supported")},t.umask=function(){return 0},lf.exports}var hf,y_;function or(){if(y_)return hf;y_=1;const{SymbolAsyncIterator:t,SymbolIterator:e,SymbolFor:n}=Je(),r=n("nodejs.stream.destroyed"),s=n("nodejs.stream.errored"),i=n("nodejs.stream.readable"),o=n("nodejs.stream.writable"),c=n("nodejs.stream.disturbed"),a=n("nodejs.webstream.isClosedPromise"),u=n("nodejs.webstream.controllerErrorFunction");function h(E,P=!1){var X;return!!(E&&typeof E.pipe=="function"&&typeof E.on=="function"&&(!P||typeof E.pause=="function"&&typeof E.resume=="function")&&(!E._writableState||((X=E._readableState)===null||X===void 0?void 0:X.readable)!==!1)&&(!E._writableState||E._readableState))}function l(E){var P;return!!(E&&typeof E.write=="function"&&typeof E.on=="function"&&(!E._readableState||((P=E._writableState)===null||P===void 0?void 0:P.writable)!==!1))}function d(E){return!!(E&&typeof E.pipe=="function"&&E._readableState&&typeof E.on=="function"&&typeof E.write=="function")}function f(E){return E&&(E._readableState||E._writableState||typeof E.write=="function"&&typeof E.on=="function"||typeof E.pipe=="function"&&typeof E.on=="function")}function p(E){return!!(E&&!f(E)&&typeof E.pipeThrough=="function"&&typeof E.getReader=="function"&&typeof E.cancel=="function")}function w(E){return!!(E&&!f(E)&&typeof E.getWriter=="function"&&typeof E.abort=="function")}function g(E){return!!(E&&!f(E)&&typeof E.readable=="object"&&typeof E.writable=="object")}function m(E){return p(E)||w(E)||g(E)}function _(E,P){return E==null?!1:P===!0?typeof E[t]=="function":P===!1?typeof E[e]=="function":typeof E[t]=="function"||typeof E[e]=="function"}function v(E){if(!f(E))return null;const P=E._writableState,X=E._readableState,H=P||X;return!!(E.destroyed||E[r]||H!=null&&H.destroyed)}function k(E){if(!l(E))return null;if(E.writableEnded===!0)return!0;const P=E._writableState;return P!=null&&P.errored?!1:typeof P?.ended!="boolean"?null:P.ended}function I(E,P){if(!l(E))return null;if(E.writableFinished===!0)return!0;const X=E._writableState;return X!=null&&X.errored?!1:typeof X?.finished!="boolean"?null:!!(X.finished||P===!1&&X.ended===!0&&X.length===0)}function A(E){if(!h(E))return null;if(E.readableEnded===!0)return!0;const P=E._readableState;return!P||P.errored?!1:typeof P?.ended!="boolean"?null:P.ended}function L(E,P){if(!h(E))return null;const X=E._readableState;return X!=null&&X.errored?!1:typeof X?.endEmitted!="boolean"?null:!!(X.endEmitted||P===!1&&X.ended===!0&&X.length===0)}function D(E){return E&&E[i]!=null?E[i]:typeof E?.readable!="boolean"?null:v(E)?!1:h(E)&&E.readable&&!L(E)}function K(E){return E&&E[o]!=null?E[o]:typeof E?.writable!="boolean"?null:v(E)?!1:l(E)&&E.writable&&!k(E)}function O(E,P){return f(E)?v(E)?!0:!(P?.readable!==!1&&D(E)||P?.writable!==!1&&K(E)):null}function N(E){var P,X;return f(E)?E.writableErrored?E.writableErrored:(P=(X=E._writableState)===null||X===void 0?void 0:X.errored)!==null&&P!==void 0?P:null:null}function W(E){var P,X;return f(E)?E.readableErrored?E.readableErrored:(P=(X=E._readableState)===null||X===void 0?void 0:X.errored)!==null&&P!==void 0?P:null:null}function q(E){if(!f(E))return null;if(typeof E.closed=="boolean")return E.closed;const P=E._writableState,X=E._readableState;return typeof P?.closed=="boolean"||typeof X?.closed=="boolean"?P?.closed||X?.closed:typeof E._closed=="boolean"&&te(E)?E._closed:null}function te(E){return typeof E._closed=="boolean"&&typeof E._defaultKeepAlive=="boolean"&&typeof E._removedConnection=="boolean"&&typeof E._removedContLen=="boolean"}function T(E){return typeof E._sent100=="boolean"&&te(E)}function $(E){var P;return typeof E._consuming=="boolean"&&typeof E._dumped=="boolean"&&((P=E.req)===null||P===void 0?void 0:P.upgradeOrConnect)===void 0}function B(E){if(!f(E))return null;const P=E._writableState,X=E._readableState,H=P||X;return!H&&T(E)||!!(H&&H.autoDestroy&&H.emitClose&&H.closed===!1)}function S(E){var P;return!!(E&&((P=E[c])!==null&&P!==void 0?P:E.readableDidRead||E.readableAborted))}function R(E){var P,X,H,G,se,ce,ue,J,ne,de;return!!(E&&((P=(X=(H=(G=(se=(ce=E[s])!==null&&ce!==void 0?ce:E.readableErrored)!==null&&se!==void 0?se:E.writableErrored)!==null&&G!==void 0?G:(ue=E._readableState)===null||ue===void 0?void 0:ue.errorEmitted)!==null&&H!==void 0?H:(J=E._writableState)===null||J===void 0?void 0:J.errorEmitted)!==null&&X!==void 0?X:(ne=E._readableState)===null||ne===void 0?void 0:ne.errored)!==null&&P!==void 0?P:!((de=E._writableState)===null||de===void 0)&&de.errored))}return hf={isDestroyed:v,kIsDestroyed:r,isDisturbed:S,kIsDisturbed:c,isErrored:R,kIsErrored:s,isReadable:D,kIsReadable:i,kIsClosedPromise:a,kControllerErrorFunction:u,kIsWritable:o,isClosed:q,isDuplexNodeStream:d,isFinished:O,isIterable:_,isReadableNodeStream:h,isReadableStream:p,isReadableEnded:A,isReadableFinished:L,isReadableErrored:W,isNodeStream:f,isWebStream:m,isWritable:K,isWritableNodeStream:l,isWritableStream:w,isWritableEnded:k,isWritableFinished:I,isWritableErrored:N,isServerRequest:$,isServerResponse:T,willEmitClose:B,isTransformStream:g},hf}var m_;function vr(){if(m_)return sa.exports;m_=1;const t=ws(),{AbortError:e,codes:n}=Lt(),{ERR_INVALID_ARG_TYPE:r,ERR_STREAM_PREMATURE_CLOSE:s}=n,{kEmptyObject:i,once:o}=Ut(),{validateAbortSignal:c,validateFunction:a,validateObject:u,validateBoolean:h}=Oc(),{Promise:l,PromisePrototypeThen:d,SymbolDispose:f}=Je(),{isClosed:p,isReadable:w,isReadableNodeStream:g,isReadableStream:m,isReadableFinished:_,isReadableErrored:v,isWritable:k,isWritableNodeStream:I,isWritableStream:A,isWritableFinished:L,isWritableErrored:D,isNodeStream:K,willEmitClose:O,kIsClosedPromise:N}=or();let W;function q(S){return S.setHeader&&typeof S.abort=="function"}const te=()=>{};function T(S,R,E){var P,X;if(arguments.length===2?(E=R,R=i):R==null?R=i:u(R,"options"),a(E,"callback"),c(R.signal,"options.signal"),E=o(E),m(S)||A(S))return $(S,R,E);if(!K(S))throw new r("stream",["ReadableStream","WritableStream","Stream"],S);const H=(P=R.readable)!==null&&P!==void 0?P:g(S),G=(X=R.writable)!==null&&X!==void 0?X:I(S),se=S._writableState,ce=S._readableState,ue=()=>{S.writable||de()};let J=O(S)&&g(S)===H&&I(S)===G,ne=L(S,!1);const de=()=>{ne=!0,S.destroyed&&(J=!1),!(J&&(!S.readable||H))&&(!H||we)&&E.call(S)};let we=_(S,!1);const be=()=>{we=!0,S.destroyed&&(J=!1),!(J&&(!S.writable||G))&&(!G||ne)&&E.call(S)},U=j=>{E.call(S,j)};let z=p(S);const ee=()=>{z=!0;const j=D(S)||v(S);if(j&&typeof j!="boolean")return E.call(S,j);if(H&&!we&&g(S,!0)&&!_(S,!1))return E.call(S,new s);if(G&&!ne&&!L(S,!1))return E.call(S,new s);E.call(S)},le=()=>{z=!0;const j=D(S)||v(S);if(j&&typeof j!="boolean")return E.call(S,j);E.call(S)},he=()=>{S.req.on("finish",de)};q(S)?(S.on("complete",de),J||S.on("abort",ee),S.req?he():S.on("request",he)):G&&!se&&(S.on("end",ue),S.on("close",ue)),!J&&typeof S.aborted=="boolean"&&S.on("aborted",ee),S.on("end",be),S.on("finish",de),R.error!==!1&&S.on("error",U),S.on("close",ee),z?t.nextTick(ee):se!=null&&se.errorEmitted||ce!=null&&ce.errorEmitted?J||t.nextTick(le):(!H&&(!J||w(S))&&(ne||k(S)===!1)||!G&&(!J||k(S))&&(we||w(S)===!1)||ce&&S.req&&S.aborted)&&t.nextTick(le);const fe=()=>{E=te,S.removeListener("aborted",ee),S.removeListener("complete",de),S.removeListener("abort",ee),S.removeListener("request",he),S.req&&S.req.removeListener("finish",de),S.removeListener("end",ue),S.removeListener("close",ue),S.removeListener("finish",de),S.removeListener("end",be),S.removeListener("error",U),S.removeListener("close",ee)};if(R.signal&&!z){const j=()=>{const oe=E;fe(),oe.call(S,new e(void 0,{cause:R.signal.reason}))};if(R.signal.aborted)t.nextTick(j);else{W=W||Ut().addAbortListener;const oe=W(R.signal,j),ae=E;E=o((...re)=>{oe[f](),ae.apply(S,re)})}}return fe}function $(S,R,E){let P=!1,X=te;if(R.signal)if(X=()=>{P=!0,E.call(S,new e(void 0,{cause:R.signal.reason}))},R.signal.aborted)t.nextTick(X);else{W=W||Ut().addAbortListener;const G=W(R.signal,X),se=E;E=o((...ce)=>{G[f](),se.apply(S,ce)})}const H=(...G)=>{P||t.nextTick(()=>E.apply(S,G))};return d(S[N].promise,H,H),te}function B(S,R){var E;let P=!1;return R===null&&(R=i),(E=R)!==null&&E!==void 0&&E.cleanup&&(h(R.cleanup,"cleanup"),P=R.cleanup),new l((X,H)=>{const G=T(S,R,se=>{P&&G(),se?H(se):X()})})}return sa.exports=T,sa.exports.finished=B,sa.exports}var ff,w_;function Vi(){if(w_)return ff;w_=1;const t=ws(),{aggregateTwoErrors:e,codes:{ERR_MULTIPLE_CALLBACK:n},AbortError:r}=Lt(),{Symbol:s}=Je(),{kIsDestroyed:i,isDestroyed:o,isFinished:c,isServerRequest:a}=or(),u=s("kDestroy"),h=s("kConstruct");function l(O,N,W){O&&(O.stack,N&&!N.errored&&(N.errored=O),W&&!W.errored&&(W.errored=O))}function d(O,N){const W=this._readableState,q=this._writableState,te=q||W;return q!=null&&q.destroyed||W!=null&&W.destroyed?(typeof N=="function"&&N(),this):(l(O,q,W),q&&(q.destroyed=!0),W&&(W.destroyed=!0),te.constructed?f(this,O,N):this.once(u,function(T){f(this,e(T,O),N)}),this)}function f(O,N,W){let q=!1;function te(T){if(q)return;q=!0;const $=O._readableState,B=O._writableState;l(T,B,$),B&&(B.closed=!0),$&&($.closed=!0),typeof W=="function"&&W(T),T?t.nextTick(p,O,T):t.nextTick(w,O)}try{O._destroy(N||null,te)}catch(T){te(T)}}function p(O,N){g(O,N),w(O)}function w(O){const N=O._readableState,W=O._writableState;W&&(W.closeEmitted=!0),N&&(N.closeEmitted=!0),(W!=null&&W.emitClose||N!=null&&N.emitClose)&&O.emit("close")}function g(O,N){const W=O._readableState,q=O._writableState;q!=null&&q.errorEmitted||W!=null&&W.errorEmitted||(q&&(q.errorEmitted=!0),W&&(W.errorEmitted=!0),O.emit("error",N))}function m(){const O=this._readableState,N=this._writableState;O&&(O.constructed=!0,O.closed=!1,O.closeEmitted=!1,O.destroyed=!1,O.errored=null,O.errorEmitted=!1,O.reading=!1,O.ended=O.readable===!1,O.endEmitted=O.readable===!1),N&&(N.constructed=!0,N.destroyed=!1,N.closed=!1,N.closeEmitted=!1,N.errored=null,N.errorEmitted=!1,N.finalCalled=!1,N.prefinished=!1,N.ended=N.writable===!1,N.ending=N.writable===!1,N.finished=N.writable===!1)}function _(O,N,W){const q=O._readableState,te=O._writableState;if(te!=null&&te.destroyed||q!=null&&q.destroyed)return this;q!=null&&q.autoDestroy||te!=null&&te.autoDestroy?O.destroy(N):N&&(N.stack,te&&!te.errored&&(te.errored=N),q&&!q.errored&&(q.errored=N),W?t.nextTick(g,O,N):g(O,N))}function v(O,N){if(typeof O._construct!="function")return;const W=O._readableState,q=O._writableState;W&&(W.constructed=!1),q&&(q.constructed=!1),O.once(h,N),!(O.listenerCount(h)>1)&&t.nextTick(k,O)}function k(O){let N=!1;function W(q){if(N){_(O,q??new n);return}N=!0;const te=O._readableState,T=O._writableState,$=T||te;te&&(te.constructed=!0),T&&(T.constructed=!0),$.destroyed?O.emit(u,q):q?_(O,q,!0):t.nextTick(I,O)}try{O._construct(q=>{t.nextTick(W,q)})}catch(q){t.nextTick(W,q)}}function I(O){O.emit(h)}function A(O){return O?.setHeader&&typeof O.abort=="function"}function L(O){O.emit("close")}function D(O,N){O.emit("error",N),t.nextTick(L,O)}function K(O,N){!O||o(O)||(!N&&!c(O)&&(N=new r),a(O)?(O.socket=null,O.destroy(N)):A(O)?O.abort():A(O.req)?O.req.abort():typeof O.destroy=="function"?O.destroy(N):typeof O.close=="function"?O.close():N?t.nextTick(D,O,N):t.nextTick(L,O),O.destroyed||(O[i]=!0))}return ff={construct:v,destroyer:K,destroy:d,undestroy:m,errorOrDestroy:_},ff}var df,b_;function oy(){if(b_)return df;b_=1;const{ArrayIsArray:t,ObjectSetPrototypeOf:e}=Je(),{EventEmitter:n}=Ui();function r(i){n.call(this,i)}e(r.prototype,n.prototype),e(r,n),r.prototype.pipe=function(i,o){const c=this;function a(w){i.writable&&i.write(w)===!1&&c.pause&&c.pause()}c.on("data",a);function u(){c.readable&&c.resume&&c.resume()}i.on("drain",u),!i._isStdio&&(!o||o.end!==!1)&&(c.on("end",l),c.on("close",d));let h=!1;function l(){h||(h=!0,i.end())}function d(){h||(h=!0,typeof i.destroy=="function"&&i.destroy())}function f(w){p(),n.listenerCount(this,"error")===0&&this.emit("error",w)}s(c,"error",f),s(i,"error",f);function p(){c.removeListener("data",a),i.removeListener("drain",u),c.removeListener("end",l),c.removeListener("close",d),c.removeListener("error",f),i.removeListener("error",f),c.removeListener("end",p),c.removeListener("close",p),i.removeListener("close",p)}return c.on("end",p),c.on("close",p),i.on("close",p),i.emit("pipe",c),i};function s(i,o,c){if(typeof i.prependListener=="function")return i.prependListener(o,c);!i._events||!i._events[o]?i.on(o,c):t(i._events[o])?i._events[o].unshift(c):i._events[o]=[c,i._events[o]]}return df={Stream:r,prependListener:s},df}var pf={exports:{}},__;function Sl(){return __||(__=1,(function(t){const{SymbolDispose:e}=Je(),{AbortError:n,codes:r}=Lt(),{isNodeStream:s,isWebStream:i,kControllerErrorFunction:o}=or(),c=vr(),{ERR_INVALID_ARG_TYPE:a}=r;let u;const h=(l,d)=>{if(typeof l!="object"||!("aborted"in l))throw new a(d,"AbortSignal",l)};t.exports.addAbortSignal=function(d,f){if(h(d,"signal"),!s(f)&&!i(f))throw new a("stream",["ReadableStream","WritableStream","Stream"],f);return t.exports.addAbortSignalNoValidate(d,f)},t.exports.addAbortSignalNoValidate=function(l,d){if(typeof l!="object"||!("aborted"in l))return d;const f=s(d)?()=>{d.destroy(new n(void 0,{cause:l.reason}))}:()=>{d[o](new n(void 0,{cause:l.reason}))};if(l.aborted)f();else{u=u||Ut().addAbortListener;const p=u(l,f);c(d,p[e])}return d}})(pf)),pf.exports}var gf,S_;function T8(){if(S_)return gf;S_=1;const{StringPrototypeSlice:t,SymbolIterator:e,TypedArrayPrototypeSet:n,Uint8Array:r}=Je(),{Buffer:s}=Yt(),{inspect:i}=Ut();return gf=class{constructor(){this.head=null,this.tail=null,this.length=0}push(c){const a={data:c,next:null};this.length>0?this.tail.next=a:this.head=a,this.tail=a,++this.length}unshift(c){const a={data:c,next:this.head};this.length===0&&(this.tail=a),this.head=a,++this.length}shift(){if(this.length===0)return;const c=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,c}clear(){this.head=this.tail=null,this.length=0}join(c){if(this.length===0)return"";let a=this.head,u=""+a.data;for(;(a=a.next)!==null;)u+=c+a.data;return u}concat(c){if(this.length===0)return s.alloc(0);const a=s.allocUnsafe(c>>>0);let u=this.head,h=0;for(;u;)n(a,u.data,h),h+=u.data.length,u=u.next;return a}consume(c,a){const u=this.head.data;if(c<u.length){const h=u.slice(0,c);return this.head.data=u.slice(c),h}return c===u.length?this.shift():a?this._getString(c):this._getBuffer(c)}first(){return this.head.data}*[e](){for(let c=this.head;c;c=c.next)yield c.data}_getString(c){let a="",u=this.head,h=0;do{const l=u.data;if(c>l.length)a+=l,c-=l.length;else{c===l.length?(a+=l,++h,u.next?this.head=u.next:this.head=this.tail=null):(a+=t(l,0,c),this.head=u,u.data=t(l,c));break}++h}while((u=u.next)!==null);return this.length-=h,a}_getBuffer(c){const a=s.allocUnsafe(c),u=c;let h=this.head,l=0;do{const d=h.data;if(c>d.length)n(a,d,u-c),c-=d.length;else{c===d.length?(n(a,d,u-c),++l,h.next?this.head=h.next:this.head=this.tail=null):(n(a,new r(d.buffer,d.byteOffset,c),u-c),this.head=h,h.data=d.slice(c));break}++l}while((h=h.next)!==null);return this.length-=l,a}[Symbol.for("nodejs.util.inspect.custom")](c,a){return i(this,{...a,depth:0,customInspect:!1})}},gf}var yf,E_;function El(){if(E_)return yf;E_=1;const{MathFloor:t,NumberIsInteger:e}=Je(),{validateInteger:n}=Oc(),{ERR_INVALID_ARG_VALUE:r}=Lt().codes;let s=16*1024,i=16;function o(h,l,d){return h.highWaterMark!=null?h.highWaterMark:l?h[d]:null}function c(h){return h?i:s}function a(h,l){n(l,"value",0),h?i=l:s=l}function u(h,l,d,f){const p=o(l,f,d);if(p!=null){if(!e(p)||p<0){const w=f?`options.${d}`:"options.highWaterMark";throw new r(w,p)}return t(p)}return c(h.objectMode)}return yf={getHighWaterMark:u,getDefaultHighWaterMark:c,setDefaultHighWaterMark:a},yf}var mf={},ia={exports:{}};var v_;function A8(){return v_||(v_=1,(function(t,e){var n=Yt(),r=n.Buffer;function s(o,c){for(var a in o)c[a]=o[a]}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?t.exports=n:(s(n,e),e.Buffer=i);function i(o,c,a){return r(o,c,a)}i.prototype=Object.create(r.prototype),s(r,i),i.from=function(o,c,a){if(typeof o=="number")throw new TypeError("Argument must not be a number");return r(o,c,a)},i.alloc=function(o,c,a){if(typeof o!="number")throw new TypeError("Argument must be a number");var u=r(o);return c!==void 0?typeof a=="string"?u.fill(c,a):u.fill(c):u.fill(0),u},i.allocUnsafe=function(o){if(typeof o!="number")throw new TypeError("Argument must be a number");return r(o)},i.allocUnsafeSlow=function(o){if(typeof o!="number")throw new TypeError("Argument must be a number");return n.SlowBuffer(o)}})(ia,ia.exports)),ia.exports}var k_;function R8(){if(k_)return mf;k_=1;var t=A8().Buffer,e=t.isEncoding||function(m){switch(m=""+m,m&&m.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function n(m){if(!m)return"utf8";for(var _;;)switch(m){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return m;default:if(_)return;m=(""+m).toLowerCase(),_=!0}}function r(m){var _=n(m);if(typeof _!="string"&&(t.isEncoding===e||!e(m)))throw new Error("Unknown encoding: "+m);return _||m}mf.StringDecoder=s;function s(m){this.encoding=r(m);var _;switch(this.encoding){case"utf16le":this.text=l,this.end=d,_=4;break;case"utf8":this.fillLast=a,_=4;break;case"base64":this.text=f,this.end=p,_=3;break;default:this.write=w,this.end=g;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=t.allocUnsafe(_)}s.prototype.write=function(m){if(m.length===0)return"";var _,v;if(this.lastNeed){if(_=this.fillLast(m),_===void 0)return"";v=this.lastNeed,this.lastNeed=0}else v=0;return v<m.length?_?_+this.text(m,v):this.text(m,v):_||""},s.prototype.end=h,s.prototype.text=u,s.prototype.fillLast=function(m){if(this.lastNeed<=m.length)return m.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);m.copy(this.lastChar,this.lastTotal-this.lastNeed,0,m.length),this.lastNeed-=m.length};function i(m){return m<=127?0:m>>5===6?2:m>>4===14?3:m>>3===30?4:m>>6===2?-1:-2}function o(m,_,v){var k=_.length-1;if(k<v)return 0;var I=i(_[k]);return I>=0?(I>0&&(m.lastNeed=I-1),I):--k<v||I===-2?0:(I=i(_[k]),I>=0?(I>0&&(m.lastNeed=I-2),I):--k<v||I===-2?0:(I=i(_[k]),I>=0?(I>0&&(I===2?I=0:m.lastNeed=I-3),I):0))}function c(m,_,v){if((_[0]&192)!==128)return m.lastNeed=0,"ï¿½";if(m.lastNeed>1&&_.length>1){if((_[1]&192)!==128)return m.lastNeed=1,"ï¿½";if(m.lastNeed>2&&_.length>2&&(_[2]&192)!==128)return m.lastNeed=2,"ï¿½"}}function a(m){var _=this.lastTotal-this.lastNeed,v=c(this,m);if(v!==void 0)return v;if(this.lastNeed<=m.length)return m.copy(this.lastChar,_,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);m.copy(this.lastChar,_,0,m.length),this.lastNeed-=m.length}function u(m,_){var v=o(this,m,_);if(!this.lastNeed)return m.toString("utf8",_);this.lastTotal=v;var k=m.length-(v-this.lastNeed);return m.copy(this.lastChar,0,k),m.toString("utf8",_,k)}function h(m){var _=m&&m.length?this.write(m):"";return this.lastNeed?_+"ï¿½":_}function l(m,_){if((m.length-_)%2===0){var v=m.toString("utf16le",_);if(v){var k=v.charCodeAt(v.length-1);if(k>=55296&&k<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=m[m.length-2],this.lastChar[1]=m[m.length-1],v.slice(0,-1)}return v}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=m[m.length-1],m.toString("utf16le",_,m.length-1)}function d(m){var _=m&&m.length?this.write(m):"";if(this.lastNeed){var v=this.lastTotal-this.lastNeed;return _+this.lastChar.toString("utf16le",0,v)}return _}function f(m,_){var v=(m.length-_)%3;return v===0?m.toString("base64",_):(this.lastNeed=3-v,this.lastTotal=3,v===1?this.lastChar[0]=m[m.length-1]:(this.lastChar[0]=m[m.length-2],this.lastChar[1]=m[m.length-1]),m.toString("base64",_,m.length-v))}function p(m){var _=m&&m.length?this.write(m):"";return this.lastNeed?_+this.lastChar.toString("base64",0,3-this.lastNeed):_}function w(m){return m.toString(this.encoding)}function g(m){return m&&m.length?this.write(m):""}return mf}var wf,x_;function jx(){if(x_)return wf;x_=1;const t=ws(),{PromisePrototypeThen:e,SymbolAsyncIterator:n,SymbolIterator:r}=Je(),{Buffer:s}=Yt(),{ERR_INVALID_ARG_TYPE:i,ERR_STREAM_NULL_VALUES:o}=Lt().codes;function c(a,u,h){let l;if(typeof u=="string"||u instanceof s)return new a({objectMode:!0,...h,read(){this.push(u),this.push(null)}});let d;if(u&&u[n])d=!0,l=u[n]();else if(u&&u[r])d=!1,l=u[r]();else throw new i("iterable",["Iterable"],u);const f=new a({objectMode:!0,highWaterMark:1,...h});let p=!1;f._read=function(){p||(p=!0,g())},f._destroy=function(m,_){e(w(m),()=>t.nextTick(_,m),v=>t.nextTick(_,v||m))};async function w(m){const _=m!=null,v=typeof l.throw=="function";if(_&&v){const{value:k,done:I}=await l.throw(m);if(await k,I)return}if(typeof l.return=="function"){const{value:k}=await l.return();await k}}async function g(){for(;;){try{const{value:m,done:_}=d?await l.next():l.next();if(_)f.push(null);else{const v=m&&typeof m.then=="function"?await m:m;if(v===null)throw p=!1,new o;if(f.push(v))continue;p=!1}}catch(m){f.destroy(m)}break}}return f}return wf=c,wf}var bf,I_;function vl(){if(I_)return bf;I_=1;const t=ws(),{ArrayPrototypeIndexOf:e,NumberIsInteger:n,NumberIsNaN:r,NumberParseInt:s,ObjectDefineProperties:i,ObjectKeys:o,ObjectSetPrototypeOf:c,Promise:a,SafeSet:u,SymbolAsyncDispose:h,SymbolAsyncIterator:l,Symbol:d}=Je();bf=re,re.ReadableState=ae;const{EventEmitter:f}=Ui(),{Stream:p,prependListener:w}=oy(),{Buffer:g}=Yt(),{addAbortSignal:m}=Sl(),_=vr();let v=Ut().debuglog("stream",C=>{v=C});const k=T8(),I=Vi(),{getHighWaterMark:A,getDefaultHighWaterMark:L}=El(),{aggregateTwoErrors:D,codes:{ERR_INVALID_ARG_TYPE:K,ERR_METHOD_NOT_IMPLEMENTED:O,ERR_OUT_OF_RANGE:N,ERR_STREAM_PUSH_AFTER_EOF:W,ERR_STREAM_UNSHIFT_AFTER_END_EVENT:q},AbortError:te}=Lt(),{validateObject:T}=Oc(),$=d("kPaused"),{StringDecoder:B}=R8(),S=jx();c(re.prototype,p.prototype),c(re,p);const R=()=>{},{errorOrDestroy:E}=I,P=1,X=2,H=4,G=8,se=16,ce=32,ue=64,J=128,ne=256,de=512,we=1024,be=2048,U=4096,z=8192,ee=16384,le=32768,he=65536,fe=1<<17,j=1<<18;function oe(C){return{enumerable:!1,get(){return(this.state&C)!==0},set(F){F?this.state|=C:this.state&=~C}}}i(ae.prototype,{objectMode:oe(P),ended:oe(X),endEmitted:oe(H),reading:oe(G),constructed:oe(se),sync:oe(ce),needReadable:oe(ue),emittedReadable:oe(J),readableListening:oe(ne),resumeScheduled:oe(de),errorEmitted:oe(we),emitClose:oe(be),autoDestroy:oe(U),destroyed:oe(z),closed:oe(ee),closeEmitted:oe(le),multiAwaitDrain:oe(he),readingMore:oe(fe),dataEmitted:oe(j)});function ae(C,F,pe){typeof pe!="boolean"&&(pe=F instanceof tr()),this.state=be|U|se|ce,C&&C.objectMode&&(this.state|=P),pe&&C&&C.readableObjectMode&&(this.state|=P),this.highWaterMark=C?A(this,C,"readableHighWaterMark",pe):L(!1),this.buffer=new k,this.length=0,this.pipes=[],this.flowing=null,this[$]=null,C&&C.emitClose===!1&&(this.state&=~be),C&&C.autoDestroy===!1&&(this.state&=~U),this.errored=null,this.defaultEncoding=C&&C.defaultEncoding||"utf8",this.awaitDrainWriters=null,this.decoder=null,this.encoding=null,C&&C.encoding&&(this.decoder=new B(C.encoding),this.encoding=C.encoding)}function re(C){if(!(this instanceof re))return new re(C);const F=this instanceof tr();this._readableState=new ae(C,this,F),C&&(typeof C.read=="function"&&(this._read=C.read),typeof C.destroy=="function"&&(this._destroy=C.destroy),typeof C.construct=="function"&&(this._construct=C.construct),C.signal&&!F&&m(C.signal,this)),p.call(this,C),I.construct(this,()=>{this._readableState.needReadable&&V(this,this._readableState)})}re.prototype.destroy=I.destroy,re.prototype._undestroy=I.undestroy,re.prototype._destroy=function(C,F){F(C)},re.prototype[f.captureRejectionSymbol]=function(C){this.destroy(C)},re.prototype[h]=function(){let C;return this.destroyed||(C=this.readableEnded?null:new te,this.destroy(C)),new a((F,pe)=>_(this,ge=>ge&&ge!==C?pe(ge):F(null)))},re.prototype.push=function(C,F){return Ne(this,C,F,!1)},re.prototype.unshift=function(C,F){return Ne(this,C,F,!0)};function Ne(C,F,pe,ge){v("readableAddChunk",F);const _e=C._readableState;let Et;if((_e.state&P)===0&&(typeof F=="string"?(pe=pe||_e.defaultEncoding,_e.encoding!==pe&&(ge&&_e.encoding?F=g.from(F,pe).toString(_e.encoding):(F=g.from(F,pe),pe=""))):F instanceof g?pe="":p._isUint8Array(F)?(F=p._uint8ArrayToBuffer(F),pe=""):F!=null&&(Et=new K("chunk",["string","Buffer","Uint8Array"],F))),Et)E(C,Et);else if(F===null)_e.state&=~G,y(C,_e);else if((_e.state&P)!==0||F&&F.length>0)if(ge)if((_e.state&H)!==0)E(C,new q);else{if(_e.destroyed||_e.errored)return!1;St(C,_e,F,!0)}else if(_e.ended)E(C,new W);else{if(_e.destroyed||_e.errored)return!1;_e.state&=~G,_e.decoder&&!pe?(F=_e.decoder.write(F),_e.objectMode||F.length!==0?St(C,_e,F,!1):V(C,_e)):St(C,_e,F,!1)}else ge||(_e.state&=~G,V(C,_e));return!_e.ended&&(_e.length<_e.highWaterMark||_e.length===0)}function St(C,F,pe,ge){F.flowing&&F.length===0&&!F.sync&&C.listenerCount("data")>0?((F.state&he)!==0?F.awaitDrainWriters.clear():F.awaitDrainWriters=null,F.dataEmitted=!0,C.emit("data",pe)):(F.length+=F.objectMode?1:pe.length,ge?F.buffer.unshift(pe):F.buffer.push(pe),(F.state&ue)!==0&&b(C)),V(C,F)}re.prototype.isPaused=function(){const C=this._readableState;return C[$]===!0||C.flowing===!1},re.prototype.setEncoding=function(C){const F=new B(C);this._readableState.decoder=F,this._readableState.encoding=this._readableState.decoder.encoding;const pe=this._readableState.buffer;let ge="";for(const _e of pe)ge+=F.write(_e);return pe.clear(),ge!==""&&pe.push(ge),this._readableState.length=ge.length,this};const Oe=1073741824;function It(C){if(C>Oe)throw new N("size","<= 1GiB",C);return C--,C|=C>>>1,C|=C>>>2,C|=C>>>4,C|=C>>>8,C|=C>>>16,C++,C}function x(C,F){return C<=0||F.length===0&&F.ended?0:(F.state&P)!==0?1:r(C)?F.flowing&&F.length?F.buffer.first().length:F.length:C<=F.length?C:F.ended?F.length:0}re.prototype.read=function(C){v("read",C),C===void 0?C=NaN:n(C)||(C=s(C,10));const F=this._readableState,pe=C;if(C>F.highWaterMark&&(F.highWaterMark=It(C)),C!==0&&(F.state&=~J),C===0&&F.needReadable&&((F.highWaterMark!==0?F.length>=F.highWaterMark:F.length>0)||F.ended))return v("read: emitReadable",F.length,F.ended),F.length===0&&F.ended?Il(this):b(this),null;if(C=x(C,F),C===0&&F.ended)return F.length===0&&Il(this),null;let ge=(F.state&ue)!==0;if(v("need readable",ge),(F.length===0||F.length-C<F.highWaterMark)&&(ge=!0,v("length less than watermark",ge)),F.ended||F.reading||F.destroyed||F.errored||!F.constructed)ge=!1,v("reading, ended or constructing",ge);else if(ge){v("do read"),F.state|=G|ce,F.length===0&&(F.state|=ue);try{this._read(F.highWaterMark)}catch(Et){E(this,Et)}F.state&=~ce,F.reading||(C=x(pe,F))}let _e;return C>0?_e=my(C,F):_e=null,_e===null?(F.needReadable=F.length<=F.highWaterMark,C=0):(F.length-=C,F.multiAwaitDrain?F.awaitDrainWriters.clear():F.awaitDrainWriters=null),F.length===0&&(F.ended||(F.needReadable=!0),pe!==C&&F.ended&&Il(this)),_e!==null&&!F.errorEmitted&&!F.closeEmitted&&(F.dataEmitted=!0,this.emit("data",_e)),_e};function y(C,F){if(v("onEofChunk"),!F.ended){if(F.decoder){const pe=F.decoder.end();pe&&pe.length&&(F.buffer.push(pe),F.length+=F.objectMode?1:pe.length)}F.ended=!0,F.sync?b(C):(F.needReadable=!1,F.emittedReadable=!0,M(C))}}function b(C){const F=C._readableState;v("emitReadable",F.needReadable,F.emittedReadable),F.needReadable=!1,F.emittedReadable||(v("emitReadable",F.flowing),F.emittedReadable=!0,t.nextTick(M,C))}function M(C){const F=C._readableState;v("emitReadable_",F.destroyed,F.length,F.ended),!F.destroyed&&!F.errored&&(F.length||F.ended)&&(C.emit("readable"),F.emittedReadable=!1),F.needReadable=!F.flowing&&!F.ended&&F.length<=F.highWaterMark,qe(C)}function V(C,F){!F.readingMore&&F.constructed&&(F.readingMore=!0,t.nextTick(Y,C,F))}function Y(C,F){for(;!F.reading&&!F.ended&&(F.length<F.highWaterMark||F.flowing&&F.length===0);){const pe=F.length;if(v("maybeReadMore read 0"),C.read(0),pe===F.length)break}F.readingMore=!1}re.prototype._read=function(C){throw new O("_read()")},re.prototype.pipe=function(C,F){const pe=this,ge=this._readableState;ge.pipes.length===1&&(ge.multiAwaitDrain||(ge.multiAwaitDrain=!0,ge.awaitDrainWriters=new u(ge.awaitDrainWriters?[ge.awaitDrainWriters]:[]))),ge.pipes.push(C),v("pipe count=%d opts=%j",ge.pipes.length,F);const Et=(!F||F.end!==!1)&&C!==t.stdout&&C!==t.stderr?by:ji;ge.endEmitted?t.nextTick(Et):pe.once("end",Et),C.on("unpipe",Xt);function Xt(xr,Rn){v("onunpipe"),xr===pe&&Rn&&Rn.hasUnpiped===!1&&(Rn.hasUnpiped=!0,hI())}function by(){v("onend"),C.end()}let kr,_y=!1;function hI(){v("cleanup"),C.removeListener("close",Rl),C.removeListener("finish",Cl),kr&&C.removeListener("drain",kr),C.removeListener("error",Al),C.removeListener("unpipe",Xt),pe.removeListener("end",by),pe.removeListener("end",ji),pe.removeListener("data",Ey),_y=!0,kr&&ge.awaitDrainWriters&&(!C._writableState||C._writableState.needDrain)&&kr()}function Sy(){_y||(ge.pipes.length===1&&ge.pipes[0]===C?(v("false write response, pause",0),ge.awaitDrainWriters=C,ge.multiAwaitDrain=!1):ge.pipes.length>1&&ge.pipes.includes(C)&&(v("false write response, pause",ge.awaitDrainWriters.size),ge.awaitDrainWriters.add(C)),pe.pause()),kr||(kr=ie(pe,C),C.on("drain",kr))}pe.on("data",Ey);function Ey(xr){v("ondata");const Rn=C.write(xr);v("dest.write",Rn),Rn===!1&&Sy()}function Al(xr){if(v("onerror",xr),ji(),C.removeListener("error",Al),C.listenerCount("error")===0){const Rn=C._writableState||C._readableState;Rn&&!Rn.errorEmitted?E(C,xr):C.emit("error",xr)}}w(C,"error",Al);function Rl(){C.removeListener("finish",Cl),ji()}C.once("close",Rl);function Cl(){v("onfinish"),C.removeListener("close",Rl),ji()}C.once("finish",Cl);function ji(){v("unpipe"),pe.unpipe(C)}return C.emit("pipe",pe),C.writableNeedDrain===!0?Sy():ge.flowing||(v("pipe resume"),pe.resume()),C};function ie(C,F){return function(){const ge=C._readableState;ge.awaitDrainWriters===F?(v("pipeOnDrain",1),ge.awaitDrainWriters=null):ge.multiAwaitDrain&&(v("pipeOnDrain",ge.awaitDrainWriters.size),ge.awaitDrainWriters.delete(F)),(!ge.awaitDrainWriters||ge.awaitDrainWriters.size===0)&&C.listenerCount("data")&&C.resume()}}re.prototype.unpipe=function(C){const F=this._readableState,pe={hasUnpiped:!1};if(F.pipes.length===0)return this;if(!C){const _e=F.pipes;F.pipes=[],this.pause();for(let Et=0;Et<_e.length;Et++)_e[Et].emit("unpipe",this,{hasUnpiped:!1});return this}const ge=e(F.pipes,C);return ge===-1?this:(F.pipes.splice(ge,1),F.pipes.length===0&&this.pause(),C.emit("unpipe",this,pe),this)},re.prototype.on=function(C,F){const pe=p.prototype.on.call(this,C,F),ge=this._readableState;return C==="data"?(ge.readableListening=this.listenerCount("readable")>0,ge.flowing!==!1&&this.resume()):C==="readable"&&!ge.endEmitted&&!ge.readableListening&&(ge.readableListening=ge.needReadable=!0,ge.flowing=!1,ge.emittedReadable=!1,v("on readable",ge.length,ge.reading),ge.length?b(this):ge.reading||t.nextTick(ze,this)),pe},re.prototype.addListener=re.prototype.on,re.prototype.removeListener=function(C,F){const pe=p.prototype.removeListener.call(this,C,F);return C==="readable"&&t.nextTick(ke,this),pe},re.prototype.off=re.prototype.removeListener,re.prototype.removeAllListeners=function(C){const F=p.prototype.removeAllListeners.apply(this,arguments);return(C==="readable"||C===void 0)&&t.nextTick(ke,this),F};function ke(C){const F=C._readableState;F.readableListening=C.listenerCount("readable")>0,F.resumeScheduled&&F[$]===!1?F.flowing=!0:C.listenerCount("data")>0?C.resume():F.readableListening||(F.flowing=null)}function ze(C){v("readable nexttick read 0"),C.read(0)}re.prototype.resume=function(){const C=this._readableState;return C.flowing||(v("resume"),C.flowing=!C.readableListening,je(this,C)),C[$]=!1,this};function je(C,F){F.resumeScheduled||(F.resumeScheduled=!0,t.nextTick(He,C,F))}function He(C,F){v("resume",F.reading),F.reading||C.read(0),F.resumeScheduled=!1,C.emit("resume"),qe(C),F.flowing&&!F.reading&&C.read(0)}re.prototype.pause=function(){return v("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(v("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState[$]=!0,this};function qe(C){const F=C._readableState;for(v("flow",F.flowing);F.flowing&&C.read()!==null;);}re.prototype.wrap=function(C){let F=!1;C.on("data",ge=>{!this.push(ge)&&C.pause&&(F=!0,C.pause())}),C.on("end",()=>{this.push(null)}),C.on("error",ge=>{E(this,ge)}),C.on("close",()=>{this.destroy()}),C.on("destroy",()=>{this.destroy()}),this._read=()=>{F&&C.resume&&(F=!1,C.resume())};const pe=o(C);for(let ge=1;ge<pe.length;ge++){const _e=pe[ge];this[_e]===void 0&&typeof C[_e]=="function"&&(this[_e]=C[_e].bind(C))}return this},re.prototype[l]=function(){return yy(this)},re.prototype.iterator=function(C){return C!==void 0&&T(C,"options"),yy(this,C)};function yy(C,F){typeof C.read!="function"&&(C=re.wrap(C,{objectMode:!0}));const pe=aI(C,F);return pe.stream=C,pe}async function*aI(C,F){let pe=R;function ge(Xt){this===C?(pe(),pe=R):pe=Xt}C.on("readable",ge);let _e;const Et=_(C,{writable:!1},Xt=>{_e=Xt?D(_e,Xt):null,pe(),pe=R});try{for(;;){const Xt=C.destroyed?null:C.read();if(Xt!==null)yield Xt;else{if(_e)throw _e;if(_e===null)return;await new a(ge)}}}catch(Xt){throw _e=D(_e,Xt),_e}finally{(_e||F?.destroyOnReturn!==!1)&&(_e===void 0||C._readableState.autoDestroy)?I.destroyer(C,null):(C.off("readable",ge),Et())}}i(re.prototype,{readable:{__proto__:null,get(){const C=this._readableState;return!!C&&C.readable!==!1&&!C.destroyed&&!C.errorEmitted&&!C.endEmitted},set(C){this._readableState&&(this._readableState.readable=!!C)}},readableDidRead:{__proto__:null,enumerable:!1,get:function(){return this._readableState.dataEmitted}},readableAborted:{__proto__:null,enumerable:!1,get:function(){return!!(this._readableState.readable!==!1&&(this._readableState.destroyed||this._readableState.errored)&&!this._readableState.endEmitted)}},readableHighWaterMark:{__proto__:null,enumerable:!1,get:function(){return this._readableState.highWaterMark}},readableBuffer:{__proto__:null,enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}},readableFlowing:{__proto__:null,enumerable:!1,get:function(){return this._readableState.flowing},set:function(C){this._readableState&&(this._readableState.flowing=C)}},readableLength:{__proto__:null,enumerable:!1,get(){return this._readableState.length}},readableObjectMode:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.objectMode:!1}},readableEncoding:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.encoding:null}},errored:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.errored:null}},closed:{__proto__:null,get(){return this._readableState?this._readableState.closed:!1}},destroyed:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.destroyed:!1},set(C){this._readableState&&(this._readableState.destroyed=C)}},readableEnded:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.endEmitted:!1}}}),i(ae.prototype,{pipesCount:{__proto__:null,get(){return this.pipes.length}},paused:{__proto__:null,get(){return this[$]!==!1},set(C){this[$]=!!C}}}),re._fromList=my;function my(C,F){if(F.length===0)return null;let pe;return F.objectMode?pe=F.buffer.shift():!C||C>=F.length?(F.decoder?pe=F.buffer.join(""):F.buffer.length===1?pe=F.buffer.first():pe=F.buffer.concat(F.length),F.buffer.clear()):pe=F.buffer.consume(C,F.decoder),pe}function Il(C){const F=C._readableState;v("endReadable",F.endEmitted),F.endEmitted||(F.ended=!0,t.nextTick(uI,F,C))}function uI(C,F){if(v("endReadableNT",C.endEmitted,C.length),!C.errored&&!C.closeEmitted&&!C.endEmitted&&C.length===0){if(C.endEmitted=!0,F.emit("end"),F.writable&&F.allowHalfOpen===!1)t.nextTick(lI,F);else if(C.autoDestroy){const pe=F._writableState;(!pe||pe.autoDestroy&&(pe.finished||pe.writable===!1))&&F.destroy()}}}function lI(C){C.writable&&!C.writableEnded&&!C.destroyed&&C.end()}re.from=function(C,F){return S(re,C,F)};let Tl;function wy(){return Tl===void 0&&(Tl={}),Tl}return re.fromWeb=function(C,F){return wy().newStreamReadableFromReadableStream(C,F)},re.toWeb=function(C,F){return wy().newReadableStreamFromStreamReadable(C,F)},re.wrap=function(C,F){var pe,ge;return new re({objectMode:(pe=(ge=C.readableObjectMode)!==null&&ge!==void 0?ge:C.objectMode)!==null&&pe!==void 0?pe:!0,...F,destroy(_e,Et){I.destroyer(C,_e),Et(_e)}}).wrap(C)},bf}var _f,T_;function cy(){if(T_)return _f;T_=1;const t=ws(),{ArrayPrototypeSlice:e,Error:n,FunctionPrototypeSymbolHasInstance:r,ObjectDefineProperty:s,ObjectDefineProperties:i,ObjectSetPrototypeOf:o,StringPrototypeToLowerCase:c,Symbol:a,SymbolHasInstance:u}=Je();_f=T,T.WritableState=q;const{EventEmitter:h}=Ui(),l=oy().Stream,{Buffer:d}=Yt(),f=Vi(),{addAbortSignal:p}=Sl(),{getHighWaterMark:w,getDefaultHighWaterMark:g}=El(),{ERR_INVALID_ARG_TYPE:m,ERR_METHOD_NOT_IMPLEMENTED:_,ERR_MULTIPLE_CALLBACK:v,ERR_STREAM_CANNOT_PIPE:k,ERR_STREAM_DESTROYED:I,ERR_STREAM_ALREADY_FINISHED:A,ERR_STREAM_NULL_VALUES:L,ERR_STREAM_WRITE_AFTER_END:D,ERR_UNKNOWN_ENCODING:K}=Lt().codes,{errorOrDestroy:O}=f;o(T.prototype,l.prototype),o(T,l);function N(){}const W=a("kOnFinished");function q(U,z,ee){typeof ee!="boolean"&&(ee=z instanceof tr()),this.objectMode=!!(U&&U.objectMode),ee&&(this.objectMode=this.objectMode||!!(U&&U.writableObjectMode)),this.highWaterMark=U?w(this,U,"writableHighWaterMark",ee):g(!1),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;const le=!!(U&&U.decodeStrings===!1);this.decodeStrings=!le,this.defaultEncoding=U&&U.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=E.bind(void 0,z),this.writecb=null,this.writelen=0,this.afterWriteTickInfo=null,te(this),this.pendingcb=0,this.constructed=!0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!U||U.emitClose!==!1,this.autoDestroy=!U||U.autoDestroy!==!1,this.errored=null,this.closed=!1,this.closeEmitted=!1,this[W]=[]}function te(U){U.buffered=[],U.bufferedIndex=0,U.allBuffers=!0,U.allNoop=!0}q.prototype.getBuffer=function(){return e(this.buffered,this.bufferedIndex)},s(q.prototype,"bufferedRequestCount",{__proto__:null,get(){return this.buffered.length-this.bufferedIndex}});function T(U){const z=this instanceof tr();if(!z&&!r(T,this))return new T(U);this._writableState=new q(U,this,z),U&&(typeof U.write=="function"&&(this._write=U.write),typeof U.writev=="function"&&(this._writev=U.writev),typeof U.destroy=="function"&&(this._destroy=U.destroy),typeof U.final=="function"&&(this._final=U.final),typeof U.construct=="function"&&(this._construct=U.construct),U.signal&&p(U.signal,this)),l.call(this,U),f.construct(this,()=>{const ee=this._writableState;ee.writing||G(this,ee),J(this,ee)})}s(T,u,{__proto__:null,value:function(U){return r(this,U)?!0:this!==T?!1:U&&U._writableState instanceof q}}),T.prototype.pipe=function(){O(this,new k)};function $(U,z,ee,le){const he=U._writableState;if(typeof ee=="function")le=ee,ee=he.defaultEncoding;else{if(!ee)ee=he.defaultEncoding;else if(ee!=="buffer"&&!d.isEncoding(ee))throw new K(ee);typeof le!="function"&&(le=N)}if(z===null)throw new L;if(!he.objectMode)if(typeof z=="string")he.decodeStrings!==!1&&(z=d.from(z,ee),ee="buffer");else if(z instanceof d)ee="buffer";else if(l._isUint8Array(z))z=l._uint8ArrayToBuffer(z),ee="buffer";else throw new m("chunk",["string","Buffer","Uint8Array"],z);let fe;return he.ending?fe=new D:he.destroyed&&(fe=new I("write")),fe?(t.nextTick(le,fe),O(U,fe,!0),fe):(he.pendingcb++,B(U,he,z,ee,le))}T.prototype.write=function(U,z,ee){return $(this,U,z,ee)===!0},T.prototype.cork=function(){this._writableState.corked++},T.prototype.uncork=function(){const U=this._writableState;U.corked&&(U.corked--,U.writing||G(this,U))},T.prototype.setDefaultEncoding=function(z){if(typeof z=="string"&&(z=c(z)),!d.isEncoding(z))throw new K(z);return this._writableState.defaultEncoding=z,this};function B(U,z,ee,le,he){const fe=z.objectMode?1:ee.length;z.length+=fe;const j=z.length<z.highWaterMark;return j||(z.needDrain=!0),z.writing||z.corked||z.errored||!z.constructed?(z.buffered.push({chunk:ee,encoding:le,callback:he}),z.allBuffers&&le!=="buffer"&&(z.allBuffers=!1),z.allNoop&&he!==N&&(z.allNoop=!1)):(z.writelen=fe,z.writecb=he,z.writing=!0,z.sync=!0,U._write(ee,le,z.onwrite),z.sync=!1),j&&!z.errored&&!z.destroyed}function S(U,z,ee,le,he,fe,j){z.writelen=le,z.writecb=j,z.writing=!0,z.sync=!0,z.destroyed?z.onwrite(new I("write")):ee?U._writev(he,z.onwrite):U._write(he,fe,z.onwrite),z.sync=!1}function R(U,z,ee,le){--z.pendingcb,le(ee),H(z),O(U,ee)}function E(U,z){const ee=U._writableState,le=ee.sync,he=ee.writecb;if(typeof he!="function"){O(U,new v);return}ee.writing=!1,ee.writecb=null,ee.length-=ee.writelen,ee.writelen=0,z?(z.stack,ee.errored||(ee.errored=z),U._readableState&&!U._readableState.errored&&(U._readableState.errored=z),le?t.nextTick(R,U,ee,z,he):R(U,ee,z,he)):(ee.buffered.length>ee.bufferedIndex&&G(U,ee),le?ee.afterWriteTickInfo!==null&&ee.afterWriteTickInfo.cb===he?ee.afterWriteTickInfo.count++:(ee.afterWriteTickInfo={count:1,cb:he,stream:U,state:ee},t.nextTick(P,ee.afterWriteTickInfo)):X(U,ee,1,he))}function P({stream:U,state:z,count:ee,cb:le}){return z.afterWriteTickInfo=null,X(U,z,ee,le)}function X(U,z,ee,le){for(!z.ending&&!U.destroyed&&z.length===0&&z.needDrain&&(z.needDrain=!1,U.emit("drain"));ee-- >0;)z.pendingcb--,le();z.destroyed&&H(z),J(U,z)}function H(U){if(U.writing)return;for(let he=U.bufferedIndex;he<U.buffered.length;++he){var z;const{chunk:fe,callback:j}=U.buffered[he],oe=U.objectMode?1:fe.length;U.length-=oe,j((z=U.errored)!==null&&z!==void 0?z:new I("write"))}const ee=U[W].splice(0);for(let he=0;he<ee.length;he++){var le;ee[he]((le=U.errored)!==null&&le!==void 0?le:new I("end"))}te(U)}function G(U,z){if(z.corked||z.bufferProcessing||z.destroyed||!z.constructed)return;const{buffered:ee,bufferedIndex:le,objectMode:he}=z,fe=ee.length-le;if(!fe)return;let j=le;if(z.bufferProcessing=!0,fe>1&&U._writev){z.pendingcb-=fe-1;const oe=z.allNoop?N:re=>{for(let Ne=j;Ne<ee.length;++Ne)ee[Ne].callback(re)},ae=z.allNoop&&j===0?ee:e(ee,j);ae.allBuffers=z.allBuffers,S(U,z,!0,z.length,ae,"",oe),te(z)}else{do{const{chunk:oe,encoding:ae,callback:re}=ee[j];ee[j++]=null;const Ne=he?1:oe.length;S(U,z,!1,Ne,oe,ae,re)}while(j<ee.length&&!z.writing);j===ee.length?te(z):j>256?(ee.splice(0,j),z.bufferedIndex=0):z.bufferedIndex=j}z.bufferProcessing=!1}T.prototype._write=function(U,z,ee){if(this._writev)this._writev([{chunk:U,encoding:z}],ee);else throw new _("_write()")},T.prototype._writev=null,T.prototype.end=function(U,z,ee){const le=this._writableState;typeof U=="function"?(ee=U,U=null,z=null):typeof z=="function"&&(ee=z,z=null);let he;if(U!=null){const fe=$(this,U,z);fe instanceof n&&(he=fe)}return le.corked&&(le.corked=1,this.uncork()),he||(!le.errored&&!le.ending?(le.ending=!0,J(this,le,!0),le.ended=!0):le.finished?he=new A("end"):le.destroyed&&(he=new I("end"))),typeof ee=="function"&&(he||le.finished?t.nextTick(ee,he):le[W].push(ee)),this};function se(U){return U.ending&&!U.destroyed&&U.constructed&&U.length===0&&!U.errored&&U.buffered.length===0&&!U.finished&&!U.writing&&!U.errorEmitted&&!U.closeEmitted}function ce(U,z){let ee=!1;function le(he){if(ee){O(U,he??v());return}if(ee=!0,z.pendingcb--,he){const fe=z[W].splice(0);for(let j=0;j<fe.length;j++)fe[j](he);O(U,he,z.sync)}else se(z)&&(z.prefinished=!0,U.emit("prefinish"),z.pendingcb++,t.nextTick(ne,U,z))}z.sync=!0,z.pendingcb++;try{U._final(le)}catch(he){le(he)}z.sync=!1}function ue(U,z){!z.prefinished&&!z.finalCalled&&(typeof U._final=="function"&&!z.destroyed?(z.finalCalled=!0,ce(U,z)):(z.prefinished=!0,U.emit("prefinish")))}function J(U,z,ee){se(z)&&(ue(U,z),z.pendingcb===0&&(ee?(z.pendingcb++,t.nextTick((le,he)=>{se(he)?ne(le,he):he.pendingcb--},U,z)):se(z)&&(z.pendingcb++,ne(U,z))))}function ne(U,z){z.pendingcb--,z.finished=!0;const ee=z[W].splice(0);for(let le=0;le<ee.length;le++)ee[le]();if(U.emit("finish"),z.autoDestroy){const le=U._readableState;(!le||le.autoDestroy&&(le.endEmitted||le.readable===!1))&&U.destroy()}}i(T.prototype,{closed:{__proto__:null,get(){return this._writableState?this._writableState.closed:!1}},destroyed:{__proto__:null,get(){return this._writableState?this._writableState.destroyed:!1},set(U){this._writableState&&(this._writableState.destroyed=U)}},writable:{__proto__:null,get(){const U=this._writableState;return!!U&&U.writable!==!1&&!U.destroyed&&!U.errored&&!U.ending&&!U.ended},set(U){this._writableState&&(this._writableState.writable=!!U)}},writableFinished:{__proto__:null,get(){return this._writableState?this._writableState.finished:!1}},writableObjectMode:{__proto__:null,get(){return this._writableState?this._writableState.objectMode:!1}},writableBuffer:{__proto__:null,get(){return this._writableState&&this._writableState.getBuffer()}},writableEnded:{__proto__:null,get(){return this._writableState?this._writableState.ending:!1}},writableNeedDrain:{__proto__:null,get(){const U=this._writableState;return U?!U.destroyed&&!U.ending&&U.needDrain:!1}},writableHighWaterMark:{__proto__:null,get(){return this._writableState&&this._writableState.highWaterMark}},writableCorked:{__proto__:null,get(){return this._writableState?this._writableState.corked:0}},writableLength:{__proto__:null,get(){return this._writableState&&this._writableState.length}},errored:{__proto__:null,enumerable:!1,get(){return this._writableState?this._writableState.errored:null}},writableAborted:{__proto__:null,enumerable:!1,get:function(){return!!(this._writableState.writable!==!1&&(this._writableState.destroyed||this._writableState.errored)&&!this._writableState.finished)}}});const de=f.destroy;T.prototype.destroy=function(U,z){const ee=this._writableState;return!ee.destroyed&&(ee.bufferedIndex<ee.buffered.length||ee[W].length)&&t.nextTick(H,ee),de.call(this,U,z),this},T.prototype._undestroy=f.undestroy,T.prototype._destroy=function(U,z){z(U)},T.prototype[h.captureRejectionSymbol]=function(U){this.destroy(U)};let we;function be(){return we===void 0&&(we={}),we}return T.fromWeb=function(U,z){return be().newStreamWritableFromWritableStream(U,z)},T.toWeb=function(U){return be().newWritableStreamFromStreamWritable(U)},_f}var Sf,A_;function C8(){if(A_)return Sf;A_=1;const t=ws(),e=Yt(),{isReadable:n,isWritable:r,isIterable:s,isNodeStream:i,isReadableNodeStream:o,isWritableNodeStream:c,isDuplexNodeStream:a,isReadableStream:u,isWritableStream:h}=or(),l=vr(),{AbortError:d,codes:{ERR_INVALID_ARG_TYPE:f,ERR_INVALID_RETURN_VALUE:p}}=Lt(),{destroyer:w}=Vi(),g=tr(),m=vl(),_=cy(),{createDeferredPromise:v}=Ut(),k=jx(),I=globalThis.Blob||e.Blob,A=typeof I<"u"?function(q){return q instanceof I}:function(q){return!1},L=globalThis.AbortController||tc().AbortController,{FunctionPrototypeCall:D}=Je();class K extends g{constructor(q){super(q),q?.readable===!1&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),q?.writable===!1&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)}}Sf=function W(q,te){if(a(q))return q;if(o(q))return N({readable:q});if(c(q))return N({writable:q});if(i(q))return N({writable:!1,readable:!1});if(u(q))return N({readable:m.fromWeb(q)});if(h(q))return N({writable:_.fromWeb(q)});if(typeof q=="function"){const{value:$,write:B,final:S,destroy:R}=O(q);if(s($))return k(K,$,{objectMode:!0,write:B,final:S,destroy:R});const E=$?.then;if(typeof E=="function"){let P;const X=D(E,$,H=>{if(H!=null)throw new p("nully","body",H)},H=>{w(P,H)});return P=new K({objectMode:!0,readable:!1,write:B,final(H){S(async()=>{try{await X,t.nextTick(H,null)}catch(G){t.nextTick(H,G)}})},destroy:R})}throw new p("Iterable, AsyncIterable or AsyncFunction",te,$)}if(A(q))return W(q.arrayBuffer());if(s(q))return k(K,q,{objectMode:!0,writable:!1});if(u(q?.readable)&&h(q?.writable))return K.fromWeb(q);if(typeof q?.writable=="object"||typeof q?.readable=="object"){const $=q!=null&&q.readable?o(q?.readable)?q?.readable:W(q.readable):void 0,B=q!=null&&q.writable?c(q?.writable)?q?.writable:W(q.writable):void 0;return N({readable:$,writable:B})}const T=q?.then;if(typeof T=="function"){let $;return D(T,q,B=>{B!=null&&$.push(B),$.push(null)},B=>{w($,B)}),$=new K({objectMode:!0,writable:!1,read(){}})}throw new f(te,["Blob","ReadableStream","WritableStream","Stream","Iterable","AsyncIterable","Function","{ readable, writable } pair","Promise"],q)};function O(W){let{promise:q,resolve:te}=v();const T=new L,$=T.signal;return{value:W((async function*(){for(;;){const S=q;q=null;const{chunk:R,done:E,cb:P}=await S;if(t.nextTick(P),E)return;if($.aborted)throw new d(void 0,{cause:$.reason});({promise:q,resolve:te}=v()),yield R}})(),{signal:$}),write(S,R,E){const P=te;te=null,P({chunk:S,done:!1,cb:E})},final(S){const R=te;te=null,R({done:!0,cb:S})},destroy(S,R){T.abort(),R(S)}}}function N(W){const q=W.readable&&typeof W.readable.read!="function"?m.wrap(W.readable):W.readable,te=W.writable;let T=!!n(q),$=!!r(te),B,S,R,E,P;function X(H){const G=E;E=null,G?G(H):H&&P.destroy(H)}return P=new K({readableObjectMode:!!(q!=null&&q.readableObjectMode),writableObjectMode:!!(te!=null&&te.writableObjectMode),readable:T,writable:$}),$&&(l(te,H=>{$=!1,H&&w(q,H),X(H)}),P._write=function(H,G,se){te.write(H,G)?se():B=se},P._final=function(H){te.end(),S=H},te.on("drain",function(){if(B){const H=B;B=null,H()}}),te.on("finish",function(){if(S){const H=S;S=null,H()}})),T&&(l(q,H=>{T=!1,H&&w(q,H),X(H)}),q.on("readable",function(){if(R){const H=R;R=null,H()}}),q.on("end",function(){P.push(null)}),P._read=function(){for(;;){const H=q.read();if(H===null){R=P._read;return}if(!P.push(H))return}}),P._destroy=function(H,G){!H&&E!==null&&(H=new d),R=null,B=null,S=null,E===null?G(H):(E=G,w(te,H),w(q,H))},P}return Sf}var Ef,R_;function tr(){if(R_)return Ef;R_=1;const{ObjectDefineProperties:t,ObjectGetOwnPropertyDescriptor:e,ObjectKeys:n,ObjectSetPrototypeOf:r}=Je();Ef=o;const s=vl(),i=cy();r(o.prototype,s.prototype),r(o,s);{const h=n(i.prototype);for(let l=0;l<h.length;l++){const d=h[l];o.prototype[d]||(o.prototype[d]=i.prototype[d])}}function o(h){if(!(this instanceof o))return new o(h);s.call(this,h),i.call(this,h),h?(this.allowHalfOpen=h.allowHalfOpen!==!1,h.readable===!1&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),h.writable===!1&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)):this.allowHalfOpen=!0}t(o.prototype,{writable:{__proto__:null,...e(i.prototype,"writable")},writableHighWaterMark:{__proto__:null,...e(i.prototype,"writableHighWaterMark")},writableObjectMode:{__proto__:null,...e(i.prototype,"writableObjectMode")},writableBuffer:{__proto__:null,...e(i.prototype,"writableBuffer")},writableLength:{__proto__:null,...e(i.prototype,"writableLength")},writableFinished:{__proto__:null,...e(i.prototype,"writableFinished")},writableCorked:{__proto__:null,...e(i.prototype,"writableCorked")},writableEnded:{__proto__:null,...e(i.prototype,"writableEnded")},writableNeedDrain:{__proto__:null,...e(i.prototype,"writableNeedDrain")},destroyed:{__proto__:null,get(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set(h){this._readableState&&this._writableState&&(this._readableState.destroyed=h,this._writableState.destroyed=h)}}});let c;function a(){return c===void 0&&(c={}),c}o.fromWeb=function(h,l){return a().newStreamDuplexFromReadableWritablePair(h,l)},o.toWeb=function(h){return a().newReadableWritablePairFromDuplex(h)};let u;return o.from=function(h){return u||(u=C8()),u(h,"body")},Ef}var vf,C_;function Kx(){if(C_)return vf;C_=1;const{ObjectSetPrototypeOf:t,Symbol:e}=Je();vf=o;const{ERR_METHOD_NOT_IMPLEMENTED:n}=Lt().codes,r=tr(),{getHighWaterMark:s}=El();t(o.prototype,r.prototype),t(o,r);const i=e("kCallback");function o(u){if(!(this instanceof o))return new o(u);const h=u?s(this,u,"readableHighWaterMark",!0):null;h===0&&(u={...u,highWaterMark:null,readableHighWaterMark:h,writableHighWaterMark:u.writableHighWaterMark||0}),r.call(this,u),this._readableState.sync=!1,this[i]=null,u&&(typeof u.transform=="function"&&(this._transform=u.transform),typeof u.flush=="function"&&(this._flush=u.flush)),this.on("prefinish",a)}function c(u){typeof this._flush=="function"&&!this.destroyed?this._flush((h,l)=>{if(h){u?u(h):this.destroy(h);return}l!=null&&this.push(l),this.push(null),u&&u()}):(this.push(null),u&&u())}function a(){this._final!==c&&c.call(this)}return o.prototype._final=c,o.prototype._transform=function(u,h,l){throw new n("_transform()")},o.prototype._write=function(u,h,l){const d=this._readableState,f=this._writableState,p=d.length;this._transform(u,h,(w,g)=>{if(w){l(w);return}g!=null&&this.push(g),f.ended||p===d.length||d.length<d.highWaterMark?l():this[i]=l})},o.prototype._read=function(){if(this[i]){const u=this[i];this[i]=null,u()}},vf}var kf,O_;function Wx(){if(O_)return kf;O_=1;const{ObjectSetPrototypeOf:t}=Je();kf=n;const e=Kx();t(n.prototype,e.prototype),t(n,e);function n(r){if(!(this instanceof n))return new n(r);e.call(this,r)}return n.prototype._transform=function(r,s,i){i(null,r)},kf}var xf,M_;function ay(){if(M_)return xf;M_=1;const t=ws(),{ArrayIsArray:e,Promise:n,SymbolAsyncIterator:r,SymbolDispose:s}=Je(),i=vr(),{once:o}=Ut(),c=Vi(),a=tr(),{aggregateTwoErrors:u,codes:{ERR_INVALID_ARG_TYPE:h,ERR_INVALID_RETURN_VALUE:l,ERR_MISSING_ARGS:d,ERR_STREAM_DESTROYED:f,ERR_STREAM_PREMATURE_CLOSE:p},AbortError:w}=Lt(),{validateFunction:g,validateAbortSignal:m}=Oc(),{isIterable:_,isReadable:v,isReadableNodeStream:k,isNodeStream:I,isTransformStream:A,isWebStream:L,isReadableStream:D,isReadableFinished:K}=or(),O=globalThis.AbortController||tc().AbortController;let N,W,q;function te(H,G,se){let ce=!1;H.on("close",()=>{ce=!0});const ue=i(H,{readable:G,writable:se},J=>{ce=!J});return{destroy:J=>{ce||(ce=!0,c.destroyer(H,J||new f("pipe")))},cleanup:ue}}function T(H){return g(H[H.length-1],"streams[stream.length - 1]"),H.pop()}function $(H){if(_(H))return H;if(k(H))return B(H);throw new h("val",["Readable","Iterable","AsyncIterable"],H)}async function*B(H){W||(W=vl()),yield*W.prototype[r].call(H)}async function S(H,G,se,{end:ce}){let ue,J=null;const ne=be=>{if(be&&(ue=be),J){const U=J;J=null,U()}},de=()=>new n((be,U)=>{ue?U(ue):J=()=>{ue?U(ue):be()}});G.on("drain",ne);const we=i(G,{readable:!1},ne);try{G.writableNeedDrain&&await de();for await(const be of H)G.write(be)||await de();ce&&(G.end(),await de()),se()}catch(be){se(ue!==be?u(ue,be):be)}finally{we(),G.off("drain",ne)}}async function R(H,G,se,{end:ce}){A(G)&&(G=G.writable);const ue=G.getWriter();try{for await(const J of H)await ue.ready,ue.write(J).catch(()=>{});await ue.ready,ce&&await ue.close(),se()}catch(J){try{await ue.abort(J),se(J)}catch(ne){se(ne)}}}function E(...H){return P(H,o(T(H)))}function P(H,G,se){if(H.length===1&&e(H[0])&&(H=H[0]),H.length<2)throw new d("streams");const ce=new O,ue=ce.signal,J=se?.signal,ne=[];m(J,"options.signal");function de(){he(new w)}q=q||Ut().addAbortListener;let we;J&&(we=q(J,de));let be,U;const z=[];let ee=0;function le(ae){he(ae,--ee===0)}function he(ae,re){var Ne;if(ae&&(!be||be.code==="ERR_STREAM_PREMATURE_CLOSE")&&(be=ae),!(!be&&!re)){for(;z.length;)z.shift()(be);(Ne=we)===null||Ne===void 0||Ne[s](),ce.abort(),re&&(be||ne.forEach(St=>St()),t.nextTick(G,be,U))}}let fe;for(let ae=0;ae<H.length;ae++){const re=H[ae],Ne=ae<H.length-1,St=ae>0,Oe=Ne||se?.end!==!1,It=ae===H.length-1;if(I(re)){let x=function(y){y&&y.name!=="AbortError"&&y.code!=="ERR_STREAM_PREMATURE_CLOSE"&&le(y)};if(Oe){const{destroy:y,cleanup:b}=te(re,Ne,St);z.push(y),v(re)&&It&&ne.push(b)}re.on("error",x),v(re)&&It&&ne.push(()=>{re.removeListener("error",x)})}if(ae===0)if(typeof re=="function"){if(fe=re({signal:ue}),!_(fe))throw new l("Iterable, AsyncIterable or Stream","source",fe)}else _(re)||k(re)||A(re)?fe=re:fe=a.from(re);else if(typeof re=="function"){if(A(fe)){var j;fe=$((j=fe)===null||j===void 0?void 0:j.readable)}else fe=$(fe);if(fe=re(fe,{signal:ue}),Ne){if(!_(fe,!0))throw new l("AsyncIterable",`transform[${ae-1}]`,fe)}else{var oe;N||(N=Wx());const x=new N({objectMode:!0}),y=(oe=fe)===null||oe===void 0?void 0:oe.then;if(typeof y=="function")ee++,y.call(fe,V=>{U=V,V!=null&&x.write(V),Oe&&x.end(),t.nextTick(le)},V=>{x.destroy(V),t.nextTick(le,V)});else if(_(fe,!0))ee++,S(fe,x,le,{end:Oe});else if(D(fe)||A(fe)){const V=fe.readable||fe;ee++,S(V,x,le,{end:Oe})}else throw new l("AsyncIterable or Promise","destination",fe);fe=x;const{destroy:b,cleanup:M}=te(fe,!1,!0);z.push(b),It&&ne.push(M)}}else if(I(re)){if(k(fe)){ee+=2;const x=X(fe,re,le,{end:Oe});v(re)&&It&&ne.push(x)}else if(A(fe)||D(fe)){const x=fe.readable||fe;ee++,S(x,re,le,{end:Oe})}else if(_(fe))ee++,S(fe,re,le,{end:Oe});else throw new h("val",["Readable","Iterable","AsyncIterable","ReadableStream","TransformStream"],fe);fe=re}else if(L(re)){if(k(fe))ee++,R($(fe),re,le,{end:Oe});else if(D(fe)||_(fe))ee++,R(fe,re,le,{end:Oe});else if(A(fe))ee++,R(fe.readable,re,le,{end:Oe});else throw new h("val",["Readable","Iterable","AsyncIterable","ReadableStream","TransformStream"],fe);fe=re}else fe=a.from(re)}return(ue!=null&&ue.aborted||J!=null&&J.aborted)&&t.nextTick(de),fe}function X(H,G,se,{end:ce}){let ue=!1;if(G.on("close",()=>{ue||se(new p)}),H.pipe(G,{end:!1}),ce){let J=function(){ue=!0,G.end()};K(H)?t.nextTick(J):H.once("end",J)}else se();return i(H,{readable:!0,writable:!1},J=>{const ne=H._readableState;J&&J.code==="ERR_STREAM_PREMATURE_CLOSE"&&ne&&ne.ended&&!ne.errored&&!ne.errorEmitted?H.once("end",se).once("error",se):se(J)}),i(G,{readable:!1,writable:!0},se)}return xf={pipelineImpl:P,pipeline:E},xf}var If,L_;function zx(){if(L_)return If;L_=1;const{pipeline:t}=ay(),e=tr(),{destroyer:n}=Vi(),{isNodeStream:r,isReadable:s,isWritable:i,isWebStream:o,isTransformStream:c,isWritableStream:a,isReadableStream:u}=or(),{AbortError:h,codes:{ERR_INVALID_ARG_VALUE:l,ERR_MISSING_ARGS:d}}=Lt(),f=vr();return If=function(...w){if(w.length===0)throw new d("streams");if(w.length===1)return e.from(w[0]);const g=[...w];if(typeof w[0]=="function"&&(w[0]=e.from(w[0])),typeof w[w.length-1]=="function"){const N=w.length-1;w[N]=e.from(w[N])}for(let N=0;N<w.length;++N)if(!(!r(w[N])&&!o(w[N]))){if(N<w.length-1&&!(s(w[N])||u(w[N])||c(w[N])))throw new l(`streams[${N}]`,g[N],"must be readable");if(N>0&&!(i(w[N])||a(w[N])||c(w[N])))throw new l(`streams[${N}]`,g[N],"must be writable")}let m,_,v,k,I;function A(N){const W=k;k=null,W?W(N):N?I.destroy(N):!O&&!K&&I.destroy()}const L=w[0],D=t(w,A),K=!!(i(L)||a(L)||c(L)),O=!!(s(D)||u(D)||c(D));if(I=new e({writableObjectMode:!!(L!=null&&L.writableObjectMode),readableObjectMode:!!(D!=null&&D.readableObjectMode),writable:K,readable:O}),K){if(r(L))I._write=function(W,q,te){L.write(W,q)?te():m=te},I._final=function(W){L.end(),_=W},L.on("drain",function(){if(m){const W=m;m=null,W()}});else if(o(L)){const q=(c(L)?L.writable:L).getWriter();I._write=async function(te,T,$){try{await q.ready,q.write(te).catch(()=>{}),$()}catch(B){$(B)}},I._final=async function(te){try{await q.ready,q.close().catch(()=>{}),_=te}catch(T){te(T)}}}const N=c(D)?D.readable:D;f(N,()=>{if(_){const W=_;_=null,W()}})}if(O){if(r(D))D.on("readable",function(){if(v){const N=v;v=null,N()}}),D.on("end",function(){I.push(null)}),I._read=function(){for(;;){const N=D.read();if(N===null){v=I._read;return}if(!I.push(N))return}};else if(o(D)){const W=(c(D)?D.readable:D).getReader();I._read=async function(){for(;;)try{const{value:q,done:te}=await W.read();if(!I.push(q))return;if(te){I.push(null);return}}catch{return}}}}return I._destroy=function(N,W){!N&&k!==null&&(N=new h),v=null,m=null,_=null,k===null?W(N):(k=W,r(D)&&n(D,N))},I},If}var D_;function O8(){if(D_)return ra;D_=1;const t=globalThis.AbortController||tc().AbortController,{codes:{ERR_INVALID_ARG_VALUE:e,ERR_INVALID_ARG_TYPE:n,ERR_MISSING_ARGS:r,ERR_OUT_OF_RANGE:s},AbortError:i}=Lt(),{validateAbortSignal:o,validateInteger:c,validateObject:a}=Oc(),u=Je().Symbol("kWeak"),h=Je().Symbol("kResistStopPropagation"),{finished:l}=vr(),d=zx(),{addAbortSignalNoValidate:f}=Sl(),{isWritable:p,isNodeStream:w}=or(),{deprecate:g}=Ut(),{ArrayPrototypePush:m,Boolean:_,MathFloor:v,Number:k,NumberIsNaN:I,Promise:A,PromiseReject:L,PromiseResolve:D,PromisePrototypeThen:K,Symbol:O}=Je(),N=O("kEmpty"),W=O("kEof");function q(J,ne){if(ne!=null&&a(ne,"options"),ne?.signal!=null&&o(ne.signal,"options.signal"),w(J)&&!p(J))throw new e("stream",J,"must be writable");const de=d(this,J);return ne!=null&&ne.signal&&f(ne.signal,de),de}function te(J,ne){if(typeof J!="function")throw new n("fn",["Function","AsyncFunction"],J);ne!=null&&a(ne,"options"),ne?.signal!=null&&o(ne.signal,"options.signal");let de=1;ne?.concurrency!=null&&(de=v(ne.concurrency));let we=de-1;return ne?.highWaterMark!=null&&(we=v(ne.highWaterMark)),c(de,"options.concurrency",1),c(we,"options.highWaterMark",0),we+=de,(async function*(){const U=Ut().AbortSignalAny([ne?.signal].filter(_)),z=this,ee=[],le={signal:U};let he,fe,j=!1,oe=0;function ae(){j=!0,re()}function re(){oe-=1,Ne()}function Ne(){fe&&!j&&oe<de&&ee.length<we&&(fe(),fe=null)}async function St(){try{for await(let Oe of z){if(j)return;if(U.aborted)throw new i;try{if(Oe=J(Oe,le),Oe===N)continue;Oe=D(Oe)}catch(It){Oe=L(It)}oe+=1,K(Oe,re,ae),ee.push(Oe),he&&(he(),he=null),!j&&(ee.length>=we||oe>=de)&&await new A(It=>{fe=It})}ee.push(W)}catch(Oe){const It=L(Oe);K(It,re,ae),ee.push(It)}finally{j=!0,he&&(he(),he=null)}}St();try{for(;;){for(;ee.length>0;){const Oe=await ee[0];if(Oe===W)return;if(U.aborted)throw new i;Oe!==N&&(yield Oe),ee.shift(),Ne()}await new A(Oe=>{he=Oe})}}finally{j=!0,fe&&(fe(),fe=null)}}).call(this)}function T(J=void 0){return J!=null&&a(J,"options"),J?.signal!=null&&o(J.signal,"options.signal"),(async function*(){let de=0;for await(const be of this){var we;if(J!=null&&(we=J.signal)!==null&&we!==void 0&&we.aborted)throw new i({cause:J.signal.reason});yield[de++,be]}}).call(this)}async function $(J,ne=void 0){for await(const de of E.call(this,J,ne))return!0;return!1}async function B(J,ne=void 0){if(typeof J!="function")throw new n("fn",["Function","AsyncFunction"],J);return!await $.call(this,async(...de)=>!await J(...de),ne)}async function S(J,ne){for await(const de of E.call(this,J,ne))return de}async function R(J,ne){if(typeof J!="function")throw new n("fn",["Function","AsyncFunction"],J);async function de(we,be){return await J(we,be),N}for await(const we of te.call(this,de,ne));}function E(J,ne){if(typeof J!="function")throw new n("fn",["Function","AsyncFunction"],J);async function de(we,be){return await J(we,be)?we:N}return te.call(this,de,ne)}class P extends r{constructor(){super("reduce"),this.message="Reduce of an empty stream requires an initial value"}}async function X(J,ne,de){var we;if(typeof J!="function")throw new n("reducer",["Function","AsyncFunction"],J);de!=null&&a(de,"options"),de?.signal!=null&&o(de.signal,"options.signal");let be=arguments.length>1;if(de!=null&&(we=de.signal)!==null&&we!==void 0&&we.aborted){const he=new i(void 0,{cause:de.signal.reason});throw this.once("error",()=>{}),await l(this.destroy(he)),he}const U=new t,z=U.signal;if(de!=null&&de.signal){const he={once:!0,[u]:this,[h]:!0};de.signal.addEventListener("abort",()=>U.abort(),he)}let ee=!1;try{for await(const he of this){var le;if(ee=!0,de!=null&&(le=de.signal)!==null&&le!==void 0&&le.aborted)throw new i;be?ne=await J(ne,he,{signal:z}):(ne=he,be=!0)}if(!ee&&!be)throw new P}finally{U.abort()}return ne}async function H(J){J!=null&&a(J,"options"),J?.signal!=null&&o(J.signal,"options.signal");const ne=[];for await(const we of this){var de;if(J!=null&&(de=J.signal)!==null&&de!==void 0&&de.aborted)throw new i(void 0,{cause:J.signal.reason});m(ne,we)}return ne}function G(J,ne){const de=te.call(this,J,ne);return(async function*(){for await(const be of de)yield*be}).call(this)}function se(J){if(J=k(J),I(J))return 0;if(J<0)throw new s("number",">= 0",J);return J}function ce(J,ne=void 0){return ne!=null&&a(ne,"options"),ne?.signal!=null&&o(ne.signal,"options.signal"),J=se(J),(async function*(){var we;if(ne!=null&&(we=ne.signal)!==null&&we!==void 0&&we.aborted)throw new i;for await(const U of this){var be;if(ne!=null&&(be=ne.signal)!==null&&be!==void 0&&be.aborted)throw new i;J--<=0&&(yield U)}}).call(this)}function ue(J,ne=void 0){return ne!=null&&a(ne,"options"),ne?.signal!=null&&o(ne.signal,"options.signal"),J=se(J),(async function*(){var we;if(ne!=null&&(we=ne.signal)!==null&&we!==void 0&&we.aborted)throw new i;for await(const U of this){var be;if(ne!=null&&(be=ne.signal)!==null&&be!==void 0&&be.aborted)throw new i;if(J-- >0&&(yield U),J<=0)return}}).call(this)}return ra.streamReturningOperators={asIndexedPairs:g(T,"readable.asIndexedPairs will be removed in a future version."),drop:ce,filter:E,flatMap:G,map:te,take:ue,compose:q},ra.promiseReturningOperators={every:B,forEach:R,reduce:X,toArray:H,some:$,find:S},ra}var Tf,F_;function Hx(){if(F_)return Tf;F_=1;const{ArrayPrototypePop:t,Promise:e}=Je(),{isIterable:n,isNodeStream:r,isWebStream:s}=or(),{pipelineImpl:i}=ay(),{finished:o}=vr();Qx();function c(...a){return new e((u,h)=>{let l,d;const f=a[a.length-1];if(f&&typeof f=="object"&&!r(f)&&!n(f)&&!s(f)){const p=t(a);l=p.signal,d=p.end}i(a,(p,w)=>{p?h(p):u(w)},{signal:l,end:d})})}return Tf={finished:o,pipeline:c},Tf}var N_;function Qx(){if(N_)return rf.exports;N_=1;const{Buffer:t}=Yt(),{ObjectDefineProperty:e,ObjectKeys:n,ReflectApply:r}=Je(),{promisify:{custom:s}}=Ut(),{streamReturningOperators:i,promiseReturningOperators:o}=O8(),{codes:{ERR_ILLEGAL_CONSTRUCTOR:c}}=Lt(),a=zx(),{setDefaultHighWaterMark:u,getDefaultHighWaterMark:h}=El(),{pipeline:l}=ay(),{destroyer:d}=Vi(),f=vr(),p=Hx(),w=or(),g=rf.exports=oy().Stream;g.isDestroyed=w.isDestroyed,g.isDisturbed=w.isDisturbed,g.isErrored=w.isErrored,g.isReadable=w.isReadable,g.isWritable=w.isWritable,g.Readable=vl();for(const _ of n(i)){let k=function(...I){if(new.target)throw c();return g.Readable.from(r(v,this,I))};const v=i[_];e(k,"name",{__proto__:null,value:v.name}),e(k,"length",{__proto__:null,value:v.length}),e(g.Readable.prototype,_,{__proto__:null,value:k,enumerable:!1,configurable:!0,writable:!0})}for(const _ of n(o)){let k=function(...I){if(new.target)throw c();return r(v,this,I)};const v=o[_];e(k,"name",{__proto__:null,value:v.name}),e(k,"length",{__proto__:null,value:v.length}),e(g.Readable.prototype,_,{__proto__:null,value:k,enumerable:!1,configurable:!0,writable:!0})}g.Writable=cy(),g.Duplex=tr(),g.Transform=Kx(),g.PassThrough=Wx(),g.pipeline=l;const{addAbortSignal:m}=Sl();return g.addAbortSignal=m,g.finished=f,g.destroy=d,g.compose=a,g.setDefaultHighWaterMark=u,g.getDefaultHighWaterMark=h,e(g,"promises",{__proto__:null,configurable:!0,enumerable:!0,get(){return p}}),e(l,s,{__proto__:null,enumerable:!0,get(){return p.pipeline}}),e(f,s,{__proto__:null,enumerable:!0,get(){return p.finished}}),g.Stream=g,g._isUint8Array=function(v){return v instanceof Uint8Array},g._uint8ArrayToBuffer=function(v){return t.from(v.buffer,v.byteOffset,v.byteLength)},rf.exports}var P_;function M8(){return P_||(P_=1,(function(t){const e=Qx(),n=Hx(),r=e.Readable.destroy;t.exports=e.Readable,t.exports._uint8ArrayToBuffer=e._uint8ArrayToBuffer,t.exports._isUint8Array=e._isUint8Array,t.exports.isDisturbed=e.isDisturbed,t.exports.isErrored=e.isErrored,t.exports.isReadable=e.isReadable,t.exports.Readable=e.Readable,t.exports.Writable=e.Writable,t.exports.Duplex=e.Duplex,t.exports.Transform=e.Transform,t.exports.PassThrough=e.PassThrough,t.exports.addAbortSignal=e.addAbortSignal,t.exports.finished=e.finished,t.exports.destroy=e.destroy,t.exports.destroy=r,t.exports.pipeline=e.pipeline,t.exports.compose=e.compose,Object.defineProperty(e,"promises",{configurable:!0,enumerable:!0,get(){return n}}),t.exports.Stream=e.Stream,t.exports.default=t.exports})(nf)),nf.exports}var $_;function L8(){if($_)return io;$_=1;const{Readable:t}=M8(),e=Symbol("iterator"),n=Symbol("nextv"),r=Symbol("nextvLegacy"),s=Symbol("destroy");class i extends t{constructor(h,l,d){const{highWaterMark:f,...p}=d||{};super({objectMode:!0,autoDestroy:!0,highWaterMark:f||1e3}),this[e]=h[l](p),this[n]=this[n].bind(this),this[r]=this[r].bind(this),this[s]=this.destroy.bind(this)}get db(){return this[e].db}_read(h){this.destroyed||this[e].nextv(h).then(this[n],this[s])}[r](h,l){if(!this.destroyed){if(h)return this.destroy(h);if(l.length===0)this.push(null);else for(const d of l)this.push(d)}}[n](h){if(!this.destroyed)if(h.length===0)this.push(null);else for(const l of h)this.push(l)}_destroy(h,l){this[e].close().then(h?()=>l(h):l,l)}}class o extends i{constructor(h,l){super(h,"iterator",{...l,keys:!0,values:!0})}[r](h,l){if(!this.destroyed){if(h)return this.destroy(h);if(l.length===0)this.push(null);else for(const[d,f]of l)this.push({key:d,value:f})}}[n](h){if(!this.destroyed)if(h.length===0)this.push(null);else for(const[l,d]of h)this.push({key:l,value:d})}}class c extends i{constructor(h,l){super(h,"keys",l)}}class a extends i{constructor(h,l){super(h,"values",l)}}return io.EntryStream=o,io.KeyStream=c,io.ValueStream=a,io}var uy=L8(),Gx=Yt();const D8=500,B_=0,q_=1,F8={buffer:!0,type:"y-value",encode:t=>t,decode:t=>t},N8=(t,e)=>{for(let n=3;n>=0;n--)ct(t,e>>>8*n&xO)},P8=t=>{const e=t.arr[t.pos+3]+(t.arr[t.pos+2]<<8)+(t.arr[t.pos+1]<<16)+(t.arr[t.pos]<<24)>>>0;return t.pos+=4,e},$8={buffer:!0,type:"y-keys",encode:t=>{const e=ls();for(let n=0;n<t.length;n++){const r=t[n];if(typeof r=="string")Po(e,B_),Fr(e,r);else if(typeof r=="number")Po(e,q_),N8(e,r);else throw new Error("Unexpected key value")}return Gx.Buffer.from(Kt(e))},decode:t=>{const e=sr(t),n=[];for(;MS(e);)switch(Hr(e)){case B_:n.push(Nr(e));break;case q_:n.push(P8(e));break}return n}},Jx=async(t,e)=>{let n;try{n=await t.get(e)}catch(r){if(r.notFound)return;throw r}return n},ly=async(t,e,n)=>t.put(e,Gx.Buffer.from(n)),Yx=(t,e)=>Hn((n,r)=>{const s=[];new uy.EntryStream(t,e).on("data",i=>{s.push(i)}).on("end",()=>{n(s)}).on("error",r)}),hy=(t,e)=>Hn((n,r)=>{const s=[];new uy.KeyStream(t,e).on("data",i=>{s.push(i)}).on("end",()=>{n(s)}).on("error",r)}),B8=(t,e)=>Hn((n,r)=>{const s=[];new uy.ValueStream(t,e).on("data",i=>{s.push(i)}).on("end",()=>{n(s)}).on("error",r)}),Af=(t,e,n={})=>B8(t,{gte:cs(e,0),lt:cs(e,AS),...n}),q8=(t,e,n={})=>hy(t,{gte:cs(e,0),lt:cs(e,AS),...n}),U8=t=>hy(t,{gte:["v1_sv"],lt:["v1_sw"]}),V8=t=>Yx(t,{gte:["v1_sv"],lt:["v1_sw"]}),Xx=(t,e)=>q8(t,e,{reverse:!0,limit:1}).then(n=>n.length===0?-1:n[0][3]),Zx=async(t,e,n)=>{if(t.supports.clear)await t.clear({gte:e,lt:n});else{const s=(await hy(t,{gte:e,lt:n})).map(i=>({type:"del",key:i}));await t.batch(s)}},j8=async(t,e,n,r)=>Zx(t,cs(e,n),cs(e,r)),cs=(t,e)=>["v1",t,"update",e],oa=(t,e)=>["v1",t,"meta",e],K8=t=>["v1",t,"metb"],fy=t=>["v1_sv",t],W8=t=>["v1",t],z8=t=>["v1",t,"zzzzzzz"],U_=t=>{const e=new In;return e.transact(()=>{for(let n=0;n<t.length;n++)Pu(e,t[n])}),{update:Uo(e),sv:Ai(e)}},eI=async(t,e,n,r)=>{const s=ls();Le(s,r),Dt(s,n),await ly(t,fy(e),Kt(s))},tI=t=>{const e=sr(t),n=Re(e);return{sv:Ft(e),clock:n}},H8=async(t,e)=>{const n=await Jx(t,fy(e));return n==null?{sv:null,clock:-1}:tI(n)},Rf=async(t,e,n,r)=>{const s=await nI(t,e,n);return await eI(t,e,r,s),await j8(t,e,0,s),s},nI=async(t,e,n)=>{const r=await Xx(t,e);if(r===-1){const s=new In;Pu(s,n);const i=Ai(s);await eI(t,e,i,0)}return await ly(t,cs(e,r+1),n),r+1};class Q8{constructor(e,{Level:n=I8.Level,levelOptions:r={}}={}){const s=new n(e,{...r,valueEncoding:F8,keyEncoding:$8});this.tr=o1(),this._transact=i=>{const o=this.tr;return this.tr=(async()=>{await o;let c=null;try{c=await i(s)}catch(a){console.warn("Error during y-leveldb transaction",a)}return c})(),this.tr}}flushDocument(e){return this._transact(async n=>{const r=await Af(n,e),{update:s,sv:i}=U_(r);await Rf(n,e,s,i)})}getYDoc(e){return this._transact(async n=>{const r=await Af(n,e),s=new In;return s.transact(()=>{for(let i=0;i<r.length;i++)Pu(s,r[i])}),r.length>D8&&await Rf(n,e,Uo(s),Ai(s)),s})}getStateVector(e){return this._transact(async n=>{const{clock:r,sv:s}=await H8(n,e);let i=-1;if(s!==null&&(i=await Xx(n,e)),s!==null&&r===i)return s;{const o=await Af(n,e),{update:c,sv:a}=U_(o);return await Rf(n,e,c,a),a}})}storeUpdate(e,n){return this._transact(r=>nI(r,e,n))}async getDiff(e,n){const r=await this.getYDoc(e);return Uo(r,n)}clearDocument(e){return this._transact(async n=>{await n.del(fy(e)),await Zx(n,W8(e),z8(e))})}setMeta(e,n,r){return this._transact(s=>ly(s,oa(e,n),A1(r)))}delMeta(e,n){return this._transact(r=>r.del(oa(e,n)))}getMeta(e,n){return this._transact(async r=>{const s=await Jx(r,oa(e,n));if(s!=null)return vm(s)})}getAllDocNames(){return this._transact(async e=>(await U8(e)).map(r=>r[1]))}getAllDocStateVectors(){return this._transact(async e=>(await V8(e)).map(r=>{const{sv:s,clock:i}=tI(r.value);return{name:r.key[1],sv:s,clock:i}}))}getMetas(e){return this._transact(async n=>{const r=await Yx(n,{gte:oa(e,""),lt:K8(e),keys:!0,values:!0}),s=new Map;return r.forEach(i=>{s.set(i.key[3],vm(i.value))}),s})}destroy(){return this._transact(e=>e.close())}clearAll(){return this._transact(async e=>e.clear())}}var kl=sy();function dy(t){return kK(["replicate",...t])}class KW extends qi("NetworkError"){}class V_ extends qi("IDBError"){}class G8 extends qi("IDBWriteError"){}class J8 extends qi("ReconciliationError"){}class ca extends qi("ProseError"){}class WW extends qi("CollectionNotReadyError"){}class j_ extends Error{constructor(e){super(e),this.name="NonRetriableError"}}class tp extends T0("Checkpoint")(){}function Y8(t){return _x(tp,tp.of({loadCheckpoint:e=>Ur(function*(n){const r=`checkpoint:${e}`,s=yield*n(Ia({try:()=>t.get(r),catch:i=>new V_({operation:"get",key:r,cause:i})}));return s?(yield*n(po("Loaded checkpoint from storage",{collection:e,checkpoint:s})),s):(yield*n(po("No stored checkpoint, using default",{collection:e})),{lastModified:0})}),saveCheckpoint:(e,n)=>Ur(function*(r){const s=`checkpoint:${e}`;yield*r(Ia({try:()=>t.set(s,n),catch:i=>new G8({key:s,value:n,cause:i})})),yield*r(po("Checkpoint saved",{collection:e,checkpoint:n}))}),clearCheckpoint:e=>Ur(function*(n){const r=`checkpoint:${e}`;yield*n(Ia({try:()=>t.del(r),catch:s=>new V_({operation:"delete",key:r,cause:s})})),yield*n(po("Checkpoint cleared",{collection:e}))})}))}const K_=dy(["replicate","merge"]);async function X8(t,e){const n=`yjsClientId:${t}`;let r=await e.get(n);r||(r=Math.floor(2147483647*Math.random()),await e.set(n,r),K_.info("Generated new Yjs clientID",{collection:t,clientId:r}));const s=new In({guid:t,clientID:r});return K_.info("Created Yjs document",{collection:t,clientId:r}),s}function aa(t,e,n){Np(t,e,n)}function Z8(t,e){return t.getMap(e)}function e3(t,e,n){return t.transact(e,n)}function Cf(t,e,n){const r=Ai(t),s=t.transact(e,n),i=Wa(t,r);return{result:s,delta:i}}function py(t){if(t===null||typeof t!="object")return!1;const e=t;return"_map"in e&&"_eH"in e&&"doc"in e}function xl(t){if(!py(t))return!1;const e=t;return typeof e.keys=="function"&&typeof e.get=="function"}function t3(t){if(!py(t))return!1;const e=t;return typeof e.toArray=="function"&&typeof e.get!="function"}function rI(t){if(!py(t))return!1;const e=t;return typeof e.toArray=="function"&&typeof e.keys!="function"}function _i(t){if(t==null||typeof t!="object")return t;if(rI(t))return s3(t);if(xl(t)){const e={};return t.forEach((r,s)=>{e[s]=_i(r)}),e}return t3(t)?t.toArray().map(_i):t}function n3(t){return _i(t)}function W_(t){const e=[];return t.forEach(n=>{xl(n)&&e.push(_i(n))}),e}function z_(t,e){const n=t.get(e);return xl(n)?_i(n):null}function r3(t){return typeof t=="object"&&t!==null&&"type"in t&&t.type==="doc"}function s3(t){const e=[];for(const n of t.toArray())if(n instanceof Gn)e.push(sI(n));else if(n instanceof Gr){const r=iI(n);r.length>0&&e.push({type:"paragraph",content:r})}return{type:"doc",content:e.length>0?e:[{type:"paragraph"}]}}function sI(t){const e={type:t.nodeName},n=t.getAttributes();Object.keys(n).length>0&&(e.attrs=n);const r=[];for(const s of t.toArray())s instanceof Gn?r.push(sI(s)):s instanceof Gr&&r.push(...iI(s));return r.length>0&&(e.content=r),e}function iI(t){const e=[],n=t.toDelta();for(const r of n)if(typeof r.insert=="string"){const s={type:"text",text:r.insert};r.attributes&&Object.keys(r.attributes).length>0&&(s.marks=Object.entries(r.attributes).map(([i,o])=>({type:i,attrs:typeof o=="object"?o:void 0}))),e.push(s)}return e}function i3(t,e){if(e.content)for(const n of e.content)oI(t,n)}function o3(t){if(!t||typeof t!="object")return"";const e=t;return!e.content||!Array.isArray(e.content)?"":e.content.map(n=>!n.content||!Array.isArray(n.content)?"":n.content.map(r=>r.text||"").join("")).join(" ")}function oI(t,e){if(e.type==="text"){const n=new Gr;if(e.text){const r={};if(e.marks)for(const s of e.marks)r[s.type]=s.attrs??!0;n.insert(0,e.text,Object.keys(r).length>0?r:void 0)}t.insert(t.length,[n])}else{const n=new Gn(e.type);if(e.attrs)for(const[r,s]of Object.entries(e.attrs))n.setAttribute(r,s);if(e.content)for(const r of e.content)oI(n,r);t.insert(t.length,[n])}}function np(t){return _i(t)}function c3(t,e,n){const r=t.get(e);if(!xl(r))return null;const s=r.get(n);return rI(s)?s:null}class rp extends T0("Reconciliation")(){}const a3=_x(rp,rp.of({reconcile:(t,e,n,r,s)=>Ur(function*(i){const o=new Set(r.map(s)),c=[];if(e.forEach((u,h)=>{o.has(h)||c.push(h)}),c.length===0)return yield*i(po("No phantom documents found",{collection:n})),[];yield*i(SK(`Found ${c.length} phantom documents`,{collection:n,phantomDocs:c.slice(0,10)}));const a=[];for(const u of c){const h=e.get(u);h instanceof br&&a.push(n3(h))}return e3(t,()=>{for(const u of c)e.delete(u)},"reconciliation"),yield*i(_K("Reconciliation completed",{collection:n,deletedCount:a.length})),a}).pipe(bx(i=>bK(new J8({collection:n,reason:"Reconciliation failed",cause:i}))))}));function u3(t){return{insert(e){t.begin();for(const n of e)t.write({type:"insert",value:n});t.commit()},delete(e){t.begin();for(const n of e)t.write({type:"delete",value:n});t.commit()},upsert(e){t.begin();for(const n of e)t.write({type:"update",value:n});t.commit()},replace(e){t.begin(),t.truncate();for(const n of e)t.write({type:"insert",value:n});t.commit()}}}const l3="server",jt=dy(["replicate","prose"]),h3=1e3,nc=new Map,Wn=new Map,To=new Map,rc=new Map,js=new Map,Ao=new Map,Rs=new Map;function f3(t,e){const n=`${t}:${e}`;return nc.get(n)??!1}function H_(t,e,n){const r=`${t}:${e}`;n?nc.set(r,!0):nc.delete(r)}function Cs(t,e){if((rc.get(t)??!1)!==e){rc.set(t,e);const r=js.get(t);if(r)for(const s of r)try{s(e)}catch(i){jt.error("Pending listener error",{key:t,error:String(i)})}}}function d3(t,e){return rc.get(`${t}:${e}`)??!1}function p3(t,e,n){const r=`${t}:${e}`;let s=js.get(r);return s||(s=new Set,js.set(r,s)),s.add(n),()=>{s?.delete(n),s?.size===0&&js.delete(r)}}function cI(t,e){const n=`${t}:${e}`,r=Wn.get(n);r&&(clearTimeout(r),Wn.delete(n),Cs(n,!1),jt.debug("Cancelled pending sync due to remote update",{collection:t,documentId:e}))}function g3(t){const e=`${t}:`;for(const[n,r]of Wn)n.startsWith(e)&&(clearTimeout(r),Wn.delete(n),Cs(n,!1));jt.debug("Cancelled all pending syncs",{collection:t})}function y3(t){const{collection:e,documentId:n,field:r,fragment:s,ydoc:i,ymap:o,collectionRef:c,debounceMs:a=h3}=t,u=`${e}:${n}`,h=Ao.get(u);if(h)return jt.debug("Fragment already being observed",{collection:e,documentId:n,field:r}),h;const l=(f,p)=>{if(p.origin===l3)return;const w=Wn.get(u);w&&clearTimeout(w),Cs(u,!0);const g=setTimeout(async()=>{Wn.delete(u);const m=o.get(n);if(!m){jt.error("Document not found",{collection:e,documentId:n}),Cs(u,!1);return}try{const _=To.get(u),v=_?Wa(i,_):Wa(i);if(v.length<=2){jt.debug("No changes to sync",{collection:e,documentId:n}),Cs(u,!1);return}const k=v.buffer,I=Ai(i);jt.debug("Syncing prose delta",{collection:e,documentId:n,deltaSize:v.byteLength});const A=np(m);await c.update(n,{metadata:{contentSync:{crdtBytes:k,materializedDoc:A}}},D=>{D.updatedAt=Date.now()}).isPersisted.promise,To.set(u,I),Rs.delete(u),Cs(u,!1),jt.debug("Prose sync completed",{collection:e,documentId:n})}catch(_){jt.error("Prose sync failed, queued for retry",{collection:e,documentId:n,error:String(_)}),Rs.set(u,!0)}},a);Wn.set(u,g),Rs.has(u)&&(Rs.delete(u),jt.debug("Retrying failed sync",{collection:e,documentId:n}))};s.observeDeep(l);const d=()=>{s.unobserveDeep(l),cI(e,n),Ao.delete(u),To.delete(u),jt.debug("Fragment observer cleaned up",{collection:e,documentId:n,field:r})};return Ao.set(u,d),jt.debug("Fragment observer registered",{collection:e,documentId:n,field:r}),d}function m3(t){const e=`${t}:`;for(const[n,r]of Wn)n.startsWith(e)&&(clearTimeout(r),Wn.delete(n));for(const n of rc.keys())n.startsWith(e)&&rc.delete(n);for(const n of js.keys())n.startsWith(e)&&js.delete(n);for(const n of nc.keys())n.startsWith(e)&&nc.delete(n);for(const n of To.keys())n.startsWith(e)&&To.delete(n);for(const[n,r]of Ao)n.startsWith(e)&&(r(),Ao.delete(n));for(const n of Rs.keys())n.startsWith(e)&&Rs.delete(n);jt.debug("Prose cleanup complete",{collection:t})}const Me=dy(["replicate","collection"]);function Of(t,e,n){const r=t;throw Me.error(`${e} failed`,{collection:n,error:r?.message,status:r?.status}),r?.status===401||r?.status===403?new j_("Authentication failed"):r?.status===422?new j_("Validation error"):t}const Mf=new Map,co=new Map,sp=new Map,w3=500,b3=1e3,ip=new Map,ku=new Map,Q_=new Map,Lf=new Map,_3=new Map;function G_(t){let e=ip.get(t);return e||(e=qL(),ip.set(t,e)),e}function S3(t,e,n,r){const s=`${t}:${e}:${n}`;let i=ku.get(s);if(i)return i;const o=sp.get(t);return i=new WM([r],{captureTimeout:o?.captureTimeout??w3,trackedOrigins:new Set(["fragment"])}),ku.set(s,i),i}function E3({getKey:t,material:e,convexClient:n,api:r,collection:s,prose:i,undoCaptureTimeout:o=500,persistence:c}){const a=new Set(i),u={async prose(K,O){const N=O;if(!a.has(N))throw new ca({documentId:K,field:N,collection:s});let W=co.get(s);if(W||(await new Promise(($,B)=>{const R=Date.now(),E=setInterval(()=>{co.has(s)?(clearInterval(E),$()):Date.now()-R>1e4&&(clearInterval(E),B(new ca({documentId:K,field:N,collection:s})))},10)}),W=co.get(s)),!W)throw new ca({documentId:K,field:N,collection:s});const q=c3(W.ymap,K,N);if(!q)throw new ca({documentId:K,field:N,collection:s});const te=Lf.get(s);te&&y3({collection:s,documentId:K,field:N,fragment:q,ydoc:W.ydoc,ymap:W.ymap,collectionRef:te,debounceMs:Q_.get(s)??b3});const T=S3(s,K,N,q);return{fragment:q,provider:{awareness:null},get pending(){return d3(s,K)},onPendingChange($){return p3(s,K,$)},undo(){T.undo()},redo(){T.redo()},canUndo(){return T.canUndo()},canRedo(){return T.canRedo()}}}};let h=null,l=null,d=null,f=null;const p=Y8(c.kv),w=vK(p,a3);let g;const m=new Promise(K=>{g=K});let _;const v=new Promise(K=>{_=K}),k=K=>Ur(function*(){if(!r.material)return;const O=r.material,N=yield*rp,W=yield*Ia({try:()=>n.query(O,{}),catch:T=>new Error(`Reconciliation query failed: ${T}`)}),q=Array.isArray(W)?W:W.documents||[],te=yield*N.reconcile(h,l,s,q,T=>String(t(T)));te.length>0&&K.delete(te)}).pipe(bx(O=>Ur(function*(){yield*EK("Reconciliation failed",{collection:s,error:O})}))),I=async()=>{if(!r.recovery)return void Me.debug("No recovery API configured, skipping recovery sync",{collection:s});try{const K=Ai(h);Me.debug("Starting recovery sync",{collection:s,localVectorSize:K.byteLength});const O=await n.query(r.recovery,{clientStateVector:K.buffer});O.diff?(G_(s)(()=>{aa(h,new Uint8Array(O.diff),"server")}),Me.info("Recovery sync applied diff",{collection:s,diffSize:O.diff.byteLength})):Me.debug("Recovery sync - no diff needed",{collection:s}),O.serverStateVector&&_3.set(s,new Uint8Array(O.serverStateVector))}catch(K){Me.error("Recovery sync failed",{collection:s,error:String(K)})}},A=K=>{const{delta:O}=Cf(h,()=>{K.forEach(N=>{const W=new br;l.set(String(N.key),W),Object.entries(N.modified).forEach(([q,te])=>{if(a.has(q)&&r3(te)){const T=new Qn;W.set(q,T),i3(T,te)}else W.set(q,te)})})},"local");return O},L=K=>{const{delta:O}=Cf(h,()=>{K.forEach(N=>{const W=l.get(String(N.key));if(W){const q=N.modified;if(!q)return void Me.warn("mut.modified is null/undefined",{collection:s,key:String(N.key)});Object.entries(q).forEach(([te,T])=>{const $=W.get(te);if(a.has(te))return void Me.debug("Skipping prose field in applyYjsUpdate",{field:te});if($ instanceof Qn)return void Me.debug("Preserving live fragment field",{field:te});W.set(te,T)})}else Me.error("Update attempted on non-existent item",{collection:s,key:String(N.key)})})},"local");return O},D=K=>{const{delta:O}=Cf(h,()=>{K.forEach(N=>{l.delete(String(N.key))})},"local");return O};return{id:s,getKey:t,_convexClient:n,_collection:s,_proseFields:i,_persistence:c,utils:u,onInsert:async({transaction:K})=>{try{await Promise.all([m,v]);const O=A(K.mutations);if(O.length>0){const N=String(K.mutations[0].key),W=l.get(N),q=W?np(W):K.mutations[0].modified;await n.mutation(r.insert,{documentId:N,crdtBytes:O.slice().buffer,materializedDoc:q})}}catch(O){Of(O,"Insert",s)}},onUpdate:async({transaction:K})=>{try{const O=K.mutations[0],N=String(O.key);if(f3(s,N))return void Me.debug("Skipping onUpdate - data from server",{collection:s,documentKey:N});await Promise.all([m,v]);const W=O.metadata;if(W?.contentSync){const{crdtBytes:te,materializedDoc:T}=W.contentSync;await n.mutation(r.update,{documentId:N,crdtBytes:te,materializedDoc:T});return}const q=L(K.mutations);if(q.length>0){const te=l.get(N),T=te?np(te):O.modified;await n.mutation(r.update,{documentId:N,crdtBytes:q.slice().buffer,materializedDoc:T})}}catch(O){Of(O,"Update",s)}},onDelete:async({transaction:K})=>{try{await Promise.all([m,v]);const O=D(K.mutations),N=K.mutations.map(W=>W.original).filter(W=>W!==void 0&&Object.keys(W).length>0);if(f.delete(N),O.length>0){const W=String(K.mutations[0].key);await n.mutation(r.remove,{documentId:W,crdtBytes:O.slice().buffer})}}catch(O){Of(O,"Delete",s)}},sync:{rowUpdateMode:"partial",sync:K=>{const{markReady:O,collection:N}=K;Lf.set(s,N);const W=Mf.get(s);W&&(W(),Mf.delete(s));let q=null;const te=e?.documents,T=e?.checkpoint,$=e?.crdtBytes,B=te?[...te]:[];return(async()=>{try{h=await X8(s,c.kv),l=Z8(h,s),co.set(s,{ydoc:h,ymap:l});const S=new Set(["local"]);if(sp.set(s,{captureTimeout:o,trackedOrigins:S}),d=c.createDocPersistence(s,h),d.whenSynced.then(()=>{Me.debug("Persistence synced",{collection:s}),g?.()}),await m,Me.info("Persistence ready",{collection:s,ymapSize:l.size}),f=u3(K),_?.(),$&&aa(h,new Uint8Array($),"server"),await I(),l.size>0){const G=W_(l);f.replace(G),Me.info("Data loaded to TanStack DB",{collection:s,itemCount:G.length})}else f.replace([]),Me.info("No data, cleared TanStack DB",{collection:s});Me.debug("Running reconciliation",{collection:s,ymapSize:l.size}),await Xw(k(f).pipe(Yw(w))),Me.debug("Reconciliation complete",{collection:s}),O(),Me.info("Collection ready",{collection:s,ymapSize:l.size});const R=T||await Xw(Ur(function*(){return yield*(yield*tp).loadCheckpoint(s)}).pipe(Yw(p)));Me.info("Checkpoint loaded",{collection:s,checkpoint:R,source:T?"SSR":"IndexedDB",ymapSize:l.size});const E=G_(s),P=G=>{g3(s),E(()=>{try{Me.debug("Applying snapshot",{collection:s,bytesLength:G.byteLength}),aa(h,new Uint8Array(G),"server");const se=W_(l);Me.debug("Snapshot applied",{collection:s,itemCount:se.length}),f.replace(se)}catch(se){throw Me.error("Error applying snapshot",{collection:s,error:String(se)}),new Error(`Snapshot application failed: ${se}`)}})},X=(G,se)=>{se&&(cI(s,se),H_(s,se,!0)),E(()=>{try{Me.debug("Applying delta",{collection:s,documentId:se,bytesLength:G.byteLength});const ce=se?z_(l,se):null;if(aa(h,new Uint8Array(G),"server"),!se)return void Me.debug("Delta applied (no documentId)",{collection:s});const ue=z_(l,se);ue?(Me.debug("Upserting item after delta",{collection:s,documentId:se}),f.upsert([ue])):ce?(Me.debug("Deleting item after delta",{collection:s,documentId:se}),f.delete([ce])):Me.debug("No change detected after delta",{collection:s,documentId:se})}catch(ce){throw Me.error("Error applying delta",{collection:s,documentId:se,error:String(ce)}),new Error(`Delta application failed for ${se}: ${ce}`)}finally{se&&H_(s,se,!1)}})},H=async G=>{try{if(!G||!Array.isArray(G.changes))return void Me.error("Invalid subscription response",{response:G});const{changes:se,checkpoint:ce}=G;for(const ue of se){const{operationType:J,crdtBytes:ne,documentId:de}=ue;if(!ne){Me.warn("Skipping change with missing crdtBytes",{change:ue});continue}try{J==="snapshot"?P(ne):X(ne,de)}catch(we){Me.error("Failed to apply change",{operationType:J,documentId:de,error:String(we)})}}if(ce)try{const ue=`checkpoint:${s}`;await c.kv.set(ue,ce),Me.debug("Checkpoint saved",{collection:s,checkpoint:ce})}catch(ue){Me.error("Failed to save checkpoint",{collection:s,error:String(ue)})}}catch(se){Me.error("Subscription handler error",{collection:s,error:String(se)})}};Me.info("Establishing subscription",{collection:s,checkpoint:R,limit:1e3}),q=n.onUpdate(r.stream,{checkpoint:R,limit:1e3},G=>{Me.debug("Subscription received update",{collection:s,changesCount:G.changes?.length??0,checkpoint:G.checkpoint,hasMore:G.hasMore}),H(G)}),Me.info("Subscription established",{collection:s})}catch(S){Me.error("Failed to set up collection",{error:S,collection:s}),O()}})(),{material:B,cleanup:()=>{q?.(),m3(s);const S=`${s}:`;for(const[R,E]of ku)R.startsWith(S)&&(E.destroy(),ku.delete(R));ip.delete(s),Q_.delete(s),Lf.delete(s),sp.delete(s),co.delete(s),d?.destroy(),h?.destroy(),Mf.delete(s)}}}}}}class v3{db;constructor(e){this.db=new h8.BrowserLevel(e)}async get(e){try{const n=await this.db.get(e);return n===void 0?void 0:JSON.parse(n)}catch(n){if(n.code==="LEVEL_NOT_FOUND")return;throw n}}async set(e,n){await this.db.put(e,JSON.stringify(n))}async del(e){try{await this.db.del(e)}catch(n){if(n.code!=="LEVEL_NOT_FOUND")throw n}}async close(){await this.db.close()}}class k3{persistence;whenSynced;constructor(e,n){this.persistence=new zK(e,n),this.whenSynced=new Promise(r=>{this.persistence.synced?r():this.persistence.once("synced",()=>r())})}destroy(){this.persistence.destroy()}}function x3(t="replicate-kv"){const e=new v3(t);return{createDocPersistence:(n,r)=>new k3(n,r),kv:e}}class I3{store=new Map;async get(e){return this.store.get(e)}async set(e,n){this.store.set(e,n)}async del(e){this.store.delete(e)}}class T3{whenSynced=Promise.resolve();destroy(){}}function A3(){const t=new I3;return{createDocPersistence:(e,n)=>new T3,kv:t}}class R3 extends kl.AbstractLevel{adapter=null;adapterFactory=null;constructor(e,n){super({encodings:{utf8:!0,buffer:!0,view:!0},seek:!0,permanence:!0,createIfMissing:!0,errorIfExists:!1,additionalMethods:{}},{keyEncoding:n?.keyEncoding??"utf8",valueEncoding:n?.valueEncoding??"utf8"}),n?.adapter&&(this.adapter=n.adapter)}setAdapterFactory(e){this.adapterFactory=e}async _open(){if(!this.adapter)if(this.adapterFactory)this.adapter=await this.adapterFactory();else throw new Error("No SQLite adapter configured. Call setAdapterFactory() before open().");await this.adapter.execute(`
      CREATE TABLE IF NOT EXISTS entries (
        key BLOB PRIMARY KEY,
        value BLOB NOT NULL
      )
    `),await this.adapter.execute(`
      CREATE INDEX IF NOT EXISTS entries_key_idx ON entries (key)
    `)}async _close(){this.adapter&&(this.adapter.close(),this.adapter=null)}async _get(e){if(!this.adapter)throw new Error("Database not open");const n=this.encodeKey(e),r=await this.adapter.execute("SELECT value FROM entries WHERE key = ?",[n]);if(r.rows.length!==0)return this.decodeValue(r.rows[0].value)}async _put(e,n){if(!this.adapter)throw new Error("Database not open");const r=this.encodeKey(e),s=this.encodeValue(n);await this.adapter.execute("INSERT OR REPLACE INTO entries (key, value) VALUES (?, ?)",[r,s])}async _del(e){if(!this.adapter)throw new Error("Database not open");const n=this.encodeKey(e);await this.adapter.execute("DELETE FROM entries WHERE key = ?",[n])}async _batch(e){if(!this.adapter)throw new Error("Database not open");await this.adapter.execute("BEGIN TRANSACTION");try{for(const n of e)if(n.type==="put"){const r=this.encodeKey(n.key),s=this.encodeValue(n.value);await this.adapter.execute("INSERT OR REPLACE INTO entries (key, value) VALUES (?, ?)",[r,s])}else if(n.type==="del"){const r=this.encodeKey(n.key);await this.adapter.execute("DELETE FROM entries WHERE key = ?",[r])}await this.adapter.execute("COMMIT")}catch(n){throw await this.adapter.execute("ROLLBACK"),n}}async _clear(){if(!this.adapter)throw new Error("Database not open");await this.adapter.execute("DELETE FROM entries")}_iterator(e){if(!this.adapter)throw new Error("Database not open");return new C3(this,this.adapter,e)}_keys(e){if(!this.adapter)throw new Error("Database not open");return new O3(this,this.adapter,e)}_values(e){if(!this.adapter)throw new Error("Database not open");return new M3(this,this.adapter,e)}encodeKey(e){return e instanceof Uint8Array?e:typeof e=="string"?new TextEncoder().encode(e):new TextEncoder().encode(String(e))}encodeValue(e){return e instanceof Uint8Array?e:typeof e=="string"?new TextEncoder().encode(e):new TextEncoder().encode(JSON.stringify(e))}decodeValue(e){return new TextDecoder().decode(e)}}class C3 extends kl.AbstractIterator{adapter;options;rows=null;index=0;constructor(e,n,r){super(e,r),this.adapter=n,this.options=r}async _next(){if(this.rows===null&&await this.loadRows(),this.rows&&this.index<this.rows.length){const e=this.rows[this.index++],n=new TextDecoder().decode(e.key),r=new TextDecoder().decode(e.value);return[n,r]}}async _nextv(e){this.rows===null&&await this.loadRows();const n=[];for(;this.rows&&this.index<this.rows.length&&n.length<e;){const r=this.rows[this.index++],s=new TextDecoder().decode(r.key),i=new TextDecoder().decode(r.value);n.push([s,i])}return n}async loadRows(){const{reverse:e,limit:n,gt:r,gte:s,lt:i,lte:o}=this.options;let c="SELECT key, value FROM entries";const a=[],u=[];r!==void 0&&(u.push("key > ?"),a.push(this.encodeKey(r))),s!==void 0&&(u.push("key >= ?"),a.push(this.encodeKey(s))),i!==void 0&&(u.push("key < ?"),a.push(this.encodeKey(i))),o!==void 0&&(u.push("key <= ?"),a.push(this.encodeKey(o))),u.length>0&&(c+=` WHERE ${u.join(" AND ")}`),c+=` ORDER BY key ${e?"DESC":"ASC"}`,n!==void 0&&n>=0&&(c+=` LIMIT ${n}`);const h=await this.adapter.execute(c,a);this.rows=h.rows}encodeKey(e){return e instanceof Uint8Array?e:typeof e=="string"?new TextEncoder().encode(e):new TextEncoder().encode(String(e))}}class O3 extends kl.AbstractKeyIterator{adapter;options;rows=null;index=0;constructor(e,n,r){super(e,r),this.adapter=n,this.options=r}async _next(){if(this.rows===null&&await this.loadRows(),this.rows&&this.index<this.rows.length){const e=this.rows[this.index++];return new TextDecoder().decode(e.key)}}async loadRows(){const{reverse:e,limit:n}=this.options;let r="SELECT key FROM entries";r+=` ORDER BY key ${e?"DESC":"ASC"}`,n!==void 0&&n>=0&&(r+=` LIMIT ${n}`);const s=await this.adapter.execute(r);this.rows=s.rows}}class M3 extends kl.AbstractValueIterator{adapter;options;rows=null;index=0;constructor(e,n,r){super(e,r),this.adapter=n,this.options=r}async _next(){if(this.rows===null&&await this.loadRows(),this.rows&&this.index<this.rows.length){const e=this.rows[this.index++];return new TextDecoder().decode(e.value)}}async loadRows(){const{reverse:e,limit:n}=this.options;let r="SELECT value FROM entries";r+=` ORDER BY key ${e?"DESC":"ASC"}`,n!==void 0&&n>=0&&(r+=` LIMIT ${n}`);const s=await this.adapter.execute(r);this.rows=s.rows}}class L3{db;prefix="kv:";constructor(e){this.db=e}async get(e){try{const n=await this.db.get(this.prefix+e);return n===void 0?void 0:JSON.parse(n)}catch{return}}async set(e,n){await this.db.put(this.prefix+e,JSON.stringify(n))}async del(e){await this.db.del(this.prefix+e)}}class D3{persistence;whenSynced;constructor(e,n,r){this.persistence=r,this.whenSynced=this.persistence.getYDoc(e).then(s=>{})}destroy(){this.persistence.destroy()}}async function gy(t){const{adapter:e,dbName:n="replicate"}=t,r=new R3(n);r.setAdapterFactory(()=>Promise.resolve(e)),await r.open();const s=new Q8(n,{level:r}),i=new L3(r);return{createDocPersistence:(o,c)=>new D3(o,c,s),kv:i}}class F3{db;onPersist;constructor(e,n={}){this.db=e,this.onPersist=n.onPersist}async execute(e,n){const r=[];if(e.trim().toUpperCase().startsWith("CREATE")||e.trim().toUpperCase().startsWith("INSERT")||e.trim().toUpperCase().startsWith("UPDATE")||e.trim().toUpperCase().startsWith("DELETE")||e.trim().toUpperCase().startsWith("BEGIN")||e.trim().toUpperCase().startsWith("COMMIT")||e.trim().toUpperCase().startsWith("ROLLBACK"))return this.db.run(e,n),await this.persist(),{rows:r};const s=this.db.prepare(e);for(n&&n.length>0&&s.bind(n);s.step();)r.push(s.getAsObject());return s.free(),{rows:r}}close(){this.db.close()}async persist(){if(this.onPersist){const e=this.db.export();await this.onPersist(new Uint8Array(e))}}}async function N3(t){try{const s=await(await(await(await navigator.storage.getDirectory()).getFileHandle(`${t}.sqlite`)).getFile()).arrayBuffer();return new Uint8Array(s)}catch{return null}}function P3(t){return async e=>{try{const s=await(await(await navigator.storage.getDirectory()).getFileHandle(`${t}.sqlite`,{create:!0})).createWritable(),i=new ArrayBuffer(e.length);new Uint8Array(i).set(e),await s.write(i),await s.close()}catch{}}}async function $3(t,e){const n=await N3(e),r=n?new t.Database(n):new t.Database,s=new F3(r,{onPersist:P3(e)});return gy({adapter:s,dbName:e})}class B3{db;constructor(e){this.db=e}async execute(e,n){return{rows:(await this.db.execute(e,n)).rows||[]}}close(){this.db.close()}}async function q3(t,e){const n=new B3(t);return gy({adapter:n,dbName:e})}const U3={indexeddb:x3,memory:A3,sqlite:{browser:$3,native:q3,create:gy}},zW={extract:o3},V3=xT;fA();let Df=null,Os=null;async function HW(){return Os||(Os=U3.indexeddb("intervals"),Os)}function QW(){if(!Os)throw new Error("Call initIntervalsPersistence() before useIntervals()");if(!Df){const t=pA();Df=mO(E3({convexClient:t,api:V3.intervals,collection:"intervals",getKey:e=>e.id,prose:["description"],persistence:Os}))}return Df}export{wS as $,f1 as A,Wt as B,Tn as C,In as D,zr as E,LW as F,vn as G,ht as H,Ve as I,rr as J,DW as K,A1 as L,SM as M,HW as N,z3 as O,pA as P,Ta as Q,LM as R,PM as S,Q3 as T,WM as U,zW as V,qI as W,PI as X,Gr as Y,ki as Z,vi as _,MW as a,Tu as a0,xW as a1,Na as a2,kt as a3,rn as a4,sW as a5,tW as a6,wO as a7,G3 as a8,nW as a9,mW as aA,wW as aB,bW as aC,EW as aD,AW as aE,Fc as aF,cW as aG,RW as aH,aW as aI,CW as aJ,uW as aK,hW as aL,fW as aM,ha as aN,UC as aO,kW as aP,zl as aQ,kS as aR,IW as aS,vW as aT,mO as aU,NI as aV,UI as aW,J3 as aa,rW as ab,TW as ac,iW as ad,zt as ae,oW as af,Y3 as ag,gA as ah,nr as ai,zs as aj,$n as ak,Bn as al,X3 as am,Z3 as an,SW as ao,eW as ap,dW as aq,gr as ar,Fa as as,pW as at,Oa as au,gp as av,_W as aw,lW as ax,yW as ay,gW as az,Ht as b,FW as c,ei as d,Gn as e,mE as f,qL as g,Nu as h,b1 as i,us as j,PW as k,Np as l,IS as m,En as n,Xs as o,NW as p,za as q,jI as r,H3 as s,$W as t,QW as u,xe as v,$M as w,uc as x,hn as y,ac as z};
