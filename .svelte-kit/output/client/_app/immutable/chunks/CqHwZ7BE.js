import{P as q,a as V,S as T,F as C,T as L,A as he,N as pe,E as ge,M as me,g as ye}from"./CmIejYcp.js";import{B as G,a as _e,U as ne,c as H,Y as m,R as E,f as z,b as K,I as ie,C as be,d as se,e as g,g as xe,i as we,h as Se,m as k,j as Z,k as D,D as Te,l as Q,n as Ce,o as $,t as oe,S as re,p as Ae,q as Pe,v as Me,w as ke,x as ve,y as Oe,z as Ve,A as Re,E as Ue,F as Ne,G as Ie,H as He,J as De,K as Ee,L as ze,M as Fe}from"./mpUCCd4c.js";const je=t=>class{constructor(i){this._=i}destroy(){t(this._)}},We=je(clearTimeout),ae=(t,e)=>new We(setTimeout(e,t)),Ye=/[\uD800-\uDBFF]/,Be=/[\uDC00-\uDFFF]/,qe=(t,e)=>{let i=0,n=0;for(;i<t.length&&i<e.length&&t[i]===e[i];)i++;for(i>0&&Ye.test(t[i-1])&&i--;n+i<t.length&&n+i<e.length&&t[t.length-n-1]===e[e.length-n-1];)n++;return n>0&&Be.test(t[t.length-n])&&n--,{index:i,remove:t.length-i-n,insert:e.slice(i,e.length-n)}},Le=qe,y=(t,e)=>t>>>e|t<<32-e,Ke=t=>y(t,2)^y(t,13)^y(t,22),Je=t=>y(t,6)^y(t,11)^y(t,25),Xe=t=>y(t,7)^y(t,18)^t>>>3,Ge=t=>y(t,17)^y(t,19)^t>>>10,Ze=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Qe=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);class $e{constructor(){const e=new ArrayBuffer(320);this._H=new Uint32Array(e,0,8),this._H.set(Qe),this._W=new Uint32Array(e,64,64)}_updateHash(){const e=this._H,i=this._W;for(let c=16;c<64;c++)i[c]=Ge(i[c-2])+i[c-7]+Xe(i[c-15])+i[c-16];let n=e[0],s=e[1],l=e[2],r=e[3],o=e[4],d=e[5],a=e[6],f=e[7];for(let c=0,u,h;c<64;c++)u=f+Je(o)+(o&d^~o&a)+Ze[c]+i[c]>>>0,h=Ke(n)+(n&s^n&l^s&l)>>>0,f=a,a=d,d=o,o=r+u>>>0,r=l,l=s,s=n,n=u+h>>>0;e[0]+=n,e[1]+=s,e[2]+=l,e[3]+=r,e[4]+=o,e[5]+=d,e[6]+=a,e[7]+=f}digest(e){let i=0;for(;i+56<=e.length;){let r=0;for(;r<16&&i+3<e.length;r++)this._W[r]=e[i++]<<24|e[i++]<<16|e[i++]<<8|e[i++];if(i%64!==0){for(this._W.fill(0,r,16);i<e.length;)this._W[r]|=e[i]<<(3-i%4)*8,i++;this._W[r]|=G<<(3-i%4)*8}this._updateHash()}const n=i%64!==0;this._W.fill(0,0,16);let s=0;for(;i<e.length;s++)for(let r=3;r>=0&&i<e.length;r--)this._W[s]|=e[i++]<<r*8;n||(this._W[s-(i%4===0?0:1)]|=G<<(3-i%4)*8),this._W[14]=e.byteLength/_e,this._W[15]=e.byteLength*8,this._updateHash();const l=new Uint8Array(32);for(let r=0;r<this._H.length;r++)for(let o=0;o<4;o++)l[r*4+o]=this._H[r]>>>(3-o)*8;return l}}const et=t=>new $e().digest(t),p=new V("y-sync"),_=new V("y-undo");new V("yjs-cursor");const tt=t=>{for(let i=6;i<t.length;i++)t[i%6]=t[i%6]^t[i];return t.slice(0,6)},nt=t=>Ee(tt(et(ze(t)))),v=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&e.sv.get(t.id.client)>t.id.clock&&!ve(e.ds,t.id),it=[{light:"#ecd44433",dark:"#ecd444"}],st=(t,e,i)=>{if(!t.has(i)){if(t.size<e.length){const n=Ue();t.forEach(s=>n.add(s)),e=e.filter(s=>!n.has(s))}t.set(i,Ne(e))}return t.get(i)},ot=(t,{colors:e=it,colorMapping:i=new Map,permanentUserData:n=null,onFirstRender:s=()=>{},mapping:l}={})=>{let r=!1;const o=new lt(t,l),d=new q({props:{editable:a=>{const f=p.getState(a);return f.snapshot==null&&f.prevSnapshot==null}},key:p,state:{init:(a,f)=>({type:t,doc:t.doc,binding:o,snapshot:null,prevSnapshot:null,isChangeOrigin:!1,isUndoRedoOperation:!1,addToHistory:!0,colors:e,colorMapping:i,permanentUserData:n}),apply:(a,f)=>{const c=a.getMeta(p);if(c!==void 0){f=Object.assign({},f);for(const u in c)f[u]=c[u]}return f.addToHistory=a.getMeta("addToHistory")!==!1,f.isChangeOrigin=c!==void 0&&!!c.isChangeOrigin,f.isUndoRedoOperation=c!==void 0&&!!c.isChangeOrigin&&!!c.isUndoRedoOperation,o.prosemirrorView!==null&&c!==void 0&&(c.snapshot!=null||c.prevSnapshot!=null)&&ae(0,()=>{o.prosemirrorView!=null&&(c.restore==null?o._renderSnapshot(c.snapshot,c.prevSnapshot,f):(o._renderSnapshot(c.snapshot,c.snapshot,f),delete f.restore,delete f.snapshot,delete f.prevSnapshot,o.mux(()=>{o._prosemirrorChanged(o.prosemirrorView.state.doc)})))}),f}},view:a=>(o.initView(a),l==null&&o._forceRerender(),s(),{update:()=>{const f=d.getState(a.state);if(f.snapshot==null&&f.prevSnapshot==null&&(r||a.state.doc.content.findDiffStart(a.state.doc.type.createAndFill().content)!==null)){if(r=!0,f.addToHistory===!1&&!f.isChangeOrigin){const c=_.getState(a.state),u=c&&c.undoManager;u&&u.stopCapturing()}o.mux(()=>{f.doc.transact(c=>{c.meta.set("addToHistory",f.addToHistory),o._prosemirrorChanged(a.state.doc)},p)})}},destroy:()=>{o.destroy()}})});return d},rt=(t,e,i)=>{if(e!==null&&e.anchor!==null&&e.head!==null)if(e.type==="all")t.setSelection(new he(t.doc));else if(e.type==="node"){const n=P(i.doc,i.type,e.anchor,i.mapping);t.setSelection(at(t,n))}else{const n=P(i.doc,i.type,e.anchor,i.mapping),s=P(i.doc,i.type,e.head,i.mapping);n!==null&&s!==null&&t.setSelection(L.between(t.doc.resolve(n),t.doc.resolve(s)))}},at=(t,e)=>{const i=t.doc.resolve(e);return i.nodeAfter?pe.create(t.doc,e):L.near(i)},F=(t,e)=>({type:e.selection.jsonID,anchor:B(e.selection.anchor,t.type,t.mapping),head:B(e.selection.head,t.type,t.mapping)});class lt{constructor(e,i=new Map){this.type=e,this.prosemirrorView=null,this.mux=xe(),this.mapping=i,this.isOMark=new Map,this._observeFunction=this._typeChanged.bind(this),this.doc=e.doc,this.beforeTransactionSelection=null,this.beforeAllTransactions=()=>{this.beforeTransactionSelection===null&&this.prosemirrorView!=null&&(this.beforeTransactionSelection=F(this,this.prosemirrorView.state))},this.afterAllTransactions=()=>{this.beforeTransactionSelection=null},this._domSelectionInView=null}get _tr(){return this.prosemirrorView.state.tr.setMeta("addToHistory",!1)}_isLocalCursorInView(){return this.prosemirrorView.hasFocus()?(we&&this._domSelectionInView===null&&(ae(0,()=>{this._domSelectionInView=null}),this._domSelectionInView=this._isDomSelectionInView()),this._domSelectionInView):!1}_isDomSelectionInView(){const e=this.prosemirrorView._root.getSelection();if(e==null||e.anchorNode==null)return!1;const i=this.prosemirrorView._root.createRange();i.setStart(e.anchorNode,e.anchorOffset),i.setEnd(e.focusNode,e.focusOffset),i.getClientRects().length===0&&i.startContainer&&i.collapsed&&i.selectNodeContents(i.startContainer);const s=i.getBoundingClientRect(),l=Se.documentElement;return s.bottom>=0&&s.right>=0&&s.left<=(window.innerWidth||l.clientWidth||0)&&s.top<=(window.innerHeight||l.clientHeight||0)}renderSnapshot(e,i){i||(i=ke(Fe(),new Map)),this.prosemirrorView.dispatch(this._tr.setMeta(p,{snapshot:e,prevSnapshot:i}))}unrenderSnapshot(){this.mapping.clear(),this.mux(()=>{const e=this.type.toArray().map(n=>A(n,this.prosemirrorView.state.schema,this)).filter(n=>n!==null),i=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new T(C.from(e),0,0));i.setMeta(p,{snapshot:null,prevSnapshot:null}),this.prosemirrorView.dispatch(i)})}_forceRerender(){this.mapping.clear(),this.mux(()=>{const e=this.beforeTransactionSelection!==null?null:this.prosemirrorView.state.selection,i=this.type.toArray().map(s=>A(s,this.prosemirrorView.state.schema,this)).filter(s=>s!==null),n=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new T(C.from(i),0,0));if(e){const s=k(Z(e.anchor,0),n.doc.content.size),l=k(Z(e.head,0),n.doc.content.size);n.setSelection(L.create(n.doc,s,l))}this.prosemirrorView.dispatch(n.setMeta(p,{isChangeOrigin:!0,binding:this}))})}_renderSnapshot(e,i,n){let s=this.doc,l=this.type;if(e||(e=D(this.doc)),e instanceof Uint8Array||i instanceof Uint8Array)if((!(e instanceof Uint8Array)||!(i instanceof Uint8Array))&&K(),s=new Te({gc:!1}),Q(s,i),i=D(s),Q(s,e),e=D(s),l._item===null){const r=Array.from(this.doc.share.keys()).find(o=>this.doc.share.get(o)===this.type);l=s.getXmlFragment(r)}else{const r=s.store.clients.get(l._item.id.client)??[],o=Ce(r,l._item.id.clock);l=r[o].content.type}this.mapping.clear(),this.mux(()=>{s.transact(r=>{const o=n.permanentUserData;o&&o.dss.forEach(c=>{$(r,c,u=>{})});const d=(c,u)=>{const h=c==="added"?o.getUserByClientId(u.client):o.getUserByDeletedId(u);return{user:h,type:c,color:st(n.colorMapping,n.colors,h)}},a=oe(l,new re(i.ds,e.sv)).map(c=>!c._item.deleted||v(c._item,e)||v(c._item,i)?A(c,this.prosemirrorView.state.schema,{mapping:new Map,isOMark:new Map},e,i,d):null).filter(c=>c!==null),f=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new T(C.from(a),0,0));this.prosemirrorView.dispatch(f.setMeta(p,{isChangeOrigin:!0}))},p)})}_typeChanged(e,i){if(this.prosemirrorView==null)return;const n=p.getState(this.prosemirrorView.state);if(e.length===0||n.snapshot!=null||n.prevSnapshot!=null){this.renderSnapshot(n.snapshot,n.prevSnapshot);return}this.mux(()=>{const s=(o,d)=>this.mapping.delete(d);$(i,i.deleteSet,o=>{if(o.constructor===ie){const d=o.content.type;d&&this.mapping.delete(d)}}),i.changed.forEach(s),i.changedParentTypes.forEach(s);const l=this.type.toArray().map(o=>le(o,this.prosemirrorView.state.schema,this)).filter(o=>o!==null);let r=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new T(C.from(l),0,0));rt(r,this.beforeTransactionSelection,this),r=r.setMeta(p,{isChangeOrigin:!0,isUndoRedoOperation:i.origin instanceof ne}),this.beforeTransactionSelection!==null&&this._isLocalCursorInView()&&r.scrollIntoView(),this.prosemirrorView.dispatch(r)})}_prosemirrorChanged(e){this.doc.transact(()=>{W(this.doc,this.type,e,this),this.beforeTransactionSelection=F(this,this.prosemirrorView.state)},p)}initView(e){this.prosemirrorView!=null&&this.destroy(),this.prosemirrorView=e,this.doc.on("beforeAllTransactions",this.beforeAllTransactions),this.doc.on("afterAllTransactions",this.afterAllTransactions),this.type.observeDeep(this._observeFunction)}destroy(){this.prosemirrorView!=null&&(this.prosemirrorView=null,this.type.unobserveDeep(this._observeFunction),this.doc.off("beforeAllTransactions",this.beforeAllTransactions),this.doc.off("afterAllTransactions",this.afterAllTransactions))}}const le=(t,e,i,n,s,l)=>{const r=i.mapping.get(t);if(r===void 0){if(t instanceof g)return A(t,e,i,n,s,l);throw Oe()}return r},A=(t,e,i,n,s,l)=>{const r=[],o=d=>{if(d instanceof g){const a=le(d,e,i,n,s,l);a!==null&&r.push(a)}else{const a=d._item.right?.content?.type;a instanceof se&&!a._item.deleted&&a._item.id.client===a.doc.clientID&&(d.applyDelta([{retain:d.length},...a.toDelta()]),a.doc.transact(c=>{a._item.delete(c)}));const f=ct(d,e,i,n,s,l);f!==null&&f.forEach(c=>{c!==null&&r.push(c)})}};n===void 0||s===void 0?t.toArray().forEach(o):oe(t,new re(s.ds,n.sv)).forEach(o);try{const d=t.getAttributes(n);n!==void 0&&(v(t._item,n)?v(t._item,s)||(d.ychange=l?l("added",t._item.id):{type:"added"}):d.ychange=l?l("removed",t._item.id):{type:"removed"});const a=e.node(t.nodeName,d,r);return i.mapping.set(t,a),a}catch{return t.doc.transact(a=>{t._item.delete(a)},p),i.mapping.delete(t),null}},ct=(t,e,i,n,s,l)=>{const r=[],o=t.toDelta(n,s,l);try{for(let d=0;d<o.length;d++){const a=o[d];r.push(e.text(a.insert,gt(a.attributes,e)))}}catch{return t.doc.transact(a=>{t._item.delete(a)},p),null}return r},dt=(t,e)=>{const i=new m,n=t.map(s=>({insert:s.text,attributes:de(s.marks,e)}));return i.applyDelta(n),e.mapping.set(i,t),i},ft=(t,e)=>{const i=new g(t.type.name);for(const n in t.attrs){const s=t.attrs[n];s!==null&&n!=="ychange"&&i.setAttribute(n,s)}return i.insert(0,R(t).map(n=>j(n,e))),e.mapping.set(i,t),i},j=(t,e)=>t instanceof Array?dt(t,e):ft(t,e),ee=t=>typeof t=="object"&&t!==null,J=(t,e)=>{const i=Object.keys(t).filter(s=>t[s]!==null);let n=i.length===Object.keys(e).filter(s=>e[s]!==null).length;for(let s=0;s<i.length&&n;s++){const l=i[s],r=t[l],o=e[l];n=l==="ychange"||r===o||ee(r)&&ee(o)&&J(r,o)}return n},R=t=>{const e=t.content.content,i=[];for(let n=0;n<e.length;n++){const s=e[n];if(s.isText){const l=[];for(let r=e[n];n<e.length&&r.isText;r=e[++n])l.push(r);n--,i.push(l)}else i.push(s)}return i},ce=(t,e)=>{const i=t.toDelta();return i.length===e.length&&i.every((n,s)=>n.insert===e[s].text&&Re(n.attributes||{}).length===e[s].marks.length&&Ve(n.attributes,(l,r)=>{const o=X(r),d=e[s].marks;return d.find(f=>f.type.name===o)?J(l,d.find(f=>f.type.name===o)?.attrs):!1}))},b=(t,e)=>{if(t instanceof g&&!(e instanceof Array)&&Y(t,e)){const i=R(e);return t._length===i.length&&J(t.getAttributes(),e.attrs)&&t.toArray().every((n,s)=>b(n,i[s]))}return t instanceof m&&e instanceof Array&&ce(t,e)},O=(t,e)=>t===e||t instanceof Array&&e instanceof Array&&t.length===e.length&&t.every((i,n)=>e[n]===i),te=(t,e,i)=>{const n=t.toArray(),s=R(e),l=s.length,r=n.length,o=k(r,l);let d=0,a=0,f=!1;for(;d<o;d++){const c=n[d],u=s[d];if(O(i.mapping.get(c),u))f=!0;else if(!b(c,u))break}for(;d+a<o;a++){const c=n[r-a-1],u=s[l-a-1];if(O(i.mapping.get(c),u))f=!0;else if(!b(c,u))break}return{equalityFactor:d+a,foundMappedChild:f}},ut=t=>{let e="",i=t._start;const n={};for(;i!==null;)i.deleted||(i.countable&&i.content instanceof Ie?e+=i.content.str:i.content instanceof He&&(n[i.content.key]=null)),i=i.right;return{str:e,nAttrs:n}},ht=(t,e,i)=>{i.mapping.set(t,e);const{nAttrs:n,str:s}=ut(t),l=e.map(a=>({insert:a.text,attributes:Object.assign({},n,de(a.marks,i))})),{insert:r,remove:o,index:d}=Le(s,l.map(a=>a.insert).join(""));t.delete(d,o),t.insert(d,r),t.applyDelta(l.map(a=>({retain:a.insert.length,attributes:a.attributes})))},pt=/(.*)(--[a-zA-Z0-9+/=]{8})$/,X=t=>pt.exec(t)?.[1]??t,gt=(t,e)=>{const i=[];for(const n in t)i.push(e.mark(X(n),t[n]));return i},de=(t,e)=>{const i={};return t.forEach(n=>{if(n.type.name!=="ychange"){const s=De(e.isOMark,n.type,()=>!n.type.excludes(n.type));i[s?`${n.type.name}--${nt(n.toJSON())}`:n.type.name]=n.attrs}}),i},W=(t,e,i,n)=>{if(e instanceof g&&e.nodeName!==i.type.name)throw new Error("node name mismatch!");if(n.mapping.set(e,i),e instanceof g){const c=e.getAttributes(),u=i.attrs;for(const h in u)u[h]!==null?c[h]!==u[h]&&h!=="ychange"&&e.setAttribute(h,u[h]):e.removeAttribute(h);for(const h in c)u[h]===void 0&&e.removeAttribute(h)}const s=R(i),l=s.length,r=e.toArray(),o=r.length,d=k(l,o);let a=0,f=0;for(;a<d;a++){const c=r[a],u=s[a];if(!O(n.mapping.get(c),u))if(b(c,u))n.mapping.set(c,u);else break}for(;f+a+1<d;f++){const c=r[o-f-1],u=s[l-f-1];if(!O(n.mapping.get(c),u))if(b(c,u))n.mapping.set(c,u);else break}t.transact(()=>{for(;o-a-f>0&&l-a-f>0;){const u=r[a],h=s[a],x=r[o-f-1],U=s[l-f-1];if(u instanceof m&&h instanceof Array)ce(u,h)||ht(u,h,n),a+=1;else{let w=u instanceof g&&Y(u,h),S=x instanceof g&&Y(x,U);if(w&&S){const N=te(u,h,n),I=te(x,U,n);N.foundMappedChild&&!I.foundMappedChild?S=!1:!N.foundMappedChild&&I.foundMappedChild||N.equalityFactor<I.equalityFactor?w=!1:S=!1}w?(W(t,u,h,n),a+=1):S?(W(t,x,U,n),f+=1):(n.mapping.delete(e.get(a)),e.delete(a,1),e.insert(a,[j(h,n)]),a+=1)}}const c=o-a-f;if(o===1&&l===0&&r[0]instanceof m?(n.mapping.delete(r[0]),r[0].delete(0,r[0].length)):c>0&&(e.slice(a,a+c).forEach(u=>n.mapping.delete(u)),e.delete(a,c)),a+f<l){const u=[];for(let h=a;h<l-f;h++)u.push(j(s[h],n));e.insert(a,u)}},p)},Y=(t,e)=>!(e instanceof Array)&&t.nodeName===e.type.name,B=(t,e,i)=>{if(t===0)return H(e,0,-1);let n=e._first===null?null:e._first.content.type;for(;n!==null&&e!==n;){if(n instanceof m){if(n._length>=t)return H(n,t,-1);if(t-=n._length,n._item!==null&&n._item.next!==null)n=n._item.next.content.type;else{do n=n._item===null?null:n._item.parent,t--;while(n!==e&&n!==null&&n._item!==null&&n._item.next===null);n!==null&&n!==e&&(n=n._item===null?null:n._item.next.content.type)}}else{const s=(i.get(n)||{nodeSize:0}).nodeSize;if(n._first!==null&&t<s)n=n._first.content.type,t--;else{if(t===1&&n._length===0&&s>1)return new E(n._item===null?null:n._item.id,n._item===null?z(n):null,null);if(t-=s,n._item!==null&&n._item.next!==null)n=n._item.next.content.type;else{if(t===0)return n=n._item===null?n:n._item.parent,new E(n._item===null?null:n._item.id,n._item===null?z(n):null,null);do n=n._item.parent,t--;while(n!==e&&n._item.next===null);n!==e&&(n=n._item.next.content.type)}}}if(n===null)throw K();if(t===0&&n.constructor!==m&&n!==e)return mt(n._item.parent,n._item)}return H(e,e._length,-1)},mt=(t,e)=>{let i=null,n=null;return t._item===null?n=z(t):i=Me(t._item.id.client,t._item.id.clock),new E(i,n,e.id)},P=(t,e,i,n)=>{const s=Ae(i,t);if(s===null||s.type!==e&&!Pe(e,s.type._item))return null;let l=s.type,r=0;if(l.constructor===m)r=s.index;else if(l._item===null||!l._item.deleted){let o=l._first,d=0;for(;d<l._length&&d<s.index&&o!==null;){if(!o.deleted){const a=o.content.type;d++,a instanceof m?r+=a._length:r+=n.get(a).nodeSize}o=o.right}r+=1}for(;l!==e&&l._item!==null;){const o=l._item.parent;if(o._item===null||!o._item.deleted){r+=1;let d=o._first;for(;d!==null;){const a=d.content.type;if(a===l)break;d.deleted||(a instanceof m?r+=a._length:r+=n.get(a).nodeSize),d=d.right}}l=o}return r-1};function yt(t){const e=t.toArray(),i=n=>{let s;if(n instanceof m)s=n.toDelta().map(r=>{const o={type:"text",text:r.insert};return r.attributes&&(o.marks=Object.keys(r.attributes).map(d=>{const a=r.attributes[d],c={type:X(d)};return Object.keys(a)&&(c.attrs=a),c})),o});else if(n instanceof g){s={type:n.nodeName};const l=n.getAttributes();Object.keys(l).length&&(s.attrs=l);const r=n.toArray();r.length&&(s.content=r.map(i).flat())}else K();return s};return{type:"doc",content:e.map(i)}}const _t=t=>{const e=_.getState(t).undoManager;if(e!=null)return e.undo(),!0},bt=t=>{const e=_.getState(t).undoManager;if(e!=null)return e.redo(),!0},xt=new Set(["paragraph"]),wt=(t,e)=>!(t instanceof ie)||!(t.content instanceof be)||!(t.content.type instanceof se||t.content.type instanceof g&&e.has(t.content.type.nodeName))||t.content.type._length===0,St=({protectedNodes:t=xt,trackedOrigins:e=[],undoManager:i=null}={})=>new q({key:_,state:{init:(n,s)=>{const l=p.getState(s),r=i||new ne(l.type,{trackedOrigins:new Set([p].concat(e)),deleteFilter:o=>wt(o,t),captureTransaction:o=>o.meta.get("addToHistory")!==!1});return{undoManager:r,prevSel:null,hasUndoOps:r.undoStack.length>0,hasRedoOps:r.redoStack.length>0}},apply:(n,s,l,r)=>{const o=p.getState(r).binding,d=s.undoManager,a=d.undoStack.length>0,f=d.redoStack.length>0;return o?{undoManager:d,prevSel:F(o,l),hasUndoOps:a,hasRedoOps:f}:a!==s.hasUndoOps||f!==s.hasRedoOps?Object.assign({},s,{hasUndoOps:d.undoStack.length>0,hasRedoOps:d.redoStack.length>0}):s}},view:n=>{const s=p.getState(n.state),l=_.getState(n.state).undoManager;return l.on("stack-item-added",({stackItem:r})=>{const o=s.binding;o&&r.meta.set(o,_.getState(n.state).prevSel)}),l.on("stack-item-popped",({stackItem:r})=>{const o=s.binding;o&&(o.beforeTransactionSelection=r.meta.get(o)||o.beforeTransactionSelection)}),{destroy:()=>{l.destroy()}}}});function Tt(t){return!!t.getMeta(p)}function Ct(t,e){const i=p.getState(t);return P(i.doc,i.type,e,i.binding.mapping)||0}function fe(t,e){const i=p.getState(t);return B(e,i.type,i.binding.mapping)}var M=class ue extends me{constructor(e,i){super(e),this.yRelativePosition=i}static fromJSON(e){return new ue(e.position,e.yRelativePosition)}toJSON(){return{position:this.position,yRelativePosition:this.yRelativePosition}}};function At(t,e){const i=fe(e,t);return new M(t,i)}function Pt(t,e,i){const n=t instanceof M?t.yRelativePosition:null;if(Tt(e)&&n){const r=Ct(i,n);return{position:new M(r,n),mapResult:null}}const s=ye(t,e),l=s.position.position;return{position:new M(l,n??fe(i,l)),mapResult:s.mapResult}}var Mt=ge.create({name:"collaboration",priority:1e3,addOptions(){return{document:null,field:"default",fragment:null,provider:null}},addStorage(){return{isDisabled:!1}},onCreate(){this.editor.extensionManager.extensions.find(t=>t.name==="undoRedo")&&console.warn('[tiptap warn]: "@tiptap/extension-collaboration" comes with its own history support and is not compatible with "@tiptap/extension-undo-redo".')},onBeforeCreate(){this.editor.utils.getUpdatedPosition=(t,e)=>Pt(t,e,this.editor.state),this.editor.utils.createMappablePosition=t=>At(t,this.editor.state)},addCommands(){return{undo:()=>({tr:t,state:e,dispatch:i})=>(t.setMeta("preventDispatch",!0),_.getState(e).undoManager.undoStack.length===0?!1:i?_t(e):!0),redo:()=>({tr:t,state:e,dispatch:i})=>(t.setMeta("preventDispatch",!0),_.getState(e).undoManager.redoStack.length===0?!1:i?bt(e):!0)}},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Mod-y":()=>this.editor.commands.redo(),"Shift-Mod-z":()=>this.editor.commands.redo()}},addProseMirrorPlugins(){var t;const e=this.options.fragment?this.options.fragment:this.options.document.getXmlFragment(this.options.field),i=St(this.options.yUndoOptions),n=i.spec.view;i.spec.view=r=>{const{undoManager:o}=_.getState(r.state);o.restore&&(o.restore(),o.restore=()=>{});const d=n?n(r):void 0;return{destroy:()=>{const a=o.trackedOrigins.has(o),f=o._observers;o.restore=()=>{a&&o.trackedOrigins.add(o),o.doc.on("afterTransaction",o.afterTransactionHandler),o._observers=f},d?.destroy&&d.destroy()}}};const s={...this.options.ySyncOptions,onFirstRender:this.options.onFirstRender},l=ot(e,s);return this.editor.options.enableContentCheck&&((t=e.doc)==null||t.on("beforeTransaction",()=>{try{const r=yt(e);if(r.content.length===0)return;this.editor.schema.nodeFromJSON(r).check()}catch(r){return this.editor.emit("contentError",{error:r,editor:this.editor,disableCollaboration:()=>{var o;(o=e.doc)==null||o.destroy(),this.storage.isDisabled=!0}}),!1}})),[l,i,this.editor.options.enableContentCheck&&new q({key:new V("filterInvalidContent"),filterTransaction:()=>{var r;return this.storage.isDisabled!==!1&&((r=e.doc)==null||r.destroy()),!0}})].filter(Boolean)}}),Vt=Mt;export{Mt as Collaboration,M as CollaborationMappablePosition,At as createMappablePosition,Vt as default,Pt as getUpdatedPosition,Tt as isChangeOrigin};
